(function($){'use strict';BOM=BOM||{};BOM.User=BOM.User||{};var _self=null;BOM.User.memberNotifications=function(oConf){this.conf=$.extend({rootSel:'#modUsrNotifications',notifSel:'#modUsrNotifications .notify .num',pmSel:'#modUsrNotifications .pm .num',dataUrl:'',refreshExpiration:30000,init:true},oConf||{});_self=this;_self.lastUpdateTime=0;_self.loading=false;_self.rootElm=$(_self.conf.rootSel);_self.notifElm=$(_self.conf.notifSel);_self.pmElm=$(_self.conf.pmSel);_self.layerElm=_self.rootElm.find('.layer');_self.mainContentElm=_self.rootElm.find('#mainContent');if(this.conf.init!==false){this.init()}};BOM.User.memberNotifications.prototype={init:function(){if(BOM.User.isConnected===true){_self.rootElm.hoverIntent({interval:200,over:_self.showMemberModule,out:_self.hideMemberModule});_self.initCounts()}},initCounts:function(){_self.notifElm.empty().addClass('ajaxLoader');_self.pmElm.empty().addClass('ajaxLoader');_self.loading=true;$.ajax({type:'GET',data:{'countOnly':1},dataType:'json',url:BOM.Utils.decode(_self.conf.url),success:function(response){_self.updateMemberCounts(response);_self.loading=false},error:function(){_self.lastUpdateTime=0;_self.loading=false}})},showMemberModule:function(){_self.rootElm.addClass('expand');var delta=(new Date().getTime())-_self.lastUpdateTime;if(!_self.loading&&(delta>_self.conf.refreshExpiration)){_self.loadMemberDatas(_self.conf.url)}},loadMemberDatas:function(dataUrl){_self.layerElm.empty().addClass('ajaxLoader');_self.loading=true;$.ajax({type:'GET',url:BOM.Utils.decode(dataUrl),success:_self.updateModule,error:function(){_self.lastUpdateTime=0;_self.loading=false;_self.updateMemberData({'error':'<span class="error">An error occured</span>'})}})},hideMemberModule:function(){_self.rootElm.removeClass('expand')},updateModule:function(data){_self.loading=false;_self.lastUpdateTime=new Date().getTime();_self.updateMemberCounts(data);_self.updateMemberData(data)},updateMemberData:function(data){_self.layerElm.removeClass('ajaxLoader').empty().html(data['error']?data['error']:data.memberModContent)},updateMemberCounts:function(data){_self.notifElm.removeClass('ajaxLoader');_self.pmElm.removeClass('ajaxLoader');_self.notifElm.html(data.notificationCount);_self.pmElm.html(data.pmCount);if(data.pmCount>0||data.notificationCount>0&&BOM.User.memberNotificationsConf.newHeader){_self.pmElm.siblings('.icon-mail').addClass('alert');_self.rootElm.addClass('alert')}else{_self.pmElm.siblings('.icon-mail').removeClass('alert');_self.rootElm.removeClass('alert')}}};BOM.User.memberNotifications.initModule=function(oConf){oConf=oConf||BOM.User.memberNotificationsConf;new BOM.User.memberNotifications(oConf)}}(jQuery));if(typeof head!=='function'){BOM.config.readyLoader=BOM.config.readyLoader||[];BOM.config.readyLoader.push([BOM.User.memberNotifications.initModule])}