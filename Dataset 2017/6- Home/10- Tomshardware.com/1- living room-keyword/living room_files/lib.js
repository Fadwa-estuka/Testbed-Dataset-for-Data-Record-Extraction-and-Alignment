!function(){"use strict";var a=function(a,b){this.d=top.document,this.w=top.window,this.conf=a||[],b="undefined"==typeof b?!0:b;var c="https:"===this.d.location.protocol;this.domain=(c?"https:":"http:")+"//t.purch.com",b===!0&&this.init()};a.prototype={event:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,"undefined"!=typeof d):a.attachEvent&&a.attachEvent("on"+b,c)},deepExtend:function(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[a].hasOwnProperty(b)&&(arguments[0][b]=arguments[a][b]);return arguments[0]},uniqId:function(){return Math.abs(String((new Date).getTime()*Math.random()>>1)+Math.floor(1e4*Math.random())).toString(32)},now:function(){return(new Date).getTime()},init:function(){for(var a=0,b=this.conf.length;b>a;a++)for(var c=this.d.querySelectorAll(this.conf[a].targets||null),d=0,e=c.length;e>d;d++)this.process(this.conf[a],c[d])},initEvent:function(a,b){var c=this;this.event(b,a.eventName||"csevent",function(b){var d=c.getUrl(a,b.target||b.srcElement);c.put(d)},!0)},triggerEvent:function(a,b){var c=this.getUrl(b||{},a||this.d.body);return this.put(c)},put:function(a){if(!a)return!1;var b=new Image;return b.src=a,b},process:function(a,b,c){b.getAttribute&&b.getAttribute("href")&&(b.setAttribute("data-ohref",b.getAttribute("href")),b.setAttribute("href",this.getUrl(a,b,c))),a.event===!0&&this.initEvent(a,b)},mergedConfigs:function(a,b,c){var d=this.getElementConf(c),e={};return(b.d||d.d)&&(e.d=this.deepExtend({},b.d,d.d)),(b.p||d.p)&&(e.p=this.deepExtend({},b.p,d.p)),this.deepExtend(a,b,d,e)},getUrl:function(a,b,c){var d=this.mergedConfigs({domain:this.domain,etype:"catchall",uuid:this.uniqId(),sendAll:!1,visitor_id:this.getVisitorId()},a,b);d.el=b;var e=["etype::"+d.etype,"uuid::"+d.uuid,"visitor_id::"+d.visitor_id];if(d.sendAll===!0){var f=this.getKnownPatterns();for(var g in f)if(f.hasOwnProperty(g)&&"%visitor_id%"!==g.toLowerCase()){var h="function"==typeof f[g]?f[g].call(this,d):f[g],i=g.replace(new RegExp("%","gi"),"");e.push(i+"::"+h)}}if(d.url&&e.push("url::"+this.w.btoa(this.replacePatterns(d,c))),d.d)for(var j in d.d)d.d.hasOwnProperty(j)&&e.push(j+"::"+("function"==typeof d.d[j]?d.d[j].call(this,d):d.d[j]));return d.domain+"/"+this.w.btoa(this.replacePatterns({url:e.join("|"),p:d.p,separator:d.separator,el:b}))},getVisitorId:function(){var a;return this.w.ga&&(this.w.ga.getAll&&this.w.ga.getAll().length&&this.w.ga.getAll()[0].get&&(a="ga-"+this.w.ga.getAll()[0].get("clientId")),"function"==typeof this.w.ga&&this.w.ga(function(b){b&&b.get&&(a="ga-"+b.get("clientId"))})),this.w.Purch&&this.w.Purch.cs_data&&this.w.Purch.cs_data.VISITOR_ID||a||"visitor-%CB%"},getGaId:function(){var a;if(this.w.ga){if(this.w.ga.getAll&&this.w.ga.getAll().length&&this.w.ga.getAll()[0].get)return a="ga-"+this.w.ga.getAll()[0].get("clientId");"function"==typeof this.w.ga&&this.w.ga(function(b){return b&&b.get?a="ga-"+b.get("clientId"):void 0})}},getRampId:function(){return this.w.Purch&&this.w.Purch.cs_data&&this.w.Purch.cs_data.VISITOR_ID?this.w.Purch.cs_data.VISITOR_ID:void 0},getLocation:function(){return this.w.location},getCookies:function(){return this.d.cookie},getKnownUrl:function(){var a=this.getLocation(),b=this.d.querySelector('[rel="canonical"]');return b?b.getAttribute("href"):a.href},getKnownPatterns:function(){var a=this,b=this.getLocation(),c={"%CB%":function(){return a.now()},"%SITE%":b.hostname,"%URL%":this.getKnownUrl(),"%GAID%":this.getGaId(),"%RAMPID%":this.getRampId(),"%COOKIES%":this.getCookies()};if(this.w.Purch&&this.w.Purch.cs_data)for(var d in this.w.Purch.cs_data)this.w.Purch.cs_data.hasOwnProperty(d)&&(c["%"+d.toString().toUpperCase()+"%"]=this.w.Purch.cs_data[d]);return c},replacePatterns:function(a,b){var c=this.getKnownPatterns(),d=[a.url],e=a.separator||"?";a.pre&&a.pre.join&&d.splice(0,0,a.pre.join(e)),a.suf&&a.suf.join&&d.push(a.suf.join(e)),d=d.join(e);var f=a.p||{},g=this.deepExtend({},c,f);for(var h in g)g.hasOwnProperty(h)&&(d.match(new RegExp(h,"gi"))||d.indexOf(h)>=0)&&(d=d.replace(new RegExp(h,"gi"),"function"==typeof g[h]?g[h].call(this,a):g[h]));return d},getElementConf:function(a){return a&&a.getAttribute&&JSON.parse(a.getAttribute("data-pe")||"{}")||{}}};var b=function(b){this.conf=this.deepExtend({},{providers:["amazon.com"],separator:"?",pathLimit:5,init:!0},b),a.call(this,this.conf,this.conf.init)};b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.init=function(){var a=this;this.event(this.d.body,"mouseover",function(b){a.checkElement(b)}),this.event(this.d.body,"touchstart",function(b){a.checkElement(b)})},b.prototype.getElement=function(a){var b=a.target||a.srcElement;if("a"===b.tagName.toLowerCase())return b;for(var c=a.path||this.getPath(b),d=c.length>=this.conf.pathLimit?this.conf.pathLimit:c.length,e=0;d>e;e++)c[e].tagName&&"a"===c[e].tagName.toLowerCase()&&(b=c[e]);return b},b.prototype.getPath=function(a){for(var b=[],c=a,d=0;d<this.conf.pathLimit&&c!==document.body;)b.push(c),c=c.parentNode,d++;return b},b.prototype.hasTag=function(a,b){var c=this.conf.separator||"?";return b=b.split(c),b=b.length>1?b[1].split("&"):b[0].split("&"),b=b.length>1?b[1].split("="):b[0].split("="),b.some(function(b){return a.indexOf(b)>=0})},b.prototype.parseUrl=function(a){var b=/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n\?]+)/,c=b.exec(a);return c&&c.length>1?c[1]:""},b.prototype.isWhiteListed=function(a){return this.checkUrlPatterns(a)||this.conf.providers.indexOf(this.parseUrl(a))>=0},b.prototype.checkUrlPatterns=function(a){if(this.conf.urlPatterns){if("string"==typeof this.conf.urlPatterns)return 0===a.indexOf(this.conf.urlPatterns);for(var b=0;b<this.conf.urlPatterns.length;++b)if(0===a.indexOf(this.conf.urlPatterns[b]))return!0;return!1}return!1},b.prototype.checkElement=function(a){var b=this.getElement(a);if(b&&"a"===b.tagName.toLowerCase()&&this.isWhiteListed(b.getAttribute("href")||"")){var c=b.getAttribute("href");return this.hasTag(c,this.conf.pre?this.conf.pre.join("&"):"notag")||this.hasTag(c,this.conf.suf?this.conf.suf.join("&"):"notag")?this.process(this.conf,b,!1):this.process(this.conf,b),!0}return!1},b.prototype.getElementConf=function(b){var c=a.prototype.getElementConf.call(this,b);return c.url=b&&b.getAttribute&&b.getAttribute("href"),c},window.Purch=window.Purch||{},window.Purch.LOE=a,window.Purch.Discovery=b}();