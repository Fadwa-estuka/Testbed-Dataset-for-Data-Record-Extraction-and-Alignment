var VisitorService=VisitorService||{};VisitorService.Rules=VisitorService.Rules||{};
VisitorService.Rules.Adapter=function(){this._headElement=document.getElementsByTagName("head")[0];this._headElement||(this._headElement=document.createElement("head"),document.insertBefore(this._headElement,document.getElementsByTagName("body")));this._sessionId=this._visitorId="";this._domain=this._searchScriptNodes("vsapi",1);this._dataFields={};this._eventDataQueue=[];this._eventSending=!1;this._widgets=[];this._spacWidgets=[];this._domContentLoaded=this._vsOptsLoaded=!1;this._widgetLoadQueue=
[];this._rnScript;this._rnScriptIgnored=!1;this._widgets.indexOf=this._widgets.indexOf||function(a){var b=this.length>>>0;for(i=0;i<b;i++)if(this[i]===a)return i;return-1};this.WTYPE={SPAC:2,SKB:3,SPOL:5,SCCL:7,PAC:"ProactiveChat",CCL:"ConditionalChatLink",VSPAC:1,VSSPAC:2,VSCCL:3,VSSCCL:4};this.ATYPE={LOAD:"PAGE_LOAD",OFFER:"OFFER",ACCEPT:"ACCEPT",CONVERT:"CONVERT",SUPPRESS:"SUPPRESS",REJECT:"REJECT"};this.WIDGET_STATE={LOADING:"LOADING",LOADED:"LOADED",OFFERED:"OFFERED"};this.initialize()};
VisitorService.Rules.Adapter.prototype={push:function(a){switch(a[0]){case "vsResponse":this._vsSuccess=a[1].success;!0===this._vsSuccess&&(this._vsLastSuccessfulEvent={name:a[1].name,value:"null"==a[1].value?void 0:a[1].value});break;case "vsOpts":if(this._vip!=a[1].vip||this._site!=a[1].site||this._poolID!=a[1].poolId||this._vsEnabled!=a[1].vsEnabled)this._vip=a[1].vip,this._site=a[1].site,this._poolID=a[1].poolId,this._vsEnabled=a[1].vsEnabled,this._cacheDomain=a[1].cacheDomain,this._vsOptsLoaded=
!0,this._loadWidgetsIfReady(),this._eventSending=!1,this._sendNextEventItem();break;case "rulesReady":this._processPageLoad(a[1].visitorId,a[1].sessionId);break;case "cpWidget":if(!RightNow.Event)break;var b={rule:a[1].rule,data:a[1]},a=a[1];a.ruleId=b.rule.id;this._processExtraWidgetData(a);delete b.data.rule;delete b.data.ts;switch(b.data.name){case this.WTYPE.PAC:b.data.offerOnlyOnce=!0;b.data.ignoreCookie=!0;b.data.ignoreTriggers=!0;if(0>this._widgets.indexOf(this.WTYPE.PAC)){this._widgets.push(this.WTYPE.PAC);
RightNow.Event.subscribe("evt_ProactiveReady",function(){RightNow.Event.fire("evt_customProactiveInitialization",b)});var c={widgetData:a,instance:this};RightNow.Event.subscribe("evt_PACChatOffered",this._chatOffered,c);RightNow.Event.subscribe("evt_PACChatAccepted",this._chatAccepted,c)}a.instance_id="pac_"+a.widget_id;a.module=a.name;a.vstype=this.WTYPE.VSPAC;RightNow.Event.fire("evt_isProactiveReady");break;case this.WTYPE.CCL:a.instance_id="ccl_"+a.widget_id,a.module=a.name,a.vstype=this.WTYPE.VSCCL,
0>this._widgets.indexOf(this.WTYPE.CCL)&&(this._widgets.push(this.WTYPE.CCL),RightNow.Event.subscribe("evt_CCLReady",function(){RightNow.Event.fire("evt_customInitialization",b)}),RightNow.Event.fire("evt_isCCLReady"),c={widgetData:a,instance:this},RightNow.Event.subscribe("evt_CCLChatOffered",this._chatOffered,c),RightNow.Event.subscribe("evt_CCLChatAccepted",this._chatAccepted,c))}break;case "synWidget":a=this._clone(a[1]);a.rule&&(a.ruleId=a.rule.id,delete a.rule);delete a.ts;if(a.suppress){this._logExternal(this.ATYPE.SUPPRESS,
a);break}switch(a.type){case this.WTYPE.SPAC:a.instance_id="spac_"+a.widget_id;a.lazy_mode=!0;a.vstype=this.WTYPE.VSSPAC;(c=this._findSpacWidget(a.instance_id))?c.state===this.WIDGET_STATE.LOADED&&(a=new RightNow.Client.EventObject(a.module,a.instance_id),a.data={dataFields:this._dataFields},RightNow.Client.Event.evt_updateCustomFieldsRequest.fire(a),a.data={checkAvailability:!0},RightNow.Client.Event.evt_chatOfferRequest.fire(a)):(c={instanceId:a.instance_id,state:this.WIDGET_STATE.LOADING},this._spacWidgets.push(c),
this._widgetLoadQueue.push(a),this._loadWidgetsIfReady());break;case this.WTYPE.SKB:a.instance_id="skb_"+a.widget_id;this._loadWidgetOrIgnore(a);break;case this.WTYPE.SPOL:a.instance_id="spol_"+a.widget_id;this._loadWidgetOrIgnore(a);break;case this.WTYPE.SCCL:a.instance_id="sccl_"+a.widget_id,a.vstype=this.WTYPE.VSSCCL,this._loadWidgetOrIgnore(a)}break;case "transactionCompleted":this._sendEventData(this.ATYPE.CONVERT,a[1].customVars.total);break;case "customData":this._dataFields[a[1].name]=a[1].value}},
initialize:function(){if(window._vsq&&window._vsq.shift)for(;window._vsq.length;)this.push(window._vsq.shift());window._vsq=this},_searchScriptNodes:function(a,b){for(var c="",d=RegExp("//([a-z0-9-.]+)/.*"+a+"(-test)?.js"),f=document.getElementsByTagName("script"),e=0;e<f.length;e++){var h=f[e].src.match(d);if(h){c=h[b];break}}return c},_processPageLoad:function(a,b){this._visitorId=a;this._sessionId=b;this._sendEventData(this.ATYPE.LOAD);this._resetWidgets()},_resetWidgets:function(){var a=this._spacWidgets;
if(0<a.length)for(var b=0;b<a.length;b++)a[b].state===this.WIDGET_STATE.OFFERED&&(a[b].state=this.WIDGET_STATE.LOADED)},_checkSendSuccess:function(){this._eventSending=!1;void 0===this._vsSuccess||!1===this._vsSuccess?this._updateOpts():!0===this._vsSuccess&&(this._eventDataQueue.shift(),this._sendNextEventItem())},_updateOpts:function(){var a=this._searchScriptNodes("vsopts",0);if(""!==a){var b=document.createElement("iframe");b.style.display="none";b.src=a+"?update=true";document.body.appendChild(b)}},
_sendEventData:function(a,b){this._eventDataQueue.push({name:a,value:b});!this._eventSending&&void 0!==this._vip&&(this._eventSending=!0,this._sendNextEventItem(a,b))},_sendNextEventItem:function(){var a=this._eventDataQueue[0];void 0!==a&&this._sendEventDataItem(a.name,a.value)},_sendEventDataItem:function(a,b){if(this._vsEnabled){var c=document.createElement("script");c.setAttribute("type","text/javascript");var d=this;void 0!=c.addEventListener?(c.addEventListener("load",function(){d._checkSendSuccess()},
!1),c.addEventListener("error",function(){d._updateOpts()},!1)):void 0!=c.attachEvent&&c.attachEvent("onreadystatechange",function(){"loaded"==c.readyState&&d._checkSendSuccess()});var f=!1,e="//"+this._vip+"/vs/site/"+this._site+"/visitor/"+this._visitorId+"/session/"+this._sessionId+"/type/"+a;a===this.ATYPE.OFFER||a===this.ATYPE.ACCEPT?(e+="/val1/"+b.widget_id+"/val2/"+b.widget_name+"/val3/"+b.vstype,e+=this._addExtraInfoToPath(b),f=!0):a===this.ATYPE.CONVERT?(e=e+("/val1/"+b)+this._addExtraInfoToPath(b),
f=!0):a===this.ATYPE.LOAD&&(e+=this._addExtraInfoToPath(b),f=!0);""!=this._poolID&&(e+=(f?"&":"?")+"pool="+this._poolID);c.src=e;this._headElement.appendChild(c)}},_addExtraInfoToPath:function(a){var b="",c=encodeURIComponent(window.location.href),d=encodeURIComponent(document.title),b=b+("?url="+c+"&title="+d);this._dataFields["incidents.prod"]?b+="&prodId="+this._dataFields["incidents.prod"]:a&&a.p&&(b+="&prodId="+a.p);this._dataFields["incidents.cat"]?b+="&categId="+this._dataFields["incidents.cat"]:
a&&a.c&&(b+="&categId="+a.c);return b},_findSpacWidget:function(a){for(var b=0;b<this._spacWidgets.length;b++)if(this._spacWidgets[b].instanceId===a)return this._spacWidgets[b]},_loadWidgetOrIgnore:function(a){if(0>this._widgets.indexOf(a.instance_id))this._widgets.push(a.instance_id),this._widgetLoadQueue.push(a),this._loadWidgetsIfReady();else try{var b=window[a.instance_id];scclElement=document.getElementById(b._containerElement.id);b&&"undefined"!==typeof scclElement&&0>scclElement.className.indexOf("rn_ConditionalChatLink")&&
b.render()}catch(c){}},_loadWidgetsIfReady:function(){if(this._vsOptsLoaded||""===this._searchScriptNodes("vsopts",0))if(!this._rnScriptIgnored&&void 0===this._rnScript&&("undefined"===typeof RightNow||"undefined"===typeof RightNow.Client)&&("loaded"===document.readyState||"complete"===document.readyState||this._domContentLoaded))this._loadRNScript();else if(this._rnScriptLoaded)for(;0<this._widgetLoadQueue.length;)this._loadWidget(this._widgetLoadQueue.pop())},_loadRNScript:function(){if("undefined"!==
typeof RightNow&&"undefined"!==typeof RightNow.Event)this._onRNScriptIgnored();else{var a=this._cacheDomain||this._domain;this._rnScript=document.createElement("script");this._rnScript.setAttribute("type","text/javascript");this._rnScript.setAttribute("src","//"+a+"/euf/rightnow/RightNow.Client.js");var b=this;"undefined"!==typeof this._rnScript.addEventListener?this._rnScript.addEventListener("load",function(){b._onAfterRNScriptLoaded()},!1):"undefined"!==typeof this._rnScript.attachEvent&&this._rnScript.attachEvent("onreadystatechange",
function(){("complete"===b._rnScript.readyState||"loaded"===b._rnScript.readyState)&&b._onAfterRNScriptLoaded()});this._headElement&&this._headElement.appendChild(this._rnScript)}},_onAfterRNScriptLoaded:function(){this._rnScriptLoaded=!0;this._loadWidgetsIfReady();_throttler.subscribeToDataEvents()},_onRNScriptIgnored:function(){this._rnScriptIgnored=!0;this._loadWidgetsIfReady();_throttler.subscribeToDataEvents()},_loadWidget:function(a){var b=this._widgetLoaded,c=this._cacheDomain||this._domain,
d={widgetData:a,instance:this},f=this._dataFields,e={},h={};a.custom_fields&&(e=RightNow.lang.JSON.parse(a.custom_fields));for(var g in f)0===g.indexOf("contacts.")||0===g.indexOf("incidents.")?h[g]=f[g]:e[g]=f[g];for(g in f)if(0===g.indexOf("incidents.prod")&&a.p&&(a.p=f[g]),0===g.indexOf("incidents.cat")&&a.c)a.c=f[g];a.custom_fields=RightNow.lang.JSON.stringify(e);a.common_fields=RightNow.lang.JSON.stringify(h);RightNow.Client.Event.evt_widgetLoaded.subscribe(b,d);RightNow.Client.Controller.addComponent(a,
"//"+c+"/ci/ws/get")},_processExtraWidgetData:function(a){a.visitor_id=this._visitorId;a.ee_session_id=this._sessionId;a.ee_id=ATGSvcs.cfg("uoid");a.estara_id=window.eStara_fsguid},_widgetLoaded:function(a,b,c){if(c.instance._matchEventForWidget(b,c.widgetData)){var a=c.instance._chatOffered,b=c.instance._chatAccepted,d=c.instance._chatRejected;if(c.widgetData.type===c.instance.WTYPE.SPAC){var f=c.instance._findSpacWidget(c.widgetData.instance_id);f&&(f.state=c.instance.WIDGET_STATE.LOADED);RightNow.Client.Event.evt_chatOffered.subscribe(a,
c);RightNow.Client.Event.evt_chatAccepted.subscribe(b,c);RightNow.Client.Event.evt_chatRejected.subscribe(d,c)}else c.widgetData.type===c.instance.WTYPE.SCCL&&(RightNow.Client.Event.evt_conditionalChatLinkOffered.subscribe(a,c),RightNow.Client.Event.evt_conditionalChatLinkClicked.subscribe(b,c));c.instance._processExtraWidgetData(window[c.widgetData.instance_id].attrs)}},_chatOffered:function(a,b,c){c=c||this;if(c.instance._matchEventForWidget(b,c.widgetData)){if(c.widgetData.type===c.instance.WTYPE.SPAC&&
(a=c.instance._findSpacWidget(c.widgetData.instance_id)))a.state=c.instance.WIDGET_STATE.OFFERED;c.instance._sendEventData(c.instance.ATYPE.OFFER,c.widgetData);c.instance._logExternal(c.instance.ATYPE.OFFER,c.widgetData)}},_chatAccepted:function(a,b,c){c=c||this;c.instance._matchEventForWidget(b,c.widgetData)&&(c.instance._sendEventData(c.instance.ATYPE.ACCEPT,c.widgetData),c.instance._logExternal(c.instance.ATYPE.ACCEPT,c.widgetData))},_chatRejected:function(a,b,c){c.instance._matchEventForWidget(b,
c.widgetData)&&c.instance._logExternal(c.instance.ATYPE.REJECT,c.widgetData)},_matchEventForWidget:function(a,b){var c=a[0].data.id||a[0].id;return(a[0].data.name||a[0].name)===b.module&&c===b.instance_id},_logExternal:function(a,b){if(window.ATGSvcs){var c;b.type===this.WTYPE.SPAC?c="RNSPChat":b.type===this.WTYPE.SCCL?c="RNSCChat":b.vstype===this.WTYPE.VSPAC?c="rnpchat":b.vstype===this.WTYPE.VSCCL&&(c="rncchat");var d;a===this.ATYPE.SUPPRESS?d="suppressed":a===this.ATYPE.OFFER?d="offered":a===this.ATYPE.ACCEPT?
d="accepted":a===this.ATYPE.REJECT&&(d="declined");c&&d&&window.ATGSvcs.ee.logInvite({id:b.widget_id,type:c,timestamp:+new Date,state:d,ruleid:b.ruleId})}},_clone:function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}};VisitorService.Rules.Throttler=function(){this._widgets={}};
VisitorService.Rules.Throttler.prototype={subscribeToDataEvents:function(){"undefined"!==typeof RightNow.Event&&(RightNow.Event.subscribe("evt_chatQueueRequest",this.onBeforeDataRequest,this),RightNow.Event.subscribe("evt_chatQueueResponse",this.onQueueReceived,this));"undefined"!==typeof RightNow.Client&&"undefined"!==typeof RightNow.Client.Event&&(RightNow.Client.Event.evt_beforeDataRequest.subscribe(this.onBeforeDataRequest,this),RightNow.Client.Event.evt_chatAvailabilityResponse||(RightNow.Client.Event.evt_chatAvailabilityResponse=
new RightNow.util.CustomEvent("evt_chatAvailabilityResponse")),RightNow.Client.Event.evt_chatAvailabilityResponse.subscribe(this.onChatAvailabilityResponse,_throttler),RightNow.Client.Event.evt_conditionalChatLinkAvailabilityResponse||(RightNow.Client.Event.evt_conditionalChatLinkAvailabilityResponse=new RightNow.util.CustomEvent("evt_conditionalChatLinkAvailabilityResponse")),RightNow.Client.Event.evt_conditionalChatLinkAvailabilityResponse.subscribe(this.onConditionalChatLinkAvailabilityResponse,
_throttler))},onBeforeDataRequest:function(a,b){var c=!0,d=Math.round((new Date).getTime()/1E3),f=b[0].w_id||b[0].id,e=_throttler._widgets[f];if(void 0!==e&&"object"===typeof e){var h=e.firstPollTime,g=e.lastPollTime,k=parseInt(e.lastReportedWaitTime,10),l=b[0].name||b[0].data.name,l=l.charAt(0).toLowerCase()+l.substring(1);if(void 0!==h&&"number"===typeof h&&void 0!==g&&"number"===typeof g&&void 0!==k&&"number"===typeof k){var m=e.isThrottled,n=RightNow.Client||RightNow;if(3600>g-h){if(60<k&&(c=
d>=g+k/2,!1===c&&!0!==m)){var j=(new Date(1E3*h)).toString(),g=(new Date(1E3*g)).toString(),j={widgetId:f,firstPollTime:j.toString(),lastPollTime:g};n.ActionCapture.instrumentation(l,"throttle-start","info",1E3*(k/2),j);e.isThrottled=!0}}else c=!1;!0===c&&(e.lastPollTime=d,!0===m&&(j=(new Date(1E3*h)).toString(),g=(new Date(1E3*d)).toString(),j={widgetId:f,firstPollTime:j,lastPollTime:g},n.ActionCapture.instrumentation(l,"throttle-end","info",1E3*(k/2),j),e.isThrottled=!1))}}else _throttler._widgets[f]=
{firstPollTime:d,lastPollTime:d,lastReportedWaitTime:0};return c},onQueueReceived:function(a,b){var c=b[0].w_id||b[0].id;if(this._widgets[b[0].data.w_id])this._widgets[b[0].data.w_id].lastReportedWaitTime=b[0].response.stats.expectedWaitSeconds;else{var d=Math.round((new Date).getTime()/1E3);_throttler._widgets[c]={firstPollTime:d,lastPollTime:d,lastReportedWaitTime:0}}},onChatAvailabilityResponse:function(a,b,c){var a=b[0].w_id||b[0].id,d=c._widgets[a];void 0!==d&&"object"===typeof d&&(c._widgets[a].lastReportedWaitTime=
parseInt(b[0].data.expectedWaitSeconds,10))},onConditionalChatLinkAvailabilityResponse:function(a,b,c){a=b[0].data;if(a.stats){var b=b[0].w_id||b[0].id,d=c._widgets[b];void 0!==d&&"object"===typeof d&&(c._widgets[b].lastReportedWaitTime=parseInt(a.stats.expectedWaitSeconds,10))}}};var _adptr=new VisitorService.Rules.Adapter,_throttler=new VisitorService.Rules.Throttler;document.addEventListener("DOMContentLoaded",function(){_adptr._domContentLoaded=!0;_adptr._loadWidgetsIfReady()});
if(/^((?!chrome).)*safari/i.test(navigator.userAgent))var _timer=setInterval(function(){/loaded|complete/.test(document.readyState)&&(clearInterval(_timer),_adptr._loadWidgetsIfReady())},10);else"complete"!==document.readyState&&"loaded"!==document.readyState?document.onreadystatechange=function(){("complete"===document.readyState||"loaded"===document.readyState)&&_adptr._loadWidgetsIfReady()}:_adptr._loadWidgetsIfReady();
