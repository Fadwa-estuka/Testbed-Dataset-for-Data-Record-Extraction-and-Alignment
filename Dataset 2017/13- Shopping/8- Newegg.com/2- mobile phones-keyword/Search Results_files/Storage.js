NEG.Module('Biz.Storage', function (require) {var NeweggKey = "NV_NeweggLocalStorage";var localStorageConfig = {'AutoHistory': { 'name': 'w1', 'exp': 30 * 24 * 3600 * 1000 },'ItemSearchKeywords': { 'name': 'w2', 'exp': 30 * 24 * 3600 * 1000 },'ItemViewed': { 'name': 'w3', 'exp': 30 * 24 * 3600 * 1000 },'ItemInnerSearchKeywords': { 'name': 'w4', 'exp': 30 * 24 * 3600 * 1000 },'ItemOrdered': { 'name': 'w5', 'exp': 30 * 24 * 3600 * 1000 },'EnhanceCrossSell': { 'name': 'w6', 'exp': 30 * 24 * 3600 * 1000 },'Compare': { 'name': 'w7', 'exp': 30 * 24 * 3600 * 1000 },'ForumRecentlyViewed': { 'name': 'w56', 'exp': 30 * 24 * 3600 * 1000 },'IsPopupSelectorInHomePage': { 'name': 'w59', 'exp': 1000 * 24 * 3600 * 1000 },'BlackOut': { 'name': 'w40', 'exp': 1000 * 24 * 3600 * 1000 },'VolumeDissountCollapsibleState': { 'name': 'w8', 'exp': 30 * 24 * 3600 * 1000 }};var win = window,doc = win.document,localStorageName = 'localStorage',scriptTag = 'script';function isSupportLocalStorage() {try {localStorageName in win && win[localStorageName] && win[localStorageName].setItem("s_rwt", "t");return true;} catch(err) {return false;}}function constructor() {var me = arguments.callee;if (!(this instanceof me)) {return new me();}"use strict";var api = {getConfig: function(key) {},setItem: function(key, val) {},getItem: function(key, defaultVal) {},removeItem: function(key) {},hasItem: function(key) {},getAll: function() {},forEach: function() {},serialize: function(val) {try {return JSON.stringify(val);} catch(e) {return undefined;}},deserialize: function(val) {if (typeof val != 'string') {return {};}try {return JSON.parse(val);} catch(e) {return {};}}};var mappingKey = function(key) {if (!localStorageConfig) {throw "config error";}if (localStorageConfig[key]) {return localStorageConfig[key];}for (var k in localStorageConfig) {if (localStorageConfig[k] && localStorageConfig[k].name === key) {return localStorageConfig[k];}}throw "no key[" + key + "] in config, please check";};if (isSupportLocalStorage()) {var storage = win[localStorageName];var getConfig = function (key) {var config = mappingKey(key);return {'subKey': config.name,'storage': storage.getItem(NeweggKey) ? api.deserialize(storage.getItem(NeweggKey)) : {},'exp': config.exp};};api.setItem = function(key, val) {var config = getConfig(key);var subobj = config.storage[config.subKey] === undefined ? {} : config.storage[config.subKey];if (val === undefined) {subobj = null;api.removeItem(key);return;}subobj.value = api.serialize(val);subobj.date = new Date().getTime();config.storage[config.subKey] = subobj;storage.setItem(NeweggKey, api.serialize(config.storage));return val;};api.getItem = function(key, defaultVal) {var config = getConfig(key);var subobj = config.storage[config.subKey] === undefined ? {} : config.storage[config.subKey];if (subobj === undefined) {return defaultVal;}if (new Date().getTime() - subobj.date > config.exp) {api.removeItem(key);return defaultVal;}return subobj.value === undefined ? defaultVal : api.deserialize(subobj.value);};api.removeItem = function(key) {var config = getConfig(key);delete config.storage[config.subKey];storage.setItem(NeweggKey, api.serialize(config.storage));};api.getAll = function() {var result = {};api.forEach(function(key, val) {result[key] = val;});return result;};api.forEach = function(callBack) {var obj = api.deserialize(storage.getItem(NeweggKey));if (obj) {for (var key in obj) {callBack(key, api.getItem(key));}}};} else if (doc.documentElement.addBehavior) {var storageOwner,storageContainer;try {storageContainer = new ActiveXObject('htmlfile');storageContainer.open();storageContainer.write('<' + scriptTag + '>document.w=window</' + scriptTag + '><iframe src="/favicon.ico"></iframe>');storageContainer.close();storageOwner = storageContainer.w.frames[0].document;storage = storageOwner.createElement('div');} catch(e) {storage = doc.createElement('div');storageOwner = doc.body;}var withIEStorage = function(storeFunction) {return function() {var args = Array.prototype.slice.call(arguments, 0);args.unshift(storage);storageOwner.appendChild(storage);storage.addBehavior('#default#userData');storage.load(localStorageName);var result = storeFunction.apply(api, args);storageOwner.removeChild(storage);return result;};};var forbiddenCharsRegex = new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]", "g");var ieKeyFix = function(key) {return key.replace(/^d/, '___$&').replace(forbiddenCharsRegex, '___');};api.setItem = withIEStorage(function(storage, key, val) {key = ieKeyFix(key);if (val === undefined) {return api.remove(key);}storage.setAttribute(key, api.serialize(val));storage.save(localStorageName);return val;});api.getItem = withIEStorage(function(storage, key, defaultVal) {key = ieKeyFix(key);var val = api.deserialize(storage.getAttribute(key));return (val === undefined ? defaultVal : val);});api.removeItem = withIEStorage(function(storage, key) {key = ieKeyFix(key);storage.removeAttribute(key);storage.save(localStorageName);});api.getAll = function(storage) {var ret = {};api.forEach(function(key, val) {ret[key] = val;});return ret;};api.forEach = withIEStorage(function(storage, callback) {var attributes = storage.XMLDocument.documentElement.attributes;for (var i = 0, attr; attr = attributes[i]; ++i) {callback(attr.name, api.deserialize(storage.getAttribute(attr.name)));}});}NEG.merge(this, api);}function decorator() {var lstorage = constructor();function saveLS2Cookie() {var storage = win[localStorageName];var neweggLS = storage.getItem(NeweggKey);if (String.isNullOrEmpty(neweggLS)) {return;}var expireDate = new Date();expireDate.setFullYear(expireDate.getFullYear() + 3);document.cookie = "NV%5FLOCALSTORAGE=" + neweggLS + ";expires=" + expireDate.toGMTString() + ";path=/";}function getCookie(name) {var aCookie = document.cookie.split(";");for (var i = 0; i < aCookie.length; i++) {var aCrumb = aCookie[i].split("=");if (name == decodeURIComponent(aCrumb[0].trim()))return unescape(aCrumb[1]);}return null;}function setCookie2LS() {var cookieValue = getCookie(Web.StateManager.Cookies.Name.LS);if (String.isNullOrEmpty(cookieValue)) {saveLS2Cookie();return;}if (isSupportLocalStorage()) {var storage = win[localStorageName];storage.setItem(NeweggKey, cookieValue);}}var decorate = {getItem: function (key, defaultVal) {setCookie2LS();var value = lstorage.getItem(key);if (value === undefined) {saveLS2Cookie();return defaultVal;}saveLS2Cookie();return value;},setItem: function (key, val) {setCookie2LS();lstorage.setItem(key, val);saveLS2Cookie();}};var newStorage = constructor();NEG.merge(newStorage, decorate);return newStorage;}return decorator();})