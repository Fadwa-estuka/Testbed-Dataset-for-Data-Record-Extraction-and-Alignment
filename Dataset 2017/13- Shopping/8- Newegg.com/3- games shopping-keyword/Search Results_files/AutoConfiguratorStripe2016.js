usingNamespace("Biz.Common")["AutoConfiguratorStripe"] = (function () {var viewType;var getStandardJsonFromSelectedData = function (selectedData) {var jsonData = [];for (var i = 0; i < selectedData.length; i++) {var key = selectedData[i].stripe.toLowerCase();var value = selectedData[i].value.value;jsonData.push({ "stripeKey": key, "stripeValue": value });}return jsonData;};var getUrlParamFromSelectedVehicle = function (selectedVehicle) {var returnString = "";if (selectedVehicle && selectedVehicle.length) {for (var i = 0; i < selectedVehicle.length - 1; i++) {returnString += selectedVehicle[i].stripeKey + "=" + encodeURIComponent(selectedVehicle[i].stripeValue) + "&";}var lastStripe = selectedVehicle[selectedVehicle.length - 1];returnString += lastStripe.stripeKey + "=" + encodeURIComponent(lastStripe.stripeValue);}return returnString;};var removeUselessDataForProductDetailPage = function (data) {var newData = [];if (viewType == 1) {for (var i = 0; i < data.length; i++) {if (data[i] != Web.Lang.anyTrim && data[i] != Web.Lang.anyEngine) {newData.push(data[i]);}}return newData;}return data;};var getDropdownContent = function (data,isEngine) {content = removeUselessDataForProductDetailPage(data);if (isEngine) {var liString = "<ol class=\"auto-filter-menu-list has-4cols\">";}else {var liString = "<ol class=\"auto-filter-menu-list\">";}for (var i = 0; i < content.length; i++) {liString += "<li neg-sp-data-value=\"" + content[i] + "\">" + content[i] + "</li>"}liString += "</ol>";return liString;};var showYearErrorMessage = function () {var $yearErrorMessage = jQuery("#year-error-message");$yearErrorMessage.fadeIn();jQuery(".form-text.auto-filter-input-year").addClass("error");};var hideYearErrorMessage = function () {var $yearErrorMessage = jQuery("#year-error-message");$yearErrorMessage.fadeOut();jQuery(".form-text.auto-filter-input-year").removeClass("error");};var validateYearLength = function () {hideYearErrorMessage();var $yearInput = jQuery(".form-text.auto-filter-input-year");var $nextButton = jQuery("[neg-sp-data-key=\"Year\"] .btn.btn-secondary");if (!isNaN($yearInput.val()) && $yearInput.val().length == 4 && $yearInput.val().indexOf(' ') < 0) {$nextButton.removeAttr("disabled");}else {$nextButton.attr("disabled", "disabled");}};var handleKeyup = function (e) {if (jQuery(".form-text.auto-filter-input-year").val().length == 4 && e.keyCode == 13) {jQuery(".btn.btn-secondary")[0].click();}else {validateYearLength();}};var handleKeypress = function (e) {var explorer = navigator.userAgent;if (explorer.indexOf("Firefox") >= 0) {if (e.keyCode == 8) {return true;}var keyCode = e.charCode;}else {var keyCode = e.keyCode;}if ((keyCode >= 48 && keyCode <= 57)) {return true;}else {return false;}};var fillAllDropdownsFromAjax = function (selectedVehicle) {var ajaxPage = "Common/Ajax/AutoConfigurator2016.aspx";jQuery.ajax({url: Web.Config.Environment.Url.WWW + ajaxPage + "?datatype=1&" + getUrlParamFromSelectedVehicle(selectedVehicle),async: false}).done(function (dataStr) {try {var data = JSON.parse(dataStr);} catch (ex) {}if (data) {var dropdownData = data.DropdownData;if (dropdownData.length > 0) {var dropdownContent = getDropdownContent(dropdownData[0],false);var $makeStripeDropdown = jQuery(".menu-box-menu.make");$makeStripeDropdown.html(dropdownContent);}if (dropdownData.length > 1) {var dropdownContent = getDropdownContent(dropdownData[1],false);var $modelStripeDropdown = jQuery(".menu-box-menu.model");$modelStripeDropdown.html(dropdownContent);}if (dropdownData.length > 2) {var dropdownContent = getDropdownContent(dropdownData[2],false);var $trimStripeDropdown = jQuery(".menu-box-menu.trim");$trimStripeDropdown.html(dropdownContent);}if (dropdownData.length > 3) {var dropdownContent = getDropdownContent(dropdownData[3],true);var $engineStripeDropdown = jQuery(".menu-box-menu.engine");$engineStripeDropdown.html(dropdownContent);}var selectedVehicle = data.SelectedVehicle;if (selectedVehicle) {if (selectedVehicle.year) {var year = parseInt(selectedVehicle.year);var startYear = parseInt(jQuery("#start-year").val());var endYear = parseInt(jQuery("#end-year").val());if (year >= startYear && year <= endYear) {jQuery(".form-text.auto-filter-input-year").val(year);jQuery("[neg-sp-data-defaultstrip='Year']").html(year);jQuery(".btn.btn-secondary").attr("neg-sp-data-value", year);}}if (selectedVehicle.make) {var make = selectedVehicle.make;jQuery(".menu-box-menu.make [neg-sp-data-value='" + make + "']").addClass("selected");}if (selectedVehicle.model) {var model = selectedVehicle.model;jQuery(".menu-box-menu.model [neg-sp-data-value='" + model + "']").addClass("selected");}if (selectedVehicle.trim) {var trim = selectedVehicle.trim;jQuery(".menu-box-menu.trim [neg-sp-data-value='" + trim + "']").addClass("selected");} else {jQuery(".menu-box-menu.trim [neg-sp-data-value='" + Web.Lang.anyTrim + "']").addClass("selected");}if (selectedVehicle.engine) {var engine = selectedVehicle.engine;jQuery(".menu-box-menu.engine [neg-sp-data-value='" + engine + "']").addClass("selected");} else {jQuery(".menu-box-menu.engine [neg-sp-data-value='" + Web.Lang.anyEngine + "']").addClass("selected");}}}});};var getArrayStringFromJsonString = function (jsonString) {return jsonString.replace(/\[|\]|"/g, "");};var getJsonStringFromArrayString = function (arrayString) {arrayString = '["' + arrayString + '"]';return arrayString.replace(/,/g, '","');};var resetYearStripe = function (autoShowYear) {var $yearInput = jQuery(".form-text.auto-filter-input-year");$yearInput.val("");jQuery("[neg-sp-data-key=\"Year\"] .auto-filter-choice-name").html(Web.Lang.autoYear);hideYearErrorMessage();if (autoShowYear) {jQuery("[neg-sp-data-key=\"Year\"] .auto-filter-choice-name").click();}};var getVuidsAjax = function (urlPara) {var ajaxPage = "Common/Ajax/AutoConfigurator2016.aspx";var vuids;jQuery.ajax({url: Web.Config.Environment.Url.WWW + ajaxPage + "?datatype=2&" + urlPara,async: false}).done(function (dataStr) {try {vuids = JSON.parse(dataStr);}catch (ex) { }});return vuids;};return {init: function () {NEG.run(function (require) {var stripePicker = require("NEG.Widget.AutoConfigurator2016");var storage = require("Biz.Storage");var enableSearch = 0;viewType = parseInt(jQuery("#view-type").val());var trimClicked = 0;var alreadySearched = 0;var $yearInput = jQuery(".form-text.auto-filter-input-year");$yearInput.on("focus", hideYearErrorMessage);$yearInput.on("keypress", handleKeypress);$yearInput.on("keyup", handleKeyup);jQuery(".auto-filters").find("[neg-sp-data-key='Year']").on("mouseenter", function () {setTimeout(function () {$yearInput.focus();}, 50);});jQuery(".auto-filters").find("[neg-sp-data-key='Year']").on("mouseleave", function () {$yearInput.blur();});if (viewType == 1) {jQuery(".filter-group.trim").attr("neg-sp-data-autoexpand", "true");jQuery(".auto-filter.auto-configurator:first").addClass("warning-border");trimClicked = 1;}var container = stripePicker({stripeSelector: ".auto-filters .menu-box.auto-filter-cell",contentSelector: ".auto-filters .menu-box-menu",buttonGoSelector: ".btn.btn-mini.btn-alt",strileDisableClass: "is-disabled",buttonNextSelector: ".btn.btn-secondary",enableMouseLeave: true,processData: function (selectedData, preStripe, nextStripe) {var urlPara = selectedData.toURLPara();var $nextStripe = jQuery(nextStripe.content);for (var i = 0; i < selectedData.length; i++) {jQuery(selectedData[i].target).parents(".auto-filter-menu-list").find(".selected").removeClass("selected");jQuery(selectedData[i].target).parent().addClass("selected");}if (selectedData.length == 4) {trimClicked = 1;} else {trimClicked = 0;}if (selectedData) {if (selectedData[3] && selectedData[3].value.value == Web.Lang.anyTrim) {jQuery(".menu-box-menu.engine .auto-filter-menu-list.has-4cols").html("");jQuery("[neg-sp-data-key=\"Trim\"] .auto-filter-choice-name").html(Web.Lang.autoTrim);jQuery(".auto-filters").find("[neg-sp-data-key=\"Engine\"]").addClass("force-disabled");jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", "");return false;}else {jQuery(".auto-filters").find("[neg-sp-data-key=\"Engine\"]").removeClass("force-disabled");}if (selectedData[4] && selectedData[4].value.value == Web.Lang.anyEngine) {jQuery("[neg-sp-data-key=\"Engine\"] .auto-filter-choice-name").html(Web.Lang.autoEngine);jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", "");return false;}}var ajaxPage = "Common/Ajax/AutoConfigurator2016.aspx";jQuery.ajax({url: Web.Config.Environment.Url.WWW + ajaxPage + "?datatype=0&" + urlPara,async: false}).done(function (dataStr) {try {var data = JSON.parse(dataStr);var vuidsList;if (data.length == 1 && data[0] == Web.Lang.anyEngine || data.length == 0) {jQuery(".auto-filters").find("[neg-sp-data-key=\"Engine\"]").addClass("force-disabled");if ((selectedData && selectedData.length >= 3)) {vuidsList = getVuidsAjax(urlPara);if (vuidsList && vuidsList.length == 1) {enableSearch = 1;jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", JSON.stringify(vuidsList));jQuery(".btn.btn-mini.btn-alt").removeAttr("disabled");if (viewType == 1) {var jsonData = getStandardJsonFromSelectedData(selectedData);Biz.Common.AutoConfiguratorStripe.search(jsonData, storage);alreadySearched = 1;}}else {enableSearch = 0;}}}else {enableSearch = 0;jQuery(".auto-filters").find("[neg-sp-data-key=\"Engine\"]").removeClass("force-disabled");}if (data.length) {if ($nextStripe.length && selectedData.length && selectedData.length < 5) {var dropdownContent = getDropdownContent(data);$nextStripe.html(dropdownContent);if ($nextStripe.hasClass("trim")) {jQuery(".filter-dropdown.trim [neg-sp-data-value='" + Web.Lang.anyTrim + "']").addClass("selected");}if ($nextStripe.hasClass("engine")) {jQuery(".filter-dropdown.engine [neg-sp-data-value='" + Web.Lang.anyEngine + "']").addClass("selected");}}if (selectedData.length == 5) {enableSearch = 1;jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", dataStr);}else if (!enableSearch) {jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", "");}if (selectedData.length < 4) {jQuery(".auto-filters").find("[neg-sp-data-key=\"Engine\"]").addClass("force-disabled");}}} catch (ex) {}});return true;},go: function (e, selectedData) {if (selectedData[3] && selectedData[3].value.value == Web.Lang.anyTrim) {selectedData.splice(3, 2);}if (selectedData[4] && selectedData[4].value.value == Web.Lang.anyEngine) {selectedData.splice(4, 1);}var jsonData = getStandardJsonFromSelectedData(selectedData);Biz.Common.AutoConfiguratorStripe.search(jsonData, storage);},completed: function () {if (trimClicked) {var $engineFilter = jQuery(".filter-group.engine .filter-wrap");var trimTitle = jQuery(".filter-group.trim .filter-list-title").html();if ($engineFilter.click && trimTitle != Web.Lang.autoTrim) {$engineFilter.click();trimClicked = 0;}}var $searchButton = jQuery(".auto-filters .btn.btn-mini.btn-alt");var $garage = jQuery(".filter-call-to-action li.filter-garage");if ($garage.css('display') == "none") {$searchButton.addClass("need-radius");}else {$searchButton.removeClass("need-radius");}if (viewType == 1) {if (enableSearch) {jQuery(".btn.btn-mini.btn-alt").removeAttr("disabled");if (!alreadySearched) {jQuery(".btn.btn-mini.btn-alt").click();}}else {jQuery(".btn.btn-mini.btn-alt").attr("disabled","disable");}}else {jQuery(".btn.btn-mini.btn-alt").removeAttr("disabled");}},validateData: function (step) {if (step == 0) {var year = parseInt(jQuery(".form-text.auto-filter-input-year").val());if (isNaN(year)) {showYearErrorMessage();return false;}var startYear = parseInt(jQuery("#start-year").val());var endYear = parseInt(jQuery("#end-year").val());if (year < startYear || year > endYear) {showYearErrorMessage();return false;}jQuery(".btn.btn-secondary").attr("neg-sp-data-value", year);}return true;}});NEG(document).on("ConfiguratorFill", function (target, data) {jQuery(".auto-filters .btn.btn-mini.btn-alt").attr("disabled","disabled");if (data.selectedVehicle && data.selectedVehicle.transno) {jQuery("#transno").val(data.selectedVehicle.transno);}data.selectedVehicle = Biz.Common.AutoConfiguratorStripe.getStandardJsonFormSimpleFormat(data.selectedVehicle);jQuery(".auto-filters .menu-box.auto-filter-cell").removeClass("is-active");if (data.selectedVehicle && data.selectedVehicle.length) {fillAllDropdownsFromAjax(data.selectedVehicle);} else {resetYearStripe(data.autoShowYear);}container.Refill(data.selectedVehicle);validateYearLength();});try {var selectedVehicle = JSON.parse(jQuery("#selected-vehicle").val());} catch (ex) { }if (selectedVehicle) {NEG(document).trigger("ConfiguratorFill", { selectedVehicle: selectedVehicle, autoShowYear: false });}});},getStandardJsonFormSimpleFormat: function (simpleFormat) {var newFormat = [];if (simpleFormat) {if (simpleFormat.year && simpleFormat.make && simpleFormat.model) {var year = { "stripeKey": "Year", "stripeValue": simpleFormat.year };var make = { "stripeKey": "Make", "stripeValue": simpleFormat.make };var model = { "stripeKey": "Model", "stripeValue": simpleFormat.model };newFormat.push(year, make, model);if (simpleFormat.trim) {var trim = { "stripeKey": "Trim", "stripeValue": simpleFormat.trim };newFormat.push(trim);}if (simpleFormat.engine) {var engine = { "stripeKey": "Engine", "stripeValue": simpleFormat.engine };newFormat.push(engine);}}}return newFormat;},search: function (jsonData, storage) {var newUrlPrefix = jQuery("#new-url-prefix").val();var newUrl = (newUrlPrefix.indexOf("?") >= 0) ? (newUrlPrefix + "&") : (newUrlPrefix + "?");var vuid = jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value");var localStorageValue = '{"transno":"' + jQuery("#transno").val() + '",';for (var i = 0; i < jsonData.length; i++) {var key = jsonData[i].stripeKey.toLowerCase();var value = jsonData[i].stripeValue;if (!vuid || vuid.length <= 0) {newUrl += key + "=" + encodeURIComponent(value);if (i < jsonData.length - 1) {newUrl += "&";}}localStorageValue += '"' + key + '":' + '"' + value + '"';if (i < jsonData.length - 1) {localStorageValue += ",";}}if (vuid && vuid.length > 0) {newUrl += "vuid=" + getArrayStringFromJsonString(vuid);localStorageValue += ', "vuids": ' + vuid;}localStorageValue += "}";storage.setItem("AutoHistory", localStorageValue);if (viewType == 1) {NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["FILTER_MATCHED"], JSON.parse(localStorageValue));} else {location.href = newUrl;}}};})();var autoConfiguratorGarageEventTarget = {};var autoConfiguratorGarageEvents = {"CREATED": "Biz_Common_AutoConfiguratorGarage_Created","ITEM_DELETED": "Biz_Common_AutoConfiguratorGarage_Item_Deleted","ITEM_SELECTED": "Biz_Common_AutoConfiguratorGarage_Item_Selected","NEW_VEHICLE": "Biz_Common_AutoConfiguratorGarage_New_Vehicle","MOUSE_ENTER": "Biz_Common_AutoConfiguratorGarage_Mouse_Enter"};usingNamespace("Biz.Common")["AutoConfiguratorGarage"] = (function () {var maskBuilder;var overview;var overviewPopup;var garages = [];var optionIndexData = [];var showNewVehicleUI = function (autoShowYear) {NEG(autoConfiguratorGarageEventTarget).trigger(autoConfiguratorGarageEvents["NEW_VEHICLE"], autoShowYear);overview && overview.hide();};var getGarageDescription = function (ga) {if (ga) {var tmp = (ga.year || '') + ' ' + (ga.make || '') + ' ' + (ga.model || '');if (ga.trim) {tmp += ' ' + ga.trim;}if (ga.engine) {tmp += ' ' + ga.engine;}return { key: tmp, value: tmp };}return null;};var GarageViewModel = function () {var filterGarage = jQuery('<div class="menu-box auto-filter-garage"></div>');var vehicleCount = jQuery('<div class="menu-box-trigger auto-filter-garage-title"><i class="auto-filter-garage-icon fa fa-car"></i><span class="auto-filter-garage-text">Your Garage:</span><span class="auto-filter-garage-num">0</span></div>');var filterDropdownWarpper = jQuery('<div class="menu-box-menu" style="z-index:29"></div>');var dropdownTitle = jQuery('<div class="auto-filter-cars-top"><span class="auto-filter-cars-num"><strong>0</strong> Vehicles</span></div>');var dropdownSelection = jQuery('<ul class="auto-filter-cars"><ul>');var dropdownAction = jQuery('<div class="auto-filter-menu-buttonarea"><button type="button" class="btn btn-mini btn-secondary has-icon-left fa-plus">' + Web.Lang.addNewVehicle + '</button></div>');filterDropdownWarpper.append(dropdownTitle);filterDropdownWarpper.append(dropdownSelection);filterDropdownWarpper.append(dropdownAction);filterGarage.append(vehicleCount);filterGarage.append(filterDropdownWarpper);filterGarage.mouseenter(function () {var $self = jQuery(this);if (dropdownSelection.find("li").length > 0) {$self.addClass("is-active");NEG(autoConfiguratorGarageEventTarget).on(autoConfiguratorGarageEvents["MOUSE_ENTER"], function () {$self.removeClass("is-active");});}});filterGarage.mouseleave(function () {NEG(autoConfiguratorGarageEventTarget).trigger(autoConfiguratorGarageEvents["MOUSE_ENTER"]);});dropdownAction.find(".btn.btn-mini.btn-secondary.has-icon-left.fa-plus").click(function () {showNewVehicleUI(true);});var refreshGarage = function (selectOptions, selectIndex) {if (selectOptions && selectOptions.length > 0) {filterGarage.show();var len = selectOptions.length;var tempStr = '';for (var i = 0; i < len; i++) {var opt = getGarageDescription(selectOptions[i]);var optData = optionIndexData[selectOptions[i].num];var mainText = optData.year + ' ' + optData.make;var subText = ' ' + (optData.model || '') + ' ' + (optData.trim || '') + ' ' + (optData.engine || '');if (selectIndex == selectOptions[i].num) {var popup = '<div class="centerPopup-source" id="AutoRemove_' + selectOptions[i].num + '_Content" >'+ '<div class="centerPopup-title"><h2>Remove this Vehicle?</h2></div><div class="centerPopup-normal-content"><p class="content"><strong>'+mainText+'</strong>'+subText+'</p></div><div class="centerPopup-bottom">'+ '<div class="centerPopup-button-area"><button type="button" class="btn btn-tertiary centerPopup-trigger-close">' + Web.Lang.no + '</button><button type="button" class="autoparts btn btn-primary">' + Web.Lang.yes + '</button></div></div></div>';tempStr += '<li class="is-current" num="' + selectOptions[i].num + '"><a href="javascript:void(0)" class="auto-filter-car-name">' + opt.value + '</a><i id="AutoRemove_' + selectOptions[i].num + '" class="fa auto-filter-car-remove open-popup"></i>' + popup + '</li>';} else {var popup = '<div class="centerPopup-source" id="AutoRemove_' + selectOptions[i].num + '_Content" >'+ '<div class="centerPopup-title"><h2>Remove this Vehicle?</h2></div><div class="centerPopup-normal-content"><p class="content"><strong>'+mainText+'</strong>'+subText+'</p></div><div class="centerPopup-bottom">'+ '<div class="centerPopup-button-area"><button type="button" class="btn btn-tertiary centerPopup-trigger-close">' + Web.Lang.no + '</button><button type="button" class="autoparts btn btn-primary">' + Web.Lang.yes + '</button></div></div></div>';tempStr += '<li num="' + selectOptions[i].num + '"><a href="javascript:void(0)" class="auto-filter-car-name">' + opt.value + '</a><i id="AutoRemove_' + selectOptions[i].num + '" class="fa auto-filter-car-remove open-popup"></i>' + popup + '</li>';}}var temp = jQuery(tempStr);temp.find('i').each(function () {var $self = jQuery(this);var theOpt = jQuery(this).parent();var num = theOpt.attr("num");var optData = optionIndexData[num];var flag = true;$self.parent().click(function () {if (flag) {var targets = function () {var tempArray = [];for (var i = 0; i < garages.length; i++) {garages[i].dropdownDom.find('li[num=' + num + ']').each(function () {tempArray.push(this);});}return jQuery(tempArray);}();targets.addClass("selected");targets.find("input[type='radio']").attr("checked", true);targets.each(function () {jQuery(this).siblings().removeClass("selected").find("input[type='radio']").attr("checked", false);});NEG(autoConfiguratorGarageEventTarget).trigger(autoConfiguratorGarageEvents["ITEM_SELECTED"], { target: theOpt, data: optData });}flag = true;});$self.off('click').click(function () {flag = false;var $this = jQuery(this);$this.on("shown.ng.popup", function (e) {var $this = jQuery(this);var theOpt = jQuery(this).parent();var num = theOpt.attr("num");var optData = optionIndexData[num];jQuery('.centerPopup.is-current .autoparts.btn.btn-primary').off('click').click(function () {NEG(autoConfiguratorGarageEventTarget).trigger(autoConfiguratorGarageEvents["ITEM_DELETED"], { target: theOpt, data: optData });jQuery(this).parent().find('.btn.btn-tertiary.centerPopup-trigger-close').click();});});});});dropdownSelection.empty().append(temp.clone(true));} else {filterGarage.hide();}};var refreshVehicleCount = function (v) {vehicleCount.find('.auto-filter-garage-num').html(v);dropdownTitle.find('strong').html(v);};var showConfirm = function (msg, operator) {removePopup.find('.autoParts .centerPopup-button-area .button-primary').off("click").click(function () {operator && operator.yes && operator.yes();overviewPopup.hide();});};var hideConfirm = function () {removePopup.hide();};return {dom: filterGarage,filterDropdownWarpper: filterDropdownWarpper,dropdownDom: dropdownSelection,refreshGarage: refreshGarage,refreshVehicleCount: refreshVehicleCount};};return {on: function (eventName, fn) {var eName = autoConfiguratorGarageEvents[eventName];if (eName && fn) {NEG(autoConfiguratorGarageEventTarget).on(eName, fn);}},off: function (eventName, fn) {var eName = autoConfiguratorGarageEvents[eventName];if (eName && fn) {NEG(autoConfiguratorGarageEventTarget).off(eName, fn);}},init: function () {NEG.run(function (require) {maskBuilder = require('NEG.Widget.Mask');overview = maskBuilder({ size: { width: jQuery(document).width(), height: jQuery(document).height() }, position: { top: 0, left: 0 } },{ style: { "z-index": 998, "opacity": 0 }, supportResize: true });overviewPopup = maskBuilder({ size: { width: jQuery(document).width(), height: jQuery(document).height() }, position: { top: 0, left: 0 } },{ style: { "z-index": 999, "opacity": 0.6 }, supportResize: true });overview.on("AFTER_RESIZE", function () {jQuery(this.dom).css({ width: jQuery(document).width(), height: jQuery(document).height() });});overviewPopup.on("AFTER_RESIZE", function () {jQuery(this.dom).css({ width: jQuery(document).width(), height: jQuery(document).height() });});overview.on("AFTER_SHOW", function () {jQuery(this.dom).css({ width: jQuery(document).width(), height: jQuery(document).height() });var len = garages.length;for (var i = 0; i < len; i++) {garages[i].filterDropdownWarpper.addClass("is-active");garages[i].dom.addClass("is-active");}});overviewPopup.on("AFTER_SHOW", function () {jQuery(this.dom).css({ width: jQuery(document).width(), height: jQuery(document).height() });});overview.on("BEFORE_HIDE", function () {var len = garages.length;for (var i = 0; i < len; i++) {garages[i].filterDropdownWarpper.removeClass("is-active");garages[i].dom.removeClass("is-active");}});jQuery(overview.dom).css("background", "url('" + Web.UI.ResourceManager.Image.build("transparent000.png") + "') repeat");jQuery(overviewPopup.dom).css("background", "url('" + Web.UI.ResourceManager.Image.build("transparent060.png") + "') repeat");jQuery(overview.dom).appendTo(document.body);jQuery(overviewPopup.dom).appendTo(document.body);Biz.Common.AutoConfigurator.on("GARAGE_REFRESH", function (target, info) {var garageData = info.garageData || [];optionIndexData = (function () {var tmp = [];var theGarageLen = garageData.length;for (var i = 0; i < theGarageLen; i++) {garageData[i].num = i;tmp[garageData[i].num] = garageData[i];}return tmp;})();garageData.sort(function (v1, v2) {var tmpV1 = getGarageDescription(v1) || { key: '', value: '' };var tmpV2 = getGarageDescription(v2) || { key: '', value: '' };return tmpV1.value < tmpV2.value ? 1 : tmpV1.value > tmpV2.value ? -1 : 0;});var len = garages.length;for (var i = 0; i < len; i++) {garages[i].refreshGarage(garageData, info.selectIndex);garages[i].refreshVehicleCount(garageData.length);}});});},create: function () {var garage = new GarageViewModel();garage.dom.hide();NEG(autoConfiguratorGarageEventTarget).trigger(autoConfiguratorGarageEvents["CREATED"], garage);garages.push(garage);return garage;},showNewVehicleUI: showNewVehicleUI,hide: function () { overview && overview.hide(); },getGarageDescription: getGarageDescription};})();var autoConfiguratorEventTarget = {};var autoConfiguratorEvents = {"ITEM_MATCHED": "Biz_Common_AutoConfigurator_Item_Match","FILTER_MATCHED": "Biz_Common_AutoConfigurator_Filter_Match","GARAGE_MATCHED": "Biz_Common_AutoConfigurator_Garage_Match","INIT_MATCHED": "Biz_Common_AutoConfigurator_Init_Match","GARAGE_REFRESH": "Biz_Common_AutoConfigurator_Garage_Refresh","WIDGET_INITIALIZED": "Biz_Common_AutoConfigurator_Widget_Initialized",};usingNamespace("Biz.Common")["AutoConfigurator"] = (function () {var defaultOptions = {viewType: 0,filterBarSelector: ".auto-filter-bar",containerSelector: ".auto-filter-product"};var storage;var customerGarageData = [];var viewModel;var lastMatchItemInfo;var lastMatchInfo;var popupBuilder;var messagePopup;var widgetInitialized;var verifyMatchInfo = function (matchInfo) {return (matchInfo.vuids && matchInfo.vuids.length == 1) ||(matchInfo.engine && matchInfo.engine != Web.Lang.anyEngine &&matchInfo.trim && matchInfo.trim != Web.Lang.anyTrim);};var FilterBarViewModel = function (options) {var warpper;var title;var vehicleDescription;var actionWarpper;var garage;var createDom = function () {warpper = jQuery('<div class="auto-filter-bar"></div>');title = jQuery('<label class="auto-filter-label">Select Vehicle:</label>');vehicleDescription = jQuery('<div class="auto-filters"><div class="auto-filter-saved-vehicle"></div></div>');actionWarpper = jQuery('<div class="menu-box auto-filter-garage"></div>');(function () {Biz.Common.AutoConfiguratorGarage.on("CREATED", function (target, garageView) {actionWarpper.append(garageView.dom);});garage = Biz.Common.AutoConfiguratorGarage.create();Biz.Common.AutoConfiguratorGarage.off("CREATED");})();warpper.append(title);warpper.append(actionWarpper);warpper.append(vehicleDescription);return warpper;};var refreshVehicleMatchText = function (description) {var tmp = title.children();title.empty().append(tmp).append(description);};var refreshVehicleMatchClass = function (removeClass, addClass) {warpper.removeClass(removeClass).addClass(addClass);};var refreshVehicleDescription = function (text) {vehicleDescription.find('.auto-filter-saved-vehicle').html(text);};var dom = (function () { return createDom(); })();return {dom: dom,garage: garage,refreshVehicleMatchClass: refreshVehicleMatchClass,refreshVehicleMatchText: refreshVehicleMatchText,refreshVehicleDescription: refreshVehicleDescription,show: function () { dom.show(); },hide: function () { dom.hide(); }};};var CommonViewModel = function () {var processMatch = function (info) {var matchInfo = info.matchInfo;if (matchInfo != null) {Biz.Common.AutoConfiguratorGarage.hide();if (matchInfo.vuids && matchInfo.vuids.length) {var tempvuids = '"' + matchInfo.vuids[0] + '"';for (var i = 1; i < matchInfo.vuids.length; i++) {tempvuids += ',"' + matchInfo.vuids[i] + '"';}jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", JSON.stringify(matchInfo.vuids));}var jsonData = Biz.Common.AutoConfiguratorStripe.getStandardJsonFormSimpleFormat(matchInfo);Biz.Common.AutoConfiguratorStripe.search(jsonData, storage);} else {Biz.Common.AutoConfiguratorGarage.showNewVehicleUI(false);}};return {garageMatch: function (info) {processMatch(info);}};};var FitResultViewModel = function (options) {var filterBar;var autoContainer;var autofilter;var getGarageDescription = function (ga) {return Biz.Common.AutoConfiguratorGarage.getGarageDescription(ga);};var containsArray = function (sourceArray, matchArray) {if (!sourceArray || !matchArray) {return false;}var sourceLen = sourceArray.length;var matchLen = matchArray.length;for (var i = 0; i < matchLen; i++) {var matchKey = matchArray[i];var flag = false;for (var j = 0; j < sourceLen; j++) {if (matchKey == sourceArray[j]) {flag = true;break;}}if (!flag) {return false;}}return true;};var match = function (info) {var matchInfo = info.matchInfo;var itemInfo = info.itemInfo;if (!matchInfo) {return;}var matchFlag = false;var array = itemInfo ? itemInfo.vehicle : [];var description = getGarageDescription(matchInfo).value;filterBar.refreshVehicleDescription(description);if (containsArray(array, matchInfo.vuids)) {matchFlag = true;}if (matchFlag) {filterBar.refreshVehicleMatchText(Web.Lang.thisFit);filterBar.refreshVehicleMatchClass("warning", "fits");} else {filterBar.refreshVehicleMatchText(Web.Lang.thisNotFit);filterBar.refreshVehicleMatchClass("fits", "warning");}Biz.Common.AutoConfiguratorGarage.hide();autofilter.hide();filterBar.show();autoContainer.show();lastMatchInfo = matchInfo;};filterBar = new FilterBarViewModel(options);autoContainer = jQuery(options.containerSelector);autofilter = jQuery(options.filterBarSelector);autofilter.after(filterBar.dom);var processMatch = function (info) {var matchInfo = info.matchInfo;var itemInfo = info.itemInfo;if (itemInfo && itemInfo.vehicle && itemInfo.vehicle.length > 0) {if (matchInfo != null) {if (verifyMatchInfo(matchInfo)) {match(info);} else {fillToAutoFilter(matchInfo, false);Biz.Common.AutoConfiguratorGarage.hide();autofilter.show();filterBar.hide();autoContainer.show();lastMatchInfo = matchInfo;}} else {Biz.Common.AutoConfiguratorGarage.showNewVehicleUI(false);}} else {autoContainer.hide();}};return {itemMatch: function (info) {var itemInfo = info.itemInfo;if (itemInfo) {lastMatchItemInfo = itemInfo;}if (itemInfo && storage) {var localstorage = lastMatchInfo != null ? lastMatchInfo : getLocalStorage();info.matchInfo = localstorage;return processMatch(info);} else {return Biz.Common.AutoConfiguratorGarage.showNewVehicleUI(false);}},searchMatch: function (info) {info.itemInfo = lastMatchItemInfo;processMatch(info);},garageMatch: function (info) {info.itemInfo = lastMatchItemInfo;processMatch(info);},newVehicle: function () {autofilter.show();filterBar.hide();autoContainer.show();}};};var DescriptionViewModel = function (options) {var filterBar;var autofilter;var getGarageDescription = function (ga) {return Biz.Common.AutoConfiguratorGarage.getGarageDescription(ga);};var match = function (info) {var matchInfo = info.matchInfo;if (!matchInfo) {return;}var description = getGarageDescription(matchInfo).value;filterBar.refreshVehicleDescription(description);filterBar.refreshVehicleMatchText(Web.Lang.autoPartsFor2016);Biz.Common.AutoConfiguratorGarage.hide();autofilter.hide();filterBar.show();};filterBar = new FilterBarViewModel(options);autofilter = jQuery(options.filterBarSelector);autofilter.after(filterBar.dom);autofilter.hide();filterBar.hide();var processMatch = function (info) {var matchInfo = info.matchInfo;if (matchInfo != null) {Biz.Common.AutoConfiguratorGarage.hide();if (matchInfo.vuids && matchInfo.vuids.length) {var tempvuids = '"' + matchInfo.vuids[0] + '"';for (var i = 1; i < matchInfo.vuids.length; i++) {tempvuids += ',"' + matchInfo.vuids[i] + '"';}jQuery(".btn.btn-mini.btn-alt").attr("neg-sp-data-value", JSON.stringify(matchInfo.vuids));}var jsonData = Biz.Common.AutoConfiguratorStripe.getStandardJsonFormSimpleFormat(matchInfo);Biz.Common.AutoConfiguratorStripe.search(jsonData, storage);} else {Biz.Common.AutoConfiguratorGarage.showNewVehicleUI(false);}};return {initMatch: function (info) {var matchInfo = info.matchInfo;if (matchInfo != null) {match(info);} else {Biz.Common.AutoConfiguratorGarage.showNewVehicleUI(false);}},garageMatch: function (info) {processMatch(info);},newVehicle: function () {autofilter.show();filterBar.hide();}};};var getLocalStorage = function () {try {return JSON.parse(storage.getItem("AutoHistory"));}catch (ex) {return null;}};var removeLocalStorage = function () {storage.removeItem("AutoHistory");};var setLocalStorage = function (o) {storage.setItem("AutoHistory", JSON.stringify(o));};var garageCompare = function (c1, c2) {var ignoreEqual = function (t1, t2) {t1 = (!t1 || t1 == "") ? "" : t1;t2 = (!t2 || t2 == "") ? "" : t2;return t1 == t2;};if (c1.year != c2.year ||c1.make != c2.make ||c1.model != c2.model ||!ignoreEqual(c1.trim, c2.trim) ||!ignoreEqual(c1.engine, c2.engine)) {return false;}return true;};var requestGarage = function (needRequestCustomerGarage, operator, garageItem) {var findGarageIndex = function (garageData, find) {var selectIndex = -1;if (find != null) {if (selectIndex == -1) {for (var j = 0; j < garageData.length; j++) {if (garageCompare(garageData[j], find)) {selectIndex = j;break;}}}}return selectIndex;};var process = function (garageData) {garageData = garageData || [];var theLocalstorage = getLocalStorage();var selectIndex = -1;if (theLocalstorage) {var notNeedSelected = false;if (defaultOptions.viewType == 0) {notNeedSelected = true;}if (!notNeedSelected) {selectIndex = findGarageIndex(garageData, theLocalstorage);}if (selectIndex == -1) {if (!isLogin()) {if (!notNeedSelected) {selectIndex = garageData.length;}garageData.push(theLocalstorage);}}}NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["GARAGE_REFRESH"], { garageData: garageData, selectIndex: selectIndex });};var queryGarage = function () {var proxy = function (d) {return d;};jQuery.ajax({url: Web.Config.Environment.Url.Secure + "Common/Ajax/CustomerGarage.aspx?submit=GET",processData: false,dataType: "jsonp",jsonpCallback: "proxy"}).done(function (response) {customerGarageData = response.customergarages || [];var theLocalstorage = getLocalStorage();var selectIndex = findGarageIndex(customerGarageData, theLocalstorage);if (selectIndex != -1) {if (theLocalstorage.transno != customerGarageData[selectIndex].transno) {theLocalstorage.transno = customerGarageData[selectIndex].transno;theLocalstorage.synchronized = true;setLocalStorage(theLocalstorage);} else {if (!theLocalstorage.synchronized) {theLocalstorage.synchronized = true;setLocalStorage(theLocalstorage);}}} else {if (isLogin() && theLocalstorage) {if (theLocalstorage.synchronized) {theLocalstorage.synchronized = false;setLocalStorage(theLocalstorage);}}}return process(customerGarageData.slice());}).fail(function () {process(customerGarageData.slice());});};var syncGarage = function (garageItem, callback) {var proxy = function (d) {return d;};var theErrorProcess = function () {callback && callback.fail && callback.fail();};var theSucceedProcess = function () {callback && callback.succeed && callback.succeed();};var theLocalstorage = getLocalStorage();if (theLocalstorage && theLocalstorage.transno == garageItem.transno && theLocalstorage.synchronized) {theLocalstorage.synchronized = false;setLocalStorage(theLocalstorage);}jQuery.ajax({url: Web.Config.Environment.Url.Secure + "Common/Ajax/CustomerGarage.aspx?submit=ADD",processData: false,data: jQuery.param({transno: garageItem.transno,year: garageItem.year,make: garageItem.make,model: garageItem.model,trim: garageItem.trim,engine: garageItem.engine,vuids: (garageItem.vuids || []).join(",")}),dataType: "jsonp",jsonpCallback: "proxy"}).done(function (response) {if (response && response.responsemsg) {return theErrorProcess();}return theSucceedProcess();}).fail(function () {theErrorProcess();});};var deleteGarage = function (garageItem, callback) {var proxy = function (d) {return d;};var errorMessage = { title: Web.Lang.deleteGarageErrorMessageTitle, description: Web.Lang.deleteGarageErrorMessage };var theErrorProcess = function () {callback && callback.fail && callback.fail();};var theSucceedProcess = function () {callback && callback.succeed && callback.succeed();};jQuery.ajax({url: Web.Config.Environment.Url.Secure + "Common/Ajax/CustomerGarage.aspx?submit=DEL",processData: false,data: jQuery.param({ transno: garageItem.transno }),dataType: "jsonp",jsonpCallback: "proxy"}).done(function (response) {if (response && response.responsemsg) {return showMessage(errorMessage, theErrorProcess);}return theSucceedProcess();}).fail(function () {showMessage(errorMessage, theErrorProcess);});};var showMessage = function (msg, theErrorProcess) {messagePopup.find(".auto-configurator #NetWorkError").on("hidden.ng.popup", function () {theErrorProcess && theErrorProcess();});messagePopup.find(".auto-configurator #NetWorkError").click();};var isLogin = function () {var loginID = Web.StateManager.Cookies.get(Web.StateManager.Cookies.Name.LOGIN, "LOGINID6");return !String.isNullOrEmpty(loginID);};if (needRequestCustomerGarage) {if (isLogin()) {var localstorage = getLocalStorage();if (localstorage != null && !localstorage.synchronized) {syncGarage(localstorage, { succeed: queryGarage, fail: queryGarage });} else {queryGarage();}} else {process(customerGarageData.slice());}} else {if (operator && operator == "DELETE" && garageItem) {var deleteProcess = function () {var len = customerGarageData.length;var temp = [];for (var i = 0; i < len; i++) {if (customerGarageData[i] != garageItem) {temp.push(customerGarageData[i]);}}customerGarageData = temp;process(customerGarageData.slice());};if (isLogin()) {deleteGarage(garageItem, { succeed: deleteProcess });} else {removeLocalStorage();deleteProcess();}}else if (operator && operator == "UPDATE" && garageItem) {if (isLogin()) {syncGarage(garageItem, { succeed: queryGarage });} else {process(customerGarageData.slice());}}else {process(customerGarageData.slice());}}};var fillToAutoFilter = function (fillVehicle, autoShowYear) {try {NEG(document).trigger("ConfiguratorFill", { selectedVehicle: fillVehicle, autoShowYear: autoShowYear });} catch (ex) {}};var itemMatch = function (target, itemInfo) {if (widgetInitialized) {NEG.utility.isDefined(viewModel.itemMatch) && viewModel.itemMatch({ itemInfo: itemInfo });} else {Biz.Common.AutoConfigurator.on("WIDGET_INITIALIZED", function () {NEG.utility.isDefined(viewModel.itemMatch) && viewModel.itemMatch({ itemInfo: itemInfo });});}};var searchMatch = function (target, matchInfo) {requestGarage(false, "UPDATE", matchInfo);NEG.utility.isDefined(viewModel.searchMatch) && viewModel.searchMatch({ matchInfo: matchInfo });};var garageMatch = function (target, matchInfo) {NEG.utility.isDefined(viewModel.garageMatch) && viewModel.garageMatch({ matchInfo: matchInfo });};var initMatch = function (target, matchInfo) {NEG.utility.isDefined(viewModel.initMatch) && viewModel.initMatch({ matchInfo: matchInfo });};return {on: function (eventName, fn) {var eName = autoConfiguratorEvents[eventName];if (eName && fn) {NEG(autoConfiguratorEventTarget).on(eName, fn);}},off: function (eventName, fn) {var eName = autoConfiguratorEvents[eventName];if (eName && fn) {NEG(autoConfiguratorEventTarget).off(eName, fn);}},init: function (options) {NEG.blend(defaultOptions, options, { cover: true, mergePrototype: false });if (defaultOptions.viewType == 1) {viewModel = new FitResultViewModel(defaultOptions);} else if (defaultOptions.viewType == 2) {viewModel = new DescriptionViewModel(defaultOptions);} else {viewModel = new CommonViewModel(defaultOptions);}Biz.Common.AutoConfigurator.on("ITEM_MATCHED", itemMatch);Biz.Common.AutoConfigurator.on("FILTER_MATCHED", searchMatch);Biz.Common.AutoConfigurator.on("GARAGE_MATCHED", garageMatch);Biz.Common.AutoConfigurator.on("INIT_MATCHED", initMatch);Biz.Common.AutoConfiguratorGarage.on("CREATED", function (target, garageView) {jQuery(".auto-filter-bar:first .auto-filters").after(garageView.dom);});Biz.Common.AutoConfiguratorGarage.create();Biz.Common.AutoConfiguratorGarage.off("CREATED");Biz.Common.AutoConfiguratorGarage.on("ITEM_DELETED", function (target, info) {if (info.target.hasClass("is-current")) {removeLocalStorage();lastMatchInfo = null;}requestGarage(false, "DELETE", info.data);if (info.target.hasClass("is-current")) {NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["GARAGE_MATCHED"], null);}});Biz.Common.AutoConfiguratorGarage.on("ITEM_SELECTED", function (target, info) {setLocalStorage(info.data);requestGarage(false);NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["GARAGE_MATCHED"], info.data);});Biz.Common.AutoConfiguratorGarage.on("NEW_VEHICLE", function (targe, autoShowYear) {fillToAutoFilter(null, autoShowYear);NEG.utility.isDefined(viewModel.newVehicle) && viewModel.newVehicle();});NEG.run(function (require) {storage = require("Biz.Storage");popupBuilder = require("NEG.Widget.Popup");messagePopup = popupBuilder({content: '<div class="auto-configurator">' +'  <a href="javascript:void(0)" id="NetWorkError" class="networkerror open-popup"></a>' +'  <div class="centerPopup-source" id="NetworkError_Content">' +'      <a href="javascript:void(0)" class="fa fa-close centerPopup-close"></a>' +'		<div class="centerPopup-title"></div>' +'		<div class="centerPopup-normal-content">' +'			<div class="message message-info">' +'				<div class="message-wrapper">' +'					<div class="message-icon"></div>' +'					<div class="message-information"></div>' +'				</div>' +'			</div>' +'		</div>' +'		<div class="conterPopup-bottom"><div class="centerPopup-button-area"><button type="button" class="btn btn-primary centerPopup-trigger-close">' + Web.Lang.close1 + '</button></div></div>' +'  </div>' +'</div>'}, {autoCenterAfterResize: true});if (defaultOptions.initUrlGarage) {var theLocalstorage = getLocalStorage();var initUrlGarage = defaultOptions.initUrlGarage;if (theLocalstorage != null) {if (!garageCompare(theLocalstorage, initUrlGarage)) {setLocalStorage(initUrlGarage);}} else {setLocalStorage(initUrlGarage);}if (defaultOptions.viewType == 2) {NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["INIT_MATCHED"], initUrlGarage);}}jQuery(messagePopup.dom).appendTo(document.body);requestGarage(true);NEG(autoConfiguratorEventTarget).trigger(autoConfiguratorEvents["WIDGET_INITIALIZED"]);widgetInitialized = true;});}};})();