"use strict";$(document).ready(function(){window.isIE9=window.navigator.userAgent.indexOf("MSIE 9.0")!==-1;window.onbeforeunload=function(){var searchForm=$('form[id^="sfsForm"]'),searchFormElements=searchForm.find(":input").not("disabled");searchFormElements.each(function(){$(this).removeAttr("disabled")})};window.onpageshow=function(e){if(e.persisted){var sfsElementsWithAutocompleteOff=$(".SUI_SFS_form").find("[autocomplete=off]");sfsElementsWithAutocompleteOff.attr("autocomplete","on");setTimeout(function(){sfsElementsWithAutocompleteOff.attr("autocomplete","off")},500);$("div.SUI_SFS_form form input[type=submit]").each(function(){var item=$(this);item.val(item.attr("data-initial-text"));item.removeClass("disabled")})}}});var searchFormModule=angular.module("SearchFormServiceUI",[]);angular.module("SearchFormServiceUI").controller("SearchFormCtrl",["$scope","$window","queryParamCollection","sfsDataModelProvider","userPreferences",function($scope,$window,queryParamCollection,sfsDataModelProvider,userPreferences){$scope.sfsData={};$scope.model=null;$scope.init=function(domPrefix){function loadingComplete(){$scope.model.isExactAllEnabled===!0&&$scope.$root.$broadcast("toggleMatchAllTermsExactly",$scope.model.isExactAllEnabled,$scope.domPrefix);$scope.$root.$broadcast("modelLoaded",$scope.model,$scope.domPrefix)}var formSubmittedData,savedData,formData;$scope.sfsData=$window[domPrefix+"sfsData"];$scope.domPrefix=domPrefix;$scope.model=sfsDataModelProvider.getDataModel(domPrefix);$scope.metadata=sfsDataModelProvider.getMetadata(domPrefix);userPreferences.updateMetadataDefaults(domPrefix);formSubmittedData=$($window.document).find("#"+$scope.metadata.form.dataFieldId).val();formSubmittedData!=null&&formSubmittedData.length>0?(savedData=JSON.parse(formSubmittedData),$.extend(!0,$scope.model,savedData.dataModel),loadingComplete()):(formData=queryParamCollection.getFormData($scope.domPrefix),sfsDataModelProvider.populateFromData(domPrefix,formData,"onload",function(){userPreferences.applyUserPreferences(domPrefix);loadingComplete()}))};$scope.$on("clearFormEvent",function(event,domPrefix){$scope.domPrefix===domPrefix&&sfsDataModelProvider.resetData(domPrefix)});$scope.$on("personPickerUpdated",function($event,domPrefix){if($scope.domPrefix===domPrefix){var personPickerData=queryParamCollection.getPersonPickerParams();sfsDataModelProvider.populateFromData(domPrefix,personPickerData,"personPicker")}});$scope.$on("toggleMatchAllTermsExactly",function($event,isMatchAll,domPrefix){$scope.domPrefix===domPrefix&&sfsDataModelProvider.matchAllTermsExactly(domPrefix,isMatchAll)});$scope.$on("resetMatchAllTermsExactly",function(event,domPrefix){domPrefix===$scope.domPrefix&&($scope.model.isExactAllEnabled=!1)})}]);angular.module("SearchFormServiceUI").controller("AdvancedPanelCtrl",["$scope",function($scope){$scope.switchView=function(){$scope.model.isShowMoreOptionsExpanded=!$scope.model.isShowMoreOptionsExpanded}}]);angular.module("SearchFormServiceUI").controller("EventController",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){$scope.event=null;$scope.init=function(eventGroupName){$scope.event=sfsDataModelProvider.getEvent($scope.domPrefix,eventGroupName)}}]);angular.module("SearchFormServiceUI").controller("MSAVController",["$scope",function($scope){$scope.getMSAV=function(){return $scope.model.isExactAllEnabled&&$scope.model.isShowMoreOptionsExpanded?2:!$scope.model.isExactAllEnabled&&$scope.model.isShowMoreOptionsExpanded?1:$scope.model.isExactAllEnabled&&!$scope.model.isShowMoreOptionsExpanded?-1:0}}]);angular.module("SearchFormServiceUI").controller("MatchAllTermsExactlyModuleController",["$scope",function($scope){$scope.checkBoxChanged=function(){$scope.$root.$broadcast("toggleMatchAllTermsExactly",!$scope.model.isExactAllEnabled,$scope.domPrefix)}}]);angular.module("SearchFormServiceUI").service("urlCanonicalizerProvider",function(){return{getUrlCanonicalizer:function(){return urlCanonicalizer}}});
angular.module("SearchFormServiceUI").controller("CategoryBucketCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){var alertMessage=$scope.sfsData.categoryBucket.alertMessage;$scope.getSubmitValue=function(){return sfsDataModelProvider.getCategoryBucketString($scope.domPrefix)};$scope.categoryBucketChanged=function(nameOfChangedCategoryBucketProperty){var submitValue=$scope.getSubmitValue();submitValue===""&&($scope.model.types[nameOfChangedCategoryBucketProperty]=!0,alert(alertMessage))}}]);
angular.module("SearchFormServiceUI").controller("CollectionFocusModuleController",["$scope","$window",function($scope,$window){var defaultSearchBlock="0",metadata;$scope.collectionFocusList=[{group:null,name:"All Collections",value:"0",groupName:null,gpids:null,location:null}];$scope.searchBlock=defaultSearchBlock;metadata=$window[$scope.domPrefix+"ScopeMetadata"];$scope.collectionFocusList=$.map(metadata.collectionFocus.items,function(item){return{value:item.id,name:item.localizedName,group:item.group,groupName:item.weightGroupName,location:item.location,gpids:item.locationGpids}});$scope.updateCollectionFocus=function(){var newCollectionFocus=$.grep($scope.collectionFocusList,function(elem){return elem.value===$scope.searchBlock})[0];$scope.model.location.length=0;$.extend($scope.model.location,newCollectionFocus.gpids||[]);$scope.model.priority=newCollectionFocus.groupName||""};$scope.$watch("model.priority",function(){var newCollectionFocus=$.grep($scope.collectionFocusList,function(elem){return $scope.model.priority===elem.groupName})[0];newCollectionFocus?$scope.searchBlock=newCollectionFocus.value:($scope.searchBlock=defaultSearchBlock,$scope.updateCollectionFocus())})}]);
angular.module("SearchFormServiceUI").controller("ContentBasedFormCtrl",["$scope","$window","sfsCookies",function($scope,$window,sfsCookies){function updateCookie(){var cookieStr=sfsCookies.get("VARSESSION")||"",domain;cookieStr.indexOf("NovaS=1")===-1&&(cookieStr.length>0&&(cookieStr=cookieStr+"&"),cookieStr="VARSESSION="+cookieStr+"NovaS=1",domain=getCookieDomain(),domain&&(cookieStr+=";domain="+domain),sfsCookies.set("VARSESSION",cookieStr,7300))}function getCookieDomain(){var location=$window.location.hostname,firstDot=location.indexOf(".");return firstDot>0?location.substring(firstDot,location.length):""}$scope.showLicensePage=!1;$scope.initLicensePage=function(dbid){$scope.showLicensePage=!0;try{$scope.showLicensePage=$.inArray(dbid,$window.Ancestry.SFS.Settings.AcceptedDbLicenses)==-1}catch(e){}};$scope.hideLicensePage=function(){$scope.showLicensePage=!1;updateCookie()}}]);
angular.module("SearchFormServiceUI").controller("DayModuleCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){$scope.searchKey="";$scope.day="unselected";$scope.event=null;$scope.init=function(moduleGroupId,moduleId,searchKey){$scope.searchKey=searchKey;$scope.event=sfsDataModelProvider.getEvent($scope.domPrefix,moduleGroupId)};$scope.updateDay=function(){var day=$scope.day==="unselected"?null:parseInt($scope.day);day=day!=null&&day>=1&&day<=31?day:null;$scope.event.date.day=day};$scope.$watch("event.date.day",function(){$scope.day=$scope.event.date.day!=null?$scope.event.date.day.toString():"unselected"})}]);
angular.module("SearchFormServiceUI").controller("EstBirthYearExactCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){function isAgeValid(){return $scope.yeage!=null&&$scope.yeage>0&&$scope.yeage<=maxAgeValue}function isYearValid(){return $scope.yeyear!=null&&$scope.yeyear>minYearValue}var birthGroupName="SelfBirth",maxAgeValue,minYearValue,deletedDateObj;$scope.birthEventGroup=sfsDataModelProvider.getEventGroup($scope.domPrefix,birthGroupName);$scope.birthEvent=null;$scope.$watch("birthEventGroup.instances.length",function(){$scope.birthEvent=$scope.birthEventGroup.instances.length>=1?$scope.birthEventGroup.instances[0]:null;$scope.year=$scope.birthEvent!=null?$scope.birthEvent.date.year:$scope.year});$scope.$watch("birthEvent.date.year",function(){$scope.year=$scope.birthEvent==null?null:$scope.birthEvent.date.year});maxAgeValue=120;minYearValue=1e3;$scope.showerror=!1;deletedDateObj=null;$scope.inputYearChanged=function(){if($scope.year==null){$scope.birthEvent.date.year=null;var birthEventHasOnlyYearData=$scope.birthEvent.location.length===0;birthEventHasOnlyYearData&&(deletedDateObj=$.extend(!0,{},$scope.birthEvent),sfsDataModelProvider.removeEvent($scope.domPrefix,birthGroupName,0),$scope.birthEvent=null)}else $scope.birthEventGroup.instances.length===0?($scope.birthEvent=sfsDataModelProvider.addEvent($scope.domPrefix,birthGroupName,0),deletedDateObj&&($scope.birthEvent.dateProximity.year=deletedDateObj.dateProximity.year)):$scope.birthEvent=$scope.birthEventGroup.instances[0],$scope.birthEvent.date.year=$scope.year};$scope.$on("clearFormEvent",function(event,domPrefix){$scope.domPrefix==domPrefix&&(deletedDateObj=null)});$scope.$on("personPickerUpdated",function($event,domPrefix){$scope.domPrefix==domPrefix&&(deletedDateObj=null)});$scope.$on("toggleMatchAllTermsExactly",function($event,isMatchAll,domPrefix){$scope.domPrefix==domPrefix&&(deletedDateObj=isMatchAll?deletedDateObj:null)});$scope.ageChange=function(){$scope.yeage&&!isYearValid()&&($scope.showerror=!0);$scope.errorFix()};$scope.yearChange=function(){$scope.errorFix()};$scope.errorFix=function(){$scope.yeage==null&&$scope.yeyear==null?$scope.showerror=!1:$scope.yeage!=null&&isAgeValid()?$scope.showerror=!1:$scope.yeyear!=null&&isYearValid()&&($scope.showerror=!1)};$scope.calloutClose=function(){return $scope.yeage==null&&$scope.yeyear==null?!0:isAgeValid()&&isYearValid()?($scope.year=$scope.yeyear-$scope.yeage,$scope.inputYearChanged(),!0):($scope.showerror=!0,!1)}}]);
(function(){var nextEventId=0;angular.module("SearchFormServiceUI").controller("EventSelectorCtrl",["$scope","$window","sfsDataModelProvider","sfsObjectCache",function($scope,$window,sfsDataModelProvider,cache){function refreshAllEvents(){$scope.allEvents=[];$.each($scope.eventGroups,function(index,eventGroup){var groupName=eventGroup.relation+eventGroup.eventName;$.each(eventGroup.instances,function(eventInstanceIndex,eventInstance){var eventData=cache.get("EventSelectorCtrl",eventInstance,groupName);eventData||(eventData={groupName:groupName,data:eventInstance,id:"event"+nextEventId++},cache.set(eventData,"EventSelectorCtrl",eventInstance,eventData.groupName));eventData.index=eventInstanceIndex;$scope.allEvents.push(eventData)})})}var eventTypeToCharMap,subTypes;$scope.exactSearchEnabled=!1;$scope.eventTypesInHeaderRow=["SelfBirth","SelfMarriage","SelfDeath","SelfResidence","Self"];$scope.eventTypes=["SelfBirth","SelfMarriage","SelfDeath","SelfResidence","SelfArrival","SelfDeparture","SelfMilitary","Self"];eventTypeToCharMap={SelfBirth:"b",SelfMarriage:"g",SelfDeath:"d",SelfResidence:"r",SelfArrival:"a",SelfDeparture:"e",SelfMilitary:"i",Self:"y"};$scope.lastExactOption=null;$scope.lastExactFlag=null;subTypes={EXACTNESS:"_x"};$scope.display=$scope.sfsData.eventDisplay;$scope.eventToFocus=null;$scope.arrivalButtonId=$scope.domPrefix+"arrivalButton";$scope.departureButtonId=$scope.domPrefix+"departureButton";$scope.militaryButtonId=$scope.domPrefix+"militaryButton",function(){$scope.eventGroups=[];$.each($scope.eventTypes,function(eventTypeIndex,eventType){$scope.eventGroups.push(sfsDataModelProvider.getEventGroup($scope.domPrefix,eventType))})}();$scope.allEvents=[];$.each($scope.eventTypes,function(eventTypeIndex,eventType){$scope.$watchCollection("model.events."+eventType+".instances",refreshAllEvents)});$scope.getSelectorId=function(type){return $scope.domPrefix+"addEventLink_"+type};$scope.firstEventSelector="#"+$scope.getSelectorId("SelfBirth");$scope.shouldFocus=function(event){return $scope.eventToFocus!=null&&$scope.eventToFocus===event?($scope.eventToFocus=null,!0):!1};$scope.addEvent=function(type){var event=sfsDataModelProvider.addEvent($scope.domPrefix,type);event!=null&&($scope.eventToFocus=event);$scope.closeCallout()};$scope.hitLimit=function(type){var eventGroup=sfsDataModelProvider.getEventGroup($scope.domPrefix,type),maxCount=sfsDataModelProvider.getEventGroupMaxCount($scope.domPrefix,type);return eventGroup.instances.length>=maxCount};$scope.removeEvent=function(event,index){$scope.focusToNextRow&&$scope.focusToNextRow(index);sfsDataModelProvider.removeEvent($scope.domPrefix,event.groupName,event.index)};$scope.getDateParam=function(event,paramType,subType){var eventTypeChar=eventTypeToCharMap[event.groupName],indexStr=event.index==0?"":event.index;return"ms"+eventTypeChar+"d"+paramType+indexStr+(subType?subTypes[subType]:"")};$scope.getPlaceParam=function(event){var eventTypeChar=eventTypeToCharMap[event.groupName],indexStr=event.index>0?event.index:"";return"ms"+eventTypeChar+"pn"+indexStr}}])})();
(function(){var nextFamilyId=0;angular.module("SearchFormServiceUI").controller("FamilySelectorCtrl",["$scope","queryParamCollection","sfsDataModelProvider","sfsObjectCache",function($scope,queryParamCollection,sfsDataModelProvider,cache){function refreshAllMembers(){$scope.allMembers=[];$scope.memberTypes.forEach(function(memberType){var familyGroup=$scope.model.family[memberType],familyGroupConfig=$scope.metadata.family[memberType];familyGroup.instances.forEach(function(member,index){if(familyGroupConfig.hasGivenName||familyGroupConfig.hasSurname){var data=cache.get("FamilySelectorCtrl",member,memberType);data||(data={relationship:memberType,member:member,config:familyGroupConfig,id:nextFamilyId++,focusOnce:newMember===member},cache.set(data,"FamilySelectorCtrl",member,memberType));data.index=index;data.givenNameParam=getParam("g",index,familyGroupConfig);data.givenNameExactnessParam=getParam("g",index,familyGroupConfig,!0);data.surnameParam=getParam("s",index,familyGroupConfig);data.surnameExactnessParam=getParam("s",index,familyGroupConfig,!0);$scope.metadata.name.usesParentSurnameFields&&(data.firstSurnameParam=getParam("sf",index,familyGroupConfig),data.secondSurnameParam=getParam("ss",index,familyGroupConfig));$scope.allMembers.push(data)}})});newMember=null}function determineHasMemberWithGivenName(){var hasGivenName=!1;return $.each($scope.metadata.family,function(memberType){hasGivenName=hasGivenName||$scope.metadata.family[memberType].hasGivenName}),hasGivenName}function getFirstFamilyGroupSelector(){var firstFamilyGroup=null;return $scope.memberTypes.forEach(function(familyGroup){firstFamilyGroup==null&&$scope.metadata.family[familyGroup].maxCount>0&&(firstFamilyGroup=familyGroup)}),"#"+$scope.getSelectorId(firstFamilyGroup)}$scope.strings=$scope.sfsData.familyDisplay;$scope.memberTypes=["father","mother","sibling","spouse","child"];$scope.hasMemberWithGivenName=determineHasMemberWithGivenName();var newMember=null,getParam=function(nameType,index,config,isExactness){var memberIndex=index===0?"":index.toString(),paramName=nameType[0]==="g"?config.givenNameParam:config.surnameParam;return nameType.length===2&&(paramName+=nameType[1]),paramName+memberIndex+(isExactness?"_x":"")};$scope.allMembers=[];Object.keys($scope.model.family).forEach(function(relationship){$scope.$watchCollection("model.family."+relationship+".instances",refreshAllMembers)});refreshAllMembers();$scope.getSelectorId=function(familyGroup){return $scope.domPrefix+"addMemberLink_"+familyGroup};$scope.firstFamilyGroupSelector=getFirstFamilyGroupSelector();$scope.updateSurnamePart=function(member){var firstPart=member.firstSurname.trim(),secondPart=member.secondSurname.trim();member.surname=(firstPart+" "+secondPart).trim()};$scope.addMember=function(familyMemberType){newMember=sfsDataModelProvider.addFamilyMember($scope.domPrefix,familyMemberType)};$scope.hitLimit=function(familyMemberType){return $scope.model.family[familyMemberType].instances.length>=$scope.metadata.family[familyMemberType].maxCount};$scope.removeMember=function(relationship,indexInGroup,index){$scope.focusToNextRow&&$scope.focusToNextRow(index);sfsDataModelProvider.removeFamilyMember($scope.domPrefix,relationship,indexInGroup)}}])})();
var sfsFdidDropDownCtrlInstance=0;angular.module("SearchFormServiceUI").controller("FdidDropdownCtrl",["$scope",function($scope){sfsFdidDropDownCtrlInstance++;$scope.exactCheckboxId=$scope.domPrefix+"sfsFdidDropDownCtrl-"+sfsFdidDropDownCtrlInstance;$scope.init=function(fieldName,key,list){$scope.field=$scope.model.fields[fieldName];$scope.exactKey=key+"_x";$scope.options=list}}]);
var sfsFdidTextBoxCtrlInstance=0;angular.module("SearchFormServiceUI").controller("FdidTextBoxCtrl",["$scope",function($scope){++sfsFdidTextBoxCtrlInstance;$scope.exactnessId=$scope.domPrefix+"sfsFdidTextBoxCtrl-"+sfsFdidTextBoxCtrlInstance;$scope.init=function(fieldName,key){$scope.field=$scope.model.fields[fieldName];$scope.exactKey=key+"_x"}}]);
angular.module("SearchFormServiceUI").controller("FirstAnyEventCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){var tempEvent={location:"",date:{year:null},locationExactness:{}};$scope.event=tempEvent;$scope.$watch("model.events.Self.instances.length",function(){$scope.event=$scope.model.events.Self.instances.length===0?tempEvent:$scope.model.events.Self.instances[0];$scope.model.events.Self.instances.length===0?($scope.event=tempEvent,tempEvent.location=""):$scope.event=$scope.model.events.Self.instances[0]});$scope.onLocationChange=function(){$scope.event.location!=null&&$scope.event.location.length>0?($scope.model.events.Self.instances.length===0&&sfsDataModelProvider.addEvent($scope.domPrefix,"Self",0),$scope.model.events.Self.instances[0].location=$scope.event.location,$scope.event=$scope.model.events.Self.instances[0]):$scope.event.location.length===0&&$scope.event.date.year==null&&(sfsDataModelProvider.removeEvent($scope.domPrefix,"Self",0),$scope.model.events.Self.instances.length===0?($scope.event=tempEvent,tempEvent.location=""):$scope.event=$scope.model.events.Self.instances[0])}}]);
angular.module("SearchFormServiceUI").controller("GenderCtrl",["$scope",function($scope){function updateGenderSubmitValueFromModel(){$scope.genderSubmitValue=gender.value==="male"?"f":gender.value==="female"?"m":""}var gender=$scope.model.fields.SelfGender;$scope.genderSubmitValue="";$scope.genderSubmitValueChanged=function(){$scope.genderSubmitValue==="f"?gender.value="male":$scope.genderSubmitValue==="m"?gender.value="female":(gender.value=null,$scope.genderSubmitValue="")};$scope.$watch("model.fields.SelfGender",updateGenderSubmitValueFromModel,!0);updateGenderSubmitValueFromModel()}]);
angular.module("SearchFormServiceUI").controller("MonthModuleCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){$scope.searchKey="";$scope.month="unselected";$scope.event=null;$scope.init=function(moduleGroupId,moduleId,searchKey){$scope.searchKey=searchKey;$scope.event=sfsDataModelProvider.getEvent($scope.domPrefix,moduleGroupId)};$scope.updateMonth=function(){var month=$scope.month==="unselected"?null:parseInt($scope.month);month=month!=null&&month>=1&&month<=12?month:null;$scope.event.date.month=month};$scope.$watch("event.date.month",function(){$scope.month=$scope.event.date.month!=null?$scope.event.date.month.toString():"unselected"})}]);
angular.module("SearchFormServiceUI").controller("MSVController",["$scope","queryParamCollection",function($scope){$scope.MSV=0;$scope.$watch("model.isExactAllEnabled",function(){$scope.MSV=$scope.model.isExactAllEnabled===!0?1:0})}]);
angular.module("SearchFormServiceUI").controller("NameExactCtrl",["$scope",function($scope){function setDoubleSurname(){var surnames=$scope.model.name.surname.split(" ");$scope.doubleSurname.firstName=surnames[0]||"";$scope.doubleSurname.secondName=surnames[1]||""}$scope.metadata.name.usesParentSurnameFields&&($scope.doubleSurname={firstName:"",secondName:""},$scope.nameChanged=function(){$scope.model.name.surname=($scope.doubleSurname.firstName+" "+$scope.doubleSurname.secondName).trim()},$scope.$watch("model.name.surname",setDoubleSurname),setDoubleSurname())}]);
angular.module("SearchFormServiceUI").controller("YearModuleCtrl",["$scope","sfsDataModelProvider",function($scope,sfsDataModelProvider){$scope.searchKey="";$scope.event=null;$scope.init=function(moduleGroupId,moduleId,searchKey){$scope.searchKey=searchKey;$scope.event=sfsDataModelProvider.getEvent($scope.domPrefix,moduleGroupId)}}]);
angular.module("SearchFormServiceUI").controller("YearRangeCtrl",["$scope","$rootScope",function($scope,$rootScope){$scope.parentForm=null;$scope.showError=!1;$scope.preventSubmit=!1;$scope.init=function(formName){$scope.parentForm=$scope[formName]};$scope.rangeChanged=function(event){var isValidRange=$scope.model.range.yearStart==null||$scope.model.range.yearEnd==null||$scope.model.range.yearStart<=$scope.model.range.yearEnd;isValidRange?($scope.showError=!1,$scope.preventSubmit=!1,$scope.parentForm.ossyear.$setValidity("yearRange",!0)):$scope.preventSubmit=!0;event&&event.keyCode==13&&$scope.checkRange()};$scope.$watch("model.range",$scope.rangeChanged,!0);$scope.checkRange=function(){$scope.model.range.yearStart!=null&&$scope.model.range.yearEnd!=null?($scope.showError=$scope.model.range.yearStart>$scope.model.range.yearEnd,$scope.showError&&$rootScope.$broadcast("yearRangeHasError",$scope.model)):$scope.showError=!1;$scope.parentForm.ossyear.$setValidity("yearRange",!$scope.showError)};$scope.$on("yearRangeHasError",function(event,model){$scope.model===model&&($scope.showError=!0,$scope.parentForm.ossyear.$setValidity("yearRange",!1))});$scope.$on("modelLoaded",function(event,domPrefix){domPrefix===$scope.domPrefix&&$scope.checkRange()})}]);
angular.module("SearchFormServiceUI").directive("sfsAllowDigitsOnly",["$window","$timeout",function($window,$timeout){function isDescendant(parent,child){for(var node=child.parentNode;node!=null;){if(node===parent)return!0;node=node.parentNode}return!1}function hasSelectedText(element){var selection,domElement,hasSelection;try{return(selection=$window.getSelection(),selection!=null&&selection.type==="Range"&&isDescendant(selection.anchorNode,$(element)[0]))?!0:(domElement=element[0],hasSelection=domElement.selectionStart!=null&&domElement.selectionEnd!=null&&domElement.selectionStart!=domElement.selectionEnd,hasSelection)}catch(ex){return!1}}var keycodes={backspace:8,deleteKey:46,tab:9,escape:27,enter:13,pageUp:33,pageDown:34,endKey:35,homeKey:36,leftArrow:37,upArrow:38,rightArrow:39,downArrow:40,a:65,v:86},allowedKeyCodes=[keycodes.backspace,keycodes.deleteKey,keycodes.tab,keycodes.escape,keycodes.enter,keycodes.pageUp,keycodes.pageDown,keycodes.endKey,keycodes.homeKey,keycodes.leftArrow,keycodes.upArrow,keycodes.rightArrow,keycodes.downArrow];return{restrict:"A",link:function(scope,element){var maxLength=parseInt($(element).attr("maxlength"))||null,maxNum=parseInt(new Array(maxLength+1).join("9"));element.bind("paste",function(){$timeout(function(){var sanitizedStr=element.val().replace(/[^0-9]/g,"");maxLength!=null&&(sanitizedStr=sanitizedStr.substr(0,Math.min(sanitizedStr.length,maxLength)));element.val(sanitizedStr)},0)});element.bind("keydown",function(e){var isMaxLengthExceeded;if($.inArray(e.keyCode,allowedKeyCodes)!==-1||e.ctrlKey===!0&&e.keyCode===keycodes.v||(e.ctrlKey===!0||e.metaKey===!0)&&e.keyCode===keycodes.a){var isNotArrowKey=e.keyCode!==keycodes.downArrow&&e.keyCode!==keycodes.upArrow,isDownArrowAboveMin=e.keyCode===keycodes.downArrow&&$(element).val()>0,isUpArrowBelowMax=e.keyCode===keycodes.upArrow;if(isUpArrowBelowMax&&maxLength!=null&&(isUpArrowBelowMax=$(element).val()<maxNum),isNotArrowKey||isDownArrowAboveMin||isUpArrowBelowMax)return;e.preventDefault()}(e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault();isMaxLengthExceeded=maxLength!=null&&$(element).val().toString().length>=maxLength;!hasSelectedText(element)&&isMaxLengthExceeded&&e.preventDefault()})}}}]);
angular.module("SearchFormServiceUI").directive("sfsCallout",["$timeout","$window",function($timeout,$window){return{restrict:"A",link:function(scope,element,attr){function returnFocus(){if(attr.sfsSetFocusAfterClose){var setFocustTo=angular.element("#"+attr.sfsSetFocusAfterClose);setFocustTo&&setFocustTo.focus()}}var isExist;element.on("$destroy",function(){scope.destroyCallout&&scope.destroyCallout()});$timeout(function(){scope.destroyCallout=function(){scope.closeCallout();isExist&&(element.callout("destroy"),isExist=!1)};scope.closeCallout=function(){element.callout("close")};scope.createCallout=function(){scope.destroyCallout();element.callout({onAfterOpen:function(){var listOfElementsToFocus,i,elementIdToFocus,elements;if(attr.sfsCalloutFocus)$("#"+attr.sfsCalloutFocus).focus();else if(attr.sfsCalloutFocusList)for(listOfElementsToFocus=scope.$eval(attr.sfsCalloutFocusList),i=0;i<listOfElementsToFocus.length;++i)if(elementIdToFocus=listOfElementsToFocus[i],elements=$("#"+elementIdToFocus+":enabled"),elements.length===1){elements.focus();break}},style:"light",type:"click",content:$("#"+attr.sfsCallout),classes:"SUI_SFS_form",position:"bottom",align:"center",keepContentInPlace:!0});isExist=!0};attr.sfsCalloutVisible?scope.$watch(attr.sfsCalloutVisible,function(newVal){newVal?scope.createCallout():scope.destroyCallout()}):scope.createCallout();attr.closeButtonId&&angular.element("#"+attr.closeButtonId).bind("click",function(){scope.$apply(function(){if(attr.sfsOnCloseButtonEvent){var isValid=scope.$eval(attr.sfsOnCloseButtonEvent);isValid&&scope.closeCallout()}else scope.closeCallout()});returnFocus()});attr.sfsCallout&&angular.element("#"+attr.sfsCallout).keyup(function(e){if(e.keyCode==13&&!$window.isIE9)if(e.stopPropagation(),attr.sfsOnCloseButtonEvent){var isValid=scope.$eval(attr.sfsOnCloseButtonEvent);isValid&&(scope.closeCallout(),returnFocus());scope.$apply()}else scope.closeCallout(),element.closest("form").submit()})})}}}]);
angular.module("SearchFormServiceUI").directive("sfsClearForm",function(){return{restrict:"A",link:function(scope,element,attr){element.on("click",function(){scope.$apply(function(){scope.$root.$broadcast("clearFormEvent",scope.domPrefix);scope[attr.sfsClearForm].$setPristine()})})}}});
angular.module("SearchFormServiceUI").directive("sfsPreventSubmit",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){event.which===13&&attrs.sfsPreventSubmit.toLowerCase()==="true"&&event.preventDefault()})}});
angular.module("SearchFormServiceUI").directive("sfsFocusOnce",function(){return function(scope,element,attrs){var setFocus=attrs.sfsFocusOnce.toLowerCase()==="true";setFocus&&element[0].focus()}});
angular.module("SearchFormServiceUI").directive("sfsLocation",["$window","$timeout","sfsLocationExactnessProvider",function($window,$timeout,sfsLocationExactnessProvider){return{restrict:"E",replace:!0,scope:{event:"=",gpidName:"@",inputDomId:"@",autoname:"@",maxResults:"@",domPrefix:"@",notifyTextChanged:"&onTextChange",gpidHintEnabledAttr:"@gpidHintEnabled"},template:'<div><span data-ng-if="gpidHintEnabled" data-ng-show="showGpidHint" style="color: #4272A7;" class="errorMessage icon iconInfo">{{strings.gpidHint}}<\/span><input autocomplete="off" class="placepicker" type="text" id="{{inputDomId}}" name="{{gpidName}}__ftp" data-ng-class="{\'error error-blue\': showNoGpidHint}" data-ng-change="textChanged()" placeholder="{{strings.placeholder}}" data-ng-model="event.location" data-autoname="PlacePickerTextBox" /><input type="hidden" name="{{gpidName}}" value="{{event.gpid}}" data-ng-if="event.gpid.length > 0" /> <input type="hidden" name="{{gpidName}}_PInfo" value="{{pinfo}}" data-ng-if="event.gpid.length > 0" /><\/div>',link:function(scope){function updatePlaceWithAutcompleteValue(autoCompleteValue){sfsLocationExactnessProvider.cachePlaceByPrefixResponse(autoCompleteValue);scope.$apply(function(){scope.event.gpid=autoCompleteValue.Id.toString();scope.event.location=autoCompleteValue.HName;scope.showGpidHint=!1})}function selectAutocompleteValueIfTextMatches(autocompleteValues){var i,matchedPlace;if(!scope.event.gpid&&autocompleteValues&&autocompleteValues.length>0)for(i=0;i<autocompleteValues.length;i++)if(trimSpacesAndLowerCase(scope.event.location)===trimSpacesAndLowerCase(autocompleteValues[i].HName)){matchedPlace=autocompleteValues[i];updatePlaceWithAutcompleteValue(matchedPlace);break}}function trimSpacesAndLowerCase(placeStr){for(var parts=placeStr.split(","),i=0;i<parts.length;i++)parts[i]=[parts[i].toLowerCase().trim()];return parts.join()}function updatePlacePickerHintVisibility(){scope.gpidHintEnabled&&scope.$apply(function(){scope.showGpidHint=!scope.event.gpid&&scope.event.location.length>=minLengthForAutocompleteToShow})}var minLengthForAutocompleteToShow=3,sfsData=$window[scope.domPrefix+"sfsData"],metadata=$window[scope.domPrefix+"ScopeMetadata"],eventPlaceStrs=sfsData.eventPlace,placePickerSourceUrl,placePickerResults;scope.pinfo=null;scope.gpidHintEnabled=scope.gpidHintEnabledAttr&&metadata.form.type==="OldSearchSimulator";scope.strings={gpidHint:eventPlaceStrs.gpidHint,placeholder:eventPlaceStrs.placeholder};scope.$watch("event.gpid",function(){scope.pinfo=null;scope.event.gpid!=null&&scope.event.gpid.length>0&&scope.event.location!=null&&scope.event.location.length>0&&sfsLocationExactnessProvider.getPlaceInfoByPrefixMatchingGpid(scope.domPrefix,scope.event.location,scope.event.gpid,function(err,placeInfo){err||(scope.pinfo=placeInfo.level+"-|"+placeInfo.idHierarchy.join("|")+"|")})});scope.textChanged=function(){scope.event.gpid=null;scope.event.locationExactness.level=scope.event.locationExactness.isExact?0:null;scope.event.locationExactness.isAdjacent=!1;scope.notifyTextChanged()};placePickerSourceUrl=(eventPlaceStrs.placePickerUrl||"//placepfx.ancestry.com/s/")+"?maxCount="+(scope.maxResults||8)+"&cultureId="+(sfsData.cultureId||"en-US");$timeout(function(){$("#"+scope.inputDomId).autocomplete({customDisplay:function(data){return{display:data.value,value:data.value}},dataType:"jsonp",jsonConversion:function(data){return placePickerResults=data,data},key:"HName",minLength:minLengthForAutocompleteToShow,onClose:function(event,$resultContainer,formattedData){$.autocomplete.version===1?selectAutocompleteValueIfTextMatches(formattedData):selectAutocompleteValueIfTextMatches(placePickerResults);updatePlacePickerHintVisibility()},onResultSelect:function(input){var data=input.attr("data-extra"),savedResponse=data?$.parseJSON(data):input.data("raw");updatePlaceWithAutcompleteValue(savedResponse)},queryParameter:"prefix",source:placePickerSourceUrl,sourceUrl:placePickerSourceUrl,queryString:"prefix",saveResponse:!0,preFiltered:!0,itemHandler:function(value){return{inputText:value,displayText:value}}})})}}}]);
angular.module("SearchFormServiceUI").directive("sfsLocationExactness",["$window","sfsLocationExactnessProvider",function($window,sfsLocationExactnessProvider){var uniqueId=0;return{restrict:"E",replace:!0,scope:{event:"=",gpidKey:"@",domPrefix:"@",autonamePrefix:"@"},templateUrl:"/sfs-location-exactness.html",link:function(scope){function getCurrentPlaceExactnessByAcronym(){var placeExactness=null;return scope.relativeExactnesses.forEach(function(loopPlaceExactness){loopPlaceExactness.acronym===scope.exactnessAcronym&&(placeExactness=loopPlaceExactness)}),placeExactness}function onGpidChanged(){if(scope.event.gpid==null||scope.event.gpid.length===0){scope.relativeExactnesses.length=0;scope.exactnessAcronym=null;return}sfsLocationExactnessProvider.getPlaceInfoByPrefixMatchingGpid(scope.domPrefix,scope.event.location,scope.event.gpid,function(){var exactnesses=sfsLocationExactnessProvider.getExactnesses(scope.domPrefix,scope.event.gpid),firstExactness,i,relativeExactness;if(scope.relativeExactnesses.length=0,scope.relativeExactnesses.push.apply(scope.relativeExactnesses,exactnesses),scope.relativeExactnesses.length>0&&(firstExactness=scope.relativeExactnesses.splice(0,1,exactToThisPlaceExactness)[0],exactToThisPlaceExactness.exactnessStringWhenOneExactnessChoice=firstExactness.exactnessString),scope.exactnessAcronym=null,scope.event.locationExactness.isExact){for(scope.exactnessAcronym="1",i=0;i<scope.relativeExactnesses.length;++i)if(relativeExactness=scope.relativeExactnesses[i],relativeExactness.relativeLevel===scope.event.locationExactness.level&&relativeExactness.isAdjacent===scope.event.locationExactness.isAdjacent){scope.exactnessAcronym=relativeExactness.acronym;break}scope.exactnessAcronym==="1"&&(scope.event.locationExactness.level=0,scope.event.locationExactness.isAdjacent=!1)}})}function syncPlaceExactness(){scope.exactnessAcronym=null;scope.relativeExactnesses.forEach(function(placeExactness){scope.event.locationExactness.level===placeExactness.relativeLevel&&scope.event.locationExactness.isAdjacent===placeExactness.isAdjacent&&(scope.exactnessAcronym=placeExactness.acronym)})}var sfsData,exactnessStrs,eventPlaceStrs,exactToThisPlaceExactness;++uniqueId;scope.exactnessAcronym=null;scope.uniquePrefix=scope.domPrefix+"-sfsLocationExactness-"+uniqueId;scope.calloutId=scope.uniquePrefix+"-place-callout";scope.exactInputId=scope.uniquePrefix+"-exact";sfsData=$window[scope.domPrefix+"sfsData"];scope.searchDomain=sfsData.searchDomain;exactnessStrs=sfsData.eventPlaceExactnessDisplay;eventPlaceStrs=sfsData.eventPlace;scope.strings={exactTo:eventPlaceStrs.exactTo,aboutTheseSettings:eventPlaceStrs.aboutTheseSettings};scope.relativeExactnesses=[];exactToThisPlaceExactness={relativeLevel:0,absoluteLevel:-1,isAdjacent:!1,acronym:"1",optionString:sfsData.eventPlaceExactnessSelectDisplay["1"],exactnessString:exactnessStrs.exactToThisPlace,exactnessStringWhenOneExactnessChoice:exactnessStrs.exactToThisPlace};scope.$watch("event.gpid",onGpidChanged);scope.$watch("event.locationExactness",syncPlaceExactness,!0);scope.getExactnessButtonText=function(){if(scope.relativeExactnesses.length===0)return eventPlaceStrs.exact;if(scope.relativeExactnesses.length===1)return scope.relativeExactnesses[0].exactnessStringWhenOneExactnessChoice;if(!scope.event.locationExactness.isExact)return eventPlaceStrs.exactTo;if(scope.event.locationExactness.level===0&&!scope.event.locationExactness.isAdjacent)return exactnessStrs.exactToThisPlace;var placeExactness=getCurrentPlaceExactnessByAcronym();return scope.event.locationExactness.level==null||placeExactness==null?eventPlaceStrs.exact:placeExactness.exactnessString};scope.updateIsExact=function(isExact){scope.event.locationExactness.isExact=isExact;scope.event.locationExactness.isExact?(scope.exactnessAcronym=scope.exactnessAcronym||"1",scope.event.locationExactness.level=scope.event.locationExactness.level||0):(scope.exactnessAcronym=null,scope.event.locationExactness.level=null,scope.event.locationExactness.isAdjacent=!1)};scope.placeExactnessChanged=function(){var placeExactness=getCurrentPlaceExactnessByAcronym();scope.event.locationExactness.isExact=!0;scope.event.locationExactness.level=placeExactness.relativeLevel;scope.event.locationExactness.isAdjacent=placeExactness.isAdjacent}}}}]);
angular.module("SearchFormServiceUI").directive("sfsNameExactness",["$window",function($window){var uniqueId=0;return{restrict:"E",replace:!0,scope:{name:"=",domPrefix:"@",isGivenName:"="},template:'<div class="exact-filter" data-ng-show="name[nameProp].length > 0"><input type="hidden" name="{{searchKey}}_x" data-ng-if="name[nameProp].length > 0" value="{{exactnessString}}" data-submit-default="" /><button type="button" data-ng-class="{iconCheck: exactness.isExact, inputBox: !exactness.isExact}" class="link icon locationButton" data-ng-click="enableNameExactness()" data-sfs-callout="{{calloutId}}" data-sfs-callout-focus="{{calloutExactInputId}}" data-autoname="{{autoname}}">{{exactnessLabel}}<\/button><div id="{{calloutId}}" class="{{moduleClass}} form SUI_SFS_form calloutDomContent"><div><input class="checkbox" id="{{calloutExactInputId}}" type="checkbox" data-autoname="ExactAnd" data-ng-change="updateNameExactness()" data-ng-model="exactness.isExact"><label for="{{calloutExactInputId}}">{{strings.exactAndEllipsisText}}<\/label><\/div><div class="indent" data-ng-repeat="chk in exactnessCheckboxes" data-ng-init="checkboxId = $parent.calloutExactCheckboxIdPrefix + chk.prop"><input class="checkbox" id="{{checkboxId}}" type="checkbox" data-autoname="{{chk.autoname}}" data-ng-model="exactness.flags[chk.prop]" data-ng-change="exactness.isExact = true"><label for="{{checkboxId}}">{{chk.label}}<\/label><\/div><div class="about"><button class="link" type="button" data-autoname="Settings" data-sfs-show-help-for="{{showHelpForName}}" data-search-domain="{{searchDomain}}">{{strings.aboutTheseSettingsText}}<\/button><\/div><\/div><\/div>',link:function(scope){function getExactnessText(){var exactText=scope.strings.exactText,labels,lastLabel;return scope.exactness.isExact?(labels=[exactText],$.each(scope.exactnessCheckboxes,function(checkboxIndex,checkboxObj){scope.exactness.flags[checkboxObj.prop]&&labels.push(checkboxObj.label.toLowerCase())}),labels.length===1)?labels[0]:(lastLabel=labels.pop(),labels.join(", ")+" & "+lastLabel):exactText+"..."}function updateExactnessString(){if(scope.exactness.isExact){var exactnessStrArr=[],flagToExactnessStrMap=metadata.name.flagToExactnessStrMap;$.each(scope.exactness.flags,function(flagName,flagBoolValue){flagBoolValue===!0&&(scope.exactness.isExact=!0,exactnessStrArr.push(flagToExactnessStrMap[flagName]))});scope.exactnessString=exactnessStrArr.length===0?"1":exactnessStrArr.join("_")}else scope.exactnessString="0";scope.exactnessLabel=getExactnessText()}++uniqueId;var uniqueNamePrefix=scope.domPrefix+"sfsNameExactness-"+uniqueId,metadata=$window[scope.domPrefix+"ScopeMetadata"],sfsData=$window[scope.domPrefix+"sfsData"],sfsDataCheckboxes=scope.isGivenName?sfsData.name.firstNameCheckboxes:sfsData.name.lastNameCheckboxes;scope.strings=sfsData.name;scope.nameProp=scope.isGivenName?"givenName":"surname";scope.exactness=scope.isGivenName?scope.name.givenNameExactness:scope.name.surnameExactness;scope.searchKey=scope.isGivenName?"gsfn":"gsln";scope.exactnessString="0";scope.exactnessLabel=scope.strings.exactText;scope.showHelpForName=scope.isGivenName?"fname":"lname";scope.moduleClass=scope.isGivenName?"SUI_SFS_FirstNameExact_Container":"SUI_SFS_LastNameExact_Container";scope.autoname=scope.isGivenName?"FirstNameExact":"LastNameExact";scope.calloutId=uniqueNamePrefix+"-callout";scope.calloutExactInputId=uniqueNamePrefix+"-callout-input";scope.calloutExactCheckboxIdPrefix=uniqueNamePrefix+"-callout-checkbox-";scope.searchDomain=sfsData.searchDomain;scope.exactnessCheckboxes=$.extend(!0,[],sfsDataCheckboxes);scope.enableNameExactness=function(){scope.exactness.isExact||(scope.exactness.isExact=!0,updateExactnessString())};scope.updateNameExactness=function(){scope.exactness.isExact||$.each(scope.exactness.flags,function(key){scope.exactness.flags[key]=!1});updateExactnessString()};scope.$watch("name."+scope.nameProp+"Exactness",updateExactnessString,!0)}}}]);
angular.module("SearchFormServiceUI").directive("sfsNosubmit",function(){return{restrict:"A",link:function(scope,element,attrs){attrs.sfsNosubmit!==undefined&&attrs.sfsNosubmit.toLowerCase()==="true"&&element.closest("form").bind("submit",function(){element.find("input").attr("disabled","disabled")})}}});
angular.module("SearchFormServiceUI").directive("sfsPersonPicker",["$timeout","sfsCookies","sfsPersonPickerService",function($timeout,sfsCookies,sfsPersonPickerService){return{restrict:"A",link:function(scope,element,attrs){function loadTreeData(){$.getJSON(personPickerUrl+"trees/?callback=?",null,function(treeData){var cookieTreeId,selectedTrees;(personPickerTreeList=treeData,treeData!=null&&treeData.AllTrees!=null&&treeData.AllTrees.length!==0)&&(cookieTreeId=sfsCookies.get("personPickerSelectedTreeId"),treeData.SelectedTree||(cookieTreeId!=null&&(selectedTrees=treeData.AllTrees.filter(function(tree){return tree.TreeId===cookieTreeId}),treeData.SelectedTree=selectedTrees.length>0?selectedTrees[0]:null),treeData.SelectedTree=treeData.SelectedTree||(treeData.AllTrees.length>0?treeData.AllTrees[0]:null)),treeData.SelectedTree!=null)&&(selectedTreeId=treeData.SelectedTree.TreeId,treeData.SelectedTree.TreeId!==cookieTreeId&&sfsCookies.set("personPickerSelectedTreeId",treeData.SelectedTree.TreeId,365),createAutocomplete(treeData,selectedTreeId),$(element).is(":focus")&&$(element).trigger("focus"))})}function createAutocomplete(treeData,tid){var tidStr=typeof tid!="undefined"?tid+"/":"";element.autocomplete({source:personPickerUrl+"suggest/"+tidStr,customDisplay:function(data){var itemData=data.raw,dateRange="",displayHtml;return itemData.BirthYear!=null&&(dateRange=itemData.BirthYear+"-"),itemData.DeathYear!=null&&(dateRange+=itemData.DeathYear),itemData.FormattedFullName?displayHtml=$("<div/>").html(itemData.FormattedFullName).text().replace(/(\$];)(\s+)(\$\[;)/g,"$1<span> <\/span>$3").replace(/\$\[;/g,'<span class="autocompleteHighlighted">').replace(/\$];/g,"<\/span>"):(displayHtml=$("<div/>").html(itemData.FirstName+" "+itemData.LastName).text(),itemData.GivenName=itemData.FirstName),displayHtml='<span class="sfsPersonPickerExtraData">'+dateRange+"<\/span>"+displayHtml,{value:itemData.GivenName,display:displayHtml}},dataType:"jsonp",key:"GivenName",minLength:3,onOpen:function($resultContainer,$before){$.autocomplete.version===1?initAutoCompleteTreeSelection($before,treeData):initAutoCompleteTreeSelection($resultContainer,treeData)},onResultSelect:function(input){var data=input.attr("data-extra"),person=data?$.parseJSON(data):input.data("raw");$.getJSON(personPickerUrl+"person/"+person.TreeId+"/"+person.PersonId+"/?callback=?",null,function(personPickerResponse,textStatus){textStatus==="success"&&sfsPersonPickerService.updateModelFromPersonPickerResponse(scope.domPrefix,personPickerResponse)})},queryParameter:"partialFirstName",sourceUrl:personPickerUrl+"suggest/"+tidStr,queryString:"partialFirstName",isPrefix:!1,saveResponse:!0,itemHandler:function(value,itemData){var dateRange="",displayHtml;return itemData.BirthYear!=null&&(dateRange=itemData.BirthYear+"-"),itemData.DeathYear!=null&&(dateRange+=itemData.DeathYear),itemData.FormattedFullName?displayHtml=$("<div/>").html(itemData.FormattedFullName).text().replace(/\$\[;/g,'<span class="autocompleteHighlighted">').replace(/\$];/g,"<\/span>"):(displayHtml=$("<div/>").html(itemData.FirstName+" "+itemData.LastName).text(),itemData.GivenName=itemData.FirstName),displayHtml+='<span class="sfsPersonPickerExtraData">'+dateRange+"<\/span>",{inputText:itemData.GivenName,displayText:displayHtml}}})}function initAutoCompleteTreeSelection(autocompleteResultContainer,treeData){var treeSelectionContainer=autocompleteResultContainer.find(".sfsTreeSelectionContainer"),treeContainer,treeSelect,i,tree;if(treeData!=null&&!treeSelectionContainer.length)if(treeData.AllTrees.length>1){for(treeContainer=autocompleteResultContainer.append('<div class="sfsTreeSelectionContainer form"><hr />'+treeSelectionLabel+" <select /><\/div>"),treeSelect=treeContainer.find(".sfsTreeSelectionContainer select"),i=0;i<treeData.AllTrees.length;++i)tree=treeData.AllTrees[i],treeSelect.append($("<option>",{value:tree.TreeId,text:tree.Name,selected:tree.TreeId===selectedTreeId}));treeSelect.change(function(){var optionSelected=$(this).find("option:selected");selectedTreeId=optionSelected.val();$.getJSON(personPickerUrl+"setselectedtree/"+selectedTreeId+"/?callback=?",null,function(){});sfsCookies.set("personPickerSelectedTreeId",selectedTreeId,365);element.blur();createAutocomplete(treeData,selectedTreeId);element.focus()})}else autocompleteResultContainer.append('<span class="sfsTreeSelectionContainer">'+treeLabel+" "+treeData.SelectedTree.Name+"<\/span>")}if(!scope.sfsData.user.isInstitutional&&scope.sfsData.personPicker.enabled){var treeSelectionLabel=scope.sfsData.personPicker.treeSelectionLabel,treeLabel=scope.sfsData.personPicker.treeLabel,personPickerUrl=attrs.sfsPersonPicker||"//search.ancestry.com/personpicker/",personPickerTreeList=null,selectedTreeId=null,allowTreeRequestForTabKey=!0;element.bind("mousedown",function(){personPickerTreeList||loadTreeData()}).bind("keyup",function(event){event.which!==9||personPickerTreeList||$timeout(function(){allowTreeRequestForTabKey?loadTreeData():allowTreeRequestForTabKey=!0},500)}).bind("blur",function(){allowTreeRequestForTabKey=!1})}}}}]);
angular.module("SearchFormServiceUI").directive("sfsRequired",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs){function refreshElementStyle(){element.val()?setSuccessStyle():setErrorStyle()}function setInitialStyle(){element.removeClass("error");elementLabel.removeClass("error").removeClass("success").siblings('[class="errorMessage icon iconWarning"]').remove()}function setSuccessStyle(){element.removeClass("error");elementLabel.removeClass("error").addClass("success").siblings('[class="errorMessage icon iconWarning"]').remove()}function setErrorStyle(){element.addClass("error");elementLabel.removeClass("success").addClass("error");elementLabel.siblings('[class="errorMessage icon iconWarning"]').length<1&&elementLabel.after('<span class="errorMessage icon iconWarning"><\/span>')}if(attrs.sfsRequired.toLowerCase()==="true"){element.attr("required","true");var elementLabel=angular.element("label[for="+attrs.id+"]");elementLabel.addClass("required");elementLabel.css("float","left");element.bind("blur",function(){refreshElementStyle()});element.closest("form").bind("submit",function(){element.val().length<1&&setErrorStyle()});element.prop("tagName").toUpperCase()==="SELECT"&&element.bind("change",function(){refreshElementStyle()});scope.$on("clearFormEvent",function(event,domPrefix){domPrefix===scope.domPrefix&&setInitialStyle()})}}}});
angular.module("SearchFormServiceUI").directive("sfsRestoreFocus",["$timeout","$parse",function($timeout,$parse){function linkFn(scope,element,attrs){scope.focusToNextRow=function(currentRowIndex){var rows=attrs.$$element.find(".sfsPanel").children("fieldset"),rowToFocus,elementsToFocus;if(rows.length-1<=0){$timeout(function(){angular.element($parse(attrs.sfsRestoreFocus)(scope)).focus()});return}rowToFocus=rows.length-1>currentRowIndex?rows[currentRowIndex+1]:rows[currentRowIndex-1];elementsToFocus=$(rowToFocus).find("input").filter(":visible");elementsToFocus!=null&&elementsToFocus.length>0&&elementsToFocus.first().focus()}}return{restrict:"A",link:linkFn}}]);
function getQueryStringForQuerySetV1(queryParams,formElement){for(var paramsWithZero,queryString,paramKey,formData=$(formElement).serialize(),pairs=formData.split("&"),i=0;i<pairs.length;i++){var pair=pairs[i].split("="),key=decodeURIComponent(pair[0].replace(/\+/g," ")),value=decodeURIComponent(pair[1].replace(/\+/g," "));key&&value&&(queryParams[key]=value)}paramsWithZero={};formElement.find("input[data-submit-default], select[data-submit-default]").each(function(){!this.value||this.value.toString()!==this.attributes["data-submit-default"].value?this.value==="0"&&(paramsWithZero[this.name]=this.value):delete queryParams[this.name]});formElement.find("input[data-no-submit], select[data-no-submit]").each(function(){delete queryParams[this.name]});queryString="";for(paramKey in queryParams)(queryParams[paramKey]!=="0"||paramsWithZero[paramKey]!==undefined)&&(queryString&&(queryString+="&"),queryString+=encodeURIComponent(paramKey)+"="+encodeURIComponent(queryParams[paramKey]));return queryString}function getQueryStringForQuerySetV2(queryParams,searchModel,metadata,urlCanonicalizer,dataModelProvider){var searchModelCopy=$.extend(!0,{},searchModel),queryString;return searchModelCopy.page.number=1,searchModelCopy.page.cursor="",dataModelProvider.limitDataModelToFieldsOnSearchForm(metadata.form.domPrefix,searchModelCopy,metadata.form.fieldNames),queryString=urlCanonicalizer.queryParamNormalizer.toQueryParams(searchModelCopy,"searchResults",null).queryString,queryParams.debug&&queryParams.debug==="1"&&(queryString+="&debug=1"),queryString}var isDebugEnabledRegex=/[?&]debug=(1|true)(&|$)/gi;angular.module("SearchFormServiceUI").directive("sfsSafeSubmit",["$window","urlCanonicalizerProvider","sfsDataModelProvider","userPreferences",function($window,urlCanonicalizerProvider,sfsDataModelProvider,userPreferences){return{restrict:"A",link:function(scope,element,attr){var formDataElement=$("#"+scope.metadata.form.dataFieldId),searchModel=scope.model,metadata=scope.metadata;element.bind("submit",function(event){var queryParams,isV1QuerySet,queryString,searchResultsUrl;if(event.preventDefault(),!(element.closest("form").find(".error").length>0)){if(element.find(":submit").val(attr.sfsSafeSubmit).addClass("disabled").prop("disabled",!0),formDataElement.val(JSON.stringify({dataModel:searchModel,viewModel:{}})),queryParams={},isV1QuerySet=metadata.querySetVersion==="V1"||metadata.querySetVersion!=="V2",isV1QuerySet){queryString=getQueryStringForQuerySetV1(queryParams,element);searchResultsUrl=element[0].action+"?"+queryString;$window.location.href=searchResultsUrl;return}userPreferences.saveUserPreferences(scope.domPrefix,function(){queryParams.debug=isDebugEnabledRegex.test($window.location.search)?"1":"0";var canonicalizer=urlCanonicalizerProvider.getUrlCanonicalizer(),queryString=getQueryStringForQuerySetV2(queryParams,searchModel,metadata,canonicalizer,sfsDataModelProvider),searchResultsUrl=element[0].action+"?"+queryString;$window.location.href=searchResultsUrl})}});scope.$on("clearFormEvent",function(event,domPrefix){domPrefix===scope.domPrefix&&formDataElement.val("")})}}}]);
angular.module("SearchFormServiceUI").directive("sfsShowHelpFor",function(){return{restrict:"A",link:function(scope,element,attr){element.bind("click",function(){window.open(attr.searchDomain+"/Search/Help/SearchForm.aspx?topic="+attr.sfsShowHelpFor,"_blank","toolbar=yes, location=yes, directories=no, status=no, menubar=yes, scrollbars=yes, resizable=no, copyhistory=yes, width=640, height=480")})}}});
angular.module("SearchFormServiceUI").directive("sfsUserIdHash",function(){return{restrict:"A",scope:!1,link:function(scope,element){try{element.val(Ancestry.SFS.Settings.UserIdHash)}catch(e){element.val("")}}}})