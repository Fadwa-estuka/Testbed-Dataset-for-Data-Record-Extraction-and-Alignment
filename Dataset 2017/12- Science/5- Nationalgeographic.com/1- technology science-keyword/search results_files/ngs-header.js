/**
 * ! ngs-header - v1.4.2
 * 2016-05-09
 * Copyright (c) 2016 | ;
**/
!function(a,b){_M.ready(function(c){function d(a){var b,c,e=1;for(c in a)a.hasOwnProperty(c)&&"object"==typeof a[c]&&(b=d(a[c])+1,e=Math.max(b,e));return e}function e(){return a.cookieEnabled?!0:!1}function f(a){var b=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);return null===b?null:b[1]||0}function g(){return null===localStorage.getItem("memFrag/RegSource")?"":JSON.parse(localStorage.getItem("memFrag/RegSource"))}function h(a,d){var e=[],f=new b.Deferred;return d=d||5,b.ajax({url:c.config.get("externalRoutes.geoplaces"),data:{q:a},dataType:"jsonp"}).done(function(a){var b,c;for(b=0;b<a.cities.length&&d-1>=b;b++)c={name:a.cities[b].name+", "+a.cities[b].adminname1+", "+a.cities[b].countryname,id:a.cities[b].gid},e.push(c);f.resolve(e)}),f}function i(a){var c,d,e=[],f=[],g={},h=5;for(c=0;c<a.cities.length&&h-1>=c;c++){var i="",j=a.cities[c].name,k=a.cities[c].adminname1,l=a.cities[c].countryname;"None"!==j&&(i+=a.cities[c].name),"None"!==k&&(""!==i&&(i+=", "),i+=k),"None"!==l&&(""!==i&&(i+=", "),i+=l),d={name:i,id:a.cities[c].gid},e.push(d)}return b.each(e,function(a,b){g[b.name]=b,f.push(b.name)}),{names:f,geoResults:g}}function j(){var a=new Uri(window.location),b={regReferrer:document.referrer||"",regUrl:a.toString()||"",regSource:a.getQueryParamValue("rptregsrc")||"",regCTA:a.getQueryParamValue("rptregcta")||"",regCampaign:a.getQueryParamValue("rptregcampaign")||""};localStorage.setItem("memFrag/RegSource",JSON.stringify(b))}function k(){var b=a.userAgent.match(/(opera|chrome|safari|firefox|msie|trident|fbav)\/?\s*(\.?\d+(\.\d+)*)/i),c={CHROME:{name:"Google Chrome",codename:"Chrome"},SAFARI:{name:"Apple Safari",codename:"Safari"},FIREFOX:{name:"Mozilla Firefox",codename:"Firefox"},MSIE:{name:"Microsoft Internet Explorer",codename:"MSIE"},OPERA:{name:"Opera",codename:"Opera"},TRIDENT:{name:"Microsoft Internet Explorer",codename:"Trident"},FBAV:{name:"Facebook In-App Browser",codename:"FacebookApp"},"default":{name:"Unknown",codename:"Unknown"}};return c[b&&b[1].toUpperCase()||"default"]}function l(){var a="memFrag/fromAction",b=localStorage.getItem(a);null!==b&&m(b),localStorage.removeItem(a)}function m(a){b().ready(function(){var b=document.getElementById(a);b&&window.scrollTo(b.offsetLeft,b.offsetTop)})}function n(){window.fbAsyncInit=function(){FB.init({status:!0,xfbml:!0})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/all.js#xfbml=1",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk"),setTimeout(function(){"undefined"!=typeof FB&&null!==FB&&FB.XFBML.parse()},100)}function o(a,b,c){var d,e=[];if(c)for(d=b;d>=a;d--)e.push(d);else for(d=a;b>=d;d++)e.push(d);return e}function p(){return _M.getConfig("buckets").bucket1()}function q(){return!this.isMobile()}var r="util";Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){if(void 0===this||null===this)throw new TypeError('"this" is null or not defined');var c=this.length>>>0;for(b=+b||0,Math.abs(b)===1/0&&(b=0),0>b&&(b+=c,0>b&&(b=0));c>b;b++)if(this[b]===a)return b;return-1}),j(),l(),_M.Util={module:r,browser:{isCookiesEnabled:e(),whatBrowser:k()},depthOf:d,getRegSource:g,geoDataSuggest:h,fbFacepile:n,formatGeoData:i,range:o,setRegSource:j,urlParam:f,isMobile:p,isDesktop:q}},{},1)}(navigator,_M.$),function(a){_M.ready(function(b){function c(){function d(a){var b=new Uri(h.memFragConfig.memcenHost);return void 0!==h.memFragConfig.noSSL&&h.memFragConfig.noSSL?b.setProtocol("http"):b.setProtocol("https"),b.toString()+a}function e(){a.memFragConfig&&(h.memFragConfig=a.memFragConfig,a.memFragConfig=void 0)}function f(a,c){var e,f,g,i,j=h,k={},l=a.split(/[.\[\]]+/),m={};for(f=0;f<l.length;f++){if(e=l[f],void 0===j[e])return b._E.warn("Property: ["+e+"] Not Found"),!1;if("headerRoutes"===e){m={},i=j[e];for(g in i)i.hasOwnProperty(g)&&(m[g]=d(i[g]));j=m}else j="function"==typeof j[e]?j[e](c):j[e]}return k.name=e,k.value=j,k}function g(a){var b,c,d={};for(c=0;c<a.length;c++)b=f(a[c]),void 0!==b.name?d[b.name]=b.value:d[b.name]=!1;return d}var h={defaults:{STATIC_MEDIA:a.memFragConfig.staticMedia},header:{signin:"#sign_in",join:"#join"},validation:{formValidation:""+a.memFragConfig.memcenHost+"/header/can_user_register/",profanity:""+a.memFragConfig.memcenHost+"/check_profanity/",geodata:""+a.memFragConfig.memcenHost+"/places/geodatasuggest/",resend_vemail:""+a.memFragConfig.mmdbHost+"/user/"},templates:""+a.memFragConfig.memcenHost+"/members/",headerRoutes:{base:"/",native_login:"/header/native_login/",social_login:"/header/social_login/",social_register:"/header/social_register/",lucie_register:"/header/lucie_register/",native_reg:"/header/native_register/",native_reg_avatar:"/header/original_avatar/",logout:"/header/logout/",server_context:"/header/server_context/",forgotPassword:"/header/forgot_password/",resetPassword:"/header/reset_password/",get_notifications:"/header/notifications/inbox/",resend_vemail:"/header/resend_verification-email/",cors_handler:"/cors_handler2/"},localRoutes:{site_sync:"/header/site-sync/"},cookie_support:{firefox:"http://support.mozilla.org/en-US/kb/enable-and-disable-cookies-website-preferences",chrome:"https://support.google.com/chrome/answer/95647?hl=en&p=cpn_cookies",ie:"http://windows.microsoft.com/en-us/internet-explorer/delete-manage-cookies#ie=ie-8",safari:"http://support.apple.com/kb/PH5042?viewlocale=en_US&locale=en_US"},externalRoutes:{geoplaces:"https://geodata.nationalgeographic.com/search/api/geosearch.jsonp"},notifications:{apiHost:a.memFragConfig.notificationsHost,apiKey:a.memFragConfig.notificationsKey,inbox:""+a.memFragConfig.memcenHost+"/header/notifications/inbox/",unread:""+a.memFragConfig.notificationsHost+"/api/1.0/inbox/"}};this.get=function(a,d){var e;if(this instanceof c){if(a instanceof Array)return g(a);if("all"===a)return h;if("list"===a)b._E.log(h);else{if("string"==typeof a)return e=f(a,d),e.value;b._E.error("You must input an array or request all.")}}else b._E.error("Unauthorized Request")},e()}var d="config";_M.attach(d,new c)},{},1)}(window),function(a){var b=window.Handlebars.helpers;b.checkerror||a.registerHelper("checkerror",function(b,c){var d,e=b,f=this.errors,g=f[e];return g?(d=a.createFrame(c.data||{}),d.errorText=g,c.fn(this,{data:d})):c.inverse(this)}),b.fullname||a.registerHelper("fullname",function(){if(window.jQuery){var a=window.jQuery(document).data("reg_form_data"),b="";return a.firstName&&(b+=a.firstname),a.middleName&&(b+=" "+a.middleName),a.lastName&&(b+=" "+a.lastName),b}}),b.is_selected||a.registerHelper("is_selected",function(a,b){return a!==b?"":' selected="selected"'}),b.debug||a.registerHelper("debug",function(a){console.log(""),console.log("Current Context"),console.log("===================="),console.log(this),console.log(""),a&&(console.log("Value"),console.log("===================="),console.log(a)),console.log("")}),b.displayAvatar||a.registerHelper("displayAvatar",function(){var a=localStorage.getItem("memFrag/User/avatarInUse"),b=localStorage.getItem("memFrag/User/uploadedAvatar"),c=localStorage.getItem("memFrag/User/facebookAvatar"),d=this.HEADER_STATIC_MEDIA+"views/images/nationalGeographic_default_avatar.jpg";return"null"===a&&(a=null),"null"===c&&(c=null),"custom"===a&&b?d=b:"social"===a&&c&&(d=c),d.replace(/^\/\//,"http://"),d}),b.math||a.registerHelper("math",function(a,b,c){return a=parseFloat(a),c=parseFloat(c),{"+":a+c,"-":a-c,"*":a*c,"/":a/c,"%":a%c}[b]}),b.checkError||a.registerHelper("checkError",function(a,b,c){return a===b?c.fn(this):c.inverse(this)}),b.unless_embedded_browser||a.registerHelper("unless_embedded_browser",function(a){var b,c,d,e=window.navigator.userAgent.toLowerCase();return/iphone|ipod|ipad/.test(e)&&(b=window.navigator.standalone,c=/safari/.test(e),d=!(b||c)),d?a.inverse(this):a.fn(this)})}(window.Handlebars),function(a,b,c,d){_M.ready(function(a){function b(){return c.ajax({url:a.config.get("localRoutes.base")})}var d=a.config.get("memFragConfig").debug_lvl,e=new ErrorHandler({debug:d?d:0});_M.attach("_E",e),e.subscribe("MMDB_TIMEOUT",function(){function a(){setTimeout(function(){b().done(function(){e.removeState("MMDB_NOT_AVAILABLE")}).fail(function(b){404===b.status?e.removeState("MMDB_NOT_AVAILABLE"):(c=5*c,a())})},c)}e.addState("MMDB_NOT_AVAILABLE");var c=1e3;a()})},{},1)}(window,document,_M.$,void 0),function(window,document,$){_M.ready(function(core){function DialogManager(){function destroy(a){return dialogs[a]?(dialogs[a]._reject(),delete dialogs[a],!0):!1}function extend(a,b){if(templates[a])throw new E("A template by that name already exists",module,a);return templates[a]=b,!0}function isCached(a){return void 0===cache[a]?!1:cache[a]}function intoCache(template){cache[template.template_name].template=template.template,cache[template.template_name].context=template.context,cache[template.template_name].rendered=eval(template.template)(template.context)}function createCache(a,b){cache[a]={},cache[a].dfd=b}function getBaseContext(){return baseContext}function loadTemplate(a,b){core._E.info("loading template",module,a);var c=new $.Deferred,d={};return isCached(a)?(core._E.info("template is cached",module,a),"pending"===cache[a].dfd.state()?$.when(cache[a].dfd).done(function(){c.resolve(a)}):c.resolve(a)):templates[a]?(createCache(a,c),d.template=templates[a],d.template_name=a,d.baseContext=baseContext,d.context=$.extend(!0,{},b,d.baseContext),core._E.info("Context Object for Modal",module,d.context),intoCache(d),c.resolve(a)):(core._E.error("Can't find template",module),c.reject(a,"TEMPLATE_NOT_FOUND")),c.promise()}function newDialog(a,b,c,d){core._E.info("newDialog",module,a,b,c,d);var e;if(d&&d.hash_change)for(e in dialogs)"modal"===dialogs[e].type&&"active"===dialogs[e].state()&&dialogs[e]._close();else for(e in dialogs)"modal"===dialogs[e].type&&"active"===dialogs[e].state()&&core._E.error("Can't show two modals at once",module);return dialogs[a]?(core._E.info("Template exists in cache",module),dialogs[a].update(c,!0),dialogs[a]):(dialogs[a]=new DialogObject(a,b,c,d),dialogs[a])}if(DialogManager.prototype._singletonInstance)return DialogManager.prototype._singletonInstance;var self=this;"undefined"==typeof self&&(self=new DialogManager),DialogManager.prototype._singletonInstance=self;var dialogs={},cache=new DialogCache,header=new HeaderObject,baseContext={months:["January","February","March","April","May","June","July","August","September","October","November","December"],days:_M.Util.range(1,31),years:_M.Util.range(1887,(new Date).getFullYear(),!0),errors:{},HEADER_VERSION:_M.getConfig("version"),HEADER_STATIC_MEDIA:core.config.get("memFragConfig.staticMedia"),MEMCEN_HOST:core.config.get("memFragConfig.memcenHost"),STATIC_URL:core.config.get("memFragConfig.staticMedia")},templates=window.hbs;try{delete window.hbs}catch(e){window.hbs=void 0}return $("#dialog").length<=0&&$("body").append('<div id="dialog"></div>'),$("#dialog-alert").length<=0&&$(core.config.get("memFragConfig.alertContainerSelector")).after('<div id="dialog-alert" />'),{_cache:cache,_loaded:dialogs,extend:extend,destroyDialog:destroy,getBaseContext:getBaseContext,header:header,loadTemplate:loadTemplate,newDialog:newDialog}}function HeaderObject(){function getHeaderContainer(){var a=$(core.config.get("memFragConfig.headerContainer"));return 0===a.length&&(core._E.warn('HeaderContainer: "'+a.selector+'" selector did not match anything. Looking for <header> object or creating it and appending to body! ',module),a=$("header"),0===a.length&&(a=$("<header></header>"),$("body").prepend(a))),a}function getPlacedHeader(){var a=getHeaderContainer(),b=a.find(".ngs-header");return 0===b.length&&(core._E.info(b.selector+" was not found in the DOM. Created header element.",module),b=$('<div class="ngs-header"></div>'),a.append(b)),b}function updateNotificationCounters(a){$(".inbox_menu_item_counter",$header).toggleClass("hidden",1>a).text(a)}function notificationsGetter(){"use strict";notificationsTimer&&window.clearTimeout(notificationsTimer);var a=5e3;!function b(){user.getUnreadNotificationsCount().then(function(b){updateNotificationCounters(b.count),b.interval>0&&(a=1e3*b.interval)},function(b){console.error("ECONNREFUSE: getUnreadNotificationsCount",b),a=2*a}).always(function(){notificationsTimer=setTimeout(b,a)})}()}function renderTemplate(templateName,newData){var cache=core.dialog._cache,ctx=$.extend(!0,{},cache[templateName].context,newData);return cache[templateName].rendered=eval(cache[templateName].template)(ctx),cache[templateName].rendered}function updateHeader(){core._E.info("updateheader",module),user=core.flow.getUser(),$.when(user.isLoggedIn()).done(function(a){var b=window.$||_M.$;b(function(){$header=getPlacedHeader(),_M.getConfig("force_desktop")||$header.addClass("responsiveness"),a?(core.navbar.loadLoggedIn($header),$header.removeClass("logged_out").addClass("logged_in"),notificationsGetter()):(core.navbar.loadLoggedOut($header),$header.removeClass("logged_in").addClass("logged_out")),$("html").hasClass("touchevents")&&$header.click(function(){$(".navbar-toggle-wide ul",$header).toggleClass("opened")})})})}var $signIn,$register,$header,notificationsTimer,user;return _M.getConfig("show_user_ui")&&($signIn=$(core.config.get("header.signin")),$register=$(core.config.get("header.join")),$header=getPlacedHeader(),$signIn.attr("href","#members.signin"),$register.attr("href","#members.join"),core._E.subscribe("MMDB_TIMEOUT",function(){$header.hide()}),core._E.subscribeState("MMDB_NOT_AVAILABLE",function(){$header.show()})),{updateHeader:updateHeader,renderTemplate:renderTemplate,getHeaderContainer:getHeaderContainer}}function DialogObject(templateName,viewType,data,options){function close(){core._E.log("Closing Modal "+templateName,module),saveDOM(self.detach()),overlay&&(overlay.remove(),parent.removeClass("on")),window.location.hash="",$("body").unbind("click",modalClicks),state="inactive",unlockModal(),clearContext()}function reject(){dfd.reject(),close()}function clearContext(){cache[templateName].context=core.dialog.getBaseContext(),core._E.info("Clear Context",module,cache[templateName].context)}function myState(){return state}function myDFD(){return dfd.promise()}function myDataIn(){return dataIn}function myDataOut(){return dataOut}function removeModalErrors(a,b){return a.length>0&&a.remove(),b?(b.error={},b):void 0}function addModalErrors(a,b,c){return b.error||(b.error={}),c instanceof Object?$.each(c,function(a,c){b.error[a]=c}):b.error={errorTop:c},a.update(b),b}function modalClicks(a){var b=$(a.target),c=b.parents().addBack().is(self);if(options&&options.dismissable)"#close"===b.attr("href")&&c&&(a.preventDefault(),reject());else if(!c&&"modal"===viewType)return a.preventDefault(),!1}function open(){("rejected"===dfd.state()||"resolved"===dfd.state())&&(dfd=new $.Deferred),"active"!==state&&(overlay?(parent.append(overlay),overlay.append(cache[templateName].DOM),parent.addClass("on")):parent.append(cache[templateName].DOM),state="active",initView(),eventHandler(),lockModal())}function update(a,b){core._E.info("Update modal",module,a),open(),void 0!==a&&(self.html(renderTemplate(templateName,a)),self.append('<a class="close on" href="#close">&times;</a>'),b&&initView())}function renderView(){self.html(cache[templateName].rendered),self.append('<a class="close on" href="#close">&times;</a>')}function renderTemplate(templateName,newData){var ctx=$.extend(!0,{},cache[templateName].context,newData);return core._E.info("Rendering Template",module,{templateName:templateName,context:ctx}),cache[templateName].rendered=eval(cache[templateName].template)(ctx),cache[templateName].rendered}function saveDOM(a){cache[templateName].DOM=a,cache[templateName].view=view}function unlockModal(){"modal"===viewType&&($("body").removeClass("modal-blocker"),data.options&&data.options.mobile?$("body").removeClass("mobile-modal"):$("body").removeClass("scroll-lock"))}function lockModal(){"modal"===viewType&&($("body").addClass("modal-blocker"),data.options&&data.options.mobile?$("body").addClass("mobile-modal"):$("body").addClass("scroll-lock"))}function success(a,b){$.extend(dataIn,!0,dataIn,a),void 0===b&&(b=a),dataIn=a,dataOut=b,close(),dfd.resolve(b)}function toggleDisplay(a,b,c){a.toggle(),b&&a.one("click",b,function(){a.toggle()}),c&&a.one("click",c,function(){a.toggle(0,function(){reject()})})}function registerView(a){view=core.dialog._loaded[templateName].view=new a(dataIn),initView()}function initView(){void 0!==view&&view.initialize(dataIn)}function eventHandler(){$("body").bind("click",modalClicks)}var cache=new DialogCache,dataIn=data,dataOut,defaults={dismissable:!0},dfd=$.Deferred(),state="active",parent,overlay,self,view;return Date.now=Date.now||function(){return+new Date},options=$.extend(!0,{},defaults,options),"modal"===viewType?(parent=$(options&&options.parent?options.parent:"#dialog"),overlay=$('<div class="dialog_overlay" />'),self=$('<div id="dialog_'+viewType+Date.now()+'" class="dialog_'+viewType+'" />'),lockModal()):"alert"===viewType&&(parent=$(options&&options.parent?options.parent:"#dialog-alert"),overlay=$('<div class="container" />'),self=$('<div id="dialog_'+viewType+Date.now()+'" class="dialog_'+viewType+'" />')),parent.addClass("on"),overlay?(parent.append(overlay),overlay.append(self)):parent.append(self),$.when(core.dialog.loadTemplate(templateName,data)).done(function(){renderView(),eventHandler()}).fail(function(a,b){dfd.reject("Failed to load template",a,b)}),{_close:close,_clearContext:clearContext,_dataIn:myDataIn,_dataOut:myDataOut,_open:open,_reject:reject,_success:success,dfd:myDFD,dismissable:options.dismissable,mobile:options.mobile,name:templateName,state:myState,self:self,type:viewType,update:update,addModalErrors:addModalErrors,removeModalErrors:removeModalErrors,registerView:registerView,toggleDisplay:toggleDisplay}}function DialogCache(){if(DialogCache.prototype._singletonInstance)return DialogCache.prototype._singletonInstance;var a=this;"undefined"==typeof a&&(a=new DialogCache),DialogCache.prototype._singletonInstance=a}var module="dialog";_M.attach(module,new DialogManager)},{},1)}(window,document,_M.$),function(a,b,c){_M.ready(function(b){function d(a){var d=b.config.get("memFragConfig.whitelist.origins"),e=new Uri(a),f=e.host(),g=!1;return c.each(d,function(a,b){var c="*"===b.substr(0,1)?b.substr(1):b,d=new RegExp(c);g||d.test(f)&&(g=!0)}),g}function e(e,g){function h(a){b._E.info(f+":: ","AjaxTransport iframe created to: "+n);var d=c("<iframe />",{src:a,name:"cors_iframe",style:"display:none; visibility: hidden;","data-tag":(new Date).getTime()});return c("body").append(d),d}function i(a){var c;return d(a.origin)?void("ready"===a.data?j():(b._E.info("received message: ",a.data),c=JSON.parse(a.data),c.error?(408===c.error.code&&b._E.error("CORS_IFRAME_TIMEOUT",f),l.dfd.reject(a.data)):l.dfd.resolve(a.data),k())):void b._E.error("ORIGIN_NOT_ALLOWED",f)}function j(){p.postMessage(g,n),b._E.info(f+":: Posting Message: ",g)}function k(){a.removeEventListener?removeEventListener("message",i,!1):detachEvent("onmessage",i),o.remove(),l.dfd=null}var l=this,m={mmdb:b.config.get("memFragConfig.mmdbHost")+"/cors_handler2/",base:b.config.get("headerRoutes.cors_handler")},n=m[e]?m[e]:m.base,o=h(n),p=o[0].contentWindow;return a.addEventListener?addEventListener("message",i,!1):attachEvent("onmessage",i),this.dfd=new c.Deferred,this.dfd.promise()}var f="transport";c.ajaxPrefilter(function(a){return a.overrideIframe&&"false"!==a.overrideIframe||!a.crossDomain||"undefined"==typeof XDomainRequest?void 0:(a.converters["json iframe"]=c.parseJSON,"iframe")}),c.ajaxTransport("iframe",function(a){var c=null;return{send:function(g,h){return a.dataType="json",a.timeout=8e3,d(a.url)?(c=new e(a.target,JSON.stringify(a)),void c.done(function(a){c=null,h(200,"success",{iframe:a})}).fail(function(a){c=null,h(404,"failed",{iframe:a})})):(b._E.error("ORIGIN_NOT_ALLOWED",f),void h(404,"failed",{json:"Origin not allowed"}))},abort:function(){c=null}}})},{},1)}(window,document,_M.$),function(a){_M.ready(function(b){function c(){function c(){setTimeout(function(){var a=window.location.hash.substring(1).split(".");"logout"===a[1]&&a.length>1?i("logout"):"members"===a[0]&&a.length>1&&(e()||i(a[1]))},1e3),a(window).on("hashchange load",function(){var a=window.location.hash.substring(1).split(".");"logout"===a[1]&&a.length>1?i("logout"):"members"===a[0]&&a.length>1&&(e()||i(a[1]))})}function e(){if(_M.Util.browser.isCookiesEnabled)return!1;var a=_M.Util.browser.whatBrowser,c={_browser:a.name,_cookie_support_url:b.config.get("cookie_support."+a.codename.toLowerCase())};b.dialog.newDialog("nocookies","modal",c),b._E.error("COOKIES_NOT_ENABLED",r)}function f(a,c){return q[a]?void b._E.error("FLOW_ALREADY_EXISTS "+a,r,c):(q[a]=new d(a,c),q[a])}function g(){return s}function h(){return p}function i(a,c,d){if(b._E.info("processFlow",r,a,c,d),q[a]){var e=q[a].newDfd();return s[a]=e.state(),void 0!==d&&k(a,d),q[a].run(c),e.always(function(){s[a]=e.state(),q[a].reset()}),e.done(function(){c&&c.redirectCallback?j(a,c.redirectCallback):j(a)}),e.done(function(a){n(a)}),e.fail(function(){l(a,d)}),e.promise()}b._E.error("No such flow",r,a)}function j(a,c){var d={refresh:function(){var a=window.location.href.replace(/#.*/,"");window.location=a},location:function(a){window.location=a},refreshOnLogin:function(){if(!b.config.get("memFragConfig.refreshOnLogin"))return!1;var a=window.location.href.replace(/#.*/,"");window.location=a},refreshOnLogout:function(){if(!b.config.get("memFragConfig.refreshOnLogout"))return!1;var a=window.location.href.replace(/#.*/,"");window.location=a}},e={logout:d.refreshOnLogout,signin:d.refreshOnLogin,verification:d.refresh,login_register:d.refreshOnLogin,social_login:d.refreshOnLogin,social_register:d.refreshOnLogin,reset_password:d.refresh,deactivate_account:d.refresh,lucie_register:d.refreshOnLogin};if(c&&c instanceof Function)c(d);else if(c&&"string"==typeof c)d.location(c);else{if(!e[a])return!1;e[a]()}}function k(b,c){var d=["join","signin","verification","reset_password"];c&&-1!==a.inArray(b,d)&&localStorage.setItem("memFrag/fromAction",c)}function l(b,c){var d=["join","signin","verification","reset_password"];c&&-1!==a.inArray(b,d)&&localStorage.removeItem("memFrag/fromAction")}function m(a){p=a}function n(a){void 0!==a&&p.setData(_.pick(a,["user"])),p.updateState()}function o(){var a,b={};for(a in s)s.hasOwnProperty(a)&&"pending"===s[a]&&(b[a]=q[a]);return b}var p,q={},r="FlowManager",s={};return c(),{_active:o,_redirect:j,extend:f,flowState:g,getUser:h,processFlow:i,setUser:m}}function d(c,d){function e(c){function d(){g=a.extend(!0,{},f,c)}function e(){"json"===g.dataType&&(g.data=JSON.stringify(_.pick(r,h)));var c=new a.Deferred;return a.ajax(g).fail(function(a){if(0===a.status){var d=new Uri(g.url),e=new Uri(b.config.get("memFragConfig.memcenHost")).path();if(d.path().match(e))return b._E.publish("MMDB_TIMEOUT",this),h.error={},h.error.errorTop="National Geographic Membership Services are currently unavailable. Please try again soon.",c.reject(h),c}}).always(function(){var b,d,e=arguments[1];"success"===e?(b=arguments[2],d=arguments[0]):(b=arguments[0],d=void 0!==b.responseJSON?b.responseJSON:{error:{errorTop:"An unknown error occured while processing your request."}}),d.error?(d.error.code&&v[d.error.code]?"function"==typeof v[d.error.code].msg?d.error=v[d.error.code].msg.call(z,d.error):d.error[v[d.error.code].obj]=v[d.error.code].msg:d.error.errorTop="An unknown error occured while processing your request.",a.extend(!0,d,r),c.reject(d)):c.resolve(d)}),c}b._E.info("Request",w,c);var f={contentType:"application/json",dataType:"json",type:"POST",xhrFields:{withCredentials:!0}},g={},h=c.data;return delete c.data,d(),{go:e}}function f(a){return v[a.code]?b._E.error("Error code exists",w,a.code):v[a.code]={msg:a.msg,obj:a.obj},this}function g(a,b){var c={name:a,fn:b};return A.push(c),this}function h(a,c){return y[a]?b._E.error("Request object already exists for that name",w,a):y[a]=new e(c),this}function i(){return u.promise()}function j(){return("resolved"===u.state()||"rejected"===u.state())&&(u=new a.Deferred),u}function k(c){x&&b._E.error("You must lock a flow before you can use it",w,x),a.extend(!0,r,c),s<A.length?(t[A[s]]=new a.Deferred,A[s].fn.call(z,r,t[A[s]]),a.when(t[A[s]]).done(function(a){z.addData(a),m()}).fail(function(a){b._E.info("Flow Failed",w,{onStep:s,dataCollected:r}),s=0,u.reject(a)})):(u.resolve(r),s=0)}function l(){s=0,r={},v={}}function m(){s++,k()}function n(){0>=s?s=0:s--,k()}function o(){return r}function p(){x=0}function q(){if(d&&d.data&&a.extend(!0,r,d.data),d&&d.requests)for(var b in d.requests)d.requests.hasOwnProperty(d.requests[b])&&h(d.requests[b])}var r={},s=0,t=[],u=new a.Deferred,v={},w="Flow:"+c,x=0,y={},z=this,A=[],B=b.flow.getUser();return this.addData=function(b){return a.extend(!0,r,b),r},this.fail=function(a){b._E.info("fail",w,a),u.reject(a)},this.retryFlow=function(){s=0,k()},this.retryStep=function(){k()},this.doRequest=function(c){b._E.info("doRequest",w,c);var d;return d=y[c].go(),d.done(function(b){a.extend(!0,r,b)}),d},this.newView=function(c){var d=new a.Deferred;return window.yepnope({test:b.dialog,nope:function(){a.when(_M.load("dialog")).done(function(){return!0}).fail(function(){return!1})},complete:function(){var e=b.dialog.newDialog(c.templateName,c.viewType,c,{hash_change:!0});a.when(e.dfd()).done(function(){d.resolve()}).fail(function(){b._E.info("Dialog Failed",w,{templateName:c.templateName,viewType:c.viewType}),d.reject()})}}),d.promise()},this.user=function(){return B},q(),{addData:this.addData,addError:f,addRequest:h,addStep:g,dfd:i,doRequest:this.doRequest,getData:o,lock:p,nextStep:m,newDfd:j,prevStep:n,user:this.user,reset:l,run:k}}_M.attach("flow",new c)},{},1)}(_M.$),function(a,b,c){_M.ready(function(b){function d(){function f(){if(!b.config.get("memFragConfig.serverSideLogin"))return!0;var d,e,f={};return e=new Uri(b.config.get("memFragConfig.memcenHost")),d=new Uri(a.location),d.host()===e.host()?!0:(f.sessionId=n("sessionId"),f.mmdbId=n("id"),f.isLoggedIn=!!y,c.ajax({url:b.config.get("localRoutes.site_sync"),dataType:"json",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",type:"POST",xhrFields:{withCredentials:!0}}).done(function(a){b._E.info("site_sync was called and returned the following",a)}))}function g(){for(var a in localStorage)-1!==a.indexOf("memFrag/User/")&&"memFrag/User/status"!==a&&localStorage.removeItem(a)}function h(a){y&&w.fired()&&a.call(),w.add(a)}function i(a){!y&&x.fired()&&a.call(),x.add(a)}function j(){return localStorage.getItem("memFrag/User/id")}function k(){return c.ajax({url:b.config.get("headerRoutes.server_context"),cache:!1,dataType:"json",xhrFields:{withCredentials:!0}}).done(function(a){b._E.info("server context responded",a),a.user?!isNaN(parseFloat(a.user.id))&&isFinite(a.user.id)&&(y=!0,a.sessionId&&(a.user.sessionId=a.sessionId),e.setData(a.user),c.when(f()).then(function(){z.resolve(),w.fire(),localStorage.setItem("memFrag/User/status",y)})):(y=!1,c.when(f()).then(function(){z.resolve(),x.fire(),localStorage.setItem("memFrag/User/status",y)}))})}function l(){var a=new c.Deferred;return c.when(z).then(function(){a.resolve(y)}),a.promise()}function m(a){if("object"==typeof a||"null"===a)if(_M.Util.depthOf(a)>1)c.each(a,function(a,b){if(b instanceof Object){var d=a;c.each(b,function(a,b){localStorage.setItem("memFrag/User/"+d+"/"+a,b)})}else localStorage.setItem("memFrag/User/"+a,b)});else for(var b in a)a.hasOwnProperty(b)&&localStorage.setItem("memFrag/User/"+b,a[b])}function n(a){var b=t();if("null"===b.pendingEmail&&delete b.pendingEmail,a instanceof Array){for(var c={},d=0;d<a.length;d++)c[a[d]]=b[a[d]];return c}return b[a]}function o(a){var b=n(a);return null!==b&&void 0!==b}function p(a,b){"object"==typeof a||"null"===a?_M.Util.depthOf(a)>1&&m(a):localStorage.setItem("memFrag/User/"+a,b)}function q(){return n("uploadedAvatar")}function r(){var a=b.config.get("notifications.unread")+e.id()+"/unread/?callback=?";return c.jsonp({url:a,type:"GET",callback:"callback",timeout:15e3,data:{api_key:b.config.get("notifications.apiKey"),format:"jsonp"}})}function s(){var a={fetchCallbacks:[],addFetchCallback:function(a){this.fetchCallbacks.push(a)},callFetchCallbacks:function(){for(var a=0;a<this.fetchCallbacks.length;a++){var b=this.fetchCallbacks[a];b()}},fetch:function(d){var e=this;c.ajax({url:b.config.get("notifications.inbox"),type:"GET",dataType:"json",data:d.data,contentType:"application/json; charset=utf-8"}).done(function(b){a.parse(b),e.callFetchCallbacks()})},parse:function(a){this.models=[],this.length=a.objects.length;for(var b,d={get:function(a){return this[a]},toJSON:function(){return _.clone(this)}},e=0;e<a.objects.length;e++)b=c.extend({},d,a.objects[e]),this.models.push(b);this.hasNextPage=a["has-next"],this.hasPreviousPage=a["has-previous"]},at:function(a){return this.models[a]}};return a}function t(){var a={};return c.each(localStorage,function(b,d){var e=b.split("/"),f={};"memFrag"===e[0]&&"User"===e[1]&&(e.splice([0,1],2),"null"===d&&(d=""),e.length>1?(f[e[1]]=d,e[0]in a?c.extend(a[e[0]],f):a[e[0]]=f):a[e[0]]=d)}),a}function u(a){"memFrag/User/status"===a.key&&null!==y&&a.newValue!==y.toString()&&"null"!==a.newValue&&k().done(function(){y?b.flow._redirect("signin"):b.flow._redirect("logout")})}if(d.prototype._singletonInstance)return d.prototype._singletonInstance;var v=this;"undefined"==typeof v&&(v=new d),d.prototype._singletonInstance=v;var w=c.Callbacks("unique"),x=c.Callbacks("unique"),y=null,z=new c.Deferred;return z.id=1,i(g),localStorage.setItem("memFrag/User/status",y),a.addEventListener?a.addEventListener("storage",u,!1):a.attachEvent("onstorage",u),{loggedIn:h,loggedOut:i,get:n,set:p,has:o,toJSON:t,getNotifications:s,getUploadedAvatar:q,getUnreadNotificationsCount:r,setData:m,isLoggedIn:l,updateState:k,id:j}}var e;e=new d,e.updateState(),b.flow.setUser(e),_M.getConfig("show_user_ui")&&(e.loggedIn(b.dialog.header.updateHeader),e.loggedOut(b.dialog.header.updateHeader))},{},1)}(window,document,_M.$);var config={},_E;_M&&_M.ready(function(a){config=a.config.get(["validation.formValidation","validation.profanity","validation.geodata"]),_E=a._E}),window.V=function(a,b,c){function d(a){a=a||{};var b=[];return c.each(a,function(a,d){var f=c.isArray(d.checks)?d.checks:[d.checks];c.each(f,function(f,g){var h,i;"object"===c.type(g)?(h=g.type,delete g.type,i=g):h=g,i=i||{},i.control=c(d.control),b.push({check:e(h),checkName:h,field:a,config:i})})}),b}function e(a){return"string"===c.type(a)&&i.type[a]?i.type[a]:i.noCheck}function f(a){var b=new Date,c=a.split("-"),d=b.getFullYear()-c[0];return b.getMonth()<c[1]-1&&d--,c[1]-1===b.getMonth()&&b.getDate()<c[2]&&d--,d}function g(a){var b,c,d,e,f=0;return a.length&&(f+=a.length<5?5:a.length>=5&&a.length<=7?10:25),b=a.replace(/[^A-Z]/g,"").length,c=a.replace(/[^a-z]/g,"").length,b&&c?f+=20:(b||c)&&(f+=10),d=a.replace(/\D/g,"").length,d>=1&&2>=d?f+=10:d&&(f+=20),e=a.replace(/[A-Za-z0-9]/g,"").length,e>1?f+=25:e&&(f+=10),d&&b&&c&&e?f+=10:d&&(b||c)&&e?f+=5:d&&(b||c)&&(f+=2),f}function h(a,b,d){a[b.field]=a[b.field]||{},a[b.field][b.checkName]=c.extend({control:b.control},d)}var i,j="mfrag_too_young";return i={type:{noCheck:{ok:function(){return!0}},required:{ok:function(a){var b="string"===c.type(a)&&""===c.trim(a);return void 0!==a&&null!==a&&!b},message:"This field is required"},"email-format":{ok:function(a){var b=c.Deferred(),d=new RegExp("^([\\w!.%+\\-])+@([\\w\\-])+(?:\\.[\\w\\-]+)+$");return void 0===a?b.reject():d.test(a)===!0?b.resolve():b.reject(),b},message:"Invalid email format"},locationName:{ok:function(a){var b=c.Deferred();return c.get(config.geodata,"query="+a).done(function(c){a===c[0].description?b.resolve():b.reject()}),b},message:"Please enter a valid location."},"reg-form-validation":{ok:function(a){var b=c.Deferred(),d={},e=["First Name","Middle Name","Last Name","Email Address"];
return c(a).each(function(){c.each(c('input[type="text"], input[type="email"], input[type="password"], select',"#reg_form"),function(){if("birthMonth"===c(this)[0].name){var a=parseInt(c(this).val(),10)+1;isNaN(a)?d[c(this)[0].name]="":d[c(this)[0].name]=a}else c(this)[0].value&&-1===c.inArray(c(this)[0].value,e)?d[c(this)[0].name]=c(this)[0].value:d[c(this)[0].name]=""})}),c.ajax({type:"POST",contentType:"application/json",url:config.formValidation,data:JSON.stringify(d)}).fail(function(a){0===a.status?(_E.publish("MMDB_TIMEOUT",this),b.reject({MMDB_TIMEOUT:!0})):b.reject({results:a.responseJSON.error,formValues:d})}).done(function(a){a.error?b.reject({results:a.error,formValues:d}):b.resolve({formValues:d})}),b},message:{profanity:"This field contains profanity.",required:"This field is required.",too_young:"Sorry, you are not able to register at this time.",invalid:"Invalid email address.",too_short:"This password is too short.",password_too_simple:"This password is too simple.",user_exists:"This email address is already registered.",user_registration_cancelled:"This email address has been disabled"}},"lucie-reg-form-validation":{ok:function(a){var b=c.Deferred(),d={},e=["Location","Birthdate"];return c(a).each(function(){c.each(c('input[type="text"], input[type="checkbox"], select',"#lucie_reg_form"),function(){if("birthMonth"===c(this)[0].name){var a=parseInt(c(this).val(),10)+1;isNaN(a)?d[c(this)[0].name]="":d[c(this)[0].name]=a}else c(this)[0].value&&-1===c.inArray(c(this)[0].value,e)?d[c(this)[0].name]=c(this)[0].value:d[c(this)[0].name]=""})}),b.resolve({formValues:d}),b},message:{profanity:"This field contains profanity.",required:"This field is required.",too_young:"Sorry, you are not able to register at this time.",invalid_date:"Please provide a valid birthdate.",invalid:"Invalid email address.",too_short:"This password is too short.",password_too_simple:"This password is too simple.",user_exists:"This email address is already registered.",user_registration_cancelled:"This email address has been disabled"}},"social-reg-form-validation":{ok:function(a){var b=c.Deferred(),d={},e=["Location","Birthdate"];return c(a).each(function(){c.each(c('input[type="text"], input[type="checkbox"], select',"#registration"),function(){c(this)[0].value&&-1===c.inArray(c(this)[0].value,e)?d[c(this)[0].name]=c(this)[0].value:d[c(this)[0].name]=""})}),b.resolve({formValues:d}),b},message:{profanity:"This field contains profanity.",required:"This field is required.",too_young:"Sorry, you are not able to register at this time.",invalid_date:"Please provide a valid birthdate.",invalid:"Invalid email address.",too_short:"This password is too short.",password_too_simple:"This password is too simple.",user_exists:"This email address is already registered.",user_registration_cancelled:"This email address has been disabled"}},"mobile-reg-form-validation":{ok:function(a){var b=c.Deferred(),d={},e=["First Name","Last Name","Email Address"];return c(a).each(function(){c.each(c('input[type="text"], input[type="email"], input[type="password"], select',"#reg_form"),function(){if("birthMonth"===c(this)[0].name){var a=parseInt(c(this).val(),10)+1;isNaN(a)?d[c(this)[0].name]="":d[c(this)[0].name]=a}else c(this)[0].value&&-1===c.inArray(c(this)[0].value,e)?d[c(this)[0].name]=c(this)[0].value:d[c(this)[0].name]=""})}),c.ajax({type:"POST",contentType:"application/json",url:config.formValidation,data:JSON.stringify(d)}).fail(function(a){0===a.status?(_E.publish("MMDB_TIMEOUT",this),b.reject({MMDB_TIMEOUT:!0})):b.reject({results:a.responseJSON.error,formValues:d})}).done(function(a){a.error?b.reject({results:a.error,formValues:d}):b.resolve({formValues:d})}),b},message:{profanity:"This field contains profanity.",required:"This field is required.",too_young:"Sorry, you are not able to register at this time.",invalid:"Invalid email address.",too_short:"This password is too short.",password_too_simple:"This password is too simple.",user_exists:"This email address is already registered.",location_unknown:"This is not a valid location. Please select one from the list.",location_required:"This is not a valid location.",user_registration_cancelled:"This email address has been disabled"}},profanity:{ok:function(a,b){var d,e=c.isArray(a)?a:[a],f=c.Deferred();for(d=0;d<e.length;d++)e[d].match(/(["'])(?:\\\1|.)*?\1/)||(e[d].Value='"'+e[d]+'"');return c.ajax({type:"POST",contentType:"application/json",url:b.profanity,data:JSON.stringify(e)}).done(function(a){for(var b=0;b<a.length;b++)a[b].length&&f.reject({results:a});f.resolve()}),f},message:"Profane language isn't accepted as input"},"password-strength":{ok:function(a,b){var d=c.Deferred(),e=b&&c.isNumeric(b.tolerance)?b.tolerance:50,f=g(a),h=e>f?"reject":"resolve";return f>=90?d[h]({score:f,text:"Very Secure"}):f>=80?d[h]({score:f,text:"Secure"}):f>=70?d[h]({score:f,text:"Very Strong"}):f>=60?d[h]({score:f,text:"Strong"}):f>=50?d[h]({score:f,text:"Average"}):f>=25?d[h]({score:f,text:"Weak"}):d[h]({score:f,text:"Very Weak"})},message:"Password does not meet requirements."},"age-verification":{ok:function(b){if(a._M.cookie.readCookie(j))return!1;try{return f(b)>=13?!0:(a._M.cookie.createCookie(j,!0,6e5),!1)}catch(c){return!1}},message:"Sorry, you are not able to register at this time."},"contains-letter-number":{ok:function(a,b){var d=c.isNumeric(b.minLetters)?b.minLetters:1,e=c.isNumeric(b.minNumbers)?b.minNumbers:1;return a.length>0?a.replace(/[^A-Za-z]/g,"").length<d||a.replace(/[^0-9]/g,"").length<e?!1:!0:!1},message:"The field does not contain the required number of letters and/or numbers."},"html5-required":{ok:function(b,c){if(!c.control.attr("required"))throw new Error("The html5-required validator requires that the control has the required attribute present.");return a.Modernizr.input.required?!c.control.prop("validity").valueMissing:b.length>0||void 0!==b.length?!0:!1},message:"This field is required."},"html5-pattern":{ok:function(b,c){var d,e=c.control.attr("pattern");if(!e||!e.length)throw new Error("The html5-pattern validator requires that the control has a pattern attribute set.");return a.Modernizr.input.required?!c.control.prop("validity").patternMismatch:d=new RegExp(e).test(b)},message:"The field does not match the requested format."}},validate:function(a){a=d(a);var b,e=[],f=[];return c.each(a,function(a,b){var d,g,h;d="undefined"==typeof b.config.value?b.config.control.val()?b.config.control.val():b.config.control[0]:b.config.value,g=b.check.ok(d,b.config),g.then?e.push(g):(h=c.Deferred(),g?h.resolve():h.reject(),e.push(h.promise())),f.push(b)}),b=c.Deferred(),c.when.apply(null,e).done(function(){var a={};c.each(e,function(b,c){var d=f[b];c.done(function(b){h(a,d,b)})}),b.resolve(a)}).fail(function(){var a={},d={};c.each(e,function(b,e){var g=f[b];"rejected"===e.state()?e.fail(function(b){a[g.field]=a[g.field]||{},a[g.field][g.checkName]=c.extend({error:g.check.message,control:g.config.control},b)}):e.done(function(a){h(d,g,a)})}),b.reject(a,d)}),b.promise()}}}(window,document,_M.$),function(a,b,c,d){_M.ready(function(b){function d(a,c){b._E.warn(a+" is deprecated and kept only for backwards compatability. Please change to "+c+".")}function e(){var a=b.flow.getUser(),e=new c.Deferred;this.getUser=function(){return d("header.getUser()","flow.getUser()"),c.when(a.isLoggedIn()).done(function(b){b?e.resolve(a):e.resolve(!1)}),e},this.onUserLoggedIn=function(b){return d("header.onUserLoggedIn(callback)","user.loggedIn(callback)"),a.loggedIn(b)},this.onUserLoggedOut=function(b){return d("header.onUserLoggedOut(callback)","user.loggedOut(callback)"),a.loggedOut(b)},this.logoutUser=function(){return d("header.logoutUser()",'flow.processFlow("logout")'),b.flow.processFlow("logout")},this.requestLogin=function(){return d("header.requestLogin()",'flow.processFlow("signin")'),b.flow.processFlow("signin")},this.isLoggedIn=function(){return d("header.isLoggedIn()","user.isLoggedIn()"),a.isLoggedIn()},this.getCalledFromAction=function(){return!1}}function f(a){a(b.context)}var g,h="context";g=new e,_M.attach(h,g),a.MMDBContext=g,a.onMMDBHeaderLoaded=f},{},2)}(window,document,_M.$,void 0),function(){_M.ready(function(a){a.flow.extend("deactivate_account").addRequest("deactivate_account_post",{url:a.config.get("memFragConfig.memcenHost")+"/header/deactivate_account/",type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:["deactivation_token"]}).addStep("deactivate_account_modal",function(a,b){this.newView({templateName:"deactivate_account",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addStep("deactivate_account_feedback",function(a,b){var c;c=a.ok===!0?"deactivate_account_done":"deactivate_account_fail",this.newView({templateName:c,viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{})}(),function(){_M.ready(function(a){var b=a.flow.extend("forgot_password").addRequest("forgot_password",{url:a.config.get("headerRoutes.forgotPassword"),data:["email","nextpage","headerhash"]});b.addStep("modal",function(a,b){a.error||(a.error={}),this.newView({templateName:"forgot_password",viewType:"modal",error:a.error}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{},1)}(),function(){_M.ready(function(a){a.flow.extend("join").addStep("modal",function(a,b){this.newView({templateName:"join",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{},1)}(),function(){_M.ready(function(a){a.flow.extend("logout").addRequest("logout",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.logout")}).addStep("logout",function(a,b){this.doRequest("logout").done(function(){b.resolve()})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("lucie_register").addRequest("lucie_reg",{url:a.config.get("headerRoutes.lucie_register"),data:["email","password","birthMonth","birthDay","birthYear","locationReference","caslOptin"]});b.addStep("lucie_reg_modal",function(a,b){this.newView({templateName:"lucie_reg",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addError({code:"USER_EMAIL_NOT_VERIFIED",msg:"Please verify your email",obj:"errorTop"}).addError({code:"INVALID_USER_AUTH",msg:"Authentication failed: invalid username or password specified.",obj:"errorTop"}).addError({code:"USER_BANNED",msg:"Disabled Account b/c of violations of TOS or Community",obj:"errorTop"}).addError({code:"USER_REGISTRATION_CANCELLED",msg:"Authentication failed: the account has been disabled.",obj:"errorTop"}).addError({code:"INCOMPLETE_USER_AUTH",msg:"Authentication failed: the account is not completed",obj:"errorTop"}).addError({code:"INVALID_INPUT",msg:"Please provide a valid input for the fields in red.",obj:"errorTop"})},{},1)}(),function(){_M.ready(function(a){a.flow.extend("mobile_join").addStep("mobile_join",function(a,b){this.newView({templateName:"mobile_join",viewType:"modal",options:{mobile:!0}}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("mobile_register").addRequest("mobile_reg",{url:a.config.get("headerRoutes.native_reg"),data:["firstName","middleName","lastName","birthMonth","birthDay","birthYear","email","password","locationReference","caslOptin","nextpage","regSourceData"]});b.addStep("reg_modal1",function(a,b){this.newView({templateName:"mobile_reg",viewType:"modal",options:{mobile:!0}}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addStep("verify",function(a,b){this.newView({templateName:"mobile_reg_verification",viewType:"modal",email:a.email,nextpage:a.nextpage,user_id:a.userId,options:{mobile:!0}}).done(function(a){b.resolve(a)}).fail(function(a){b.resolve(a)})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("mobile_signin").addRequest("native_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.native_login"),data:["username","password","username_confirm"]});b.addStep("signin",function(a,b){this.newView({templateName:"mobile_signin",viewType:"modal",options:{mobile:!0}}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addError({code:"USER_EMAIL_NOT_VERIFIED",msg:"Please verify your email",obj:"errorTop"}).addError({code:"INVALID_USER_AUTH",msg:"Authentication failed: invalid username or password specified.",obj:"errorTop"}).addError({code:"USER_BANNED",msg:"Disabled Account b/c of violations of TOS or Community",obj:"errorTop"}).addError({code:"USER_REGISTRATION_CANCELLED",msg:"Authentication failed: the account has been disabled.",obj:"errorTop"})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("mobile_social_register").addRequest("social_register",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.social_register"),data:["password","locationReference","regSourceData","caslOptin"]}).addRequest("social_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.social_login"),data:["uid","uid_signature","signature_timestamp","is_site_uid","email"]});b.addStep("modal",function(a,b){this.newView({templateName:"mobile_social_reg",viewType:"modal",gigyaData:a[0],userData:a[0].user,options:{mobile:!0}}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("register").addRequest("native_reg",{url:a.config.get("headerRoutes.native_reg"),data:["firstName","middleName","lastName","birthMonth","birthDay","birthYear","email","password","locationReference","caslOptin","nextpage","regSourceData"]});b.addStep("reg_modal1",function(a,b){this.newView({templateName:"native_reg",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addStep("reg_modal2",function(a,b){this.newView({templateName:"location",viewType:"modal",native_reg:a}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addStep("resend",function(a,b){this.newView({templateName:"resend_email_verification",viewType:"modal",email:a.email,resend:a.resendVerificationNonce,nextpage:a.nextpage,user_id:a.userId}).done(function(a){b.resolve(a)}).fail(function(a){b.resolve(a)})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("reset_password").addRequest("native_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.native_login"),data:["username","password","username_confirm"]}).addRequest("reset_password",{url:a.config.get("headerRoutes.resetPassword"),data:["password","passwordConfirmation","confToken","user_id","username"]});b.addStep("modal",function(a,b){this.newView({templateName:"reset_password",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addError({code:"INVALID_INPUT",msg:function(a){return a.fieldErrors&&(a.fieldErrors.confToken||a.fieldErrors.userId)&&(a.errorTop="Invalid password reset code. Please submit another request using the form below.",this.fail()),a}})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("signin").addRequest("native_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.native_login"),data:["username","password","username_confirm"]});b.addStep("signin_modal",function(a,b){this.newView({templateName:"signin",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addError({code:"USER_EXISTS",msg:"This email address is already registered. Sign in to continue.",obj:"errorTop"}).addError({code:"USER_EMAIL_NOT_VERIFIED",msg:"Please verify your email",obj:"errorTop"}).addError({code:"INVALID_USER_AUTH",msg:"Authentication failed: invalid username or password specified.",obj:"errorTop"}).addError({code:"USER_BANNED",msg:"Disabled Account b/c of violations of TOS or Community",obj:"errorTop"}).addError({code:"USER_REGISTRATION_CANCELLED",msg:"Authentication failed: the account has been disabled.",obj:"errorTop"}).addError({code:"INCOMPLETE_USER_AUTH",msg:"Authentication failed: the account is not completed",obj:"errorTop"})},{},1)}(),function(){_M.ready(function(a){var b="Social Login-Flow",c=a.flow.extend("social_login").addRequest("social_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.social_login"),data:["uid","uid_signature","signature_timestamp","is_site_uid","email"]});c.addStep("gigya",function(a,b){var c={provider:"facebook",facebookExtraPermissions:["email"].join(", "),pendingRegistration:!0,callback:function(){b.resolve(arguments)}};gigya.socialize.login(c)}).addStep("social_login",function(c,d){c=this.addData({uid:c[0].UID,uid_signature:c[0].UIDSignature,signature_timestamp:c[0].signatureTimestamp,is_site_uid:c[0].user.isSiteUID,email:c[0].user.email}),this.doRequest("social_login").fail(function(e){if(e.error)if("USER_EXISTS"===e.error.code||e.responseJSON&&"USER_EXISTS"===e.responseJSON.error.code)e.error.errorTop="This email address is already registered. Sign in to continue.",a.dialog._loaded.signin.update(e);else if("UNKNOWN_USER"===e.error.code||e.responseJSON&&"UNKNOWN_USER"===e.responseJSON.error.code){var f="social_register";_M.Util.isMobile()&&(f="mobile_social_register"),a.flow.processFlow(f,c).done(function(a){d.resolve(a)}).fail(function(a){d.reject(a)})}else a._E.error("Error: "+e,b,e)}).done(function(a){a.userId&&d.resolve(a)})}),c.addError({code:"USER_EXISTS",msg:"This email address is already registered. Sign in to continue.",obj:"errorTop"})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("social_register").addRequest("social_register",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.social_register"),data:["password","locationReference","regSourceData","birthMonth","birthDay","birthYear","caslOptin"]}).addRequest("social_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.social_login"),data:["uid","uid_signature","signature_timestamp","is_site_uid","email"]});b.addStep("modal",function(a,b){this.newView({templateName:"social_reg",viewType:"modal",gigyaData:a[0],userData:a[0].user}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})})},{},1)}(),function(){_M.ready(function(a){var b=a.flow.extend("verification").addRequest("native_login",{type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",url:a.config.get("headerRoutes.native_login"),data:["username","password","username_confirm"]});b.addStep("modal",function(a,b){this.newView({templateName:"verification",viewType:"modal"}).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})}).addError({code:"INVALID_USER_AUTH",msg:"Authentication failed: invalid username or password specified.",obj:"errorTop"}).addError({code:"USER_REGISTRATION_CANCELLED",msg:"Authentication failed: the account has been disabled.",obj:"errorTop"})},{},1)}();