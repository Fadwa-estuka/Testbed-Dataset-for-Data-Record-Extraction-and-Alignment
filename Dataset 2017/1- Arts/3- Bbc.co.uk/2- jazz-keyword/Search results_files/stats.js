define(["jquery-1","istats-1","search/util"],function(c,a,d){var b={labels:{ns_search_term:null,search_form:null,ns_search_results:0,search_type:null,search_filter_site:"all",search_result_site:"unknown",page_num:1,search_result_number:0,search_result_type:"unknown",search_error:false,search_form_query:"",cards_present:null,ns_card_results:0},actions:{"search-page":["ns_search_results","cards_present","ns_card_results"],"search-page-with-no-search":["ns_search_results","ns_card_results"],"search-page-with-search":["ns_search_results","ns_search_term","search_form","search_type","cards_present","ns_card_results"],"submit-form":["search_form","search_type"],"show-more":["page_num"],"back-to-top":[],"search-result":["search_result_site","search_result_type","search_result_number","cards_present"],"search-filter-bar":["search_type","search_filter_site"],"search-filter-result":["ns_search_results","search_type","search_filter_site","cards_present","ns_card_results"],"search-error":["search_error"],"search-suggest":["search_type","search_form_query","ns_search_term","search_form"]},init:function(){var f=this;var g=this.parseSearchFrom().form;b.setLabel("search_form",g);if(c("section.error").length){b.setLabel("search_error","true");b.logInteraction("search-page","search-error")}c(".search-top").click(function(){b.logInteraction("click","back-to-top")});d.getSearchResults().each(function(h,j){b.addResultLabels("organic",this,j)});a.track("internal",{region:d.getSearchResults(),linkLocation:"organic-results"});c(".editors-choice li").each(function(h,j){b.addResultLabels("editors-choice",this,j)});a.track("internal",{region:c("ol.editors-choice"),linkLocation:"editors-choice"});c(".external-news ol li").each(function(h,j){b.addResultLabels("external-news",this,j)});a.track("external",{region:c(".external-news ol"),linkLocation:"external-news"});c(".card").each(function(h,j){b.addResultLabels("search-card",this,j)});a.track("internal",{region:c(".card-holder"),linkLocation:"search-card"});if(d.getParameterByName("sa_f",document.URL)==""&&d.getParameterByName("q",document.URL)!=""&&d.getParameterByName("filter",document.URL)==""){var e=d.getParameterByName("suggid",document.URL)==""?"freetext":"suggestion";b.setLabel("search_type",e);b.setLabel("search_form","search-nav");f.setCardsPresent();b.logInteraction("search-results-page","search-page-with-search")}else{if(c("#search-content").attr("data-submitted")==="false"&&d.getParameterByName("filter",document.URL)==""){b.logInteraction("search-page","search-page-with-no-search")}else{if(this.parseSearchFrom().suggest&&d.getParameterByName("filter",document.URL)==""){f.setCardsPresent();b.logInteraction("search-results-page","search-page")}else{if(d.getParameterByName("sa_f",document.URL)!=""&&d.getParameterByName("filter",document.URL)==""){b.setLabel("search_type","freetext");b.setLabel("search_form",encodeURI(d.getParameterByName("sa_f",document.URL)));f.setCardsPresent();b.logInteraction("search-results-page","search-page-with-search")}else{if(d.getParameterByName("filter",document.URL)!=""){b.setLabel("search_type","refinement");b.setLabel("search_form",encodeURI(d.getParameterByName("sa_f",document.URL)));b.setLabel("search_filter_site",d.getParameterByName("filter",document.URL));f.setCardsPresent();b.logInteraction("search-results-page","search-filter-result")}else{b.logInteraction("search-results-page","search-page")}}}}}},parseSearchFrom:function(){var e=false;var f=(d.getParameterByName("sa_f",document.URL)=="")?"search-product":d.getParameterByName("sa_f",document.URL);if(f.indexOf("--suggest")>-1){e=true;f=f.split("--")[0]}return{form:f,suggest:e}},logInteraction:function(e,f,h){var g=this.buildLabels(f);if(typeof h!="function"){h=null}else{window.setTimeout(h,300)}a.log(e,f,g,h)},addExitLabels:function(f,e){e.linktrack=this.buildLabels(f)},buildLabels:function(f){this.refreshGenericLabels();var g={};var e=this;c(this.actions[f]).each(function(j,h){g[h]=e.getLabel(h)});return g},refreshGenericLabels:function(){this.setLabel("ns_search_term",d.getSearchTerm());this.setLabel("ns_search_results",d.getSearchResultCount());this.setLabel("ns_card_results",d.getCardResultCount())},setLabel:function(e,f){this.labels[e]=f},getLabel:function(e){return this.labels[e]},addResultLabels:function(f,g,h){this.setLabel("search_result_type",f);this.setLabel("search_result_number",c(g).attr("data-result-number"));this.setLabel("search_result_site",b.getSiteFromResult(c(g)));this.setCardsPresent();this.addExitLabels("search-result",g)},getSiteFromResult:function(f){var g="none";if(f.find(".signpost-site").length>0){var e=f.find(".signpost-site").first();g=e.attr("data-site");if(typeof g!==undefined&&g!==false){g=e.text()}}return g},formLabels:{},unloadSent:false,addFormLabels:function(g,f){this.formLabels=this.buildLabels(g);this.formLabels.intlink_from_url=location.href;var e=this;c(window).on("pagehide",function(){if(!e.unloadSent){e.addLabelsToCookie()}e.unloadSent=true});c(window).on("beforeunload",function(h){if(!e.unloadSent){e.addLabelsToCookie()}e.unloadSent=true})},cookieName:"sa_labels",addLabelsToCookie:function(){var f="";if(this.getCookie()!==null){f=this.getCookie()+"&"}var g=[];for(var e in this.formLabels){if(this.formLabels.hasOwnProperty(e)){g.push(encodeURIComponent(e)+"="+encodeURIComponent(this.formLabels[e]))}}f+=g.join("&");this.setCookie(f)},getCookie:function(){var j=this.cookieName+"=",h=document.cookie.split(";"),f;for(var g=0,e=h.length;g<e;g++){f=h[g];while(f.charAt(0)===" "){f=f.substring(1,f.length)}if(f.indexOf(j)===0){return decodeURIComponent(f.substring(j.length,f.length))}}return null},setCookie:function(h){var f=new Date(),e=5*60*1000,g,i;f.setTime(f.getTime()+e);g="; expires="+f.toGMTString();i=this.cookieName+"="+encodeURIComponent(h)+g+"; domain="+this.getDomainFromHost()+"; path=/ ; ";document.cookie=i;return i},getDomainFromHost:function(){var e=window.location.host;var f=e.match(/(bbc(?:\.co\.uk|\.com))$/i);return f?f[1]:e},setCardsPresent:function(){b.setLabel(("cards_present"),d.hasCards()?1:null)}};return b});