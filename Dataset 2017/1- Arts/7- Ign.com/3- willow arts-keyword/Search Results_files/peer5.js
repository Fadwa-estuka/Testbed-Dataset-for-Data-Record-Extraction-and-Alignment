var peer5=function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="/",t(0)}([function(e,t,n){n(116),e.exports=n(119)},function(e,t){e.exports={core:{apis:{},apiValidators:{},dataStructures:{},data:{},controllers:{},media:{},protocol:{},transport:{},util:{},stats:{},workers:{},playlist:{}},client:{downloader:{}},state:{},players:{}}},function(e,t,n){"use strict";var r=n(99);e.exports={VERSION:"2.1",CHUNKY_HEAD_LENGTH:1e5,SMALL_FILE_SIZE:10485760,USE_HEAD:!1,IGNORE_LENGTH:!1,PLAYER_REQUEST_ALWAYS_HTTP:!1,MIMIC_REAL_HTTP_DOWNLOAD:!1,MIMIC_REAL_HTTP_INTERVAL:100,REMOVE_QUERYSTRING_FOR_HASH:!0,REMOVE_WOWZA_SESSION_ID_FOR_HASH:!0,REMOVE_SUBDOMAIN_FOR_HASH:!1,REPLACE_IP_TOKEN_FOR_HASH:!1,REPLACE_HOSTNAME_WITH_TOKEN_FOR_HASH:!1,HASH_ALLOWED_QUERY_PARAMETERS:[],REMOVE_REGEX_MATCH_FOR_HASH:null,REMOVE_PROTOCOL_FOR_HASH:!0,DISABLE_CHROME:!1,DISABLE_FIREFOX:!1,HTTP_ONLY:!1,PC_MOCK:!1,STUN_SERVERS:["stun.l.google.com:19302"],TURN_SERVERS:[],TURN_CREDENTIALS:[],MAX_CONNECTIONS:15,MIN_CONNECTIONS:10,SECONDS_BEFORE_IDLE:120,SECONDS_SINCE_LAST_HAVE:60,PC_FAIL_TIMEOUT:15e3,PC_RECON_METHOD:"none",PC_RECON_EXP_COEF:2,PC_RECON_DELAY:1e4,PC_RESEND_INTERVAL:1e3,PC_CREATE_INTERVAL:0,REQUEST_DROPPED_FAIL:20,SMALL_WINDOW_THRESHOLD:1,CLOSE_SMALL_WINDOW_CONNECTIONS:!1,CHUNK_SIZE:16e3,BLOCK_SIZE:12e5,MAX_PENDING_CHUNKS:100,PC_CHUNK_EXPIRATION_TIMEOUT:4e3,P2P_SEND_RETRIES:3,PC_POOL_SIZE:100,PC_POOL_INIT_INTERVAL:100,PC_POOL_LOW:10,PC_POOL_REGEN_INTERVAL:5e3,MAX_PC_CREATE:1e5,PC_CLOSE_TIMEOUT:5e3,PC_SDP_FLUSH_TIMEOUT:300,PC_SDP_FLUSH_LENGTH:4,PC_ALLOCATE_CHUNKS_EVENLY:!1,DC_UNORDERED:!0,DC_MAX_RETRANSMITS:void 0,DC_MAX_PACKET_LIFE_TIME:void 0,PEER_UPLINK_REPORT_INTERVAL:1e4,DELAY_REPORT_INTERVAL:1e4,PC_IDLE_FACTOR:.66,PC_LATENCY_INTERVAL:1e3,PC_LATENCY_ENABLED:!1,ALLOWED_FILE_SIZE:268697600,ALLOWED_FILE_SIZE_FF:10737418240,USE_FS:!0,USE_PERSISTENT:!0,DISABLE_FS_FF:!0,PROMPT_TIMEOUT:2e4,PERSISTENT_FS_SIZE:10737418240,TEMPORARY_FS_SIZE:32212254720,CACHE_SIZE:52428800,FS_ROOT_DIR:"peer5/",PREALLOCATE_FILE:!0,PERIODIC_CACHE_CLEANUP_PERIOD:6048e5,TIME_PERIOD_FILE_STILL_LIVE:72e5,SOCKET_RECONNECTION_INTERVAL:3e4,WS_ENABLED:!0,WS_URL:"wss://ws.peer5.com",XHR_INITIAL_TIMEOUT:1e4,XHR_MAXIMUM_TIMEOUT:3e4,XHR_MINIMUM_TIMEOUT:2e3,XHR_TIMEOUT_FACTOR:2,XHR_ALLOW_RANGE:!0,XHR_MAX_GET:1,XHR_CONCURRENT:4,HTTP_IDLE_RESET_DURATION:3e4,XHR_SLOT_PROBE_INTERVAL:3e4,MONITOR_INTERVAL:200,REPORT_INTERVAL:2e4,REPORT_TTL_MS:3e5,STAT_CALC_INTERVAL:500,DISABLE_GOOGLE_ANALYTICS:!1,DISABLE_GOOGLE_EVENTS:!0,GOOGLE_SAMPLING_RATIO:20,SEQUENTIAL_DOWNLOAD:!1,INITIAL_DL_SECS_ESTIMATION:0,PARALLEL_HTTP_AND_P2P:!0,SYNCED_BUFFERS:!0,HIGH_BUFFER_HTTP_CONSTRAINT:1e4,EXTERNAL_MINIMUM_HTTP_CONSTRAINT:1e4,EXTERNAL_MAXIMUM_HTTP_CONSTRAINT:1e4,BLOCK_ALLOCATION_INTERVAL:100,HTTP_FETCH_AHEAD:!1,FETCH_AHEAD_MIN_SEEDERS:1,P2P_DOWNLOADING_MSG:!0,HTTP_INIT_AHEAD:!1,HTTP_INIT_AHEAD_MIN_SEEDERS:1,PEER_LIVE_DETECTION:!1,EARLY_LIVE_DETECTION:!1,EARLY_LIVE_DETECTION_INTERVAL:1e3,LIVE_DETECTION_WINDOW:10,MERGE_REQUESTS:!1,P2P_VOD_WINDOW:10,HTTP_VOD_WINDOW:5,MAX_P2P_REQUESTS:2,MAX_HTTP_REQUESTS:0,DYNAMIC_PREFETCH:!1,MAX_REQUEST_CACHE_SIZE_VOD:314572800,MAX_REQUEST_CACHE_SIZE_LIVE:104857600,SKIP_JOIN_MIN_TIME:0,EXTERNAL_MEDIA_FALLBACK_ON_FLASH:!1,EXTERNAL_MEDIA_LOWBUFFER:.1,EXTERNAL_MEDIA_MINBUFFER:-1,EXTERNAL_MEDIA_MINBUFFER_LENGTH_CAPPING:-1,EXTERNAL_MEDIA_MAXBUFFER:120,EXTERNAL_MEDIA_LIVE_START_POS:-1,EXTERNAL_MEDIA_MAXBUFFER_SIZE:6e7,EXTERNAL_MEDIA_MANIFEST_TIMEOUT:1e4,EXTERNAL_MEDIA_MANIFEST_RETRIES:6,EXTERNAL_MEDIA_MANIFEST_RETRY_DELAY:500,EXTERNAL_MEDIA_FRAGMENT_TIMEOUT:12e4,EXTERNAL_MEDIA_FRAGMENT_RETRIES:6,EXTERNAL_MEDIA_FRAGMENT_RETRY_DELAY:500,EXTERNAL_MEDIA_FPS_MONITOR_PERIOD:5e3,EXTERNAL_MEDIA_FPS_MONITOR_THRESHOLD:.2,EXTERNAL_MEDIA_HLSJS_ENABLE:!0,EXTERNAL_MEDIA_HLSJS_DEBUG:!1,EXTERNAL_MEDIA_HLSJS_OVERRIDE:!0,EXTERNAL_MEDIA_MAX_BUFFER_HOLE:.5,EXTERNAL_VIDEOTAG_MONITORING:!0,EXTERNAL_MEDIA_WATERMARK:!1,EXTERNAL_DISABLE_UNSUPPORTED:!0,EXTERNAL_DISABLE_DVR:!1,VIDEOTAG_FIND_INTERVAL:500,INTERNAL_VIDEOTAG_MONITORING:!1,DISABLE_ABR_CONFIGURE:!1,AGGRESSIVE_P2P:!1,REQUEST_TIMEOUT:!0,P2P_TIMEOUT_DURATION:1e4,HTTP_TIMEOUT_DURATION:1e5,PLAYLIST_TIMEOUT:!0,PLAYLIST_TIMEOUT_DURATION:1e4,INITIAL_P2P_SLOTS:2,MINIMUM_P2P_SLOTS:1,ADD_SLOT_LOADED_REQUESTS_THRESHOLD:3,REDUCE_SLOT_ABORTS_THRESHOLD:2,TIME_ESTIMATION_LIST_LENGTH:5,ZIXI_DIGEST:!1,MINIMUM_METADATA_SIZE:1e6,VIDEO_DOWNLOAD_SIZE:3e5,BUFFERING_THRESHOLD:.1,URGENT_THRESHOLD:2,BYTE_NEEDED_THRESHOLD:10,ENOUGH_BYTES_THRESHOLD:20,STOP_BUFFERING_THRESHOLD:2,BLOCK_GAP:17,BANDWIDTH_INTERVAL:1e4,LIVE_SECONDS_DELAY:r.randomOffset(10,35,5),MIN_NUMBER_OF_REMAINING_SEGMENTS:3,SEGMENTS_AFTER_PRUNE:3,FEATURE_PRUNE_SEGMENTS_FROM_START:!0,FEATURE_DATACHANNEL_KEY:"DATACHANNEL",FEATURE_DATACHANNEL_ENABLED:!0,FEATURE_PAGE_WHITELIST_KEY:"PAGE_WHITELIST",FEATURE_PAGE_WHITELIST_ENABLED:!1,FEATURE_PAGE_WHITELIST_REGEX:/peer5/,FEATURE_PAGE_BLACKLIST_KEY:"PAGE_BLACKLIST",FEATURE_PAGE_BLACKLIST_ENABLED:!1,FEATURE_PAGE_BLACKLIST_REGEX:/peer5/,FEATURE_XHR_KEY:"XHR",FEATURE_XHR_ENABLED:!0,FEATURE_PEER5_KEY:"PEER5",FEATURE_PEER5_ENABLED:!0,FEATURE_P2P_IMPROVEMENT_ENABLED:!1,FEATURE_LIMIT_SLOTS_BY_PEERS:!1,FEATURE_CLOSE_DEAD_CONNECTIONS:!0,FEATURE_CLOSE_DEAD_CONNECTIONS_PERMANENTLY:!1,FEATURE_CLOSE_OVERLAPPING_CONNECTIONS:!0,FEATURE_CLOSE_OVERLAPPING_CONNECTIONS_PERMANENTLY:!1,FEATURE_PRE_PLAY_PREFETCH:!0,SEGMENTS_TO_PREFETCH_BEFORE_PLAY:10,STOP_PREFETCH_AFTER_SECONDS:60,PLAYER_SEGMENTS_BUFFER:3,PREFETCH_LIVE_INTERVAL_MS:2e3,MAX_REBUFFER_DURATION:18e4,FEATURE_DOWNLOAD_SPEED_ESTIMATION:!1,RELEVANT_LAST_ENTRIES:5,SIMPLE_SPEED_ESTIMATOR:!1,SPEED_SMOOTH_FACTOR:.1,SPEED_FACTOR:1,URL_ALLOWED_QUERY_PARAMETERS:[],FEATURE_WS_HEARTBEAT:!1,FEATURE_WS_HEARTBEAT_INTERVAL:5e3,FEATURE_WS_HEARTBEAT_ELAPSED:6e4,LOG_LEVEL:0,TRACK_REPORT_LEVEL:1,TRACK_PLAYER_EVENTS_MAX:16,GA_ONERROR:!0,SENTRY_APP_URL:"https://a9e5ea6c873c451cbc2da95cbdb1e74e@app.getsentry.com/78409",EXTERNAL_XHR_FALLBACK:Math.random()<.01,AB_TEST_TOGETHER:!1,LEECH:!1,BUFFER_LENGTH_LEECH_LOW_SEC:0,A_B_TEST:{},A_B_INITIAL_JSON:null,A_B_CONFIG_JSON:null,DYNAMIC_CONFIG:!1,STATS_RECENT_QUERY_AGE:15e3,STATS_RECENT_MAX_AGE:12e4,STATS_ENABLE_OVERLAY:!1,EXTERNAL_JW_MUX_PLUGIN:!1}},function(e,t,n){(function(t){"use strict";function r(){function e(e){k[e]={},y.forEach(function(t){k[e][t]=0});for(var n in R)k[e][n]=0;M[e]=new t.core.stats.StatsCalculator(e)}function n(){return D}function r(e){var t=e||"*",r={};for(var i in k[t])r[i]=k[t][i];for(var i in w)r[i]=w[i];return r.numOfPeers=n(),r}function a(e){return s.getPredictedSpeed(e)||A||C||s.getSpeed(e)||0}function c(){for(var e in M)M[e].calcAvg(k[e])}function l(e,t){k[e]&&(Object.keys(t).forEach(function(n){k[e][n]=(k[e][n]||0)+t[n]}),N.sum(t))}function d(e){N.sum(e)}function h(e){N.max(e)}function f(e){N.average(e)}function p(e){N.sumRecent(e)}function g(e){N.averageRecent(e)}function v(e){return N.getStats(e)}function m(e){var n=s.getPredictedSpeed(e),r=s.getSpeed(e);r>0?(C=r,t.info("last http speed for "+e+" updated to: "+r)):t.info("last http speed value is invalid: "+r),n>0?(A=n,t.info("last http predicted speed for "+e+" updated to: "+n)):t.info("last http predicted speed value is invalid: "+n)}function _(e,t){delete M[e],delete k[e],delete M[t],delete k[t],s.removeResource(e)}function E(e){u(I,e)}function b(){return u({},I)}function S(){radio("report:full").subscribe([function(t,n){k[t]||e(t);for(var r in R){var i=R[r];k["*"][r]+=n[i],k[t][r]+=n[i]}}]),radio("report:p2pWaste").subscribe([function(t,n){k[t]||e(t);var r="totalP2PWaste";k["*"][r]+=n,k[t][r]+=n}]),radio("httpDownloaded").subscribe([function(t,n){k[t]||e(t),k["*"].totalHttpDownloaded+=n,k[t].totalHttpDownloaded+=n,k[t].totalHttpProgress+=n}]),radio("chunkSent").subscribe([function(t,n){k[t]||e(t),k["*"].totalP2PUploaded+=n,k[t].totalP2PUploaded+=n,p({recentP2PUploaded:n})}]),radio("blockReceived").subscribe([function(t,n){k[t]||e(t);var r="totalVerifiedBytes";k["*"][r]+=n,k[t][r]+=n}]),radio("blockVerifiedP2P").subscribe([function(t){k[t]||e(t),k[t].totalP2PProgress=0}]),radio("blockVerifiedHTTP").subscribe([function(t){k[t]||e(t);var n=k[t].totalP2PProgress;k[t].totalP2PWaste+=n,k[t].totalP2PProgress=0}]),radio("resourceAdded").subscribe([function(n){k[n]||e(n),k[n].totalHttpProgress=0,k[n].start=performance.now(),k[n].startLoaded=k[n].totalVerifiedBytes;var r=Math.round(1e3*t.core.apis.MediaFetcher.mediaController.getBufferLength());k[n].startBufferHealth=r}]),radio("resourceLoadEnd").subscribe([function(e){k[e].end=performance.now(),m(e)}]),radio("external.player").subscribe([function(e){L.processEvent(e.action),P.indexOf(e.action)!==-1&&E({lastPlayerEvent:e.action,sinceLastPlayerEvent:Date.now()}),void 0!==w[e.action]&&"number"==typeof e.duration?w[e.action].push(e.duration):"fps.drop"===e.action&&(O.push(e.value),e.value&&N.sum({totalFPSDrop:e.value}))}]),radio("player.attach").subscribe([function(e){Object.keys(w).forEach(function(t){e.on(t,function(e){w[t].push(e.duration)})}),P.forEach(function(t){e.on(t,function(){L.processEvent(t),E({lastPlayerEvent:t,sinceLastPlayerEvent:Date.now()})})}),e.on("fps.drop",function(e){O.push(e.value)}),e.on("fps.drop.raw",function(e){N.sum({totalFPSDrop:e.value||0})}),e.on("bitsDecoded",function(e){if(e.value){N.sum({totalBitsDecoded:e.value});var t=L.getTotalDurations();E({avgBitrate:1e3*Math.round(N.getStats().totalBitsDecoded/t.play)||0})}}),e.on("media.info",function(e){E(e)})}]),radio("fileInfoProcessed").subscribe([function(t){t.swarmId&&t.url&&(k[t.swarmId]&&!k[t.url]?(k[t.url]=k[t.swarmId],M[t.url]=M[t.swarmId]):k[t.url]&&!k[t.swarmId]?(k[t.swarmId]=k[t.url],M[t.swarmId]=M[t.url]):k[t.swarmId]||k[t.url]||(e(t.swarmId),k[t.url]=k[t.swarmId],M[t.url]=M[t.swarmId]),M[t.swarmId].url=t.url,M[t.swarmId].size=t.size)}]),radio("activePeerConnectionsNumberChanged").subscribe([function(e){D=e}])}function T(){return r()}var y=["totalP2PDownloaded","totalP2PUploaded","totalP2PWaste","totalHttpDownloaded","totalHttpWaste","totalFSLoaded","totalVerifiedBytes","totalP2PProgress","totalHttpProgress"],R={totalP2PDownloaded:"p2pDown",totalP2PWaste:"p2pWaste",totalHttpWaste:"httpWaste",totalFSLoaded:"fsLoad"},w={"load.end":[],"seek.end":[],"rebuffer.end":[]},P=["ready","load.start","load.end","pause.start","pause.end","rebuffer.start","rebuffer.end","seek.start","seek.end"],I={},O=[],C=0,A=0,k={},D=0,M={},N=i(),L=o();return e("*"),S(),{getStats:r,getNumOfPeers:n,getSpeed:a,calcAvg:c,sum:l,sumGlobal:d,maxGlobal:h,avgGlobal:f,sumRecentGlobal:p,averageRecentGlobal:g,getGlobalStats:v,removeResource:_,publicGetStats:T,getTotalDurations:L.getTotalDurations,statsCalculators:M,setMediaInfo:E,getMediaInfo:b}}n(26);var i=n(134),a=n(2),o=n(131),s=n(a.SIMPLE_SPEED_ESTIMATOR?75:25),u=n(14),c=r();e.exports=c,t.core.stats.StatsCollector=e.exports}).call(t,n(1))},function(e,t,n){(function(t){"use strict";function r(e,t,n){n&&console[e]("[peer5] > EXCEPTION:",n);var r=t;"string"!=typeof t&&(r=JSON.stringify(t)),console[e]("[peer5] > "+r)}function i(e){var t=e;return"string"==typeof e&&(t={message:e}),t.lastPlayerEvents=d,t}function a(e,t,n){n&&!n.stack&&c.warn("Invalid logging!"),l[u[e]]++;var a=o.LOG_LEVEL;if(!(e>o.TRACK_REPORT_LEVEL&&e>a))switch(e){case 1:o.TRACK_REPORT_LEVEL>=1&&s.trackError(n,i(t)),a>=1&&r("error",t,n);break;case 2:o.TRACK_REPORT_LEVEL>=2&&s.trackWarning(n,i(t)),a>=2&&r("warn",t,n);break;case 3:a>=3&&r("info",t,n);break;default:throw new Error("internal")}}var o=n(2),s=n(40),u=["none","error","warn","info"],c={},l={error:0,warn:0,info:0},d=[];c.setLogLevel=function(e){o.LOG_LEVEL=e},c.logPlayerEvent=function(e){for(;d.length>=o.TRACK_PLAYER_EVENTS_MAX;)d.shift();d.push([Date.now(),e])},c.info=function(e){a(3,e)},c.warn=function(e,t){a(2,e,t)},c.error=function(e,n){var r,i=typeof e;if(a(1,e,n),o.GA_ONERROR){if("object"===i)r=JSON.stringify(e);else{if("string"!==i)return void t.warn("couldnt send error event of type "+i);r=e}n&&(r+=": "+n),radio("peer5error").broadcast(r)}},c.getMetrics=function(){return l},["setLogLevel","info","warn","error"].forEach(function(e){t[e]=c[e]}),e.exports=c}).call(t,n(1))},function(e,t){"use strict";function n(e,n,r){this.tag=t.P2P_DATA,this.swarmId=e,this.chunkId=n,this.payload=r}function r(e,n){this.tag=t.P2P_REQUEST,this.swarmId=e,this.chunkIds=n}function i(e,n,r,i,a){this.tag=t.P2P_HAVE,this.swarmId=e,this.hashUrl=i||"0123456789abcdefghijklmnopqrstuv",this.seeder=n,this.filesize=a,this.blockIds=[],n||(this.complete=!0,this.availabilityMap=r)}function a(e,n){this.tag=t.P2P_DONT_HAVE,this.swarmId=e,this.hashUrl=n||"0123456789abcdefghijklmnopqrstuv"}function o(e,n){this.tag=t.P2P_VERSION,this.client=e,this.conf=n}function s(e,n){this.tag=t.P2P_LATENCY_REQUEST,this.timestamp=e,this.originBufferedAmount=n}function u(e,n,r){this.tag=t.P2P_LATENCY_RESPONSE,this.timestamp=e,this.originBufferedAmount=n,this.remoteBufferedAmount=r}function c(e,n){this.tag=t.P2P_DOWNLOADING,this.swarmId=e,this.hashUrl=n}function l(e){this.tag=t.P2P_NEW_SEGMENT,this.segSeq=e}function d(e){this.tag=t.P2P_INITIALIZING,this.hashUrl=e}function h(e,n,r,i,a,o){this.tag=t.FILE_INFO,this.swarmId=e,this.size=n,this.hash=r,this.hashes=i,this.blockSize=a,this.url=o}function f(e,n){this.tag=t.JOIN,this.swarmId=e,this.matchMe=n}function p(e){this.tag=t.LEAVE,this.swarmId=e}function g(e){this.tag=t.GROUP_REPORT,this.body=e}function v(){this.tag=t.HEARTBEAT}function m(e,n,r,i,a,o){this.tag=t.SHARE,this.swarmId=e,this.size=n,this.hash=r,this.hashes=i,this.blockSize=a,this.url=o}function _(e){this.tag=t.LEECH,this.swarmId=e}function E(e,n,r){this.tag=t.GROUP_SDP,this.originId=e,this.destId=n,this.sdp=r}function b(e){this.tag=t.AB_CONFIG,this.conf=e}function S(e){this.tag=t.SESSION_REPORT,this.body=e}t.SWARM_NOT_FOUND=0,t.P2P_DATA=17,t.P2P_REQUEST=18,t.P2P_HAVE=20,t.P2P_DONT_HAVE=22,t.P2P_VERSION=23,t.P2P_LATENCY_REQUEST=24,t.P2P_LATENCY_RESPONSE=25,t.P2P_DOWNLOADING=26,t.P2P_NEW_SEGMENT=27,t.P2P_INITIALIZING=28,t.FILE_INFO=34,t.JOIN=36,t.LEAVE=37,t.CLOSE=38,t.SWARM_ERROR=48,t.GROUP_REPORT=51,t.GROUP_MATCH=52,t.HEARTBEAT=57,t.SHARE=59,t.LEECH=60,t.GROUP_SDP=61,t.AB_CONFIG=62,t.SESSION_REPORT=63,t.DataMessage=n,t.RequestMessage=r,t.HaveMessage=i,t.DontHaveMessage=a,t.VersionMessage=o,t.LatencyRequestMessage=s,t.LatencyResponseMessage=u,t.DownloadingMessage=c,t.NewSegmentMessage=l,t.InitializingMessage=d,t.FileInfoMessage=h,t.JoinMessage=f,t.LeaveMessage=p,t.GroupReportMessage=g,t.HeartbeatMessage=v,t.ShareMessage=m,t.LeechMessage=_,t.GroupSdpMessage=E,t.ABConfigMessage=b,t.SessionReport=S},function(e,t,n){"use strict";function r(){function e(e){for(var t=e;l[t];)t=l[t];return t}function t(e){for(var t=e;l[t];){var n=l[t];delete l[t],t=n}}function n(t){var n=e(t);return!!c[n]}function r(e,t){n(e)&&i.warn("overriding blockmap with key "+e),c[e]=t}function a(t){var n=e(t);return c[n]}function o(e,t){return n(e)?void i.warn("trying to alias an already existing key"):void(l[e]=t)}function s(n){var r=e(n),i=c[r];i&&i.dtor(),delete c[r],t(n)}function u(e){Object.keys(c).forEach(function(t){e(t,c[t])})}var c=Object.create(null),l=Object.create(null);return{add:r,get:a,alias:o,has:n,remove:s,forEach:u}}var i=n(4);r.singleton=r(),e.exports=r},function(e,t){"use strict";e.exports=window.XMLHttpRequest},function(e,t,n){(function(e){function r(e,t){t=t||[];var n=e.split("&"),r=n.filter(function(e){var n=e.split("=")[0];return t.indexOf(n)>-1});return r.join("&")}function i(e){return e.replace(d,s.TOKEN)}function a(e){return e.replace(l,s.TOKEN)}function o(e){return e.replace(h,"")}var s=n(2),u=n(141),c=n(9),l=/^https?:\/\/(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])*/,d=/^https?:\/\/(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9][0-9]|[0-9])/,h=/^https?:\/\//;t.zixi=function(e){var t,n=e.indexOf("hlsid=HLS_"),r=e.indexOf("interstream");if(n!==-1&&r!==-1){e=e.replace(":80/","/");var i=e.split("?"),a=i[0]+"?",o=i[1].split("&"),s=o[0].indexOf("interstream"),u=o[0].substring(0,s+13)+"1&",c=o[1]+"&",l=o[2].indexOf("hlsid=HLS"),d=o[2].substring(0,l)+"hlsid=HLS_1";t=[a,u,c,d].join("")}else t=e;return t},t.urlWithAllowedKeys=function(e,t){var n=e.indexOf("?");if(n!==-1){var i=e.substring(0,n),a=e.substring(n+1),o=r(a,t);return o?i+"?"+o:i}return e},t.swarmId=function(n){var r=n;return s.REMOVE_QUERYSTRING_FOR_HASH===!0&&(r=t.urlWithAllowedKeys(r,s.HASH_ALLOWED_QUERY_PARAMETERS)),s.REMOVE_WOWZA_SESSION_ID_FOR_HASH===!0&&(r=u.wowza(r)),s.REPLACE_HOSTNAME_WITH_TOKEN_FOR_HASH===!0?r=a(r):s.REPLACE_IP_TOKEN_FOR_HASH===!0?r=i(r):s.REMOVE_SUBDOMAIN_FOR_HASH===!0?r=e.core.util.removeSubDomain(r):s.REMOVE_PROTOCOL_FOR_HASH===!0&&(r=o(r)),s.REMOVE_REGEX_MATCH_FOR_HASH&&(r=r.replace(s.REMOVE_REGEX_MATCH_FOR_HASH,"")),r};var f=Object.create(null);t.getNormalizedUrlHash=function(e){var n=f[e];if(n)return n;var r=t.swarmId(e);return n=c.hash(r),f[e]=n,n}}).call(t,n(1))},function(e,t,n){!function(t){e.exports=t()}(function(e){"use strict";function t(e,t){var n=e[0],r=e[1],i=e[2],a=e[3];n+=(r&i|~r&a)+t[0]-680876936|0,n=(n<<7|n>>>25)+r|0,a+=(n&r|~n&i)+t[1]-389564586|0,a=(a<<12|a>>>20)+n|0,i+=(a&n|~a&r)+t[2]+606105819|0,i=(i<<17|i>>>15)+a|0,r+=(i&a|~i&n)+t[3]-1044525330|0,r=(r<<22|r>>>10)+i|0,n+=(r&i|~r&a)+t[4]-176418897|0,n=(n<<7|n>>>25)+r|0,a+=(n&r|~n&i)+t[5]+1200080426|0,a=(a<<12|a>>>20)+n|0,i+=(a&n|~a&r)+t[6]-1473231341|0,i=(i<<17|i>>>15)+a|0,r+=(i&a|~i&n)+t[7]-45705983|0,r=(r<<22|r>>>10)+i|0,n+=(r&i|~r&a)+t[8]+1770035416|0,n=(n<<7|n>>>25)+r|0,a+=(n&r|~n&i)+t[9]-1958414417|0,a=(a<<12|a>>>20)+n|0,i+=(a&n|~a&r)+t[10]-42063|0,i=(i<<17|i>>>15)+a|0,r+=(i&a|~i&n)+t[11]-1990404162|0,r=(r<<22|r>>>10)+i|0,n+=(r&i|~r&a)+t[12]+1804603682|0,n=(n<<7|n>>>25)+r|0,a+=(n&r|~n&i)+t[13]-40341101|0,a=(a<<12|a>>>20)+n|0,i+=(a&n|~a&r)+t[14]-1502002290|0,i=(i<<17|i>>>15)+a|0,r+=(i&a|~i&n)+t[15]+1236535329|0,r=(r<<22|r>>>10)+i|0,n+=(r&a|i&~a)+t[1]-165796510|0,n=(n<<5|n>>>27)+r|0,a+=(n&i|r&~i)+t[6]-1069501632|0,a=(a<<9|a>>>23)+n|0,i+=(a&r|n&~r)+t[11]+643717713|0,i=(i<<14|i>>>18)+a|0,r+=(i&n|a&~n)+t[0]-373897302|0,r=(r<<20|r>>>12)+i|0,n+=(r&a|i&~a)+t[5]-701558691|0,n=(n<<5|n>>>27)+r|0,a+=(n&i|r&~i)+t[10]+38016083|0,a=(a<<9|a>>>23)+n|0,i+=(a&r|n&~r)+t[15]-660478335|0,i=(i<<14|i>>>18)+a|0,r+=(i&n|a&~n)+t[4]-405537848|0,r=(r<<20|r>>>12)+i|0,n+=(r&a|i&~a)+t[9]+568446438|0,n=(n<<5|n>>>27)+r|0,a+=(n&i|r&~i)+t[14]-1019803690|0,a=(a<<9|a>>>23)+n|0,i+=(a&r|n&~r)+t[3]-187363961|0,i=(i<<14|i>>>18)+a|0,r+=(i&n|a&~n)+t[8]+1163531501|0,r=(r<<20|r>>>12)+i|0,n+=(r&a|i&~a)+t[13]-1444681467|0,n=(n<<5|n>>>27)+r|0,a+=(n&i|r&~i)+t[2]-51403784|0,a=(a<<9|a>>>23)+n|0,i+=(a&r|n&~r)+t[7]+1735328473|0,i=(i<<14|i>>>18)+a|0,r+=(i&n|a&~n)+t[12]-1926607734|0,r=(r<<20|r>>>12)+i|0,n+=(r^i^a)+t[5]-378558|0,n=(n<<4|n>>>28)+r|0,a+=(n^r^i)+t[8]-2022574463|0,a=(a<<11|a>>>21)+n|0,i+=(a^n^r)+t[11]+1839030562|0,i=(i<<16|i>>>16)+a|0,r+=(i^a^n)+t[14]-35309556|0,r=(r<<23|r>>>9)+i|0,n+=(r^i^a)+t[1]-1530992060|0,n=(n<<4|n>>>28)+r|0,a+=(n^r^i)+t[4]+1272893353|0,a=(a<<11|a>>>21)+n|0,i+=(a^n^r)+t[7]-155497632|0,i=(i<<16|i>>>16)+a|0,r+=(i^a^n)+t[10]-1094730640|0,r=(r<<23|r>>>9)+i|0,n+=(r^i^a)+t[13]+681279174|0,n=(n<<4|n>>>28)+r|0,a+=(n^r^i)+t[0]-358537222|0,a=(a<<11|a>>>21)+n|0,i+=(a^n^r)+t[3]-722521979|0,i=(i<<16|i>>>16)+a|0,r+=(i^a^n)+t[6]+76029189|0,r=(r<<23|r>>>9)+i|0,n+=(r^i^a)+t[9]-640364487|0,n=(n<<4|n>>>28)+r|0,a+=(n^r^i)+t[12]-421815835|0,a=(a<<11|a>>>21)+n|0,i+=(a^n^r)+t[15]+530742520|0,i=(i<<16|i>>>16)+a|0,r+=(i^a^n)+t[2]-995338651|0,r=(r<<23|r>>>9)+i|0,n+=(i^(r|~a))+t[0]-198630844|0,n=(n<<6|n>>>26)+r|0,a+=(r^(n|~i))+t[7]+1126891415|0,a=(a<<10|a>>>22)+n|0,i+=(n^(a|~r))+t[14]-1416354905|0,i=(i<<15|i>>>17)+a|0,r+=(a^(i|~n))+t[5]-57434055|0,r=(r<<21|r>>>11)+i|0,n+=(i^(r|~a))+t[12]+1700485571|0,n=(n<<6|n>>>26)+r|0,a+=(r^(n|~i))+t[3]-1894986606|0,a=(a<<10|a>>>22)+n|0,i+=(n^(a|~r))+t[10]-1051523|0,i=(i<<15|i>>>17)+a|0,r+=(a^(i|~n))+t[1]-2054922799|0,r=(r<<21|r>>>11)+i|0,n+=(i^(r|~a))+t[8]+1873313359|0,n=(n<<6|n>>>26)+r|0,a+=(r^(n|~i))+t[15]-30611744|0,a=(a<<10|a>>>22)+n|0,i+=(n^(a|~r))+t[6]-1560198380|0,i=(i<<15|i>>>17)+a|0,r+=(a^(i|~n))+t[13]+1309151649|0,r=(r<<21|r>>>11)+i|0,n+=(i^(r|~a))+t[4]-145523070|0,n=(n<<6|n>>>26)+r|0,a+=(r^(n|~i))+t[11]-1120210379|0,a=(a<<10|a>>>22)+n|0,i+=(n^(a|~r))+t[2]+718787259|0,i=(i<<15|i>>>17)+a|0,r+=(a^(i|~n))+t[9]-343485551|0,r=(r<<21|r>>>11)+i|0,e[0]=n+e[0]|0,e[1]=r+e[1]|0,e[2]=i+e[2]|0,e[3]=a+e[3]|0}function n(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function r(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function i(e){var r,i,a,o,s,u,c=e.length,l=[1732584193,-271733879,-1732584194,271733878];for(r=64;r<=c;r+=64)t(l,n(e.substring(r-64,r)));for(e=e.substring(r-64),i=e.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r=0;r<i;r+=1)a[r>>2]|=e.charCodeAt(r)<<(r%4<<3);if(a[r>>2]|=128<<(r%4<<3),r>55)for(t(l,a),r=0;r<16;r+=1)a[r]=0;return o=8*c,o=o.toString(16).match(/(.*?)(.{0,8})$/),s=parseInt(o[2],16),u=parseInt(o[1],16)||0,a[14]=s,a[15]=u,t(l,a),l}function a(e){var n,i,a,o,s,u,c=e.length,l=[1732584193,-271733879,-1732584194,271733878];for(n=64;n<=c;n+=64)t(l,r(e.subarray(n-64,n)));for(e=n-64<c?e.subarray(n-64):new Uint8Array(0),i=e.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0;n<i;n+=1)a[n>>2]|=e[n]<<(n%4<<3);if(a[n>>2]|=128<<(n%4<<3),n>55)for(t(l,a),n=0;n<16;n+=1)a[n]=0;return o=8*c,o=o.toString(16).match(/(.*?)(.{0,8})$/),s=parseInt(o[2],16),u=parseInt(o[1],16)||0,a[14]=s,a[15]=u,t(l,a),l}function o(e){var t,n="";for(t=0;t<4;t+=1)n+=g[e>>8*t+4&15]+g[e>>8*t&15];return n}function s(e){var t;for(t=0;t<e.length;t+=1)e[t]=o(e[t]);return e.join("")}function u(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function c(e,t){var n,r=e.length,i=new ArrayBuffer(r),a=new Uint8Array(i);for(n=0;n<r;n+=1)a[n]=e.charCodeAt(n);return t?a:i}function l(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function d(e,t,n){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e)),r.set(new Uint8Array(t),e.byteLength),n?r:r.buffer}function h(e){var t,n=[],r=e.length;for(t=0;t<r-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function f(){this.reset()}var p=function(e,t){return e+t&4294967295},g=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==s(i("hello"))&&(p=function(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||!function(){function t(e,t){return e=0|e||0,e<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,r){var i,a,o,s,u=this.byteLength,c=t(n,u),l=u;return r!==e&&(l=t(r,u)),c>l?new ArrayBuffer(0):(i=l-c,a=new ArrayBuffer(i),o=new Uint8Array(a),s=new Uint8Array(this,c,i),o.set(s),a)}}(),f.prototype.append=function(e){return this.appendBinary(u(e)),this},f.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var r,i=this._buff.length;for(r=64;r<=i;r+=64)t(this._hash,n(this._buff.substring(r-64,r)));return this._buff=this._buff.substring(r-64),this},f.prototype.end=function(e){var t,n,r=this._buff,i=r.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)a[t>>2]|=r.charCodeAt(t)<<(t%4<<3);return this._finish(a,i),n=s(this._hash),e&&(n=h(n)),this.reset(),n},f.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},f.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},f.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},f.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},f.prototype._finish=function(e,n){var r,i,a,o=n;if(e[o>>2]|=128<<(o%4<<3),o>55)for(t(this._hash,e),o=0;o<16;o+=1)e[o]=0;r=8*this._length,r=r.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(r[2],16),a=parseInt(r[1],16)||0,e[14]=i,e[15]=a,t(this._hash,e)},f.hash=function(e,t){return f.hashBinary(u(e),t)},f.hashBinary=function(e,t){var n=i(e),r=s(n);return t?h(r):r},f.ArrayBuffer=function(){this.reset()},f.ArrayBuffer.prototype.append=function(e){var n,i=d(this._buff.buffer,e,!0),a=i.length;for(this._length+=e.byteLength,n=64;n<=a;n+=64)t(this._hash,r(i.subarray(n-64,n)));return this._buff=n-64<a?new Uint8Array(i.buffer.slice(n-64)):new Uint8Array(0),this},f.ArrayBuffer.prototype.end=function(e){var t,n,r=this._buff,i=r.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)a[t>>2]|=r[t]<<(t%4<<3);return this._finish(a,i),n=s(this._hash),e&&(n=h(n)),this.reset(),n},f.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},f.ArrayBuffer.prototype.getState=function(){var e=f.prototype.getState.call(this);return e.buff=l(e.buff),e},f.ArrayBuffer.prototype.setState=function(e){return e.buff=c(e.buff,!0),f.prototype.setState.call(this,e)},f.ArrayBuffer.prototype.destroy=f.prototype.destroy,f.ArrayBuffer.prototype._finish=f.prototype._finish,f.ArrayBuffer.hash=function(e,t){var n=a(new Uint8Array(e)),r=s(n);return t?h(r):r},f})},function(e,t,n){(function(t){function r(e){if(t.config.ZIXI_DIGEST){var n=p.zixi(e);return n}return e=c.removeKeysFromQuery(e,["_","time"])}n(27);var i=n(12),a=n(18),o=n(3),s=n(19),u=n(7),c=n(140),l=n(2),d=n(29),h=n(129),f=n(130)(),p=n(8),g="ï»¿",v=i.HYBRID,m=i.P2P,_=i.HTTP,E=i.DYNAMIC,b=Object.subClass({ctor:function(e){this.readyState=0,this.response,this.responseText=null,this._responseHeaders="server: peer5",this.responseType="",this.timeout="unimplemented",this.status,this._range,this._url,this._method,this._data,this.withCredentials=!1,this._swarmState={uploaded:0},this.fileInfo,this._meta={},e=this.sanitizeCtorArgs(e),this.downloadMode=e.downloadMode,this.md5=e.md5,this.sha1=e.sha1,this.origin=e.origin,this._responseHeadersMap=Object.create(null),this._startLoaded,this._startTime,this._speed,this._constraint,this.onloadstart,this.onprogress,this.onabort,this.onerror,this.onload,this.ontimeout="unimplemented",this.onloadend,this.onreadystatechange,this.onswarmstatechange,this.eventListeners=Object.create(null),this.eventListeners.loadstart=[],this.eventListeners.progress=[],this.eventListeners.abort=[],this.eventListeners.error=[],this.eventListeners.load=[],this.eventListeners.timeout=[],this.eventListeners.loadend=[],this.eventListeners.readystatechange=[],this.eventListeners.swarmstatechange=[],this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4},open:function(e,t){if(t=c.normalizeUrl(t),this._method=e&&e.toUpperCase(),!this._method)return!1;if("GET"===this._method&&t)t=r(t),this._url=t;else if(this.isCatchAllRequest)this._url=t;else{if("POST"!==this._method)return this._url=t,!1;this._url="peer5://"+a()}return this.changeReadyState(1),this.isMethodSupported(this._method)?void 0:this.fallbackToNative()},setResponseHeaders:function(e){for(var t=e.split("\n"),n=0;n<t.length;n++){var r=t[n].split(":"),i=r.shift().trim(),a=r.join(":").trim();this._responseHeadersMap[i]=a}},forceImmediateLoad:function(e){t.client.bypassServer(this,e)},setRequestHeader:function(e,t){},send:function(e){if(this._data=e,radio("requestSent").broadcast(this),!t.clientInstance.isValidated()){var n=this;return void t.getCompatibilityStatus(function(e){n.handleRequestError(e[0])})}e||"GET"!==this._method||1!=this.readyState||(this._meta={sha1:this.sha1,md5:this.md5,origin:this.origin,constraint:this._constraint,httpConstraint:this._httpConstraint,skipJoin:this.skipJoin},this._startLoaded=t.core.stats.StatsCollector.getStats(this._url).totalVerifiedBytes||0,this._startTime=Date.now(),f.addRequest(this)),e&&"POST"===this._method&&1==this.readyState&&e instanceof Blob&&this.changeReadyState(2)&&f.addRequest(this)},getResponseHeader:function(e){if(this.readyState<2)throw"Response headers are available only when readystate >=2";var n=this._responseHeadersMap[e];return n?n:(t.warn('Refused to get unsafe header "'+e+'"'),null)},getAllResponseHeaders:function(){return this._responseHeaders},getFileInfo:function(){if(this.readyState>=2)return this.fileInfo},abort:function(e){this.readyState>=1&&this.readyState<3&&t.warn("peer5.Request::abort: aborting a request with readyState < 3: "+this.readyState+" "+this._url);var n=this.createProgressEvent();e&&e.leaveSwarm?t.clientInstance.removeResource(this._url):t.clientInstance.stopResource(this._url),this.changeReadyState(4,!0)&&(this._triggerEvent("progress",n),this._triggerEvent("abort",n),this._triggerEvent("loadend",n),f.removeRequest(this))},addEventListener:function(e,t){this.eventListeners[e]&&this.eventListeners[e].push(t)},removeEventListener:function(e,t){if(this.eventListeners[e]){var n=this.eventListeners[e].indexOf(t);n!==-1&&this.eventListeners[e].splice(n,1)}},HTTPHeadersReceivedEvent:function(e,t,n){this._responseHeaders=t,this._responseHeadersMap=n},fileInfoProcessedEvent:function(e){"GET"===this._method&&(this.fileInfo=e,this.changeReadyState(2))},resourceReadyEvent:function(e){var n=this,r=e.swarmId;if("GET"===this._method){if(!this.changeReadyState(3))return;if(3!=this.readyState)return;var i=this.createProgressEvent();this._triggerEvent("loadstart",i),t.clientInstance.isFull(r,function(i){t.info("Resource "+r+" is ready and full="+i),i?l.MIMIC_REAL_HTTP_DOWNLOAD?h(n,e.swarmId,n._getDownloadSpeed(),e.size,function(e){n._triggerEvent("progress",e)},function(){n.handleTransferLoaded(e)}):n.handleTransferLoaded(e):t.config.SYNCED_BUFFERS?radio("needByteRangeEvent").broadcast(n._url,void 0,void 0,n._constraint):radio("needByteRangeEvent").broadcast(n._url)})}else if("POST"===this._method){if(this.fileInfo=e,e.url="peer5://"+e.swarmId,3!==this.readyState)return;this._getUrlAndTriggerOnLoad(e)}},blockReceivedEvent:function(){var e=this.createProgressEvent();this._triggerEvent("progress",e)},httpProgressEvent:function(){var e=this.createProgressEvent();this._triggerEvent("progress",e)},transferLoadedEvent:function(e){this.handleTransferLoaded(e)},requestErrorEvent:function(e,t){this.handleRequestError(e,t)},activePeerConnectionsNumberChangedEvent:function(e){this._swarmState.numOfPeers=e;var t=this.createSwarmStateEvent();this._triggerEvent("swarmstatechange",t)},chunkSentEvent:function(e,n){var r=this;t.clientInstance.getUploadedStats(e,function(e){for(var i in e)"numOfPeers"===i&&0===e[i]&&t.error("chunkSentEvent: sent p2p while connected to 0 peers"),r._swarmState[i]=e[i];var a=r.createSwarmStateEvent();a.sent=n,r._triggerEvent("swarmstatechange",a)})},sanitizeCtorArgs:function(e){switch(e||(e=Object.create(null)),e.downloadMode){case"p2p":e.downloadMode=m;break;case"http":e.downloadMode=_;break;case"dynamic":e.downloadMode=E;break;default:e.downloadMode=v}if(e.md5){if("[object String]"!=Object.prototype.toString.call(e.md5))return t.error("options.sha1 contains invalid characters"),!1}else e.md5=null;if(e.sha1){if("[object String]"!=Object.prototype.toString.call(e.sha1))return t.error("options.sha1 contains invalid characters"),!1}else e.sha1=null;return e},createProgressEvent:function(){var e=d(this);e.verified=t.clientInstance.getNumOfVerifiedBytes(this._url),e.loaded=0,e.lengthComputable=!1;var n=t.clientInstance.getLoadedStats(this._url);for(var r in n)e[r]=n[r],e.loaded+=e[r];return this.fileInfo&&(e.lengthComputable=!0,e.total=this.fileInfo.size),e},createSwarmStateEvent:function(){var e=d(this);for(var t in this._swarmState)e[t]=this._swarmState[t];return e},createEvent:function(){var e={};return e.currentTarget=this,e.target=this,e},changeReadyState:function(e,n){if(n||this.readyState==e-1){if(4===e&&4===this.readyState)return t.info("request has already finished (readystate=4)"),!1;if(this.readyState=e,3==this.readyState&&(this.queuedCommand&&t.core.util.executeFunctionByName(this.queuedCommand[0],this,[this.queuedCommand[1]]),
"GET"===this._method),this.fileInfo){var r=this.createProgressEvent();this._triggerEvent("readystatechange",r)}else{var i=d(this);this._triggerEvent("readystatechange",i)}return!0}return t.info("ready state has jumped a stage"),!1},handleTransferLoaded:function(e){"GET"===this._method?3===this.readyState&&this._getUrlAndTriggerOnLoad(e):"POST"===this._method&&(this.changeReadyState(3),this.fileInfo=e)},handleRequestError:function(e,t){if(this.status=e,this.description=t,f.removeRequest(this),this.changeReadyState(4,!0)){var n=this.createProgressEvent();this._triggerEvent("progress",n),this._triggerEvent("error",n),this._triggerEvent("loadend",n)}},_getDownloadSpeed:function(){return t.core.stats.StatsCollector.getSpeed(this._url)},_complete:function(e){if(this.response=e,this.changeReadyState(4)){var t=this.createProgressEvent();this._triggerEvent("progress",t),this._triggerEvent("load",t),this._triggerEvent("loadend",t),f.removeRequest(this)}},_getUrlAndTriggerOnLoad:function(e){var n=this;this.status=200,t.info("onload "+this._url+" responseType: "+this.responseType+" speed: "+this._speed),t.core.util.asyncDefer(function(){switch(this.responseType){case"arraybuffer":t.clientInstance.getUint8Array(e.swarmId,function(e,r){e?n._complete(r.buffer):t.error("couldn't receive arraybuffer")});break;case"blob":t.clientInstance.getBlob(e.swarmId,function(e,r){e?n._complete(r):t.error("couldn't receive blob")});break;case"document":t.error("document responseType isn't supported"),this.handleRequestError(this.INVALID_RESPONSETYPE,"document is not implemented");break;case"json":t.error("json responseType isn't supported"),this.handleRequestError(this.INVALID_RESPONSETYPE,"json is not implemented");break;case"blobUrl":t.clientInstance.getBlobUrl(e.swarmId,function(e,r){e?n._complete(r):t.error("couldn't receive blobUrl")});break;case"text":default:t.clientInstance.getText(e.swarmId,function(e,r){e?(r=r.replace(g,""),n.responseText=r,n._complete(r)):t.error("couldn't receive text")})}},this)},_triggerEvent:function(e,n){if("progress"===e){var r=this._getDownloadSpeed(this._url),i=l.SPEED_FACTOR;i&&(r*=i),this._speed=r,this._speed<0&&t.error("_speed is negative ("+this._speed+")"),n.loadedHTTP===n.total&&o.avgGlobal({avgHTTPSpeed:this._speed})}for(var a=0;a<this.eventListeners[e].length;a++)t.core.util.envokeCallback(this.eventListeners[e][a],[n],this);t.core.util.envokeCallback(this["on"+e],[n],this)},isMethodSupported:function(e){return/^(GET|POST)$/i.test(e)&&(!this.isCatchAllRequest||"POST"!==e)},fallbackToNative:function(){var e=new u;return e.open(this._method,this._url),s(e,this),e},discontinue:function(){this._method=null}});b.INVALID_RESPONSETYPE=669,b.INVALID_RESPONSELENGTH=668,b.SWARMID_NOT_FOUND_ERR=650,b.FILE_SIZE_ERR=640,b.FIREFOX_ONLY_SWARM_ERR=641,b.CHROME_ONLY_SWARM_ERR=642,b.BROWSER_SWARM_COMPAT_ERR=643,b.OUT_OF_SPACE_ERR=644,b.WRITE_ERR=645,b.VERIFICATION_ERR=646,e.exports=t.Request=b}).call(t,n(1))},function(e,t){"use strict";function n(e){return arguments.length?n.$.channel(e):n.$.reset(),n.$}var r=this;n.$={version:"0.2",channelName:"",channels:[],reset:function(){n.$.channelName="",n.$.channels=[]},broadcast:function(){var e,t,n,i,a=this.channels[this.channelName],o=a.length;for(e=0;e<o;e++)t=a[e],"object"==typeof t&&t.length&&(n=t[0],i=t[1]||r),n.apply(i,arguments);return this},channel:function(e){var t=this.channels;return t[e]||(t[e]=[]),this.channelName=e,this},subscribe:function(){var e,t,n=arguments,r=this.channels[this.channelName],i=n.length,a=[];for(e=0;e<i;e++)a=n[e],t="function"==typeof a?[a]:a,"object"==typeof t&&t.length&&r.push(t);return this},unsubscribe:function(){var e,t,n,r=arguments,i=this.channels[this.channelName],a=r.length,o=i.length,s=0;for(e=0;e<a;e++)for(s=0,o=i.length,t=0;t<o;t++)n=t-s,(!(r[e]instanceof Array)&&i[n][0]===r[e]||r[e]instanceof Array&&i[n][0]===r[e][0])&&(r[e]instanceof Array&&i[n][1]!==r[e][1]||(i.splice(n,1),s++));return this}},e.exports=window.radio=n},function(e,t){"use strict";e.exports={HYBRID:1,P2P:2,HTTP:3,DYNAMIC:4}},function(e,t){"use strict";e.exports={LOADING:1,STOPPED:2}},function(e,t){"use strict";function n(e){if(null===e||void 0===e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}function r(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;var r=Object.getOwnPropertyNames(t).map(function(e){return t[e]});if("0123456789"!==r.join(""))return!1;var i={};return"abcdefghijklmnopqrst".split("").forEach(function(e){i[e]=e}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},i)).join("")}catch(e){return!1}}var i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;e.exports=r()?Object.assign:function(e,t){for(var r,o,s=n(e),u=1;u<arguments.length;u++){r=Object(arguments[u]);for(var c in r)i.call(r,c)&&(s[c]=r[c]);if(Object.getOwnPropertySymbols){o=Object.getOwnPropertySymbols(r);for(var l=0;l<o.length;l++)a.call(r,o[l])&&(s[o[l]]=r[o[l]])}}return s}},function(e,t,n){(function(t){"use strict";function n(e,t){var n=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(e);return i&&decodeURIComponent(i[1].replace(/\+/g," "))}function r(e){for(var t=0;t<e.length;t++)if(e[t])return e[t];return null}function i(e,t){var i=[].slice.call(document.getElementsByTagName("script"));return r(i.filter(function(t){return t.src.indexOf(e)>=0}).map(function(e){return n(e.src,t)}))}var a;e.exports=function(e){var n=e||"peer5.js";return a=a||i(n,"id")||"undefined"!=typeof t&&t.config&&t.config.TOKEN}}).call(t,n(1))},function(e,t,n){(function(t){"use strict";var r=n(10);e.exports=t.VideoRequest=r.subClass({ctor:function(e){this.isVideoPlayerRequest=!0,this._super(e)}})}).call(t,n(1))},function(e,t){e.exports=function(){var e=[],t=0;this.getLength=function(){return e.length-t},this.isEmpty=function(){return 0==e.length},this.enqueue=function(t){e.push(t)},this.dequeue=function(){if(0!=e.length){var n=e[t];return 2*++t>=e.length&&(e=e.slice(t),t=0),n}},this.peek=function(){return e.length>0?e[t]:void 0}}},function(e,t){"use strict";function n(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)}var r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",i=/[xy]/g;e.exports=function(){return r.replace(i,n)}},function(e,t,n){"use strict";function r(e,t){var n=Object.create(null);return Object.keys(e).forEach(function(t){n[t]=e[t]}),n.currentTarget=t,n.target=t,n}function i(e,t){return e?function(){if(arguments.length>0){var n=r(arguments[0],t);e.call(t,n)}else e.call(t)}:null}function a(e,t,n){var r=e;try{Object.defineProperty(t,n,{configurable:!0,set:function(e){r[n]=e},get:function(){return e[n]}})}catch(e){h.warn("proxying future event assignments failed",e)}}function o(e,t,n){var r=e;r[n]=i(t[n],t)||r[n]}function s(e,t,n){o(e,t,n),a(e,t,n)}function u(e,t,n){var r=t;e.addEventListener("readystatechange",function(t){Object.keys(Object.getPrototypeOf(e)).concat(Object.keys(e)).forEach(function(i){return"response"===i&&4===t.currentTarget.readyState&&n?(r[i]=n(e[i]),null):"responseXML"===i?(4!==t.currentTarget.readyState||""!==e.responseType&&"document"!==e.responseType||(n?r[i]=n(e[i]):r[i]=e[i]),null):"responseText"===i?(4!==t.currentTarget.readyState||""!==e.responseType&&"text"!==e.responseType||(n?r[i]=n(e[i]):r[i]=e[i]),null):"function"==typeof e[i]?null:(r[i]=e[i],null)});var i=this.getAllResponseHeaders();i&&r.setResponseHeaders(i)})}function c(e,t){var n=e;n.responseType=t.responseType,f.forEach(function(n){s(e,t,n)}),Object.keys(t.eventListeners).forEach(function(e){for(var r=t.eventListeners[e],a=0;a<r.length;a++){var o=i(r[a],t);n.addEventListener(e,o)}})}function l(e,t){function n(t){r[t]=function(){return e[t].apply(e,arguments)}}var r=t;Object.keys(Object.getPrototypeOf(e)).concat(Object.keys(e)).forEach(function(e){"function"==typeof t[e]&&f.indexOf(e)===-1&&n(e)})}function d(e,t,n){u(e,t,n),c(e,t),l(e,t)}var h=n(4),f=["onreadystatechange","onloadstart","onprogress","onabort","onerror","onload","ontimeout","onloadend"];e.exports=d},function(e,t){"use strict";function n(e,t){if(e in r){var n,i=r[e];for(n in t){if(!(n in i))return!1;if(typeof t[n]!==i[n].type)return!1}for(var a in i)if(i[a].required&&typeof t[a]!==i[a].type)return!1;return!0}return!1}var r={player:{action:{type:"string",required:!0},label:{type:"string",required:!0},value:{type:"number",required:!1},timeSinceLoaded:{type:"number",required:!1},duration:{type:"number",required:!1},vendor:{type:"string",required:!0},id:{type:"string",required:!0},occurrence:{type:"number",required:!1},timeSinceReady:{type:"number",required:!1}}};e.exports=function(e,t){n(e,t)&&radio("external."+e).broadcast(t)}},function(e,t,n){"use strict";var r=n(16);e.exports=r.subClass({ctor:function(e){this.isVideoPlayerRequest=!0,this.isCatchAllRequest=!0,this._super(e)}})},function(e,t,n){(function(t){"use strict";var r=n(10);e.exports=t.FragmentRequest=r.subClass({ctor:function(e){this.isFragmentRequest=!0,this._super(e)}})}).call(t,n(1))},function(e,t,n){(function(t){"use strict";function r(){function e(e,t){void 0===r[e]&&(r[e]=i(e,t))}function t(e,t){var i=r[e],a=i.getEvents(t);n("player",a)}function n(e,t){t.forEach(function(t){a(e,t)})}var r=Object.create(null);return{updateAction:t,initPlayer:e}}var i=n(47),a=n(20);e.exports=t.players.EventsDispatcher=r()}).call(t,n(1))},function(e,t,n){(function(t){"use strict";var r=n(10);e.exports=t.PlaylistRequest=r.subClass({ctor:function(e){this.isPlaylistRequest=!0,this._super(e)}})}).call(t,n(1))},function(e,t,n){(function(t){function r(){function e(e){if(!d[e]){var t=Object.create(null);t.slots=0,t.loaded=0,t.endedIntervalsDuration=0,t.currIntervalStart=null,t.speed=void 0,t.nbProgress=0,d[e]=t}var n=d[e];n.slots++,1===n.slots&&(n.currIntervalStart=performance.now())}function n(e){var t=d[e];t&&(t.slots--,0===t.slots&&(t.endedIntervalsDuration+=performance.now()-t.currIntervalStart,r(e,t.endedIntervalsDuration)))}function r(e,n){if(i.has(e)){var r=d[e],a=i.get(e),o=a.fileSize,s=(o-r.loaded)/h;s<0&&t.error("durationLeft is negative ("+s+")"),r.predictedSpeed=o/(s+n/1e3)}}function o(e,t){var n=performance.now(),i=d[e];if(i){i.loaded+=t,i.nbProgress++;var a=n-i.currIntervalStart+i.endedIntervalsDuration;i.speed=i.loaded/(a/1e3),i.nbProgress>1&&(h=h?f*i.speed+(1-f)*h:i.speed,r(e,a))}}function s(e,n){var r=d[e];r&&(r.loaded-=n,r.slots--,r.loaded<0&&t.error("stat.loaded < 0 ("+r.loaded+")"),0===r.slots&&0===r.loaded&&delete d[e])}function u(e){var n=d[e];if(n)return n.predictedSpeed<0&&t.error("predicted speed is negative ("+n.predictedSpeed+")"),n.predictedSpeed}function c(e){delete d[e]}function l(e){var n=d[e];if(n)return n.speed<0&&t.error("speed is negative ("+n.speed+")"),n.speed}var d=Object.create(null),h=null,f=a.SPEED_SMOOTH_FACTOR;return radio("xhrSent").subscribe([e,this]),radio("xhrComplete").subscribe([n,this]),radio("httpDownloaded").subscribe([o,this]),radio("httpAborted").subscribe([s,this]),{getSpeed:l,getPredictedSpeed:u,removeResource:c}}var i=n(6).singleton,a=n(2);e.exports=r()}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.stats.StatsCalculator=Object.subClass({ctor:function(){this.Total_Recv_No_Waste=0,this.Total_Recv_P2P=0,this.Total_Recv_HTTP=0,this.Total_Avg_Download=0,this.Avg_Recv_P2P=0,this.Avg_Recv_HTTP=0,this.Total_Avg_Download=0,this.statsTimestamp=0,this.startTime=Date.now()},calcAvg:function(e){var t=Date.now()-this.statsTimestamp;this.statsTimestamp+=t,t/=1e3,this.Total_Recv_No_Waste=e.totalP2PDownloaded+e.totalHttpDownloaded,this.Total_Avg_Download=(e.totalHttpDownloaded+e.totalP2PDownloaded)/((Date.now()-this.startTime)/1e3),this.Avg_Recv_P2P=(e.totalP2PDownloaded-this.Total_Recv_P2P)/t,this.Avg_Recv_HTTP=(e.totalHttpDownloaded-this.Total_Recv_HTTP)/t,this.Total_Recv_P2P=e.totalP2PDownloaded,this.Total_Recv_HTTP=e.totalHttpDownloaded}})}()}).call(t,n(1))},function(e,t){!function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(n){function r(){!e&&this.ctor&&this.ctor.apply(this,arguments)}var i=this.prototype;e=!0;var a=new this;e=!1;var o;for(o in n){var s="function"==typeof n[o]&&"function"==typeof i[o]&&t.test(n[o]);a[o]=s?function(e,t){return function(){var n=this._super;this._super=i[e];var r=t.apply(this,arguments);return this._super=n,r}}(o,n[o]):n[o]}for(o in this)this.hasOwnProperty(o)&&"function"!=typeof this[o]&&(r[o]=this[o]);return r.prototype=a,r.constructor=r,r.subClass=arguments.callee,r.addBehavior=function(e,t){if(t=t||{},!e)throw"behaviorAbstractClass must be a vaild behavior class";override(a,t,new e)},r}}()},function(e,t,n){"use strict";function r(e){var t=window.peer5.getConfig("MEDIA_MAX_BUFFER_HOLE"),n=i(e.buffered,e.currentTime,t);return n.timeAhead}var i=n(136);e.exports=r},function(e,t){"use strict";e.exports=function(e){return{currentTarget:e,target:e}}},function(e,t){"use strict";e.exports=function(e,t){var n=t;return n="string"==typeof n?document.getElementById(n):n,n=n?n.tagName.toLowerCase()!==e?n.querySelector(e):n:document.querySelector(e),n||null}},function(e,t,n){"use strict";var r=n(8),i=n(9);e.exports=function(e){var t=r.swarmId(e);return i.hash(t)}},function(e,t,n){(function(e){var t=n(7);!function(){e.overrideXHR=function(){window.XMLHttpRequest=e.Request},e.revertXHR=function(){window.XMLHttpRequest=t},e.clientInstance.isValidated()&&!e.config.EXTERNAL_XHR_FALLBACK||(e.PlaylistRequest=e.FragmentRequest=e.VideoRequest=e.Request=t),e.DATACHANNELS_ERROR=700,e.WEBSOCKETS_ERROR=701,e.FILESYSTEM_ERROR=702,e.getCompatibilityStatus=function(t){e.clientInstance.getCompatibilityStatus(function(n,r){var i=[];for(type in n)if(!n[type])switch(type){case"dataChannels":i.push(e.DATACHANNELS_ERROR);break;case"Websockets":i.push(e.WEBSOCKETS_ERROR);break;case"fileSystem":i.push(e.FILESYSTEM_ERROR)}t(i,r.name,r.version)})},e.isEnabled=function(){return e.feature.isEnabledAndInitialized(e.config.FEATURE_PEER5_KEY)}}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(37),r=n(39),i=n(49),a=n(12),o=n(18),s=n(6).singleton,u=n(2),c=n(118),l=n(74),d=n(3),h=n(5),f=n(139),p=n(31),g=n(9),v=a.HYBRID,m=a.P2P,_=a.HTTP,E=a.DYNAMIC;!function(n){var a=e.core.util.UrlSwarmIdMap;e.client.DownloadUploadManager=Object.subClass({ctor:function(){var n=this;if(this.registerEvents(),this.apiValidator=new e.core.apiValidators.ApiValidator({dataChannels:e.core.apiValidators.DataChannelsApiValidator,fileSystem:e.core.apiValidators.FileSystemApiValidator}),this.apiValidator.validate()){this.validated=!0,this.clientId=o(),this.wsConnection=new e.core.transport.WsConnection(u.WS_URL,this.clientId);var a=this.tracker=new i(this.wsConnection);if(this.signaller=new r(this.wsConnection),this.controller=new e.client.HybridController(new t(this.clientId,this.signaller)),this.reportBuilder=new l({onReportedEvent:function(){n.sendReportPeriodically()}}),u.DYNAMIC_CONFIG){var s=u.A_B_CONFIG_JSON;c(function(e){e&&s!==u.A_B_CONFIG_JSON&&a.updateABConfig(u.A_B_CONFIG_JSON),radio("loadedDynamicConfig").broadcast()})}else radio("loadedDynamicConfig").broadcast();this.lastReportTime=Date.now(),this.lastStatCalcTime=0,this.cron_interval_id=window.setInterval(function(){n.cron()},e.config.MONITOR_INTERVAL)}else this.validated=!1;e.core.data.FSio.executeOnReady({function:this.cleanOldFiles,args:function(){},context:this}),radio("scriptLoaded").broadcast(),radio("scriptValidated").broadcast(this.validated),f.onExit(function(){n.handleSessionEnd()})},cleanOldFiles:function(e){this.cleanOldFilesPersistent(this.cleanOldFilesTemporary,e)},cleanOldFilesPersistent:function(t,n){e.core.data.FSio.queryPersQuota(function(r,i,a){e.info("quota is : "+a),a>0?e.core.data.FSio.requestPersQuota(a-1,function(r){r?e.core.data.CacheManager.cleanOldFiles(function(e){t&&t(n)}):t&&t(n)}):t&&t(n)})},cleanOldFilesTemporary:function(t){e.core.data.FSio.queryTempQuota(function(n,r,i){i>0?e.core.data.FSio.requestTempQuota(e.config.TEMPORARY_FS_SIZE,function(n){n?e.core.data.CacheManager.cleanOldFiles(function(e){t&&t()}):t&&t()}):t&&t()})},getNumOfVerifiedBytes:function(e){if(!s.has(e))return 0;var t=s.get(e);return t.getNumOfVerifiedBytes()},getBlobUrl:function(e,t){var n=s.get(e);n.getBlobUrl(t)},getBlob:function(e,t){var n=s.get(e);n.getBlob(t)},getUint8Array:function(e,t){var n=s.get(e);n.getUint8Array(t)},getText:function(e,t){var n=s.get(e);n.getText(t)},isValidated:function(){return this.validated},isFull:function(e,t){var n=s.get(e);t(n.isFull())},addResource:function(t,n,r){radio("resourceAdded").broadcast(t),d.sum(t,{requestsCount:1});var i=p(t),a=e.state.resources.get(i);return a&&a.state>=0?void this.addExistingResource(t,i,n,r):void this.addNewResource(t,n,r)},addNewResource:function(t,n,r){if(e.info("Adding new resource "+t),e.state.resources.add({state:0,mod:n,sha1:r.sha1,md5:r.md5,origin:r.origin,url:t,constraint:r.constraint,httpConstraint:r.httpConstraint,start:performance.now(),skipJoin:r.skipJoin}),t.indexOf("http")!=-1)this._initiateHttpResource(t);else if(t.indexOf("peer5://")!=-1){var i=t.slice(8);e.state.resources.alias(i,t),this.leechSwarm(i)}},addExistingResource:function(t,n,r,i){var a=e.state.resources.get(n);if(e.info("Adding existing resource "+t+" with state: "+a.state),a.url!==t&&s.has(a.url)&&(s.alias(t,a.url),e.state.resources.alias(t,a.url)),s.has(t)){var o=s.get(t),u=o.getMetadata();return u?(u.url=t,a.url=t,a.url!==t&&e.core.util.UrlSwarmIdMap.addMapping(t,a.swarmId),a.mod=r,a.constraint=i.constraint,a.httpConstraint=i.httpConstraint,this.controller.init(t),radio("fileInfoProcessed").broadcast(u),void radio("resourceReady"+t).broadcast(u)):void e.error("adding existing resource but no blockMap but no fileInfo")}e.error("adding existing resource but no blockMap")},removeResource:function(t){var n=e.state.resources.get(t);return n?(e.info("removeResource: removing resource "+t+" with state: "+n.state),!n.state||n.state<=1?(e.warn("removing resource with state smaller than 1: "+t),this._removeResourceBeforeInit(t)):(n.swarmId&&this.tracker.leave(n.swarmId),n.state=4,n.end=performance.now(),this.controller.removeResource(t),radio("stopHttpInit"+t).broadcast(),d.removeResource(t,n.resourceId),s.remove(t),void e.state.resources.remove(t))):void e.error("tried to remove a resource that was already removed: "+t)},stopResource:function(t){var n=e.state.resources.get(t);if(n){if(e.info("stopResource: stopping resource "+t+" with state: "+n.state),!n.state||n.state<=1)return e.warn("removing resource with state smaller than 1: "+t),this._removeResourceBeforeInit(t);n.state=4,n.end=performance.now(),this.controller.stopResource(t),radio("stopHttpInit"+t).broadcast()}},readBlobData:function(t,n){var r=e.state.resources.add({url:t,state:0,origin:!0,hashAlg:new g.ArrayBuffer,blockHashes:[],chunkRead:0,mod:m}),i=n.size;s.add(t,new e.core.dataStructures.BlockMap(i,t,r.md5,r.sha1));var a=this,o=s.get(t);e.config.USE_FS&&o.fs?radio("filesystemInitiated"+t).subscribe([function(){1==o.fs&&e.config.PREALLOCATE_FILE?o.allocateFileSizeSync(function(r){r?a.readBlobInSlices(t,n):radio("removeResource").broadcast(t,e.Request.FILE_SIZE_ERR,"Not enough disk space for file")}):a.readBlobInSlices(t,n)},this]):this.readBlobInSlices(t,n),radio("transferLoaded").subscribe(function(n){var r=e.state.resources.get(t);n.url!==t||r.uploaded||e.core.util.asyncDefer(function(){r.uploaded=!0;var e=a.createAndUploadFileInfo(t);radio("transferLoaded"+t).broadcast(e)})})},getLoadedStats:function(e){var t;if(s.has(e)){var n=s.get(e);if(t=n._getResourceStats(),t.httpDown||t.p2pDown||t.fsLoad)return{loadedHTTP:t.httpDown,loadedP2P:t.p2pDown,loadedFS:t.fsLoad}}t=d.getStats(e);var r=Object.create(null);return r.loadedHTTP=t.totalHttpProgress,r.loadedP2P=t.totalP2PDownloaded,r.loadedFS=t.totalFSLoaded,r},getUploadedStats:function(e,t){var n=d.getStats(e),r=Object.create(null);r.uploaded=n.totalP2PUploaded,t(r)},getCompatibilityStatus:function(e){var t=this.apiValidator.getStatus(),n=this.apiValidator.getBrowser();e(t,n)},_initiateHttpResource:function(t){e.info("initializing http resource: "+t);var n=e.state.resources.get(t);if(n.hashUrl=p(t),e.state.resources.alias(n.hashUrl,t),n.hash&&n.length){var r=new h.FileInfoMessage(n.hash,n.length,n.hash,null,e.config.BLOCK_SIZE,t);this._joinSwarmAndHandleFileInfo(r,n)}else{var i=this;e.client.getHttpMeta(t,n,function(e,t,r){i._joinSwarmAndHandleFileInfo(e,n,t,r)})}},_joinSwarmAndHandleFileInfo:function(e,t,n,r){t.skipJoin||this.joinSwarm(e.swarmId),this.handleFileInfo(e,n,r)},createAndUploadFileInfo:function(t){var n=e.state.resources.get(t),r=n.hashAlg.end();a.addMapping(t,r),n.hash=r,this.changeResourceId(t,n.hash);var i=s.get(t);return this.tracker.share(n.hash,i.fileSize,n.hash,n.blockHashes,e.config.BLOCK_SIZE)},readBlobInSlices:function(t,n){var r=s.get(t);if(r&&!r.fs&&n.size>e.config.ALLOWED_FILE_SIZE)return void radio("removeResource").broadcast(t,e.Request.FILE_SIZE_ERR,"file size too big");var i=this;e.core.util.fileHandler.readFileInSlices(t,n,e.config.BLOCK_SIZE,function(t,n,r){t&&n&&r?i.addChunks(t,n,r):(!t||n||r)&&e.error("handle error")})},addChunks:function(t,n,r){var i=e.state.resources.get(t);i.hashAlg.append(n);for(var a=s.get(t),o=Math.ceil(n.byteLength/e.config.CHUNK_SIZE),u=0;u<o;u++){var c=u*e.config.CHUNK_SIZE,l=new Uint8Array(n.slice(c,Math.min(c+e.config.CHUNK_SIZE,n.byteLength))),d=a.setChunk(i.chunkRead,l),h=a.ingestBlock(d);h&&(i.blockHashes[d]=h),radio("chunkAddedToBlockMap").broadcast(),i.chunkRead++}i.chunkRead==this.numOfChunksInFile&&(this.hasEntireFile=!0),a.fs?e.core.data.FSio.notifyFinishWrite(r):r()},cron:function(){this.sendReportPeriodically(),this.calculateStats(),radio("cron").broadcast();for(var t in s._blockMaps){var n=e.state.resources.get(t),r=s.get(t);n&&n.mod!==m&&r&&!r.isFull()&&!n.preventDownload&&(0===d.statsCalculators[t].Avg_Recv_HTTP?n.httpIdle++:n.httpIdle=0,n.httpIdle>=e.config.HTTP_IDLE_RESET_DURATION/e.config.MONITOR_INTERVAL&&(this.controller.stopHttp(r.getMetadata().url),n.httpIdle=0),this.controller.downloadPeriodicTest(r.getMetadata().url))}},calculateStats:function(){var t=Date.now();t-this.lastStatCalcTime<e.config.STAT_CALC_INTERVAL||(this.lastStatCalcTime=t,d.calcAvg())},sendReport:function(){if(this.validated){var e=this.reportBuilder.rotateReport();e&&this.tracker.groupReport(e)}},sendReportPeriodically:function(){var e=this,t=Date.now();t-e.lastReportTime<u.REPORT_INTERVAL||(e.lastReportTime=t,e.sendReport())},handleFileInfo:function(t,n,r){var i=t.swarmId,o=t.url;a.addMapping(o,i),e.info("Handling file Info:: url="+o+" swarmId="+i);var u=e.state.resources.get(o),c=new e.core.dataStructures.BlockMap(t.size,i,u.md5,u.sha1);n>0&&(c.setResourceAsBeingDownloadedInHttp(),c.httpProgressBytes=n),r>0&&(c.httpExtraWaste=r),s.add(i,c),c.addMetadata(t),this.changeResourceId(o,i),s.alias(u.hashUrl,o),u.state=1,u.swarmId=i,radio("fileInfoProcessed").broadcast(t),c.fs||radio("resourceInit").broadcast(t)},updateFileInfo:function(t){var n=t.url,r=t.swarmId,i=e.state.resources.get(n);this.changeResourceId(n,r,function(n){if(n){i.state=1,i.swarmId=r;var a=s.get(r);a.addMetadata(t),radio("resourceInit").broadcast(t)}else e.warn("couldn't change resource Id")}),radio("fileInfoProcessed").broadcast(t)},joinSwarm:function(e){var t=this.controller.P2PController.getLookingForPeers();t&&this.tracker.join(e,t)},leechSwarm:function(e){this.tracker.leech(e)},_removeResourceBeforeInit:function(t){var n=e.state.resources.get(t);n&&(n.state=4,n.end=performance.now(),e.state.resources.remove(t),radio("stopHttpInit"+t).broadcast())},registerEvents:function(){radio("pauseResource").subscribe([function(t,n,r){this.stopResource(t),radio("resumeResource").subscribe([function(n){if(n===t){var r=null,i=e.state.resources.get(t);i.md5?r={md5:i.md5}:i.sha1&&(r={sha1:i.sha1}),this.addResource(t,i.mod,r)}},this])},this]),radio("stopResource").subscribe([function(t,n,r){var i=e.state.resources.get(t),a=i?i.mod:null;radio("requestError"+t).broadcast(n,r),radio("resourceLoadEnd").broadcast(t,a),this.stopResource(t)},this]),radio("removeResource").subscribe([function(t,n,r){e.warn("removing resource "+t),e.warn(n+": "+r);var i=e.state.resources.get(t);return i?(radio("requestError"+t).broadcast(n,r),void(i.state<1?this._removeResourceBeforeInit(t):this.removeResource(t))):void e.warn("Tried removing resource: "+t+" but it was already removed")},this]),radio("resourceInit").subscribe([function(t){var n=e.state.resources.get(t.swarmId);if(n&&n.state&&4!==n.state){n.state=2;var r=s.get(t.swarmId);if(!r.fs&&t.size>e.config.ALLOWED_FILE_SIZE)return void radio("removeResource").broadcast(t.url,e.Request.FILE_SIZE_ERR,"file size too big");this.controller.init(t.url),r.fs===!0&&e.config.PREALLOCATE_FILE&&r.allocateFileSize(function(t){t||e.warn("Couldn't allocate space for file")}),radio("resourceReady"+t.url).broadcast(t)}},this]),radio("fileInfoProcessed").subscribe([function(e){radio("fileInfoProcessed"+e.url).broadcast(e)},this]),radio("chunkSent").subscribe([function(t,n){var r=e.state.resources.get(t).url;radio("chunkSent"+r).broadcast(t,n)},this]),radio("blockReceived").subscribe([function(t,n){var r=e.state.resources.get(t);if(r){var i=r.url;radio("blockReceived"+i).broadcast(n)}},this]),radio("HTTPHeadersReceived").subscribe([function(e,t,n){radio("HTTPHeadersReceived"+e).broadcast(t,n)},this]),radio("needByteRangeEvent").subscribe([function(t,n,r,i){var a=e.state.resources.get(t);if(!a.preventDownload){var o=s.get(t),u=n?o.getBlockIndex(n):null,c=r?o.getBlockIndex(r):null;a.mod===E?this.controller.dynamicDownload(t,u,c,i):this.controller.download(t,u,c)}},this]),radio("receivedFileInfo").subscribe([function(t){var n=e.state.resources.get(t.swarmId);n?n&&0===n.state&&(t.url=n.url,n.origin?this.updateFileInfo(t):this.handleFileInfo(t)):e.warn("received fileInfo for a non existing swarm")},this]),radio("browserUnsupported").subscribe([function(t,n,r){e.warn("Unsupported browser for peer5"),radio("browserUnsupported").unsubscribe(arguments.callee),this.validated=!1},this]),radio("httpDownloaded").subscribe([function(e,t){if(s.has(e)){var n=s.get(e);n.addHttpProgressBytes(t)}},this]),radio("httpAborted").subscribe([function(e,t){if(s.has(e)){var n=s.get(e);n.removeHttpProgressBytes(t)}},this]),radio("swarmError").subscribe([function(t){var n,r=e.state.resources.get(t.swarmId);switch(t.error){case h.SWARM_NOT_FOUND:if(!r)return void e.warn("swarm not found for an unexisting resource");if(r.mod===v||r.mod===_)return;if(void 0!==r.hashUrl)return;if(r.mod===m){var n=e.Request.SWARMID_NOT_FOUND_ERR;break}}e.error("swarmError: "+t.error),radio("stopResource").broadcast(t.swarmId,n)},this]),radio("transferLoaded").subscribe([function(t){var n=e.state.resources.get(t.url);if(this.controller.stopResource(n.url),radio("stopHttpInit"+n.url).broadcast(),t&&t.swarmId&&n){n.state=4,n.end=performance.now();var r=n.url,i=n.mod;radio("resource:complete").broadcast(t),radio("resourceLoadEnd").broadcast(r,i)}},this]),radio("httpProgress").subscribe([function(e){radio("httpProgress"+e).broadcast(e)},this])},changeResourceId:function(t,n,r){var i=e.state.resources.get(t);i&&(e.state.resources.alias(n,t),i.resourceId=n),!s.has(t)||s.has(n)&&t!==n?!s.has(t)&&s.has(n)&&s.alias(t,n):s.alias(n,t),r&&s.get(n).resourceId!==n&&s.get(t).changeResourceId(n,r)},sendSessionSummary:function(){if(this.validated){var e=this.reportBuilder.getSessionSummary();e&&this.tracker.sessionReport(e)}},handleSessionEnd:function(){this.sendReport(),this.sendSessionSummary()}}),n.clientInstance=new e.client.DownloadUploadManager}(e)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(6).singleton,r=n(13);!function(){var n=e.core.dataStructures.PendingBlockMap;e.client.HTTPController=e.core.controllers.AbstractController.subClass({ctor:function(){this._super(),this.lastFailedStartBlock=Object.create(null),this.xhrs=Object.create(null),this.resourceState=Object.create(null),this.registerEvents()},isAvailable:function(t){return!(!this.resourceState[t]||this.resourceState[t]===r.STOPPED)&&(this.xhrs[t]?!this.xhrs[t].isHTTPBusy():(e.warn("HTTP downloaders corruption for url "+t),!1))},removeResource:function(t){e.info("removed http resource "+t),this._super(t),this.stop(t)},stopResource:function(t){e.info("stopped http resource "+t),this._super(t),this.stop(t)},init:function(i){function a(a,o){if(!o){var s,u=a.startRange,c=a.endRange;if(!c){if(!t.has(i))return;s=t.get(i),c=s.fileSize}!s&&t.has(i)&&(s=t.get(i));for(var l=u/e.config.CHUNK_SIZE,d=Math.ceil((c+1)/e.config.CHUNK_SIZE)-1,h=l;h<=d;h++)n.removeChunk(i,h),s&&s.unsetBlockAsBeingDownloadedInHttp(Math.floor(h/(e.config.BLOCK_SIZE/e.config.CHUNK_SIZE)));this.lastFailedStartBlock[i]=u/e.config.BLOCK_SIZE,this.resourceState[i]!==r.STOPPED&&radio("HTTPAvailableEvent").broadcast(i)}}if(this._super(i),!this.xhrs[i]){var o=new e.client.MultiSlotManager(i);radio("xhrFailed"+i).subscribe([a,this]),radio("xhrAbort"+i).subscribe([a,this]),this.xhrs[i]=o}},download:function(r,i,a){if(this.isAvailable(r)){this.xhrs[r]||(this.xhrs[r]=new e.client.HTTPDownloader(r));var o=this.xhrs[r];if(o.isHTTPBusy())return 0;var s=t.get(r);!this.lastFailedStartBlock[r]||s.has(this.lastFailedStartBlock[r])||n.isBlockPending(r,this.lastFailedStartBlock[r])||(i=this.lastFailedStartBlock[r],a=this.lastFailedStartBlock[r]);for(var u=a-i+1,c=i;c<=a;c++){s.setBlockAsBeingDownloadedInHttp(c);var l=s.getChunkIdsOfBlock(c);for(var d in l)n.addChunk(r,l[d])}var h=!1,f=e.config.BLOCK_SIZE*i,p=e.config.BLOCK_SIZE*(a+1)-1;return p>=s.fileSize-1&&(p=null),o.download(f,p,h),u}},validateFileSize:function(t,n){if(t>n)return!1;var r=t%e.config.BLOCK_SIZE;if(0===r)return!0;var i=n%e.config.BLOCK_SIZE;return r===i},addHTTPBytesToBlocks:function(r,i,a){if(!t.has(r))return void e.warn("addHTTPBytesToChunks - downloaded http for a resource that doesnt exist "+r);var o=t.get(r),s=a.length,u=s+i;if(!this.validateFileSize(u,o.fileSize))return e.warn("XHR response length isnt as expected "+r),radio("removeResource").broadcast(r,e.Request.INVALID_RESPONSELENGTH,"XHR response length isnt as expected"),void e.client.FailedUrls.addUrl(r);for(var c,l,d=0;d<s;)c=d+e.config.BLOCK_SIZE<=s?a.subarray(d,d+e.config.BLOCK_SIZE):a.subarray(d),l=Math.floor((i+d)/e.config.BLOCK_SIZE),n.removeBlock(r,l),o.unsetBlockAsBeingDownloadedInHttp(l),o.isFull()||o.setBlock(l,c,"http"),d+=c.length},registerEvents:function(){radio("bytesReceivedEvent").subscribe([function(e){var n=e.url;this.addHTTPBytesToBlocks(n,e.offset,e.dataArray),t.has(n)&&radio("HTTPAvailableEvent").broadcast(n)},this]),radio("blockVerified").subscribe([function(e,t){var n=this.xhrs[e];n&&n.clearDownloadedBlock&&n.clearDownloadedBlock(t)},this])},stop:function(e){var r=this.xhrs[e];if(r){if(r.stop(),n.removeResource(e),t.has(e)){var i=t.get(e);i.unsetResourceAsBeingDownloadedInHttp()}delete this.xhrs[e]}}})}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(7);!function(){var n=e.config.XHR_INITIAL_TIMEOUT;e.client.HTTPDownloader=Object.subClass({ctor:function(e,n){if(this.url=e,this.method=null,this.httpRequestTime=0,this.firstRequest=!0,this.lastTimerTimestamp=null,this.lengthKnown="undefined"==typeof n||n,this.xhr=new t,this.xhr.url=this.url,!this.xhr)throw"Cannot instantiate XHR";this.registerEvents()},isHTTPBusy:function(){return this.xhr.busy},cleanHTTP:function(){this.xhr.busy=!1,this.httpRequestTime=0,this.xhr.lastTotalLoaded=0},stop:function(t){e.info("aborting XHR:"+this.url+" loaded so far "+this.xhr.lastTotalLoaded),this.xhr.busy&&!this.xhr.aborted&&(this.xhr.aborted=!0,"GET"===this.method&&radio("xhrAbort"+this.url).broadcast(this.xhr,t),this.xhr.abort()),this.cleanHTTP(),clearTimeout(this.timerId)},head:function(){this.method="HEAD",this.xhr.open("HEAD",this.url),this.xhr.busy=!0,this.xhr.aborted=!1;var t=this;this.xhr.onload=function(n){this.busy=!1;var r=this.getAllResponseHeaders();200===this.status||206===this.status?(radio("responseHeadersReceived"+this.url).broadcast(r),
n.lengthComputable&&n.total>0&&radio("responseLengthReceived"+this.url).broadcast(n.total)):(e.warn("Expecting status code 200/206 from HEAD request. Got "+this.status),radio("xhrFailed"+this.url).broadcast(this)),t.stop()},this.xhr.onerror=function(e){this.busy=!1,radio("xhrFailed"+this.url).broadcast(this)},this.xhr.lastModified=Date.now(),this.resetTimer(this.xhr.lastModified),this.xhr.send(null)},resetTimer:function(t){if(this.timerId&&clearTimeout(this.timerId),this.lastTimerTimestamp){var r=Date.now()-this.lastTimerTimestamp,i=(n+e.config.XHR_TIMEOUT_FACTOR*r)/2;n=Math.round(Math.max(e.config.XHR_MINIMUM_TIMEOUT,i))}var a=this;this.timerId=setTimeout(function(){a.expireRequest(t)},n),this.lastTimerTimestamp=Date.now()},download:function(t,r){this.method="GET",e.info("Downloading in http "+this.url+" start="+t+" end="+r);var i=this;this.httpRequestTime=Date.now(),this.xhr.lastModified=this.httpRequestTime,this.xhr.loaded=0,this.xhr.aborted=!1;try{this.xhr.open("GET",this.url,!0)}catch(t){return this.xhr.busy=!1,e.warn("xhr onerror!"),void radio("xhrFailed"+this.xhr.url).broadcast(this.xhr)}this.xhr.busy=!0,this.xhr.isRange=t&&t>0||r,r?this.xhr.setRequestHeader("Range","bytes="+t+"-"+r):t&&t>0?this.xhr.setRequestHeader("Range","bytes="+t+"-"):t=0,this.xhr.startRange=t,this.xhr.endRange=r,(!this.xhr.lastTotalLoaded||t>this.xhr.lastTotalLoaded||r&&r<this.xhr.lastTotalLoaded)&&(this.xhr.lastTotalLoaded=t),this.xhr.onloadend=function(t){if(clearTimeout(i.timerId),this.busy=!1,i.httpRequestTime=0,this.status<300&&this.status>=200&&this.response){var n=this.response;i.lengthKnown||this.isRange||(t.lengthComputable&&t.total>0?radio("responseLengthReceived"+this.url).broadcast(t.total):n.byteLength>0?radio("responseLengthReceived"+this.url).broadcast(n.byteLength):n.length>0&&radio("responseLengthReceived"+this.url).broadcast(n.length),radio("xhrBytesReceived"+this.url).broadcast(this.url,n.byteLength||n.length)),radio("xhrComplete"+this.url).broadcast(t),e.info("xhr onload: "+this.url+"start= "+this.startRange+"end= "+this.endRange),radio("bytesReceivedEvent"+this.url).broadcast({url:this.url,offset:this.startRange,dataArray:new Uint8Array(n)})}else radio("xhrFailed"+this.url).broadcast(this)},this.xhr.onabort=function(){e.warn("xhr onabort: "+this.url)},this.xhr.onerror=function(){e.warn("xhr onerror: "+this.url)},this.xhr.onreadystatechange=function(){if(this.readyState===this.HEADERS_RECEIVED&&(i.resetTimer(this.lastModified),this.onreadystatechange=null,this.status>=200&&this.status<300)){var e=this.getAllResponseHeaders();radio("responseHeadersReceived"+this.url).broadcast(e)}},this.xhr.responseType="arraybuffer",this.xhr.onprogress=function(t){if(this.status<300&&this.status>=200){var r=Date.now(),a=r-this.lastModified;a>n/2&&e.info("onprogress last part arrived in "+a+"ms"),this.lastModified=r,this.loaded=t.loaded,i.resetTimer(this.lastModified),!i.lengthKnown&&t.lengthComputable&&t.total>0&&!this.isRange&&(i.lengthKnown=!0,radio("responseLengthReceived"+this.url).broadcast(t.total));var o=t.loaded+t.target.startRange-t.target.lastTotalLoaded;o>0&&(i.lengthKnown&&radio("xhrBytesReceived"+this.url).broadcast(this.url,o),radio("httpDownloaded"+this.url).broadcast(this.url,o),t.target.lastTotalLoaded=t.loaded+t.target.startRange,radio("onprogressEvent"+this.url).broadcast(this.url))}},this.resetTimer(this.xhr.lastModified);try{radio("xhrSent"+this.url).broadcast(),this.xhr.send(null)}catch(t){e.error("xhr native error: "+this.url,t)}},requestRetry:function(){var t=this;this.xhr.onloadend=function(n){var r=n.currentTarget.startRange,i=n.currentTarget.endRange;e.info("retrying request: "+t.url+" Range="+r+"-"+i),setTimeout(function(){t.download(r,i)},0)},this.stop(!0),this.xhr.busy=!0},registerEvents:function(){var t=this;this.expireRequest=function(r){t.xhr.lastModified==r&&(e.warn("expiring xhr requested on: "+r),radio("xhrRetry"+t.url).broadcast(),n=Math.round(Math.min(e.config.XHR_MAXIMUM_TIMEOUT,2*n)),"GET"===t.method?t.requestRetry():(t.stop(),t.xhr.busy=!1,radio("xhrTimeout"+t.url).broadcast(t.xhr)))}}})}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(12),r=n(6).singleton,i=n(13),a=t.P2P,o=t.HTTP,s=t.DYNAMIC;!function(){var t=e.core.dataStructures.PendingBlockMap,n=e.core.util.UrlSwarmIdMap;e.client.HybridController=e.core.controllers.AbstractController.subClass({ctor:function(t){if(this.P2PController=new e.core.controllers.P2PController(t),this.httpController=new e.client.HTTPController,this.resourceState=Object.create(null),this.registerEvents(),this.lastBlockRequestedInP2P=Object.create(null),this.nonFullResources=Object.create(null),e.config.SYNCED_BUFFERS){var n=this;setInterval(function(){n.blockAllocationCron()},e.config.BLOCK_ALLOCATION_INTERVAL)}},registerEvents:function(){radio("P2PMaybeAvailableEvent").subscribe([function(t,n){if(this.P2PController.isPeerAvailable(n)){var i=e.state.resources.get(t);if(i&&r.has(t)){var u=r.get(t);if(u.isFull())return void e.info("Peer "+n+" is available but swarm "+t+" is full");var c=i.url,l=i.mod;if(i.mod===s)return void this.allocateBlocks(c);if(l!==a&&l!==o){var d=null;d=e.config.SEQUENTIAL_DOWNLOAD?this.relaxedP2PDownload(c,null,null,n):this.relaxedP2PDownloadRandomly(c,null,null,n),!d||0===d.length}}}},this]),radio("HTTPAvailableEvent").subscribe([function(t){if(this.httpController.isAvailable(t)){var n=r.get(t);if(n.isFull())return e.info("HTTP Available but already have everything"),void this.httpController.stop(t);if(e.state.resources.get(t).mod===s)return void this.allocateBlocks(t);if(!e.config.XHR_ALLOW_RANGE)return void this.aggressiveHTTPDownloadFull(t);var i;i=e.config.SEQUENTIAL_DOWNLOAD?this.relaxedHTTPDownload(t):this.relaxedHTTPDownloadRandomly(t),0===i&&(e.config.SEQUENTIAL_DOWNLOAD?this.aggressiveHTTPDownload(t):this.aggressiveHTTPDownloadRandomly(t))}},this]),radio("xhrRangeFailed").subscribe([function(t){e.warn("XHR Range failed for url: "+t),this.stopResource(t),this.init(t),this.aggressiveHTTPDownloadFull(t)},this])},removeResource:function(t){var r=n.getSwarmId(t);r?this.P2PController.removeResource(r):e.info("not removing p2p resource "+t+" - no swarmId"),this.httpController.removeResource(t),delete this.nonFullResources[t],delete this.resourceState[t],delete this.lastBlockRequestedInP2P[t]},stopResource:function(t){this.resourceState[t]=i.STOPPED,delete this.nonFullResources[t];var r=n.getSwarmId(t);r?this.P2PController.stopResource(r):e.info("not stopping p2p resource "+t+" -  no swarmId"),this.httpController.stopResource(t)},download:function(t,i,s){if(this.isAvailable(t)){var u=r.get(t);if(!u.isFull()){if(i||0===i||(i=u.getMissingBlock()),s||0===s||(s=u.getNumOfBlocks()-1),i>u.getNumOfBlocks()-1||s>u.getNumOfBlocks()-1)return void e.warn("out of range");var c=i;i=u.getMissingBlock(),c<i&&radio("blockReceived").broadcast(t,e.config.BLOCK_SIZE);var l=e.state.resources.get(t);if(l.mod!==a&&!e.config.XHR_ALLOW_RANGE)return void this.aggressiveHTTPDownloadFull(t);if(l.mod===o)return void(e.config.SEQUENTIAL_DOWNLOAD?this.aggressiveHTTPDownload(t,i,s):this.aggressiveHTTPDownloadRandomly(t,i,s));this.P2PController.isAvailable(n.getSwarmId(t))&&(e.config.SEQUENTIAL_DOWNLOAD?this.relaxedP2PDownload(t,i,s):this.relaxedP2PDownloadRandomly(t,i,s)),this.httpController.isAvailable(t)&&(e.config.SEQUENTIAL_DOWNLOAD?this.relaxedHTTPDownload(t,i,s):this.relaxedHTTPDownloadRandomly(t,i,s))}}},blockAllocationCron:function(){for(var e=Object.keys(this.nonFullResources),t=0,n=e.length;t<n;t++){var a=e[t];if(this.resourceState[a]===i.LOADING){var o=r.get(a);if(o.isFull())delete this.nonFullResources[a];else{var s=o.getMissingBlock(),u=o.getNumOfBlocks()-1;this.allocateBlocks(e[t],s,u)}}}},dynamicDownload:function(t,n,r,i){"number"!=typeof i&&e.warn("HybridController::allocateBlocks: constraint is not defined:"+i),this.nonFullResources[t]=i,this.allocateBlocks(t,n,r)},allocateBlocks:function(t,r,i){var a=performance.now(),o=e.state.resources.get(t),s=o?o.constraint:null,u=o?o.httpConstraint:null;if("number"!=typeof s)return void e.warn("constraint is not a number for resource "+t);var c=n.getSwarmId(t),l=o?o.hashUrl:null;if(e.config.HTTP_FETCH_AHEAD){var d=this.P2PController.numOfSeeders(c,l);if(d<e.config.FETCH_AHEAD_MIN_SEEDERS)return e.info("seeders < MIN_SEEDERS, fetching ahead in http"+t),void(e.config.XHR_ALLOW_RANGE?this.aggressiveHTTPDownloadRandomly(t,r,i):this.aggressiveHTTPDownloadFull(t))}u||s-a<e.config.EXTERNAL_MINIMUM_HTTP_CONSTRAINT?(e.config.XHR_ALLOW_RANGE?this.aggressiveHTTPDownloadRandomly(t,r,i):this.aggressiveHTTPDownloadFull(t),e.config.PARALLEL_HTTP_AND_P2P===!0&&this.aggressiveP2PDownloadRandomly(t,r,i)):this.relaxedP2PDownloadRandomly(t,r,i)},relaxedHTTPDownload:function(i,a,o){var s=r.get(i);a||0===a||(a=s.getFirstMissingBlock()),o||0===o||(o=s.getNumOfBlocks()-1);var u=this.getSeqBlocks(i,e.config.XHR_MAX_GET,function(e){return e>=a&&e<=o&&s.isEmpty(e)&&!t.isBlockPending(i,e)&&!t.isBlockPending(n.getSwarmId(i),e)});return 0===u.length?0:(e.info("downloading in relaxed http: "+i),this.httpController.download(i,u[0],u[u.length-1]),u[u.length-1]-u[0]+1)},aggressiveHTTPDownload:function(n,i,a){var o=r.get(n);i||0===i||(i=o.getFirstMissingBlock()),a||0===a||(a=o.getNumOfBlocks()-1);var s=this.getSeqBlocks(n,e.config.XHR_MAX_GET,function(e){return e>=i&&e<=a&&!t.isBlockPending(n,e)});return 0===s.length?0:(e.info("downloading in aggressive http: "+n),this.httpController.download(n,s[0],s[s.length-1]),s[s.length-1]-s[0]+1)},relaxedHTTPDownloadRandomly:function(i,a,o){var s=r.get(i);a||0===a||(a=s.getFirstMissingBlock()),o||0===o||(o=s.getNumOfBlocks()-1);var u=this.getRarestBlocks(i,e.config.XHR_MAX_GET,function(e){return e>=a&&e<=o&&s.isEmpty(e)&&!t.isBlockPending(i,e)&&!t.isBlockPending(n.getSwarmId(i),e)}),c=e.core.util.longestSequence(u);return c.length>0&&(a=c[0],o=c[c.length-1],e.info("downloading in relaxed-random http: "+i),this.httpController.download(i,a,o)),c.length},aggressiveHTTPDownloadFull:function(n){if(!t.isFullResourcePending(n)){var i=r.get(n),a=0,o=i.getNumOfBlocks()-1,s=i.fileSize;return t.addFullResource(n,s),e.info("downloading in aggressive-full http: "+n),this.httpController.download(n,a,o),o-a+1}return 0},aggressiveHTTPDownloadRandomly:function(n,i,a){var o=r.get(n);i||0===i||(i=o.getFirstMissingBlock()),a||0===a||(a=o.getNumOfBlocks()-1);var s=this.getRarestBlocks(n,e.config.XHR_MAX_GET,function(e){return e>=i&&e<=a&&!o.has(e)&&!t.isBlockPending(n,e)}),u=e.core.util.longestSequence(s);return u.length>0&&(i=u[0],a=u[u.length-1],e.info("downloading in aggressive-random http: "+n),this.httpController.download(n,i,a)),u.length},relaxedP2PDownload:function(i,a,o,s){var u=r.get(i),c=n.getSwarmId(i);if(this.P2PController.isAvailable(c)){if(a||0===a||(a=u.getFirstMissingBlock()),o||0===o||(o=u.getNumOfBlocks()-1),a>u.getNumOfBlocks()-1||o>u.getNumOfBlocks()-1)return void e.warn("out of range");var l=a;for(a=this.lastBlockRequestedInP2P[i]&&!u.has(this.lastBlockRequestedInP2P[i])?this.lastBlockRequestedInP2P[i]:u.getFirstMissingBlock(),l<a&&radio("blockReceived").broadcast(i,e.config.BLOCK_SIZE);a<=o&&(t.isBlockPending(i,a)||this.P2PController.isPendingEntireBlock(c,a));)a++;for(var d,h=[],f=a;f<=o&&f<u.getNumOfBlocks()&&h.length<this.P2PController.getAvailableNumOfChunksToSend();++f)if(!t.isBlockPending(i,f)&&!this.P2PController.isPendingEntireBlock(c,f)){d=u.getChunkIdsOfBlock(f);for(var p=0;p<d.length;++p)u.hasOrPendingChunk(d[p])||h.push(d[p]);this.lastBlockRequestedInP2P[i]=f}return e.info("downloading in relaxed p2p: "+i),this.P2PController.distributeChunksAmongSources(c,h,s),h.length}},relaxedP2PDownloadRandomly:function(i,a,o,s){if(!r.has(i))return 0;var u=r.get(i);a||0===a||(a=u.getFirstMissingBlock()),o||0===o||(o=u.getNumOfBlocks()-1);var c=n.getSwarmId(i),l=this,d=function(e){return e>=a&&e<=o&&!u.has(e)&&!t.isBlockPending(i,e)&&!l.P2PController.isPendingEntireBlock(c,e)};e.info("downloading in relaxed-random p2p: "+i);var h=this.P2PController.download(c,s,d);return h},aggressiveP2PDownloadRandomly:function(t,i,a,o){if(!r.has(t))return 0;var s=r.get(t);i||(i=s.getFirstMissingBlock()),a||(a=s.getNumOfBlocks()-1);var u=n.getSwarmId(t),c=this,l=function(e){return e>=i&&e<=a&&!s.has(e)&&!c.P2PController.isPendingEntireBlock(u,e)};e.info("downloading in aggressive-random p2p: "+t);var d=this.P2PController.download(u,o,l);return d},init:function(t){var n=e.state.resources.get(t);if(!n)return void e.error("HybridController::init:no resource found: "+t);var r=n.mod,s=n.swarmId;e.info("initiating resource controllers: url="+t+" swarmId="+s+" mod="+r),this.resourceState[t]=i.LOADING,this.P2PController.init(s),r!==a&&this.httpController.init(t),r===o&&this.P2PController.stopResource(s)},isAvailable:function(e){return(this.P2PController.isAvailable(n.getSwarmId(e))||this.httpController.isAvailable(e))&&this.resourceState[e]&&!(this.resourceState[e]===i.STOPPED)},downloadPeriodicTest:function(e){this.resourceState[e]&&this.httpController.isAvailable(e)&&radio("HTTPAvailableEvent").broadcast(e)},stopHttp:function(e){this.httpController.stop(e)},getNumberOfConnectedPeers:function(){return Object.keys(this.P2PController.peerConnections).length},numOfSeeders:function(e,t){return this.P2PController.numOfSeeders(e,t)}})}()}).call(t,n(1))},function(e,t,n){(function(t){var r=n(79),i=n(2);e.exports=Object.subClass({ctor:function(e,t){this.id=e,this.signaller=t},connect:function(e,n,a){return i.PC_MOCK?r(this,e,n):new t.core.transport.PeerConnectionImpl(this,e,n,a)}})}).call(t,n(1))},function(e,t,n){(function(e){var t=n(18),r=n(3),i=n(5);!function(){e.client.MultiSlotManager=Object.subClass({ctor:function(t){this.url=t,this.xhrs=[],this.rampup=!0,this.progress=Object.create(null),this.createNewSlot(this.url),this.firstRequest=!0;var n=this;this.cronIntervalId=window.setInterval(function(){n.cron()},e.config.XHR_SLOT_PROBE_INTERVAL)},createNewSlot:function(n){if(e.config.XHR_CONCURRENT>=2)var r=n.indexOf("?")>-1?"&":"?";else var r="#";var i=t(),a=n+r+i,o=new e.client.HTTPDownloader(a,!0);this.xhrs.push(o),e.info("created new slot "+a),this.registerNewSlotEvents(a)},isHTTPBusy:function(){for(var e=0;e<this.xhrs.length;++e)if(!this.xhrs[e].isHTTPBusy())return!1;return!0},download:function(t,n){for(var r,a=0;a<this.xhrs.length;++a)if(!this.xhrs[a].isHTTPBusy()){r=this.xhrs[a];break}var o=e.state.resources.get(this.url);e.config.P2P_DOWNLOADING_MSG&&radio("p2p.send.all").broadcast(new i.DownloadingMessage(o.swarmId,o.hashUrl),"Downloading"),r.blockIds=Object.create(null);for(var a=t||0;a<(n||o.length);a+=e.config.BLOCK_SIZE){var s=Math.floor(a/e.config.BLOCK_SIZE);r.blockIds[s]=!0}r.download(t,n),this.isHTTPBusy()||radio("HTTPAvailableEvent").broadcast(this.url)},clearDownloadedBlock:function(t){for(var n=0;n<this.xhrs.length;++n){var r=this.xhrs[n];if(r.blockIds&&r.blockIds[t]===!0)return delete r.blockIds[t],void(r.xhr.busy&&e.core.util.isObjectEmpty(r.blockIds)&&(this.unregisterSlotEvents(r.url),r.stop(),this.unregisterAbortEvent(r.url)))}},stop:function(){for(var e=0;e<this.xhrs.length;++e){var t=this.xhrs[e].url;this.unregisterSlotEvents(t),this.xhrs[e].stop(),this.unregisterAbortEvent(t)}window.clearInterval(this.cronIntervalId)},registerNewSlotEvents:function(e){radio("bytesReceivedEvent"+e).subscribe([this.onBytesReceivedEvent,this]),radio("xhrFailed"+e).subscribe([this.onXhrFailed,this]),radio("xhrTimeout"+e).subscribe([this.onXhrTimeout,this]),radio("xhrBytesReceived"+e).subscribe([this.onXhrBytesReceived,this]),radio("httpDownloaded"+e).subscribe([this.onHttpDownloaded,this]),radio("onprogressEvent"+e).subscribe([this.onprogressEvent,this]),radio("xhrSent"+e).subscribe([this.onXhrSent,this]),radio("xhrComplete"+e).subscribe([this.onXhrComplete,this]),radio("xhrRetry"+e).subscribe([this.onXhrRetry,this]),radio("xhrAbort"+e).subscribe([this.onXhrAbort,this])},unregisterSlotEvents:function(e){radio("bytesReceivedEvent"+e).unsubscribe([this.onBytesReceivedEvent,this]),radio("xhrFailed"+e).unsubscribe([this.onXhrFailed,this]),radio("xhrTimeout"+e).unsubscribe([this.onXhrTimeout,this]),radio("xhrBytesReceived"+e).unsubscribe([this.onXhrBytesReceived,this]),radio("httpDownloaded"+e).unsubscribe([this.onHttpDownloaded,this]),radio("onprogressEvent"+e).unsubscribe([this.onprogressEvent,this]),radio("xhrSent"+e).unsubscribe([this.onXhrSent,this]),radio("xhrComplete"+e).unsubscribe([this.onXhrComplete,this]),radio("xhrRetry"+e).unsubscribe([this.onXhrRetry,this])},unregisterAbortEvent:function(e){radio("xhrAbort"+e).unsubscribe([this.onXhrAbort,this])},onBytesReceivedEvent:function(e){this.firstRequest=!1,e.url=this.url,radio("bytesReceivedEvent").broadcast(e)},onXhrFailed:function(t){var n=t.url;e.info("failed xhr: "+this.url+" start: "+t.startRange+" end: "+t.endRange),this.rampup=!1;for(var r=this.xhrs[0]&&this.xhrs[0].url===n&&t.isRange&&this.firstRequest,i=0;i<this.xhrs.length;++i)if(this.xhrs[i]&&this.xhrs[i].url===n){var a=this.xhrs.splice(i,1)[0];this.unregisterSlotEvents(n),a.stop(),this.unregisterAbortEvent(n),e.info("removed slot "+n);break}r?radio("xhrRangeFailed").broadcast(this.url):radio("xhrFailed"+this.url).broadcast(t)},onXhrTimeout:function(e){radio("xhrFailed"+this.url).broadcast(e)},onXhrRetry:function(){r.sum(this.url,{internalHTTPTimeouts:1})},onXhrBytesReceived:function(e,t){radio("xhrBytesReceived").broadcast(this.url,t)},onHttpDownloaded:function(e,t){radio("httpDownloaded").broadcast(this.url,t)},onXhrAbort:function(e,t){var n=e.loaded;n>0&&radio("httpAborted").broadcast(this.url,n),radio("xhrAbort"+this.url).broadcast(e,t)},onprogressEvent:function(t){!this.progress[t]&&this.rampup&&this.xhrs.length<e.config.XHR_CONCURRENT&&(this.createNewSlot(this.url),this.progress[t]=!0,radio("HTTPAvailableEvent").broadcast(this.url)),radio("httpProgress").broadcast(this.url)},onXhrSent:function(){radio("xhrSent").broadcast(this.url)},onXhrComplete:function(e){radio("xhrComplete").broadcast(this.url,e)},cron:function(){this.xhrs.length<e.config.XHR_CONCURRENT&&(this.createNewSlot(this.url),radio("HTTPAvailableEvent").broadcast(this.url))}})}()}).call(t,n(1))},function(e,t,n){var r=n(5),i=n(3);e.exports=Object.subClass({ctor:function(e){this.ws=e},groupSdp:function(e,t,n){var a=new r.GroupSdpMessage(e,t,n);return i.sumGlobal({sdpMessagesSent:1}),this.ws.sendMessage(a),a}})},function(e,t,n){"use strict";function r(e){this.name="UnknownError",this.message=e||"Internal error?",this.stack=(new Error).stack}function i(e,t,n){var i="string"==typeof n?{message:n}:n,o=e||new r(i.message);return a.captureException(o,{level:t,extra:i})}var a=n(147),o=n(15),s=n(2);r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,s.SENTRY_APP_URL&&a.config(s.SENTRY_APP_URL,{release:"0.70.8",tags:{token:o(),abConfig:s.A_B_CONFIG_JSON}}),e.exports={trackError:function(e,t){s.SENTRY_APP_URL&&i(e,"error",t)},trackWarning:function(e,t){s.SENTRY_APP_URL&&i(e,"warning",t)}}},function(e,t,n){(function(e){!function(e){function t(){function e(e){n[e]=!0}function t(e){return!!n[e]}var n=Object.create(null);return{addUrl:e,contains:t}}e.FailedUrls=t()}(e.client)}).call(t,n(1))},function(e,t,n){(function(e){!function(){var t=window.GoogleAnalyticsObject||"__ga__",n=t;Object.defineProperty(window,"GoogleAnalyticsObject",{get:function(){return n},set:function(e){e!==n&&(n=e,window[t]&&window[t].q&&(window[e]=window[t],t=n))}}),function(e,t,n,r,i,a,o){e.GoogleAnalyticsObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(n),o=t.getElementsByTagName(n)[0],a.async=1,a.src=r,o.parentNode.insertBefore(a,o)}(window,document,"script","//www.google-analytics.com/analytics.js",n),e.gaManager=function(){e.config.DISABLE_GOOGLE_ANALYTICS||(window[t]("create","UA-37859248-1",{name:"peer5",sampleRate:e.config.GOOGLE_SAMPLING_RATIO}),window[t]("peer5.send","pageview"),window[t]("peer5.set","dimension2",e.config.EXTERNAL_XHR_FALLBACK),e.config.DISABLE_GOOGLE_EVENTS||this.registerEvents())},e.gaManager.prototype={registerEvents:function(){radio("scriptLoaded").subscribe([function(){e.info("script loaded "+Date.now()),window[t]("peer5.send","event","script","loaded")},this]),radio("scriptValidated").subscribe([function(n){n?(e.info("script passed validated"),window[t]("peer5.send","event","script","browser passed validation")):(e.info("script failed validation"),window[t]("peer5.send","event","script","browser failed validation"))},this]),radio("unhandledError").subscribe([function(e,n,r){window[t]("peer5.send","event","unhandled errors",e,n,r)},this]),radio("fileVerificationFailed").subscribe([function(){window[t]("peer5.send","event","errors","file verification failed")},this]),radio("peer5error").subscribe([function(e){window[t]("peer5.send","event","peer5error",e)},this]),radio("external.player").subscribe([function(e){window[t]("peer5.send","event","player",e.action,e.label,e.value)},this]),radio("mediaElementWrapperFailure").subscribe(function(e,n){window[t]("peer5.send","event","failure",e,n,0)}),radio("resumeStarted").subscribe([function(){e.info("resume started "+Date.now()),window[t]("peer5.send","event","storage","resume started")},this]),radio("resumeEnded").subscribe([function(){e.info("resume ended "+Date.now()),window[t]("peer5.send","event","storage","resume ended")},this]),radio("requestedPersQuota").subscribe([function(){e.info("requested persistent quota event"),window[t]("peer5.send","event","user","prompt persistent quota")},this]),radio("persQuotaAnswer").subscribe([function(n){n?(e.info("user has approved using persistent quota"),window[t]("peer5.send","event","user","approved persistent quota")):(e.info("user has denied using persistent quota"),window[t]("peer5.send","event","user","denied persistent quota"))},this]),radio("persQuotaTimeout").subscribe([function(){window[t]("peer5.send","event","user","persistent quota timed out")},this]),radio("offlineStorageError").subscribe([function(e){window[t]("peer5.send","event","errors","offline storage",e)},this]),radio("usingFileSystem").subscribe([function(e){window[t]("peer5.send","event","cacheMethod","filesystem","fileSize",e)},this]),radio("usingMemory").subscribe([function(e){window[t]("peer5.send","event","cacheMethod","memory","fileSize",e)},this]),radio("outOfMemoryError").subscribe([function(e){window[t]("peer5.send","event","errors","out of memory","heap size",e)},this])}},radio("loadedDynamicConfig").subscribe(function(){e.gaManager=new e.gaManager})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){var t=[{key:e.config.FEATURE_DATACHANNEL_KEY,enabled:e.config.FEATURE_DATACHANNEL_ENABLED,initialized:!1,initFunction:function(e,t){var n=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,r="stun:stun.l.google.com:19302",i={iceServers:[{urls:r}]};try{var a=new n(i),o=a.createDataChannel("test_data_channels",{});o.close(),a.close()}catch(e){return t()}e()}},{key:e.config.FEATURE_PAGE_WHITELIST_KEY,enabled:e.config.FEATURE_PAGE_WHITELIST_ENABLED,initialized:!1,initFunction:function(t,n){return null!==document.location.href.match(e.config.FEATURE_PAGE_WHITELIST_REGEX)?t():n()}},{key:e.config.FEATURE_PAGE_BLACKLIST_KEY,enabled:e.config.FEATURE_PAGE_BLACKLIST_ENABLED,initialized:!1,initFunction:function(t,n){return null!==document.location.href.match(e.config.FEATURE_PAGE_BLACKLIST_REGEX)?t():n()}},{key:e.config.FEATURE_XHR_KEY,enabled:e.config.FEATURE_XHR_ENABLED,initialized:!1,initFunction:function(e,t){return window.XMLHttpRequest?e():t()}},{key:e.config.FEATURE_PEER5_KEY,enabled:e.config.FEATURE_PEER5_ENABLED,initialized:!1,initFunction:function(t,n){return(e.feature.isDisabled(e.config.FEATURE_PAGE_WHITELIST_KEY)||e.feature.isEnabledAndInitialized(e.config.FEATURE_PAGE_WHITELIST_KEY))&&!e.feature.isEnabledAndInitialized(e.config.FEATURE_PAGE_BLACKLIST_KEY)&&e.feature.isEnabledAndInitialized(e.config.FEATURE_XHR_KEY)?t():n()}}];t.forEach(e.feature.add)}function r(){e.feature=e.featureToggle.create()}t.init=function(){r(),n()},t.init()}(e)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){function t(t){return t.httpConstraint===!0?(e.info("resource is within critical zone, init by download "+t.url),r):e.config.HTTP_FETCH_AHEAD&&0===e.clientInstance.controller.getNumberOfConnectedPeers()?(e.info("not connected to any peers, init by download "+t.url),r):e.config.HTTP_INIT_AHEAD?e.clientInstance.controller.numOfSeeders(null,t.hashUrl)<e.config.HTTP_INIT_AHEAD_MIN_SEEDERS?e.config.USE_HEAD?(e.info("not enough seeders, init by head "+t.url),i):(e.info("not enough seeders, init by download "+t.url),r):e.config.USE_HEAD?(e.info("enough seeders, init by head "+t.url),i):(e.info("enough seeders, wait for init by peers "+t.url),a):e.config.USE_HEAD?(e.info("default, init by head "+t.url),i):(e.info("default, wait for init by peers "+t.url),a)}return{chooseMethod:t}}var r="download",i="head",a="wait";t.initDecider=n()}(e.client)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(19),r=n(7);!function(n){function i(t,n){var r=e.core.util.ManifestManipulator(t),i=r.delayManifest(n);return i}function a(n){function a(t){if(t&&"string"==typeof t&&t.indexOf(".m3u8")===-1){o=!0;var n=i(t,e.config.LIVE_SECONDS_DELAY);return n}return t}var s=new r;return s.open("GET",n._url),o?t(s,n):t(s,n,a),s}var o=!1;n.createManifestRequest=a,n.setDelayedAlready=function(e){o=e}}(e.client)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(2),r=n(3),i=n(5),a=n(8),o=n(9);!function(n){function s(n,s,u){function c(e,t){radio("xhrBytesReceived").broadcast(e,t)}function l(e,t){P+=t,radio("httpDownloaded").broadcast(e,t)}function d(){radio("httpProgress").broadcast(n)}function h(){radio("xhrSent").broadcast(n)}function f(){radio("xhrComplete").broadcast(n)}function p(e){var t=e.url,n=e.loaded;n>0&&(P-=n,I+=n,radio("httpAborted").broadcast(t,n))}function g(t){e.core.dataStructures.PendingBlockMap.removeResource(n),e.info("received bytes "+n),radio("bytesReceivedEvent"+n).unsubscribe(g),radio("xhrBytesReceived"+n).unsubscribe(c),radio("httpDownloaded"+n).unsubscribe(l),radio("onprogressEvent"+n).unsubscribe(d),radio("xhrComplete"+n).unsubscribe(f),radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrAbort"+n).unsubscribe(p),radio("xhrSent"+n).unsubscribe(h),radio("stopHttpInit"+n).unsubscribe(m),radio("bytesReceivedEvent").broadcast(t),w.stop(),s&&(s.preventDownload=!1)}function v(r){e.info("received bytes "+n),radio("bytesReceivedEvent"+n).unsubscribe(v),radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrAbort"+n).unsubscribe(p),radio("xhrSent"+n).unsubscribe(h),radio("stopHttpInit"+n).unsubscribe(m);var a=new o.ArrayBuffer;a.append(r.dataArray),a.append(new Uint8Array(t.VERSION.split(""))),a.append(new Uint8Array(s.length.toString().split(""))),t.A_B_INITIAL_JSON&&!t.AB_TEST_TOGETHER&&a.append(new Uint8Array(t.A_B_INITIAL_JSON.split("")));var c=a.end();e.info("SwarmId for url: "+n+" is: "+c),s.hashUrl=o.hash(n);var l=new i.FileInfoMessage(c,s.length,null,null,t.BLOCK_SIZE,n);u(l,P,I)}function m(){e.info("stopping httpDownloader init "+n),O&&clearTimeout(O),radio("responseLengthReceived"+n).unsubscribe(T),radio("responseHeadersReceived"+n).unsubscribe(S),radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrSent"+n).unsubscribe(h),radio("bytesReceivedEvent"+n).unsubscribe(v),radio("bytesReceivedEvent"+n).unsubscribe(g),radio("xhrBytesReceived"+n).unsubscribe(c),radio("httpDownloaded"+n).unsubscribe(l),radio("onprogressEvent"+n).unsubscribe(d),radio("xhrComplete"+n).unsubscribe(f),radio("stopHttpInit"+n).unsubscribe(m),w&&w.stop(),radio("xhrAbort"+n).unsubscribe(p),s&&delete s.preventDownload}function _(){var e=new i.FileInfoMessage(s.md5,s.length,s.md5,null,t.BLOCK_SIZE,n);u(e,P,I),s.length>t.SMALL_FILE_SIZE&&w.stop()}function E(){"download"===A?(e.core.dataStructures.PendingBlockMap.addFullResource(n,s.length),4===s.mod&&t.PARALLEL_HTTP_AND_P2P!==!1||(s.preventDownload=!0),radio("xhrFailed"+n).subscribe(y),radio("xhrTimeout"+n).subscribe(y),radio("xhrRetry"+n).subscribe(R),radio("xhrAbort"+n).subscribe(p),radio("xhrSent"+n).subscribe(h),radio("bytesReceivedEvent"+n).subscribe(g),radio("xhrBytesReceived"+n).subscribe(c),radio("xhrComplete"+n).subscribe(f)):radio("stopHttpInit"+n).unsubscribe(m);var r=a.swarmId(n),l=s.length+r+t.VERSION;e.config.A_B_INITIAL_JSON&&!t.AB_TEST_TOGETHER&&(l+=t.A_B_INITIAL_JSON);var d=o.hash(l);e.core.util.UrlSwarmIdMap.addMapping(n,d),e.info("SwarmId for url: "+n+" is: "+d);var v=new i.FileInfoMessage(d,s.length,null,null,t.BLOCK_SIZE,n);u(v,P,I),t.P2P_DOWNLOADING_MSG&&radio("p2p.send.all").broadcast(new i.DownloadingMessage(d,s.hashUrl),"Downloading")}function b(){w&&w.stop(),w=new e.client.HTTPDownloader(n),radio("xhrFailed"+n).subscribe(y),radio("xhrTimeout"+n).subscribe(y),radio("xhrRetry"+n).subscribe(R),radio("xhrAbort"+n).subscribe(p),radio("xhrSent"+n).subscribe(h),radio("bytesReceivedEvent"+n).subscribe(v),radio("httpDownloaded"+n).unsubscribe(l),w.download(0,t.CHUNKY_HEAD_LENGTH)}function S(t){s.state>=1&&e.warn("receiveHeaders but resource is already initiated"),radio("responseHeadersReceived"+n).unsubscribe(S),"head"===A&&(radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrAbort"+n).unsubscribe(p));var r=e.core.util.parseResponseHeaders(t);radio("HTTPHeadersReceived"+n).broadcast(n,t,r),r["content-md5"]&&(s.md5=r["content-md5"]);var i=e.core.util.parseResponseLengthHeader(r["content-range"],r["content-length"]);i&&T(i)}function T(r){return s.length?void e.warn("received length for resource that already has length, skipping "+n):(O&&clearTimeout(O),radio("responseHeadersReceived"+n).unsubscribe(S),radio("responseLengthReceived"+n).unsubscribe(T),radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrAbort"+n).unsubscribe(p),radio("xhrSent"+n).unsubscribe(h),s.length=r,!t.USE_FS&&s.length>t.ALLOWED_FILE_SIZE?void radio("removeResource").broadcast(n,e.Request.FILE_SIZE_ERR,"file size too big"):s.md5?void _():s.length<=t.SMALL_FILE_SIZE?void E():void b())}function y(e){O&&clearTimeout(O),radio("responseLengthReceived"+n).unsubscribe(T),radio("responseHeadersReceived"+n).unsubscribe(S),radio("xhrFailed"+n).unsubscribe(y),radio("xhrTimeout"+n).unsubscribe(y),radio("xhrRetry"+n).unsubscribe(R),radio("xhrAbort"+n).unsubscribe(p),radio("xhrSent"+n).unsubscribe(h),radio("bytesReceivedEvent"+n).unsubscribe(v),radio("bytesReceivedEvent"+n).unsubscribe(g),radio("xhrBytesReceived"+n).unsubscribe(c),radio("httpDownloaded"+n).unsubscribe(l),radio("onprogressEvent"+n).unsubscribe(d),radio("xhrComplete"+n).unsubscribe(f),radio("stopHttpInit"+n).unsubscribe(m),radio("removeResource").broadcast(n,e.status,"xhr failed or timed out")}function R(){r.sum(n,{internalHTTPTimeouts:1})}var w,P=0,I=0,O=null,C=e.core.util.HashUrlLengthMap.getLength(s.hashUrl);if(!C||t.USE_HEAD||t.IGNORE_LENGTH){var A="download";switch(4===s.mod?A=e.client.initDecider.chooseMethod(s):2===s.mod&&(A=t.USE_HEAD||"preload"===s.origin||0===e.clientInstance.controller.getNumberOfConnectedPeers()?"head":"wait"),radio("responseLengthReceived"+n).subscribe(T),radio("stopHttpInit"+n).subscribe(m),A){case"head":e.info("initializing resource with HEAD: "+n),radio("responseHeadersReceived"+n).subscribe(S),radio("xhrFailed"+n).subscribe(y),radio("xhrTimeout"+n).subscribe(y),radio("xhrRetry"+n).subscribe(R),radio("xhrAbort"+n).subscribe(p),radio("xhrSent"+n).subscribe(h),w=new e.client.HTTPDownloader(n,!1),w.head();break;case"download":e.info("initializing resource with GET: "+n),radio("responseHeadersReceived"+n).subscribe(S),radio("xhrFailed"+n).subscribe(y),radio("xhrTimeout"+n).subscribe(y),radio("xhrRetry"+n).subscribe(R),radio("xhrAbort"+n).subscribe(p),
radio("xhrSent"+n).subscribe(h),radio("onprogressEvent"+n).subscribe(d),radio("httpDownloaded"+n).subscribe(l),w=new e.client.HTTPDownloader(n,!1),w.download();break;case"wait":if(C&&t.IGNORE_LENGTH)e.info("Decided to wait, initializing resource with pre-saved length: "+n),T(C);else if("undefined"!=typeof s.constraint){var k=s.constraint-t.EXTERNAL_MINIMUM_HTTP_CONSTRAINT-performance.now();e.info("waiting for up to "+k+"ms for peers to initialize resource: "+n),O=setTimeout(function(){s.length||(A="download",e.info("timed-out waiting for peers to initialize resource: "+n),radio("responseHeadersReceived"+n).subscribe(S),radio("xhrFailed"+n).subscribe(y),radio("xhrTimeout"+n).subscribe(y),radio("xhrRetry"+n).subscribe(R),radio("xhrAbort"+n).subscribe(p),radio("xhrSent"+n).subscribe(h),radio("onprogressEvent"+n).subscribe(d),radio("httpDownloaded"+n).subscribe(l),w=new e.client.HTTPDownloader(n,!1),w.download(),radio("p2p.send.all").broadcast(new i.InitializingMessage(s.hashUrl),"Initializing"))},k)}else e.error("waiting forever for peers to initialize resource: "+n);return}radio("p2p.send.all").broadcast(new i.InitializingMessage(s.hashUrl),"Initializing")}else e.info("initializing resource with pre-saved length: "+n),T(C)}n.getHttpMeta=s}(e.client)}).call(t,n(1))},function(e,t){"use strict";function n(e,t){function n(){if(p)return[];if(g)return[];b++,p=Date.now();var e=Date.now()-m,t={action:"rebuffer.start",label:"playback",timeSinceLoaded:e,id:h,vendor:f,occurrence:b};return[t]}function r(){S++,g=Date.now();var e=Date.now()-m,t={action:"seek.start",label:"seek",timeSinceLoaded:e,id:h,vendor:f,occurrence:S};return[t]}function i(){var e=Date.now();if(!v){v=e;var t={action:"load.start",label:"load",id:h,vendor:f};return E&&(E=!1,_&&(t.timeSinceReady=e-_)),[t]}return[]}function a(){var e=Date.now();if(v){var t=e-v;v=null;var n={action:"load.end",label:"load",duration:t,id:h,vendor:f};return m=e,[n]}return[]}function o(){var e=Date.now();if(p){var t=e-p;p=null;var n=e-m,r={action:"rebuffer.end",label:"playback",timeSinceLoaded:n,duration:t,id:h,vendor:f,occurrence:b};return[r]}if(g){var t=e-g;g=null;var n=e-m,i={action:"seek.end",label:"seek",timeSinceLoaded:n,duration:t,id:h,vendor:f,occurrence:S};return[i]}return[]}function s(){_=Date.now(),E=!0;var e={action:"ready",label:"ready",id:h,vendor:f};return[e]}function u(){T=!0;var e={action:"pause.start",label:"pause",id:h,vendor:f};return[e]}function c(){var e={action:"stop",label:"stop",id:h,vendor:f};return[e]}function l(){T=!1;var e={action:"pause.end",label:"pause",id:h,vendor:f};return[e]}function d(e){var t=[];switch(e){case"ready":t=s();break;case"buffer":t=n();break;case"seek":t=r();break;case"loadStart":t=i();break;case"loadEnd":t=a();break;case"pause":t=u();break;case"stop":t=c();break;case"play":t=l();break;case"resume":t=o();break;default:console.error("unrecognized action:"+e)}return t}var h=e,f=t,p=null,g=null,v=null,m=null,_=null,E=!0,b=0,S=0,T=!0;return{getEvents:d}}e.exports=n},function(e,t,n){(function(e){!function(t){function n(t,n){t.response=n,""!==t.responseType&&"text"!==t.responseType||(t.responseText=n),t.readyState=4,t.responseURL=t._url,t.status=200;for(var r={currentTarget:t,target:t,lengthComputable:!0,loaded:n.length,loadedFS:0,loadedHTTP:n.length,loadedP2P:0,total:n.length},i=0;i<t.eventListeners.readystatechange.length;i++){var a=t.eventListeners.readystatechange[i];e.core.util.envokeCallback(a,[r],t)}e.core.util.envokeCallback(t.onreadystatechange,[r],t);for(var i=0;i<t.eventListeners.load.length;i++){var a=t.eventListeners.load[i];e.core.util.envokeCallback(a,[r],t)}e.core.util.envokeCallback(t.onload,[r],t);for(var i=0;i<t.eventListeners.loadend.length;i++){var a=t.eventListeners.loadend[i];e.core.util.envokeCallback(a,[r],t)}e.core.util.envokeCallback(t.onloadend,[r],t)}t.bypassServer=n}(e.client)}).call(t,n(1))},function(e,t,n){(function(t){"use strict";var r=n(5),i=n(3);e.exports=Object.subClass({ctor:function(e){this.ws=e},groupReport:function(e){var n=new r.GroupReportMessage(e),i=Date.now()+t.config.REPORT_TTL_MS;return this.ws.sendMessage(n,function(){return Date.now()<i}),n},join:function(e,t){var n=new r.JoinMessage(e,t);return i.sumGlobal({joinMessagesSent:1}),this.ws.sendMessage(n,!0),n},leech:function(e){var t=new r.LeechMessage(e);return this.ws.sendMessage(t,!0),t},share:function(e,t,n,i,a,o){var s=new r.ShareMessage(e,t,n,i,a,o);return this.ws.sendMessage(s,!0),s},leave:function(e){var t=new r.LeaveMessage(e);return i.sumGlobal({leaveMessagesSent:1}),this.ws.sendMessage(t,!0),t},updateABConfig:function(e){var t=new r.ABConfigMessage(e);return this.ws.sendMessage(t,!0),t},sessionReport:function e(t){var e=new r.SessionReport(t);return this.ws.sendMessage(e,!0),e}})}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.apiValidators.ApiValidator=Object.subClass({ctor:function(t){var n=this.detectBrowser();this.browserName=n[0].toLowerCase(),this.browserVersion=n[1],this.validators={},this.validity={},e.browserName=this.browserName,e.browserVersion=this.browserVersion;for(var r in t)this.validators[r]=new t[r](this.browserName,this.browserVersion),this.validity[r]=!1},detectBrowser:function(){var e,t=navigator.appName,n=navigator.userAgent,r=n.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);return r&&null!=(e=n.match(/version\/([\.\d]+)/i))&&(r[2]=e[1]),r=r?[r[1],r[2]]:[t,navigator.appVersion,"-?"],r&&r[0]&&"Netscape"===r[0]&&(r[0]="msie"),r},validate:function(){var t=!0;switch(this.browserName){case"chrome":if(e.config.DISABLE_CHROME)return!1;break;case"firefox":if(e.config.DISABLE_FIREFOX)return!1}for(var n in this.validators)t=t&&this.validators[n].validate();return t},getBrowser:function(){return{name:this.browserName,version:this.browserVersion}},getStatus:function(){var e={};for(var t in this.validators)e[t]=this.validators[t].status;return e}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.apiValidators.ApiValidatorBase=Object.subClass({ctor:function(){this.status=!1}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.apiValidators.DataChannelsApiValidator=e.core.apiValidators.ApiValidatorBase.subClass({ctor:function(e,t){this._super(),this.browserName=e,this.browserVersion=t},validate:function(){var e,t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,n=!0;try{var r="stun:stun.l.google.com:19302",i={iceServers:[{urls:r}]};e=new t(i),e.createDataChannel("test_data_channels",{ordered:!1,maxRetransmits:0})}catch(e){n=!1}return e&&e.close(),n||radio("browserUnsupported").broadcast(this.browserName,this.browserVersion,"data channels"),this.status=n,n}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.apiValidators.FileSystemApiValidator=e.core.apiValidators.ApiValidatorBase.subClass({ctor:function(e,t){this._super(),this.browserName=e,this.browserVersion=t},validate:function(){if(0==e.config.USE_FS)return!0;var t=this;return"firefox"==this.browserName?(e.config.ALLOWED_FILE_SIZE=e.config.ALLOWED_FILE_SIZE_FF,e.config.IS_FIREFOX=!0,!e.config.USE_PERSISTENT||e.config.DISABLE_FS_FF?e.config.USE_FS=!1:window.indexedDB&&window.indexedDB.open?e.core.data.FSio=new e.core.data.FSioFireFox(function(n){n||(e.info("changing USE_FS to false"),t.status=!1,e.config.USE_FS=!1)}):e.config.USE_FS=!1):window.webkitRequestFileSystem&&navigator.webkitTemporaryStorage?(e.core.data.FSio.requestTempQuota(100,function(n){n||(e.info("changing USE_FS to false"),t.status=!1,e.config.USE_FS=!1)}),e.config.IS_CHROME=!0):e.config.USE_FS=!1,this.status=e.config.USE_FS,!0}})}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(12),r=n(19),i=n(3),a=n(5),o=n(7),s=n(8),u=n(2),c=t.HYBRID,l=t.P2P,d=t.HTTP,h=t.DYNAMIC;!function(t){e.core.apis.MediaFetcher=Object.subClass({ctor:function(){this.segmentsInfo=Object.create(null),this.interceptRequests=Object.create(null),this.playlistsHandler=e.core.playlist.PlaylistsHandler(),this.playlistsCache=e.core.util.createPlaylistCache(),this.segmentsPrefetcher=null,this.prePlaySegmentsPrefetcher=null,this.requests=Object.create(null),this.numOfPeers=0,this.httpPendingRequests=0,this.p2pPendingRequests=0,this.peersHave=Object.create(null);var t=this;this.requestLRU=new e.core.dataStructures.LRU(null,function(){return t._scavange.apply(t,arguments)},function(){return t._requestCacheTester.apply(t,arguments)}),this.totalRequestSize=0,this.downloadSpeed=[0,0],this.playerStarted=!1,this.MAX_REQUEST_CACHE_SIZE_LIVE,this.mediaController=new e.core.media.MediaController,this.playlistXhr=null,this.playlistXhrTimer=null,this.httpConstraintOn=!0,this.firstRequestTimestamp=null,radio("requestSent").subscribe([this._interceptP5Request,this]),radio("activePeerConnectionsNumberChanged").subscribe([this._changeNumOfPeers,this]),radio("receivedHaveMessage").subscribe([this._handleHaveMessage,this]),radio("receivedDontHaveMessage").subscribe([this._handleDontHaveMessage,this]),radio("connectionFailed").subscribe([this._handleConnectionFail,this]),radio("external.prePlayPrefetch").subscribe([this._prePlayPrefetch,this]),radio("peerDiscoveredSegment").subscribe([this._handleDiscoveredSegment,this]),this._initPrefetchers()},_initPrefetchers:function(){var t=this,n={requestSwarmStateChanged:function(){return t._requestSwarmStateChanged.apply(t,arguments)},saveDownloadSpeed:function(){return t._saveDownloadSpeed.apply(t,arguments)},reportProgress:this.reportProgress,onP2PPrefetchComplete:function(){return t._prefetch.apply(t,arguments)},getSeeders:function(){return t._getSeeders.apply(t,arguments)}},r={playlistsHandler:this.playlistsHandler,prefetchSlotsHandler:e.core.util.PrefetchSlotsHandler(function(){return t._peersCount()}),prefetchSpeedEstimator:e.core.util.PrefetchSpeedEstimator(),playlistsCache:this.playlistsCache};this.segmentsPrefetcher=e.core.util.SegmentsPrefetcher(r,n),this.prePlaySegmentsPrefetcher=e.core.util.prePlayPrefetcher(r,n)},_peersCount:function(){return this.numOfPeers},_getSeeders:function(e){var t=s.getNormalizedUrlHash(e);return this.segmentsInfo[t]},_prePlayPrefetch:function(t){e.config.FEATURE_PRE_PLAY_PREFETCH&&e.VideoRequest!==o&&this.prePlaySegmentsPrefetcher.startPrefetch(t)},_interceptP5Request:function(t){if(!t.mediaPrefetch)if(this.interceptRequests[t._url]||t.isFragmentRequest)this._interceptSegmentRequest(t);else if(e.core.util.PlaylistParserFactory.isPlaylistCandidate(t)||t.isPlaylistRequest)this.prePlaySegmentsPrefetcher.stopPrefetch(),this.playerStarted=!0,this._interceptPlaylistRequest(t);else if(t.isVideoPlayerRequest){var n=t.fallbackToNative();n.send(),t.discontinue()}else e.info("didnt intercept: "+t._url)},_interceptPlaylistRequest:function(t){this.firstRequestTimestamp||(this.firstRequestTimestamp=performance.now()),this.playlistXhr&&(this.playlistXhr.abort(),this.playlistXhr=null),this.playlistXhrTimer&&(clearInterval(this.playlistXhrTimer),this.playlistXhrTimer=null),e.info("Intercepted a playlist request"),t.discontinue();var n=this.playlistsCache.load(t._url),r=this;if(n)return void e.core.util.envokeCallback(function(){e.client.setDelayedAlready(!0),setTimeout(function(){r.playlistsCache.remove(t._url)},1e3),t.addEventListener("load",function(e){r._parsePlaylist(e,t._url)}),t.forceImmediateLoad(n)},null,this);t.addEventListener("load",function(e){var t=e.currentTarget.status;t<200||t>=300||r._cachePlaylist(e)});var i=e.client.createManifestRequest(t),a=i.onreadystatechange;if(i.onreadystatechange=function(e){var n=e.currentTarget.status;4===i.readyState&&n>=200&&n<300&&r._parsePlaylist(e,t._url),a&&a.apply(this,arguments)},i.send(),e.config.PLAYLIST_TIMEOUT){var o=e.config.PLAYLIST_TIMEOUT_DURATION;setTimeout(function(){i.readyState<4&&(e.info("playlist request timedout "+t._url),i.abort())},o)}},_interceptSegmentRequest:function(t){var n=this;e.info("intercepted an interesting request: "+t._url);var i=performance.now();if(this.firstRequestTimestamp||(this.firstRequestTimestamp=i),i-this.firstRequestTimestamp<e.config.SKIP_JOIN_MIN_TIME&&(t.skipJoin=!0),e.client.FailedUrls.contains(t._url)){var a=new o;return a.open("GET",t._url),r(a,t),a.addEventListener("load",function(e){n._onXhrLoad(t,e)}),a.send(),void t.discontinue()}e.config.FEATURE_P2P_IMPROVEMENT_ENABLED?this.segmentsPrefetcher.updatePlayerLastRequestedSegment(t._url):this.playlistsHandler.setLastRequestedSegment(t._url),t.addEventListener("load",function(){n._requestLoaded.apply(n,arguments)}),t.addEventListener("swarmstatechange",function(){n._requestSwarmStateChanged.apply(n,arguments)}),this._overrideInterceptedRequest(t),this._requestExist(t._url)?this._updateRequest(t,t._url):this._addRequest(t,t._url)},_onXhrLoad:function(t,n){if(e.info("failed request "+t._url+" loaded"),2==parseInt(n.currentTarget.status/100)){this.playlistsHandler.deleteToSegment(t._url),this.playlistsHandler.setLastLoadedSegment(t._url);var r=this;setTimeout(function(){r._prefetchBoth()},10)}},_prefetchBoth:function(){this._prefetch("http"),this._prefetch("p2p")},_changeNumOfPeers:function(e){this.numOfPeers=e,this.reportProgress({type:"swarmChange",peers:e})},_handleHaveMessage:function(e,t){var n=e.hashUrl;this.segmentsInfo[n]||(this.segmentsInfo[n]=Object.create(null)),this.segmentsInfo[n][t]=!!e.seeder,this.peersHave[t]||(this.peersHave[t]=Object.create(null)),this.peersHave[t][n]=!0,this._prefetch("p2p")},_handleDontHaveMessage:function(t,n){var r=t.hashUrl;e.info("peer "+n+": dont have swarm with hashUrl - "+r),this.segmentsInfo[r]&&this.segmentsInfo[r][n]&&(delete this.segmentsInfo[r][n],delete this.peersHave[n][r])},_handleConnectionFail:function(e){if(this.peersHave[e]){for(var t=Object.keys(this.peersHave[e]),n=0,r=t.length;n<r;n++)delete this.segmentsInfo[t[n]][e];delete this.peersHave[e]}},_requestLoaded:function(t){if(e.info("request "+t.currentTarget._url+" loaded"),this._decreasePendingRequests(t.currentTarget.downloadMode),this.reportProgress({type:"fileDownloaded",url:t.currentTarget._url,loaded:t.loaded,p2p:t.loadedP2P,http:t.loadedHTTP,waste:t.loadedP2P+t.loadedHTTP-t.total,fileSize:t.total,downloadTimeMS:Date.now()-t.currentTarget.timestamp}),t.currentTarget.status>=200&&t.currentTarget.status<300){this.playlistsHandler.deleteToSegment(t.currentTarget._url),this.playlistsHandler.setLastLoadedSegment(t.currentTarget._url),this._saveDownloadSpeed(t.currentTarget);var n=this;setTimeout(function(){n._prefetchBoth()},10)}this._updateRequestHttpConstraint()},_requestSwarmStateChanged:function(e){if(e.sent){var t={type:"swarmChange",sent:e.sent};this.reportProgress(t)}},_prefetch:function(t){if(this.playerStarted&&0!==this.numOfPeers)if(e.config.FEATURE_P2P_IMPROVEMENT_ENABLED)for(var n=this.segmentsPrefetcher.prefetchSegments(),r=0;r<n.length;r++){var i=n[r];this._addRequest(i.xhr,i.url)}else if("http"===t){if(this.httpPendingRequests>=e.config.MAX_HTTP_REQUESTS||0===e.config.MAX_HTTP_REQUESTS)return;for(var a=[],o=this.playlistsHandler.getNextSegmentsWindow(e.config.HTTP_VOD_WINDOW),r=0;r<o.length;r++){var u=o[r];if(!this._requestExist(u)){var c=s.getNormalizedUrlHash(u),l=Object.keys(this.segmentsInfo[c]).length;0===l&&a.push(u)}}var u=a[Math.floor(Math.random()*a.length)];if(!u)return void this._prefetch("p2p");e.info("prefetching "+u+" in http"),this._requestP5(u,null,{downloadMode:"http"}),this._prefetch("http")}else if("p2p"===t){if(this.p2pPendingRequests>=e.config.MAX_P2P_REQUESTS||0===e.config.MAX_P2P_REQUESTS)return;for(var a=[],d=1,o=this.playlistsHandler.getNextSegmentsWindow(e.config.P2P_VOD_WINDOW),r=0;r<o.length;r++){var u=o[r];if(!this._requestExist(u)){var c=s.getNormalizedUrlHash(u),h=this.segmentsInfo[c];if(h){var l=Object.keys(h).length;l===d?a.push(u):l>d&&(a=[u],d=l)}}}var u=a[Math.floor(Math.random()*a.length)];if(!u)return;e.config.DYNAMIC_PREFETCH&&(t="dynamic"),e.info("prefetching "+u+" in "+t+" mod"),this._requestP5(u,null,{downloadMode:t}),this._prefetch("p2p")}},_requestP5:function(t,n,r){var i=new e.VideoRequest({downloadMode:r.downloadMode});i.mediaPrefetch=!0,i.responseType="arraybuffer",i.open("GET",t);var a=this;i.addEventListener("swarmstatechange",function(){return a._requestSwarmStateChanged.apply(a,arguments)}),i.addEventListener("error",function(n){e.warn("onerror prefetching resource: "+t+" "+n)}),i.addEventListener("loadend",function(n){e.info("MediaFetcher::_requestP5:onloadend "+t," status ",this.status),a._decreasePendingRequests(n.currentTarget.downloadMode),this.status>=200&&this.status<300&&(a._saveDownloadSpeed(this),a.reportProgress({type:"fileDownloaded",url:t,loaded:n.loaded,p2p:n.loadedP2P,http:n.loadedHTTP,waste:n.loadedP2P+n.loadedHTTP-n.total,fileSize:n.total,downloadTimeMS:Date.now()-n.currentTarget.timestamp})),a._prefetch(r.downloadMode||"http")}),e.info("MediaFetcher::_requestP5:requesting "+t),this._increasePendingRequests(i.downloadMode),this._addRequest(i,t),"dynamic"===r.downloadMode&&this._addRequestTimeConstraints(i),i.send()},_requestExist:function(e){return e in this.requests},_addRequest:function(t,n){e.info("adding request "+n+" to requests"),t.timestamp=Date.now(),this.requests[n]=t;var r=this.requestLRU.get(n,t);r?this.requestLRU.update(n,t):this.requestLRU.set(n,t);var i,a=this,o=function(e){!i&&t.readyState>=2&&e.lengthComputable&&(a.totalRequestSize+=e.total,i=!0)};t.addEventListener("readystatechange",o)},_updateRequest:function(t,n){e.info("updating request "+n+" to requests"),t.timestamp=Date.now();var i=this.requests[n];if(i.readyState<4)if(e.config.MERGE_REQUESTS){e.info("MediaFetcher::_updateRequest: merging new request to a prefetched request: "+n),r(i,t),t.discontinue();var a=e.state.resources.get(n);a&&(a.httpConstraint=t._httpConstraint,e.info("updated httpConstraint for resource "+n+" to "+t._httpConstraint))}else e.info("aborting a prefetched request:"+n),i.abort(),this.reportProgress({type:"requestAborted",mode:i.downloadMode===l?"p2p":"http"}),this._saveDownloadSpeed(i);this.requests[n]=t,this.requestLRU.update(n,t)},_scavange:function(t,n){if(e.info("removing request"+t),!n)return void e.warn("scavanging an undefined request");var r=n.getFileInfo();r?(n.abort({leaveSwarm:!0}),n.readyState>=2&&(this.totalRequestSize-=r.size)):e.warn("scavanged a request that hadnt initiated"+t),delete this.requests[t]},_requestCacheTester:function(){return this.totalRequestSize>this.MAX_REQUEST_CACHE_SIZE},_cachePlaylist:function(t){e.info("caching playlist");var n=t.currentTarget._url,r=t.currentTarget.response;this.playlistsCache.save(n,r);var i=this;setTimeout(function(){i.playlistsCache.remove(n)},1e3)},_parsePlaylist:function(t,n,r){e.info("parsing playlist");var o;switch(t.currentTarget.responseType){case"blob":return void e.warn("playlist was requested as a blob: "+n);case"arraybuffer":o=String.fromCharCode.apply(null,new Uint8Array(t.currentTarget.response));break;default:o=t.currentTarget.response}var u=this.playlistsHandler.hasLivePlaylist();i.setMediaInfo({type:u?"live":"vod"}),this.MAX_REQUEST_CACHE_SIZE=u?e.config.MAX_REQUEST_CACHE_SIZE_LIVE:e.config.MAX_REQUEST_CACHE_SIZE_VOD;var c=this.playlistsHandler.getNewestSegment(n),l=this.playlistsHandler.extractSegments(n,o),d=this.playlistsHandler.getNewestSegment(n);if(l&&0!==l.length){for(var h=0;h<l.length;h++){var f=l[h],p=s.getNormalizedUrlHash(f);this.segmentsInfo[p]||(this.segmentsInfo[p]=Object.create(null)),this.interceptRequests[f]=!0}if(e.config.PEER_LIVE_DETECTION&&c&&c!==d){e.info("detected new segment, sending to peers");var g=this.playlistsHandler.getSegmentData(d).segmentData,v=g.seqs,m=new a.NewSegmentMessage(v);radio("p2p.send.all").broadcast(m,"NewSegment")}if(e.config.EARLY_LIVE_DETECTION){var _=this;this.playlistXhrTimer=setTimeout(function(){_._detectLiveEarly(n)},e.config.EARLY_LIVE_DETECTION_INTERVAL)}(e.config.EARLY_LIVE_DETECTION||e.config.PEER_LIVE_DETECTION)&&c&&d!==c&&!this._isActivePlayerRequest()&&r&&(e.info("discovered new segment - prefetching: "+d),this._requestP5(d,null,{downloadMode:"dynamic"}))}},_detectLiveEarly:function(e){this.playlistXhrTimer=null,this._requestPlaylist(e)},_overrideInterceptedRequest:function(t){var n,r=s.getNormalizedUrlHash(t._url),i=this.segmentsInfo[r],a=i?Object.keys(i).length:0;0===a?n=0:a>=1&&(n=this.downloadSpeed[1]),e.config.AGGRESSIVE_P2P&&n>this.downloadSpeed[0]?(e.info("override interception to p2p"),t.downloadMode=l):e.config.SYNCED_BUFFERS?(e.info("override interception to dynamic mode"),t.downloadMode=h,this._addRequestTimeConstraints(t)):(e.info("override interception to http"),t.downloadMode=d),this._increasePendingRequests(t.downloadMode),this._timeoutPlayerRequests(t)},_addRequestTimeConstraints:function(t){var n=this.mediaController.getBufferLength(),r=n>0?this.playlistsHandler.getDurationFromLastLoadedToSegment(t._url):0,i=n+r,a=(e.config.EXTERNAL_MEDIA_FRAGMENT_TIMEOUT-e.config.HIGH_BUFFER_HTTP_CONSTRAINT+e.config.EXTERNAL_MINIMUM_HTTP_CONSTRAINT)/1e3,o=Math.min(i,a);this._updateRequestHttpConstraint(),t._constraint=performance.now()+1e3*o,t._httpConstraint=this.httpConstraintOn,!t.mediaPrefetch&&u.PLAYER_REQUEST_ALWAYS_HTTP?(t._httpConstraint=!0,e.info("resource "+t._url+" was requested by the player, downloading in http")):1e3*(n+r)>e.config.EXTERNAL_MAXIMUM_HTTP_CONSTRAINT&&(t._httpConstraint=!1,e.info("resource "+t._url+" is further than maximum http constraint")),e.info("player buffer is "+n+"s, extra buffer is "+r+"s for resource "+t._url+". httpConstraint is "+t._httpConstraint)},_updateRequestHttpConstraint:function(){var t=this.mediaController.getBufferLength();this.httpConstraintOn===!1&&t<e.config.EXTERNAL_MINIMUM_HTTP_CONSTRAINT/1e3?(this.httpConstraintOn=!0,e.info("player buffer ("+t+"s) is lower than minimum http constraint, changing httpConstraint to http mode")):this.httpConstraintOn===!0&&t>e.config.EXTERNAL_MAXIMUM_HTTP_CONSTRAINT/1e3&&(this.httpConstraintOn=!1,e.info("player buffer ("+t+"s) is higher than maximum http constraint, changing httpConstraint to p2p mode"))},_timeoutPlayerRequests:function(t){if(e.config.REQUEST_TIMEOUT){var n,r=t.downloadMode;switch(r){case l:n=e.config.P2P_TIMEOUT_DURATION;break;case d:n=e.config.HTTP_TIMEOUT_DURATION;break;default:n=e.config.HTTP_TIMEOUT_DURATION}if(e.config.REQUEST_TIMEOUT){var i=this;setTimeout(function(){i._requestTimeout(t)},n)}}},_requestTimeout:function(t){t.readyState<4&&(i.sumGlobal({playlistTimeouts:1}),e.info("intercepted request timedout "+t._url),t.abort(),this._decreasePendingRequests(t.downloadMode),this._saveDownloadSpeed(t))},_saveDownloadSpeed:function(t){var n=t._speed;if(n){if(t.downloadMode===l)var r=1;else var r=0;this.downloadSpeed[r]=n,e.info("speed ="+n+" bucket="+r)}},_increasePendingRequests:function(t){t&&t===l?this._increaseP2PPendingRequests():t&&t===d?this._increaseHTTPPendingRequests():t&&t===h||e.error("unidentified downloadMode request started: "+t)},_decreasePendingRequests:function(t){t===l?this._decreaseP2PPendingRequests():t===d||t===c?this._decreaseHTTPPendingRequests():t===h||e.error("unidentified downloadMode request loaded: "+t)},_increaseHTTPPendingRequests:function(){this.httpPendingRequests++},_increaseP2PPendingRequests:function(){this.p2pPendingRequests++},_decreaseHTTPPendingRequests:function(){this.httpPendingRequests--,this.httpPendingRequests<0&&e.error("httpPendingRequests smaller than 0")},_decreaseP2PPendingRequests:function(){this.p2pPendingRequests--,this.p2pPendingRequests<0&&e.error("p2pPendingRequests smaller than 0")},_requestPlaylist:function(e){if(!this.playlistXhr){var t=new o,n=this;t.open("GET",e),t.onloadend=function(t){n.playlistXhr=!1;var r=t.currentTarget.status,i=t.currentTarget.response;r>=200&&r<300&&i&&n._parsePlaylist(t,e,!0)},t.send(),this.playlistXhr=t}},_handleDiscoveredSegment:function(t){var n=this.playlistsHandler.getCurrentPlaylist();if(n){var r=this.playlistsHandler.getNewestSegment(n),i=this.playlistsHandler.getSegmentData(r).segmentData.seqs,a=this.playlistsHandler.getLastRequestedSegment(),o=this.playlistsHandler.getSegmentData(a).segmentData.seqs;t>i&&t-o<e.config.LIVE_DETECTION_WINDOW&&(e.info("new segment #"+t+" discovered by a peer, downloading playlist (old seq # is "+i+")"),this._requestPlaylist(n))}},_isActivePlayerRequest:function(){var e=this.playlistsHandler.getLastRequestedSegment(),t=this.requests[e];return!t||4!==t.readyState},reportProgress:function(e){window.P2PPerformanceUpdate&&window.P2PPerformanceUpdate(e)}}),t.core.apis.MediaFetcher=new e.core.apis.MediaFetcher,t.prefetch=function(e){radio("external.prePlayPrefetch").broadcast(e)}}(e)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(6).singleton,r=n(13);!function(){var n=e.core.util.UrlSwarmIdMap;e.core.controllers.AbstractController=Object.subClass({ctor:function(){this.resourceState=Object.create(null)},init:function(e){this.resourceState[e]=r.LOADING},removeResource:function(t){delete this.resourceState[t],e.core.dataStructures.PendingBlockMap.removeResource(t)},stopResource:function(t){this.resourceState[t]=r.STOPPED,e.core.dataStructures.PendingBlockMap.removeResource(t)},getRarestBlocks:function(r,i,a){for(var o,s,u=t.get(r),c=[],l=[],d=this.P2PController||this,h=n.getSwarmId(r)||r,f=0,p=u.getNumOfBlocks();f<p;f++)if(s=0,a(f)){for(var g in d.remoteAvailabilityMaps[h])d.remoteAvailabilityMaps[h][g].has(f)&&s++;0==l.length?(c.push(f),o=s):s===o?c.push(f):s<o&&(c=[f],o=s)}var v=e.core.util.randSample(c,i);return v},getSeqBlocks:function(e,n,r){for(var i=t.get(e),a=[],o=i.getFirstMissingBlock(),s=i.getNumOfBlocks()-1,u=o;u<=s&&a.length<n;u++)if(r(u))a.push(u);else if(a.length)break;return a}})}()}).call(t,n(1))},function(e,t,n){(function(e){var t="0.70.8",r=n(120),i=n(5),a=n(3),o=n(13),s=n(6).singleton,u=n(2);!function(){function n(){return u.LEECH||u.BUFFER_LENGTH_LEECH_LOW_SEC&&e.core.apis.MediaFetcher.mediaController.getBufferLength()<u.BUFFER_LENGTH_LEECH_LOW_SEC}var c=[],l=!1;e.core.controllers.P2PController=e.core.controllers.AbstractController.subClass({ctor:function(t){this._super(),this.peersPerformanceTracker=e.core.util.PeersPerformanceTracker,this.lastSwarmDownloaded={swarmId:null,timeStamp:null},this.peersBlacklist=Object.create(null),this.peer=t,this.lastBlockRequestedInP2P=Object.create(null),this.peerConnections=Object.create(null),this.initPeerConnections=Object.create(null),this.attemptedConnections=Object.create(null),this.deletedPeerConnections=Object.create(null),this.numberOfPCCreated=0,this.remoteAvailabilityMaps=Object.create(null),this.remoteHave=Object.create(null),this.remoteDownloading=Object.create(null),this.peerSwarms=Object.create(null),this.prefetchFlag=Object.create(null),this.resourceState=Object.create(null),this.pendingResources=Object.create(null),this._peerConnectionsToCreate=0,this.initClosePCQueue(),this.registerEvents(),this.startMeasuringLatency(),this.lookingForPeers=!0,this.initPCPool(),this.pcOpenQueue=[],this.pcInterval=null},init:function(t){l=!0,this._super(t),this.remoteAvailabilityMaps[t]||(this.remoteAvailabilityMaps[t]=Object.create(null)),this.prefetchFlag[t]=2===e.state.resources.get(t).mod,this.addResourceAsPending(t),this.loadCachedHaveRequests(t)},startPeerConnectionOpenInterval:function(){if(!this.pcInterval){var e=this;if(u.PC_CREATE_INTERVAL>0)this.pcInterval=setInterval(function(){var t=e.pcOpenQueue.pop();return t?void e.ensurePeerConnectionInitialized(t,!0):(clearInterval(e.pcInterval),void(e.pcInterval=null))},u.PC_CREATE_INTERVAL);else{var t=e.pcOpenQueue.pop();e.ensurePeerConnectionInitialized(t,!0)}}},download:function(e,t,n){if(s.has(e)){var r,i=s.get(e);if(r=t?[t]:this.getAvailablePeerIdsForSwarmId(e),r&&0!==r.length){t||(this.lastSwarmDownloaded.swarmId=e,this.lastSwarmDownloaded.timeStamp=Date.now());var a=this.getNumOfChunksToAllocate(r);if(!(a<=0)){var o,c,l=[];if((this.lastBlockRequestedInP2P[e]||0===this.lastBlockRequestedInP2P[e])&&!i.has(this.lastBlockRequestedInP2P[e])){c=this.lastBlockRequestedInP2P[e],o=i.getChunkIdsOfBlock(c);for(var d=0;d<o.length&&l.length<a;++d)i.hasOrPendingChunk(o[d])||l.push(o[d])}if(a-=l.length,a<=0)return this.distributeChunksAmongSources(e,l);for(var h=Math.ceil(a/(u.BLOCK_SIZE/u.CHUNK_SIZE)),f=this,p=function(t){for(var a=0,o=r.length;a<o;a++){var s=r[a],u=f.remoteAvailabilityMaps[e][s];if(u&&u.has(t))return n?n(t):!i.has(t)&&!f.isPendingEntireBlock(e,t)}return!1},g=this.getRarestBlocks(e,h,p),d=0;d<g.length;d++)if(g[d]!==c){o=i.getChunkIdsOfBlock(g[d]);for(var v=0;v<o.length&&l.length<=a;++v)i.hasOrPendingChunk(o[v])||l.push(o[v]);this.lastBlockRequestedInP2P[e]=g[d]}return this.distributeChunksAmongSources(e,l)}}}},getNumOfChunksToAllocate:function(e){e.length||(e=[e]);var t=0,n=this;return e.forEach(function(e){t+=n.peerConnections[e].maxNumOfPendingChunks-n.peerConnections[e].numOfPendingChunks}),t},isPendingEntireBlock:function(e,t){var n=s.get(e),r=n.getNumOfChunksPresetInBlock(t),i=n.getNumOfChunksSetInBlock(t),a=n.getNumOfChunksInBlock(t);return r+i===a},isAvailable:function(e){if(!this.resourceState[e]||this.resourceState[e]===o.STOPPED)return!1;if(!s.has(e))return!1;for(var t in this.peerConnections)if(this.remoteAvailabilityMaps[e][t]&&this.isPeerAvailable(t))return!0;return!1},isPeerAvailable:function(t){var n=this.peerConnections[t];return!!n&&(n.numOfPendingChunks<.9*n.maxNumOfPendingChunks&&(!!n.isAvailable()&&(!!this.peerSwarms[t]&&!e.core.util.isObjectEmpty(this.peerSwarms[t]))))},getAvailableNumOfChunksToSend:function(){var e=0;for(var t in this.peerConnections)e+=this.peerConnections[t].maxNumOfPendingChunks-this.peerConnections[t].numOfPendingChunks;return e},removeResource:function(t){e.info("removed p2p resource "+t),this.sendToAll(this.createDontHaveMessage(t),"DontHave"),this._super(t),delete this.pendingResources[t],delete this.lastBlockRequestedInP2P[t]},stopResource:function(t){e.info("stopped p2p resource "+t),this._super(t),delete this.pendingResources[t]},numOfSeeders:function(e,t){var n={};if(e&&this.remoteAvailabilityMaps[e])for(var r in this.remoteAvailabilityMaps[e])this.remoteAvailabilityMaps[e][r].isFull()&&this.peerConnections[r]&&!n[r]&&(n[r]=!0);if(e&&this.remoteDownloading[e])for(var r in this.remoteDownloading[e])this.remoteDownloading[e][r]&&this.peerConnections[r]&&!n[r]&&(n[r]=!0);if(t&&this.remoteDownloading[t])for(var r in this.remoteDownloading[t])this.remoteDownloading[t][r]&&this.peerConnections[r]&&!n[r]&&(n[r]=!0);return Object.keys(n).length},getLookingForPeers:function(){return this.lookingForPeers},registerEvents:function(){radio("P2PMaybeAvailableEvent").subscribe([function(e,t){this.isPeerAvailable(t)&&this.prefetch(e,t)},this]),radio("blockReceived").subscribe([function(e,t){if(e){var n=this.createHaveMessage(e);n&&this.sendToAll(n,"Have")}},this]),radio("dataReceivedEvent").subscribe([function(t,n){var r=n.targetId;if(n!=this.peerConnections[r])return void e.info("got dataReceivedEvent from peerId "+r+"which was not found in peerConnections");switch(t.tag){case i.P2P_HAVE:a.sumGlobal({p2pHaveMessagesReceived:1}),this.peersPerformanceTracker.reportPeerHaveSwarm(r,t.swarmId),this.receiveHaveMessage(t,r),radio("P2PMaybeAvailableEvent").broadcast(t.swarmId,n.targetId),radio("receivedHaveMessage").broadcast(t,r);break;case i.P2P_DONT_HAVE:a.sumGlobal({p2pDontHaveMessagesReceived:1}),this.receiveDontHaveMessage(t,r),radio("receivedDontHaveMessage").broadcast(t,r);break;case i.P2P_REQUEST:a.sumGlobal({p2pRequestMessagesReceived:1}),this.resourceState[t.swarmId]&&this.receiveRequestMessage(t,r);break;case i.P2P_DATA:a.sumGlobal({p2pDataMessagesReceived:1}),this.peersPerformanceTracker.reportChunksReceivedFromPeer(r,t.swarmId,{id:t.chunkId,bytes:t.payload.length});break;case i.P2P_VERSION:break;case i.P2P_LATENCY_REQUEST:var o=t.timestamp,s=t.originBufferedAmount,u=n.getBufferedAmount();n.queue(new i.LatencyResponseMessage(o,s,u));break;case i.P2P_LATENCY_RESPONSE:this.receiveLatencyMessage(t,r);break;case i.P2P_DOWNLOADING:a.sumGlobal({p2pDownloadingMessagesReceived:1}),this.receiveDownloadingMessage(t,r);break;case i.P2P_NEW_SEGMENT:a.sumGlobal({p2pNewSegmentMessagesReceived:1}),radio("peerDiscoveredSegment").broadcast(t.segSeq);
break;case i.P2P_INITIALIZING:a.sumGlobal({p2pInitializingMessagesReceived:1}),this.receiveInitializingMessage(t,r);break;default:e.warn("received a p2p message not in protocol from "+r)}},this]),radio("connectionIdle").subscribe([function(e){if(!(Object.keys(this.peerConnections).length<u.MAX_CONNECTIONS*u.PC_IDLE_FACTOR)){var t=!1;u.FEATURE_CLOSE_DEAD_CONNECTIONS&&(t=this.closeDeadConnections(e)),t||u.FEATURE_CLOSE_OVERLAPPING_CONNECTIONS&&this.closeOverlappingConnections(e)}},this]),radio("connectionReady").subscribe([function(t){var n=this.peerConnections[t];if(n)e.warn("peerConnection to "+t+" was initialized, but we already have a connection to him");else{if(e.info("new peer connection to "+t),n=this.peerConnections[t]=this.initPeerConnections[t],delete this.initPeerConnections[t],!n)return void e.warn("this should not happen with the new peer connection implementation");this.peersPerformanceTracker.reportPeerConnected(t);var r=Object.keys(this.peerConnections).length;r>=u.MAX_CONNECTIONS&&(this.lookingForPeers=!1),radio("activePeerConnectionsNumberChanged").broadcast(r)}this.peerSwarms[t]=Object.create(null),this.sendVersionTo(n),this.sendAllHavesTo(n)},this]),radio("connectionFailed").subscribe([function(t){e.info("onConnectionFailed: closing connection with "+t);var n=this.peerConnections[t]||this.initPeerConnections[t]||this.deletedPeerConnections[t];if(this.closeConnection(n,!1),this.peerSwarms[t]&&delete this.peerSwarms[t],delete this.deletedPeerConnections[t],n&&n.forceClosed)return void delete this.attemptedConnections[t];if(n&&n.initiator){if("exponential"===u.PC_RECON_METHOD)var r=1e3*Math.pow(u.PC_RECON_EXP_COEF,this.attemptedConnections[t]-1);else{if("single"!==u.PC_RECON_METHOD)return;if(this.attemptedConnections[t]>1)return;var r=u.PC_RECON_DELAY||1e4}var i=this;setTimeout(function(){i.ensurePeerConnectionInitialized(t,!0)},r)}},this]),radio("receivedGroupMatchEvent").subscribe([function(t){e.info("peer "+this.peer.id+" received match with peers: "+t.peerIds),t.peerIds.forEach(function(e){void 0===this.attemptedConnections[e]&&(this.pcOpenQueue.push(e),this.attemptedConnections[e]=this.attemptedConnections[e]+1||1,this.startPeerConnectionOpenInterval())},this)},this]),radio("receivedSDP").subscribe([function(e){this.ensurePeerConnectionInitialized(e.originId,!1),this.initPeerConnections[e.originId]&&this.initPeerConnections[e.originId].handleMessage(e)},this]),radio("receivedGroupSDP").subscribe([function(e){e.sdp.forEach(function(t){radio("receivedSDP").broadcast({originId:e.originId,destId:e.destId,sdpMessage:t})},this)},this]),radio("transferLoaded").subscribe([function(e){delete this.pendingResources[e.swarmId]},this]),radio("p2p.send.all").subscribe([function(e,t){this.sendToAll(e,t)},this])},startMeasuringLatency:function(){var e=this;!this.latencyInterval&&u.PC_LATENCY_ENABLED&&(this.latencyInterval=setInterval(function(){for(var t in e.peerConnections){var n=e.peerConnections[t];if(n&&n.ready){var r=Math.floor(performance.now()),a=n.getBufferedAmount();n.queue(new i.LatencyRequestMessage(r,a))}}},u.PC_LATENCY_INTERVAL))},prefetch:function(e,t){if(this.prefetchFlag[e]&&this.resourceState[e]===o.LOADING){var n=this.download(e,t);n&&0!==n||this.prefetchPendingResources(e,t)}},prefetchPendingResources:function(e,t){for(var n in this.pendingResources)if(n!==e&&this.prefetchFlag[n]&&void 0!==this.remoteAvailabilityMaps[n][t]){var r=this.download(n,t);if(r>0)break}},addResourceAsPending:function(e){if(this.prefetchFlag[e]&&s.has(e)){var t=s.get(e);t.isFull()||(this.pendingResources[e]=!0)}},getSwarmPeersCount:function(e){var t=this.remoteAvailabilityMaps[e];return t?Object.keys(t).length:0},receiveRequestMessage:function(e,t){this.sendData(e.swarmId,t,e.chunkIds,0,0),radio("requestChunks").broadcast(e.swarmId,t,e.chunkIds)},receiveLatencyMessage:function(e,t){var n=Math.floor(performance.now()),r=e.timestamp,i=e.originBufferedAmount,a=e.remoteBufferedAmount,o=Math.round(n-r),s=this.peerConnections[t];s&&0===i&&0===a&&(!s.lastLatencyTimestamp||s.lastLatencyTimestamp<r)&&(s.lastLatencyTimestamp=r,s.latencySlidingWindow.addValue(o))},receiveDownloadingMessage:function(e,t){var n=e.swarmId,r=e.hashUrl;this.remoteDownloading[n]||(this.remoteDownloading[n]={}),this.remoteDownloading[r]||(this.remoteDownloading[r]={}),this.remoteDownloading[n][t]=!0,this.remoteDownloading[r][t]=!0},receiveInitializingMessage:function(e,t){var n=e.hashUrl;this.remoteDownloading[n]||(this.remoteDownloading[n]={}),this.remoteDownloading[n][t]=!0},getAvailablePeerIdsForSwarmId:function(e){var t=this;if(!this.remoteAvailabilityMaps[e])return[];var n=Object.keys(this.remoteAvailabilityMaps[e]);return n.filter(function(e){return t.isPeerAvailable(e)})},sortPeerIdsByLoad:function(e){var t=this;return e.sort(function(e,n){var r=t.peerConnections[e],i=t.peerConnections[n];return r.numOfPendingChunks>i.numOfPendingChunks?1:r.numOfPendingChunks<i.numOfPendingChunks?-1:i.maxNumOfPendingChunks-i.numOfPendingChunks-(r.maxNumOfPendingChunks-r.numOfPendingChunks)})},distributeChunksAmongSources:function(t,n,a){if(!this.remoteAvailabilityMaps[t]||0===n.length)return 0;var o;if(a)o=[a];else{var c=this.getAvailablePeerIdsForSwarmId(t);o=this.sortPeerIdsByLoad(c)}for(var l,d=Object.create(null),h=0,f=0;f<n.length;++f)for(var p=n[f],g=Math.floor(p/(u.BLOCK_SIZE/u.CHUNK_SIZE)),v=0;v<o.length;++v)if(l=u.PC_ALLOCATE_CHUNKS_EVENLY?o[(v+f)%o.length]:o[v],d[l]||(d[l]=[]),this.remoteAvailabilityMaps[t][l]&&this.remoteAvailabilityMaps[t][l].has(g)&&!this.peerConnections[l].isFull(d[l].length)){d[l].push(p),h++;break}for(var m=0;m<o.length;++m)if(l=o[m],n=d[l],n&&n.length>0){var _=this.peerConnections[l];e.info("requesting "+n.length+" chunks from peer "+l+" with window "+_.maxNumOfPendingChunks+" pending "+_.numOfPendingChunks+" for swarm "+t),r(_,s.get(t),n),this.peersPerformanceTracker.reportChunksRequestFromPeer(t,n)}if(u.P2P_DOWNLOADING_MSG&&h>0){var E=e.state.resources.get(t);E.hashUrl&&this.sendToAll(new i.DownloadingMessage(t,E.hashUrl),"Downloading")}return h},sendToAll:function(e,t){for(var n in this.peerConnections){var r=this.peerConnections[n];if(r&&r.ready){var i={};i["p2p"+t+"MessagesSent"]=1,a.sumGlobal(i),r.queue(e)}}},ensurePeerConnectionInitialized:function(t,n){if(!(this.peersBlacklist[t]||this.peerConnections[t]||this.initPeerConnections[t]||Object.keys(this.peerConnections).length>=u.MAX_CONNECTIONS||"chrome"===e.browserName&&u.MAX_PC_CREATE&&this.numberOfPCCreated>=u.MAX_PC_CREATE)){if("firefox"===e.browserName&&e.browserVersion<43&&c.length<=0)return void this.allocateMorePC();n||(this.attemptedConnections[t]=this.attemptedConnections[t]+1||1),this.initPeerConnections[t]=this.peer.connect(t,n,c.shift()),this.increaseCreatedPCCount(),c.length<u.PC_POOL_LOW&&this.allocateMorePC(),n&&this.initPeerConnections[t].setupCall()}},increaseCreatedPCCount:function(){this.numberOfPCCreated++,"chrome"===e.browserName&&u.MAX_PC_CREATE&&radio("availablePeerConnectionsNumberChanged").broadcast(u.MAX_PC_CREATE-this.numberOfPCCreated)},sendData:function(t,n,r,o,u){if(this.canUpload(t)){var c=r[o];o++;var l=this;if(s.has(t)){var d=s.get(t);d.getChunk(c,function(s,d){return s&&d?(u+=d.length,a.sumGlobal({p2pDataMessagesSent:1}),l.peerConnections[n].queue(new i.DataMessage(t,c,d)),void(o<r.length?l.sendData(t,n,r,o,u):(l.peersPerformanceTracker.reportUploadToPeer(n,u),radio("chunkSent").broadcast(t,u)))):void e.warn("cannot send data, getChunk failed for swarm: "+t+", chunkId: "+c)})}}},sendAllHavesTo:function(e){var t,n,r=[],i=this;s.forEach(function(e,a){var o=a.metadata;o&&i.resourceState[o.swarmId]&&(t=o.swarmId,n=i.createHaveMessage(t),n&&r.push(n))});var o=u.CHUNK_SIZE/76;o=Math.floor(.9*o);for(var c=0,l=r.length;c<l;c+=o)a.sumGlobal({p2pHaveMessagesSent:1}),e.queue(r.slice(c,c+o))},sendVersionTo:function(e){e.queue(new i.VersionMessage(t,u.VERSION))},receiveHaveMessage:function(t,n){var r=t.swarmId,i=t.hashUrl,a=t.filesize;if(a>0&&!u.USE_HEAD){e.core.util.HashUrlLengthMap.addMapping(i,a);var o=e.state.resources.get(i);o&&!o.length&&(e.info("length "+a+" received for swarm: "+r+" hashUrl: "+i+" from peer: "+n),radio("responseLengthReceived"+o.url).broadcast(a))}this.receiveDownloadingMessage(t,n);var c=this.remoteAvailabilityMaps[r];if(!c)return this.remoteHave[r]=this.remoteHave[r]||{},void(this.remoteHave[r][n]=t);if(!c[n]){if(e.info("got a have message from a peer with a non initialized availabilityMap"),!s.has(r))return;var l=s.get(r);c[n]=new e.core.dataStructures.AvailabilityMap(l.getNumOfBlocks())}t.availabilityMap?c[n].deserializeAndCopy(t.availabilityMap):t.seeder?c[n].setSeeder():c[n].deserializeAndUpdate(t.blockIds),this.peerSwarms[n]||(this.peerSwarms[n]=Object.create(null)),this.peerSwarms[n][r]=!0},receiveDontHaveMessage:function(e,t){var n=e.swarmId,r=e.hashUrl;!this.remoteAvailabilityMaps[n]&&this.remoteHave[n]&&this.remoteHave[n][t]&&delete this.remoteHave[n][t],this.remoteAvailabilityMaps[n]&&this.remoteAvailabilityMaps[n][t]&&delete this.remoteAvailabilityMaps[n][t],this.remoteDownloading[n]&&delete this.remoteDownloading[n][t],this.remoteDownloading[r]&&delete this.remoteDownloading[r][t]},loadCachedHaveRequests:function(e){if(void 0!==this.remoteHave[e]){var t=Object.keys(this.remoteHave[e]),n=this;t.forEach(function(t){n.receiveHaveMessage(n.remoteHave[e][t],t)})}},createHaveMessage:function(t){if(s.has(t)&&!n()){var r,a=s.get(t),o=e.state.resources.get(t),u=o?o.hashUrl:null;return r=a.isFull()?new i.HaveMessage(t,!0,null,u,a.fileSize):new i.HaveMessage(t,!1,a.getSerializedMap(),u,a.fileSize)}},createDontHaveMessage:function(t){var n=e.state.resources.get(t),r=n?n.hashUrl:null,a=new i.DontHaveMessage(t,r);return a},closeDeadConnections:function(t){var n=(Date.now()-t.peerData.lastHaveReportTimestamp)/1e3,r=this.peerConnections[t.peerId];return!!(n>u.SECONDS_SINCE_LAST_HAVE&&r&&r.initiator)&&(e.info("closing dead connection "+t.peerId),this.closeConnection(r,u.FEATURE_CLOSE_DEAD_CONNECTIONS_PERMANENTLY),r.forceClosed=!0,!0)},closeOverlappingConnections:function(t){var n=this.peerConnections[t.peerId];t.peerData.lastSwarmReportedAsHave===this.lastSwarmDownloaded.swarmId&&n&&n.initiator&&(e.info("closing overlapping connection "+t.peerId),this.closeConnection(n,u.FEATURE_CLOSE_OVERLAPPING_CONNECTIONS_PERMANENTLY),n.forceClosed=!0)},closeConnection:function(t,n,r){var i=t&&t.targetId;return e.info("closing connection with "+i),t&&(this.peerConnections[i]||this.initPeerConnections[i]||this.deletedPeerConnections[i])===t?(this.closePC(t),this.deletePeerConnection(t),void(n&&(this.peersBlacklist[i]=!0))):void e.error("could not close corrupted peer connection to "+i)},deletePeerConnection:function(e){var t=e.targetId;this.deletedPeerConnections[t]=e,delete this.peerConnections[t],delete this.initPeerConnections[t];var n=Object.keys(this.peerConnections).length;n<=u.MIN_CONNECTIONS&&(this.lookingForPeers=!0),radio("activePeerConnectionsNumberChanged").broadcast(n),this.peersPerformanceTracker.reportPeerDisconnected(t)},canUpload:function(){return!0},allocateMorePC:function(){this._peerConnectionsToCreate>0||(this._peerConnectionsToCreate=u.PC_POOL_SIZE,this._createPoolConnections())},_createPoolConnections:function(){if(this._peerConnectionsToCreate>0){var e=this;setTimeout(function(){e._createPoolConnection()},u.PC_POOL_REGEN_INTERVAL)}},_createPoolConnection:function(){u.PC_MOCK?c.push({}):c.push(e.core.transport.PeerConnectionImpl.createPeerConnection()),this._peerConnectionsToCreate--,this._createPoolConnections()},initClosePCQueue:function(){this.pcCloseQueue=e.core.util.taskQueue();var t=0;this.pcCloseQueue.canrun=function(){var e=Date.now()-t,n=u.PC_CLOSE_TIMEOUT-e;return n<0||n},this.closePC=function(e){this.pcCloseQueue.push(function(){t=Date.now(),e&&e.close&&e.close()})}},initPCPool:function(){"complete"===document.readyState?(u.PC_MOCK?c.push({}):c.push(e.core.transport.PeerConnectionImpl.createPeerConnection()),this.allocateMorePC()):document.addEventListener("DOMContentLoaded",function(){var t=0,n=setInterval(function(){u.PC_MOCK?c.push({}):c.push(e.core.transport.PeerConnectionImpl.createPeerConnection()),t++,(t>u.PC_POOL_SIZE||l)&&clearInterval(n)},u.PC_POOL_INIT_INTERVAL)})}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.data.CacheManager=Object.subClass({ctor:function(){this.mb=1048576},getRandomArbitrary:function(e,t){return Math.floor(Math.random()*(t-e)+e)},testFillLibrary:function(e,t,n){this.fillLibraryWithMultipleFiles(0,e,t,n,function(e){console.log("wrote all test files")})},fillLibraryWithMultipleFiles:function(t,n,r,i,a){var o=this,s=this.getRandomArbitrary(r,i);if(console.log(s),t==n)a(!0);else{var u=Date.now();e.core.data.FSio.createResource(u,function(c){console.log("started to write file with id "+u),e.core.data.FSio.write(u,new Uint8Array([]),s,function(e,c){e?(console.log("wrote file with id "+u),o.fillLibraryWithMultipleFiles(t+1,n,r,i,a)):"space"===c&&o.handleOutOfSpace(u,s,function(){console.log("handleOutOfSpace")})})},!0)}},performHandleOuOfSpaceMainFunction:function(t,n,r,i,a,o,s){var u=t;e.core.data.FSio.getLibraryStatistics(function(t){a=t;var c=u.getFileSizeFromArray(n,a.filesStats),l=u.sumFilesSizeExcludingCurrent(n,a.filesStats),d=0,h=[],f=0;if(r>(c+l+s)/o)u.failedToCleanUpOutOfSpace(n,a,i);else{for(u.sortArrayOfFilesObjectByLastModified(a.filesStats);(d<o*r-c-s||d<(l-c-s)/2+r)&&f<a.filesStats.length;)if(a.filesStats[f].key.toString().indexOf(".fi")==-1)if(n!=a.filesStats[f].key&&u.isSafeToDeleteFile(a.filesStats[f])){h.push(a.filesStats[f]);var p=u.findCorrespondingFileInfo(a.filesStats,a.filesStats[f].key+".fi");p&&h.push(p),d+=a.filesStats[f].size,f++}else f++;else f++;d>=o*r-c-s?e.core.data.FSio.deleteFiles(h,e.core.data.FSio,function(t){t?i&&i(!0):(e.error("deleteFiles failed for an unknown reason"),i&&i(!1))}):u.failedToCleanUpOutOfSpace(n,a,i)}})},handleOutOfSpace:function(t,n,r){var i,a,o=this,s=0;e.config.IS_FIREFOX?(a=2,s=0,o.performHandleOuOfSpaceMainFunction(o,t,n,r,i,a,s)):(a=1,e.core.data.FSio.getUnUsedQuotaSpace(function(e){s=e,o.performHandleOuOfSpaceMainFunction(o,t,n,r,i,a,s)}))},test:function(){var t,n=this;e.core.data.FSio.getLibraryStatistics(function(e){t=e,n.standardCleanUp(t,function(e){console.log(e)})})},standardCleanUp:function(t,n){var r=0,i=[],a=0;for(this.sortArrayOfFilesObjectByLastModified(t.filesStats);r<t.size/2&&a<t.filesStats.length;)if(t.filesStats[a].key.toString().indexOf(".fi")==-1)if(this.isSafeToDeleteFile(t.filesStats[a])){i.push(t.filesStats[a]);var o=this.findCorrespondingFileInfo(t.filesStats,t.filesStats[a].key+".fi");o&&i.push(o),r+=t.filesStats[a].size,a++}else a++;else a++;e.core.data.FSio.deleteFiles(i,e.core.data.FSio,function(e){e?n&&n(!0):n&&n(!1)})},testCleanOldFiles:function(){this.cleanOldFiles(function(e){console.log(e)})},isSafeToDeleteFile:function(t){var n=0;return n=Date.now()-t.lastModified.getTime(),!(n<e.config.TIME_PERIOD_FILE_STILL_LIVE)},cleanOldFiles:function(t){var n=this;e.core.data.FSio.getLibraryStatistics(function(r){var i=r,a=0,o=[],s=0;n.sortArrayOfFilesObjectByLastModified(i.filesStats);for(var u in i.filesStats)if(s=Date.now()-i.filesStats[u].lastModified.getTime(),s>e.config.PERIODIC_CACHE_CLEANUP_PERIOD){o.push(i.filesStats[u]);var c=n.findCorrespondingFileInfo(i.filesStats,i.filesStats[u].key+".fi");c&&o.push(c),a+=i.filesStats[u].size}e.core.data.FSio.deleteFiles(o,e.core.data.FSio,function(e){e?t&&t(!0):t&&t(!1)})})},convertMiliToDays:function(e){return Math.floor(e/864e5)},findCorrespondingFileInfo:function(e,t){var n;for(var r in e)e[r].key==t&&(n=e[r]);return n},spliceFileObjectFromArray:function(e,t){for(var n in e)e[n].key==t&&e.splice(n,1)},sortArrayOfFilesObjectByLastModified:function(e){return e.sort(function(e,t){var n=new Date(e.lastModified),r=new Date(t.lastModified);return n<r?-1:n>r?1:0}),e},getFileSizeFromArray:function(e,t){var n=0;for(var r in t)if(t[r].key==e){n=t[r].size;break}return n},sumFilesSizeExcludingCurrent:function(e,t){for(var n=0,r=0;r<t.length;r++)t[r].key!=e&&this.isSafeToDeleteFile(t[r])&&(n+=t[r].size);return n},failedToCleanUpOutOfSpace:function(t,n,r){var i=this,a=[],o=this.findCorrespondingFileInfo(n.filesStats,t),s=this.findCorrespondingFileInfo(n.filesStats,t+".fi");o&&a.push(o),s&&a.push(s),o&&(n.size-=o.size),s&&(n.size-=s.size),this.spliceFileObjectFromArray(n.filesStats,t),this.spliceFileObjectFromArray(n.filesStats,t+".fi"),e.core.data.FSio.deleteFiles(a,e.core.data.FSio,function(t){e.warn("handleOutOfSpace can not clean enough space for the wanted download "),i.standardCleanUp(n,function(e){r(!1)})})}}),e.core.data.CacheManager=new e.core.data.CacheManager}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(17);!function(){e.core.data.FSio=Object.subClass({ctor:function(){this.writeQueue=new t,this.registerEvents(),this.pendingObjectUrlCb={},this.finishWriteCbs=[],this.currentlyWriting=!1},executeOnReady:function(e){},createResource:function(t,n,r){t=t.replace("peer5://",""),e.info("Adding resource "+t+" to the filesystem.");var i=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{create:!0},function(e){n&&n(!0)},function(e){i.errorHandler(e,n)})},removeResource:function(t,n){t=t.replace("peer5://","");var r=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{create:!1},function(e){e.remove(function(){n&&n(!0)},function(e){r.errorHandler(e,n)})},function(e){r.errorHandler(e,n)})},renameResource:function(t,n,r){t=t.replace("peer5://",""),n=n.replace("peer5://",""),e.info("changing resource name from "+t+" to "+n);var i=this;this.fs.root.getDirectory(e.config.FS_ROOT_DIR,{create:!1},function(a){a.getFile(t,{create:!1},function(t){t.moveTo(a,n,function(t){t&&e.info("succesfully renamed"),r&&r(!0)},function(e){i.errorHandler(e,r)})},function(e){i.errorHandler(e,r)})},function(e){i.errorHandler(e,r)})},write:function(e,t,n,r){e=e.replace("peer5://",""),t=new Blob([t]),this._writeAvailable()?(this._addWriteCommand(e,t,n,r),this._write(e,t,n,r)):this.currentlyWriting?this._addWriteCommand(e,t,n,r):this.continueWriting()},continueWriting:function(){var e=this.writeQueue.peek();this._write(e.resourceId,e.data,e.position,e.cb)},read:function(t,n,r,i){t=t.replace("peer5://","");var a=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{},function(e){e.file(function(e){var t=new FileReader;t.onloadend=function(e){e.target.readyState!=FileReader.DONE||e.target.error||i&&i(!0,new Uint8Array(e.target.result))},t.onerror=function(e){a.errorHandler(e,i)};var o=e.slice(n,r);t.readAsArrayBuffer(o)},function(e){a.errorHandler(e,i)})},function(e){a.errorHandler(e,i)})},getBlob:function(t,n,r,i){t=t.replace("peer5://","");var a=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{},function(e){e.file(function(e){var t=e.slice(n,r);i(!0,t)},function(e){a.errorHandler(e,i)})},function(e){a.errorHandler(e,i)})},getArrayBuffer:function(t,n,r,i){t=t.replace("peer5://","");var a=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{},function(t){t.file(function(t){var a,o=new FileReader;o.onloadend=function(t){t.target.readyState==FileReader.DONE?i(!0,t.target.result):e.error("getArrayBuffer::onloadend returned with error: "+o.readyState)},a=t.slice(n,r),o.readAsArrayBuffer(a)},function(e){a.errorHandler(e,i)})},function(e){a.errorHandler(e,i)})},getResourceDetails:function(t,n){t=t.replace("peer5://","");var r=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{},function(e){e.file(function(e){n(!0,{size:e.size})},function(e){r.errorHandler(e,n)})},function(e){r.errorHandler(e,n)})},createObjectURL:function(t,n){t=t.replace("peer5://","");var r=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{},function(e){n&&n(!0,e.toURL())},function(e){r.errorHandler(e,n)})},notifyFinishWrite:function(e){this.writeQueue.getLength()<=0?e():this.finishWriteCbs.push(e)},isExist:function(t,n){t=t.replace("peer5://","");var r=this;this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{create:!1},function(e){n&&n(!0)},function(e){r.errorHandler(e,n)})},getFileInfo:function(t,n){this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{create:!1},function(e){e.file(function(e){console.log(e)})})},listFiles:function(e){var t=this,n=this.fs.root.createReader();n.readEntries(function(t){e(!0,t)},function(n){t.errorHandler(n,e)})},removeAll:function(t){e.warn("removing all files in filesystem");var n=this,r=this.fs.root.createReader();r.readEntries(function(e){for(var r,i=0;r=e[i];++i)r.isDirectory?r.removeRecursively(function(){t&&t(!0)},function(e){n.errorHandler(e,t)}):r.remove(function(){t&&t(!0)},function(e){n.errorHandler(e,t)})},function(e){n.errorHandler(e,t)})},removeRootDir:function(t){e.warn("removing all files in filesystem under "+e.config.FS_ROOT_DIR);var n=this,r=this.fs.root.createReader();r.readEntries(function(r){for(var i,a=0;i=r[a];++a)i.isDirectory&&i.name+"/"==e.config.FS_ROOT_DIR&&i.removeRecursively(function(){n.fs.root.getDirectory(e.config.FS_ROOT_DIR,{create:!0},function(e){t(!0)},function(e){n.errorHandler(e,t)})},function(e){n.errorHandler(e,t)})},function(e){n.errorHandler(e,t)})},getLibraryStatistics:function(t){var n=this,r=[],i=[];this.fs&&this.fs.root.getDirectory(e.config.FS_ROOT_DIR,{},function(e){var a=e.createReader();a.readEntries(function(e){for(var a=0;a<e.length;a++)r.push(e[a]),i.push(e[a].name);n.getStatsOfFileArray(0,{size:0,filesStats:[]},r,i,function(e){t&&t(e)})})},function(e){n.errorHandler(e,t)})},printDirectory:function(){this.fs&&this.fs.root.getDirectory(e.config.FS_ROOT_DIR,{},function(e){var t=e.createReader();t.readEntries(function(e){for(var t=0;t<e.length;t++)console.log(e[t].name)})},function(e){console.log(e)})},getStatsOfFileArray:function(e,t,n,r,i){var a=this;if(e==n.length)i&&i(t);else{var o=n[e];o.file(function(s){var u=s.size;t.size+=u,t.filesStats.push({key:s.name,size:u,lastModified:s.lastModifiedDate,fileInstance:o}),a.getStatsOfFileArray(e+1,t,n,r,i)})}},deleteFiles:function(e,t,n){var r=t,i=[];for(var a in e)i.push(e[a]);r.deleteMultipleFiles(0,i,t,n)},deleteMultipleFiles:function(e,t,n,r){if(e==t.length)r&&r(!0);else{var i=t[e],a=n;i.fileInstance.remove(function(){n.deleteMultipleFiles(e+1,t,n,r)},function(e){a.errorHandler(e,r)})}},removeAllButThis:function(t,n,r){t=t.replace("peer5://",""),n=n.replace("peer5://",""),e.info("removing all files in filesystem under "+e.config.FS_ROOT_DIR+" besides "+t+","+n);var i=this;this.fs.root.getDirectory(e.config.FS_ROOT_DIR,{},function(e){var a=e.createReader();a.readEntries(function(e){for(var a,o=e.length,s=0;a=e[s];++s)a.name!=t&&a.name!=n?a.isDirectory?a.removeRecursively(function(){o--,0===o&&r(!0)},function(e){i.errorHandler(e,r)}):a.remove(function(){o--,0===o&&r(!0)},function(e){i.errorHandler(e,r)}):o--})},function(e){i.errorHandler(e,r)});var i=this,a=this.fs.root.createReader();a.readEntries(function(t){for(var n,a=0;n=t[a];++a)n.isDirectory&&n.name+"/"==e.config.FS_ROOT_DIR&&n.removeRecursively(function(){i.fs.root.getDirectory(e.config.FS_ROOT_DIR,{create:!0},function(e){r(!0)},function(e){i.errorHandler(e,r)})},function(e){i.errorHandler(e,r)})},function(e){i.errorHandler(e,r)})},getTypeOfFS:function(){if(this.fs){if(this.fs.name.indexOf("Pers")>-1)return"PERS";if(this.fs.name.indexOf("Temp")>-1)return"TEMP"}return null},getUnUsedQuotaSpace:function(e){"PERS"==this.getTypeOfFS()&&navigator.webkitPersistentStorage.queryUsageAndQuota(function(t,n){e&&e(n-t)},function(t){e&&e(0)}),"TEMP"==this.getTypeOfFS()&&navigator.webkitTemporaryStorage.queryUsageAndQuota(function(t,n){e&&e(n-t)},function(t){e&&e(0)})},requestTempQuota:function(t,n){if(!t)var t=16106127360;if(!n)var n=function(){};e.info("requesting quota size = "+t);var r=this,i=1.1*t;window.webkitRequestFileSystem(window.TEMPORARY,i,function(e){r.onInitFs(e),r.queryTempQuota(function(e,t,r){n(!0,r-t)})},function(e){r.errorHandler(e,n)})},testRequestPersQuota:function(e){if(!e)var e=16106127360;navigator.webkitPersistentStorage.requestQuota(e,function(e){console.log("requestQuota and got: "+e)},function(e){console.log("requestQuota Error "+e)})},testRequestTempQuota:function(e){if(!e)var e=32212254720;navigator.webkitTemporaryStorage.requestQuota(e,function(e){console.log("requestQuota and got: "+e)},function(e){console.log("requestQuota Error "+e)})},testPersQueryUsageAndQuota:function(){navigator.webkitPersistentStorage.queryUsageAndQuota(function(e,t){console.log("Used quota: "+e+", total quota: "+t)},function(e){console.log("Error",e)})},testTempQueryUsageAndQuota:function(){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(e,t){console.log("Used quota: "+e+", total quota: "+t)},function(e){console.log("Error",e)})},requestPersQuota:function(t,n){if(!t)var t=16106127360;if(!n)var n=function(){};e.info("requesting perma quota size = "+t);var r=this,i=t,a=!1;radio("requestedPersQuota").broadcast(),navigator.webkitPersistentStorage.requestQuota(i,function(e){if(!a){if(a=!0,0===e)return radio("persQuotaAnswer").broadcast(!1),void(n&&n(!1));window.webkitRequestFileSystem(window.PERSISTENT,e,function(e){radio("persQuotaAnswer").broadcast(!0),r.onInitFs(e),r.queryPersQuota(function(e,t,r){n(!0,r-t)})},function(e){r.errorHandler(e,n),radio("persQuotaAnswer").broadcast(!1)})}},function(e){r.errorHandler(e,n),radio("persQuotaAnswer").broadcast(!1)}),window.setTimeout(function(){a||(a=!0,n(!1),radio("persQuotaTimeout").broadcast())},e.config.PROMPT_TIMEOUT)},queryTempQuota:function(t){navigator.webkitTemporaryStorage.queryUsageAndQuota(function(n,r){e.info("Using: "+n/r*100+"% of temporary storage"),t&&t(!0,n,r)},function(n){e.error("queryTempQuota failed to query webkitTemporaryStorage",n),t&&t(!1)})},queryPersQuota:function(t){navigator.webkitPersistentStorage.queryUsageAndQuota(function(n,r){e.info("Using: "+n/r*100+"% of persistent storage"),t&&t(!0,n,r)},function(n){e.error("queryTempQuota failed to query webkitTemporaryStorage",n),t&&t(!1)})},_writeAvailable:function(){return this.writeQueue.isEmpty()},_write:function(t,n,r,i){t=t.replace("peer5://","");var a=this;a.currentlyWriting=!0,this.fs.root.getFile(e.config.FS_ROOT_DIR+t,{create:!1},function(e){e.createWriter(function(e){r>e.length?(e.onwriteend=function(o){return a.currentlyWriting=!1,o.target.error?(a.errorHandler(e.error,i),void a.writeQueue.dequeue()):void a._write(t,n,r,i)},e.truncate(r)):(e.onwriteend=function(e){if(a.currentlyWriting=!1,e.currentTarget.error)return void a.errorHandler(e.currentTarget.error,i);if(a.writeQueue.dequeue(),a.writeQueue.isEmpty()){i&&setTimeout(function(){i(!0)},0),a.pendingObjectUrlCb[t]&&(a.createObjectURL(t,a.pendingObjectUrlCb[t]),delete a.pendingObjectUrlCb[t]);for(var n=0;n<a.finishWriteCbs.length;++n)a.finishWriteCbs[n](t);a.finishWriteCbs=[]}else{i&&setTimeout(function(){i(!0)},0);var r=a.writeQueue.peek();a._write(r.resourceId,r.data,r.position,r.cb)}},e.onerror=function(e){a.currentlyWriting=!1,a.errorHandler(e.currentTarget.error,i)},e.seek(r),e.write(n))},function(e){a.currentlyWriting=!1,a.errorHandler(e,i)})},function(e){a.currentlyWriting=!1,a.errorHandler(e,i)})},_addWriteCommand:function(e,t,n,r){e=e.replace("peer5://","");var i={resourceId:e,data:t,position:n,cb:r};this.writeQueue.enqueue(i)},testQuota:function(){window.webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.TEMPORARY,function(e,t){console.log("Used quota: "+e+", remaining quota: "+t)},function(e){console.log("Error",e)})},registerEvents:function(){var t=this;this.onInitFs=function(n){t.fs=n,n.root.getDirectory(e.config.FS_ROOT_DIR,{create:!0},function(t){e.info("initiated filesystem")},function(n){t.errorHandler(n),e.warn("failed to create peer5 directory")})},this.errorHandler=function(t,n){var r="";switch(t.name){case"QuotaExceededError":r="QuotaExceededError",n&&n(!1,"space");break;case"NotFoundError":r="NotFoundError",n&&n(!1);break;case"SecurityError":r="SecurityError",n&&n(!1);break;case"InvalidModificationError":r="InvalidModificationError",n&&n(!1);break;case"InvalidStateError":r="InvalidStateError",n&&n(!1);break;default:r="Unknown Error",n&&n(!1)}radio("offlineStorageError").broadcast(r),e.warn("File system error: "+r)}}}),e.core.data.FSio=new e.core.data.FSio}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(17);!function(){e.core.data.FSioFireFox=Object.subClass({ctor:function(n){this.writeQueue=new t,this.executeOnInit=[],this.registerEvents(),this.pendingObjectUrlCb={},this.finishWriteCbs=[],this.db,this.filesObjectStore="files",this.filesMetaData={},this.flushSize=67108864,this.currentlyWriting=!1;var r=this;this.createTempDB(function(t){t?(r.createMainDB(function(t){t?e.info("mainDB created successfuly"):e.warn("mainDB creation had error"),n(t)}),e.info("tmpDB created successfuly")):e.warn("tmpDB creation had error")})},createTempDB:function(t){var n=this,r=window.indexedDB.open(e.config.FS_ROOT_DIR,{version:4,storage:"temporary"});r.onerror=function(e){n.errorHandler(e),console.log(e),t&&t(!1)},r.onupgradeneeded=function(e){e.target.result.createObjectStore(n.filesObjectStore)},r.onsuccess=function(e){n.tempStorageDB=e.target.result,t&&t(!0)}},actualCreationOfmainDB:function(t){var n=this,r=window.indexedDB.open(e.config.FS_ROOT_DIR,{version:4,storage:"persistent"});r.onerror=function(e){n.errorHandler(e),console.log(e),t&&t(!1)},r.onupgradeneeded=function(e){e.target.result.createObjectStore(n.filesObjectStore)},r.onsuccess=function(r){n.db=r.target.result;for(var i=0;i<n.executeOnInit.length;i++)e.core.util.envokeCallback(n.executeOnInit[i].function,n.executeOnInit[i].args,n.executeOnInit[i].context);t&&t(!0)}},createMainDB:function(e,t){var n=this;t?n.actualCreationOfmainDB(e):n.isExist("confirmed_persistent",function(t){t?n.actualCreationOfmainDB(e):e&&e(!0)},n.tempStorageDB)},executeOnReady:function(e){this.executeOnInit.push(e)},createResource:function(t,n,r){var i=this;r||(r=i.db),e.info("Adding resource "+t+" to the indexedDB.");var i=this,a=r.mozCreateFileHandle(t);a.onsuccess=function(e){var a=this.result,o=r.transaction([i.filesObjectStore],"readwrite").objectStore(i.filesObjectStore),s=o.put(a,t);s.onsuccess=function(e){i.filesMetaData[t]={fileLength:0,appendedSinceLastFlush:0},n&&n(!0)},s.onerror=function(e){i.errorHandler(e),n&&n(!1)}},a.onerror=function(e){i.errorHandler(e),n&&n(!1)}},removeResource:function(e,t){var n=this,r=n.db.transaction([n.filesObjectStore],"readwrite").objectStore(n.filesObjectStore),i=r.delete(e);i.onsuccess=function(r){delete n.filesMetaData[e],t&&t(!0)},i.onerror=function(e){n.errorHandler(e),t&&t(!1)}},renameResource:function(t,n,r){e.info("changing resource name from "+t+" to "+n);var i=this,a=i.db.transaction([i.filesObjectStore],"readwrite").objectStore(i.filesObjectStore),o=a.get(t);o.onsuccess=function(s){if(!s.target.result)return i.errorHandler({code:"record was not found for key"+t}),void(r&&r(!1));var u=o.result,c=a.put(u,n);i.filesMetaData[n]=i.filesMetaData[t],c.onsuccess=function(n){var a=i.db.transaction([i.filesObjectStore],"readwrite").objectStore(i.filesObjectStore),o=a.delete(t);o.onsuccess=function(n){delete i.filesMetaData[t],e.info("succesfully renamed"),r&&r(!0)},o.onerror=function(e){i.errorHandler(e),r&&r(!1)}},c.onerror=function(e){i.errorHandler(e),r&&r(!1)}},o.onerror=function(e){i.errorHandler(e),r&&r(!1)}},write:function(t,n,r,i){n||e.error("Writing to resource "+t+" with no data: "+n),this._writeAvailable()?(this._addWriteCommand(t,n,r,i),this._write(t,n,r,i)):this.currentlyWriting?this._addWriteCommand(t,n,r,i):this.continueWriting()},continueWriting:function(){var e=this.writeQueue.peek();this._write(e.resourceId,e.data,e.position,e.cb)},read:function(e,t,n,r){var i=this,a=i.db.transaction(["files"]),o=a.objectStore("files"),s=o.get(e);s.onsuccess=function(a){if(!a.target.result)return i.errorHandler({code:"record was not found for key"+e}),void(r&&r(!1));var o=s.result,u=o.open("readwrite");u.location=t;var c=u.readAsArrayBuffer(n-t);c.onsuccess=function(e){r&&r(!0,new Uint8Array(e.target.result))},c.onerror=function(e){i.errorHandler(e),r&&r(!1)}},s.onerror=function(e){i.errorHandler(e),r&&r(!1)}},getBlob:function(e,t,n,r){},
getResourceDetails:function(e,t){var n=this,r=n.db.transaction([n.filesObjectStore],"readwrite").objectStore(n.filesObjectStore),i=r.get(e);i.onsuccess=function(r){if(!r.target.result)return n.errorHandler({code:"record was not found for key"+e}),void(t&&t(!1));var a=i.result,o=a.open("readwrite"),s=o.getMetadata();s.onsuccess=function(e){t(!0,{size:e.target.result.size})},s.onerror=function(e){n.errorHandler(e),t&&t(!1)}},i.onerror=function(e){n.errorHandler(e),t&&t(!1)}},createObjectURL:function(e,t){var n=this,r=n.db.transaction([n.filesObjectStore],"readwrite").objectStore(n.filesObjectStore),i=r.get(e);i.onsuccess=function(r){if(!r.target.result)return n.errorHandler({code:"record was not found for key"+e}),void(t&&t(!1));var a=i.result,o=a.open("readwrite");n.checkAndFlush(o,n,e,function(e){var r=(o.name,a.getFile());r.onsuccess=function(e){var n=e.target.result;!window.URL&&window.webkitURL&&(window.URL=window.webkitURL),t&&t(!0,URL.createObjectURL(n))},r.onerror=function(e){n.errorHandler(e),t&&t(!1)}},!0)},i.onerror=function(e){n.errorHandler(e),t&&t(!1)}},notifyFinishWrite:function(e){this.writeQueue.getLength()<=0?e():this.finishWriteCbs.push(e)},isExistConfirmedPersistent:function(e,t){t(localStorage.confirmedPersistent?!0:!1)},isExist:function(e,t,n){var r=this;n||(n=r.db);try{var i=n.transaction([r.filesObjectStore],"readwrite").objectStore(r.filesObjectStore)}catch(e){console.log(e)}if(!i)return void(t&&t(!1));var a=i.get(e);a.onsuccess=function(n){if(!n.target.result)return void(t&&t(!1));var i=n.target.result,a=i.open("readonly"),o=a.getMetadata();o.onsuccess=function(n){r.filesMetaData[e]={fileLength:n.target.result.size,appendedSinceLastFlush:0},t&&t(!0)},o.onerror=function(e){r.errorHandler(e),t&&t(!1)}},a.onerror=function(e){r.errorHandler(e),t&&t(!1)}},listFiles:function(e){var t=this,n=t.db.transaction([t.filesObjectStore],"readwrite").objectStore(t.filesObjectStore),r=!0;n.openCursor().onsuccess=function(t){var n=[],i=t.target.result;i?(r=!1,n.push(i.key),i.continue()):(e(!0,n),alert("No more entries!"))}},forceRemoveAllDBwhenOutOfSpace:function(t){this.db.close(),window.indexedDB.deleteDatabase(e.config.FS_ROOT_DIR),this.createMainDB(function(e){e?t&&t(!0):t&&t(!1)})},removeAllNew:function(){var e=this,t=e.db.transaction([e.filesObjectStore],"readwrite"),n=t.objectStore(e.filesObjectStore).clear();n.onsuccess=function(e){console.log("Filesystem is empty")},n.onerror=function(e){console.log("removeAll() failed")}},removeDep:function(t){e.warn("removing all files in filesystem");var n=this,r=n.db.transaction([n.filesObjectStore],"readwrite").objectStore(n.filesObjectStore),i=!0;r.openCursor().onsuccess=function(e){var a=e.target.result;if(a){i=!1;var o=r.delete(a.key);o.onsuccess=function(e){n.filesMetaData[a.key]&&delete n.filesMetaData[a.key],a.continue()},o.onerror=function(e){t&&t(!1)}}else t&&t(!0)}},getAllKeys:function(t,n){e.warn("removing all files in filesystem");var r=this,i=r.db.transaction([r.filesObjectStore],"readwrite").objectStore(r.filesObjectStore),a=[],o=[];i.openCursor().onsuccess=function(e){var r=e.target.result;r?"confirmed_persistent"!=r.key||n?(a.push(r.key),o.push(r.value),r.continue()):r.continue():(console.log("get all keys : "+a.length),console.log("get all keys : "+o.length),t&&t(o,a))}},filterEntries:function(e,t,n,r){var i=this;if(e==t.length)r&&r(t,n);else{var a=t[e].open("readwrite"),o=a.getMetadata();o.onsuccess=function(a){var o=a.target.result.lastModified;Date.now()-o.getTime()>24?i.filterEntries(e+1,t,n,r):(t.splice(e,1),n.splice(e,1),i.filterEntries(e,t,n,r))}}},getStatsOfFileArray:function(e,t,n,r,i){var a=this;if(e==n.length)i&&i(t);else{var o=n[e].open("readwrite"),s=o.getMetadata();s.onsuccess=function(o){var s=o.target.result.size,u=o.target.result.lastModified;t.size+=s,t.filesStats.push({key:r[e],size:s,lastModified:u,fileInstance:n[e]}),a.getStatsOfFileArray(e+1,t,n,r,i)}}},printDirectory:function(){var e=this;e.getAllKeys(function(e,t){for(var n=0;n<t.length;n++)console.log(t[n])},!0)},cleanSpaceForFileDuringOutOfSpace:function(e,t){},getLibraryStatistics:function(e){var t=this;t.getAllKeys(function(n,r){t.getStatsOfFileArray(0,{size:0,filesStats:[]},n,r,function(t){e&&e(t)})})},removeOldEntries:function(e){var t=this;t.getAllKeys(function(n,r){console.log("removeOldEntries "+r),console.log("removeOldEntries "+n),t.filterEntries(0,n,r,function(n,r){console.log("truncating"),t.truncateFiles(0,n,t,function(n){n?(console.log("done truncating successfully"),t.deleteMultipleFiles(0,r,t,function(t){t?(e&&e(!0),console.log("done removeOldEntries successfully")):(console.log("done removeOldEntries failure"),e&&e(!1))})):(console.log("done truncating failure"),e&&e(!1))})})})},deleteFiles:function(e,t,n){var r=t,i=[],a=[];for(var o in e)a.push(e[o].key),i.push(e[o].fileInstance);r.truncateFiles(0,i,r,function(e){e?(console.log("done truncating successfully"),r.deleteMultipleFiles(0,a,r,function(e){e?n&&n(!0):(n&&n(!1),console.log("delete failure"))})):(console.log("truncating failure"),n&&n(!1))})},removeAll:function(e){var t=this;t.getAllKeys(function(n,r){console.log("truncating");for(var i=0;i<r.length;i++)if("confirmed_persistent"==r[i]){r.splice(i,1),n.splice(i,1);break}t.truncateFiles(0,n,t,function(n){n?(console.log("done truncating all files successfully"),t.deleteMultipleFiles(0,r,t,function(t){t?(e&&e(!0),console.log("done removeAll successfully")):(console.log("done removeAll failure"),e&&e(!1))})):(console.log("done truncating failure"),e&&e(!1))})})},deleteMultipleFiles:function(t,n,r,i){if(t==n.length)i&&i(!0);else{var a=r.db.transaction([r.filesObjectStore],"readwrite").objectStore(r.filesObjectStore),o=a.delete(n[t]);o.onsuccess=function(){r.deleteMultipleFiles(t+1,n,r,i)},o.onerror=function(t){e.error("delete multiple files error"),i&&i(!1)}}},truncateFiles:function(t,n,r,i){if(t==n.length)i&&i(!0);else{console.log("truncating "+n[t]);var a=n[t],o=a.open("readwrite"),s=o.truncate(0);s.onsuccess=function(){r.truncateFiles(t+1,n,r,i)},s.onerror=function(t){e.error("truncate needed files failure"),i&&i(!1)}}},removeRootDir:function(e){this.removeAll(e)},requestPersQuota:function(t,n,r){var i=this;i.isExist("confirmed_persistent",function(t){return t?void n(!0,e.config.PERSISTENT_FS_SIZE):r<=e.config.ALLOWED_FILE_SIZE?void n(!1,0):void i.createMainDB(function(t){t?i.createResource("confirmed_persistent",function(t){return t?(e.info("mainDB created in requestPersQuota successfuly"),localStorage.confirmedPersistent=!0,radio("persQuotaAnswer").broadcast(!0),void n(!0,e.config.PERSISTENT_FS_SIZE)):(e.warn("mainDB creation in requestPersQuota had error"),void n(!1,0))},i.tempStorageDB):(e.warn("mainDB creation had error"),n(!1,0)),window.setTimeout(function(){localStorage.confirmedPersistent||(radio("persQuotaTimeout").broadcast(),n(!1,0))},e.config.PROMPT_TIMEOUT),n(t)},!0)},i.tempStorageDB)},requestPersQuota1:function(t,n,r){var i=this;i.isExist("confirmed_persistent",function(t){if(t)return void n(!0,e.config.PERSISTENT_FS_SIZE);if(r<=e.config.ALLOWED_FILE_SIZE)return void n(!1,0);radio("requestedPersQuota").broadcast();var a,o=(new Date).getTime()+100,s=window.indexedDB.open(o,1),u=!1;s.onerror=function(e){console.log("Error obtaining quota, retrying..."),n(!1,0)},s.onsuccess=function(e){a=s.result,s.getquota()},s.onupgradeneeded=function(e){e.target.result.createObjectStore(o)},s.getquota=function(){var t=a.transaction(o,"readwrite");t.oncomplete=function(){a.close(),window.indexedDB.deleteDatabase(o),i.createResource("confirmed_persistent",function(t){if(!u){if(u=!0,!t)return void n(!1,0);radio("persQuotaAnswer").broadcast(!0),n(!0,e.config.PERSISTENT_FS_SIZE)}},!0)},t.onerror=function(e){if(!u)return u=!0,radio("persQuotaAnswer").broadcast(!1),a.close(),window.indexedDB.deleteDatabase(o),void n(!1,0)},t.objectStore(o).put(new Blob([new ArrayBuffer(62914560)]),"quota"),window.setTimeout(function(){u||(t.oncomplete=function(){},t.onerror=function(){},radio("persQuotaTimeout").broadcast(),a.close(),window.indexedDB.deleteDatabase(o),n(!1,0))},e.config.PROMPT_TIMEOUT)}})},requestTempQuota:function(t,n){e.warn("requestTempQuota shouldn't be called in firefox")},queryPersQuota1:function(t){this.isExist("confirmed_persistent",function(n){return n?void t(!0,0,e.config.PERSISTENT_FS_SIZE):void t(!1,0,0)})},queryPersQuota:function(t){var n=this;this.isExist("confirmed_persistent",function(n){return n?void t(!0,0,e.config.PERSISTENT_FS_SIZE):void t(!1,0,0)},n.tempStorageDB)},queryTempQuota:function(e){e(!1,0,0)},_writeAvailable:function(){return this.writeQueue.isEmpty()},_write_dep:function(t,n,r,i){var a=this,o=window.indexedDB.open(e.config.FS_ROOT_DIR,3);o.onerror=function(e){a.errorHandler(e),i&&i(!1)},o.onsuccess=function(e){a.db=o.result;var s=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore),u=s.get(t);u.onsuccess=function(e){if(!e.target.result)return a.errorHandler({code:"record was not found for key"+t}),void(i&&i(!1));var o=u.result,s=o.open("readwrite"),c=s.getMetadata();c.onsuccess=function(e){var s=e.target.result.size;if(r>s){var u=new FileReader;u.onload=function(e){var n=e.target.result,u=o.open("readwrite");u.oncomplete=function(){if(a.writeQueue.dequeue(),a.writeQueue.isEmpty()){i&&i(!0),a.pendingObjectUrlCb[t]&&(a.createObjectURL(t,a.pendingObjectUrlCb[t]),delete a.pendingObjectUrlCb[t]);for(var e=0;e<a.finishWriteCbs.length;++e)a.finishWriteCbs[e](t);a.finishWriteCbs=[]}else{i&&i(!0);var n=a.writeQueue.peek();a._write(n.resourceId,n.data,n.position,n.cb)}};for(var c=r-s,l=0,d=new ArrayBuffer(1048576);l<c;)c-l<1048576&&(d=new ArrayBuffer(c-l)),l+=1048576,u.append(d);var h=u.append(n);h.onerror=function(e){a.errorHandler(e),i&&i(!1)}},u.readAsArrayBuffer(n)}else{var u=new FileReader;u.onload=function(e){var n=e.target.result,s=o.open("readwrite");s.location=r;var u=s.write(n);if(u||0!=r||0!=n.byteLength)u.onsuccess=function(){var e=s.flush();e.onsuccess=function(e){if(a.writeQueue.dequeue(),a.writeQueue.isEmpty()){i&&i(!0),a.pendingObjectUrlCb[t]&&(a.createObjectURL(t,a.pendingObjectUrlCb[t]),delete a.pendingObjectUrlCb[t]);for(var n=0;n<a.finishWriteCbs.length;++n)a.finishWriteCbs[n](t);a.finishWriteCbs=[]}else{i&&i(!0);var r=a.writeQueue.peek();a._write(r.resourceId,r.data,r.position,r.cb)}},e.onerror=function(e){a.errorHandler(e),i&&i(!1)}},u.onerror=function(e){a.errorHandler(e),i&&i(!1)};else if(a.writeQueue.dequeue(),i&&i(!0),a.writeQueue.isEmpty()){a.pendingObjectUrlCb[t]&&(a.createObjectURL(t,a.pendingObjectUrlCb[t]),delete a.pendingObjectUrlCb[t]);for(var c=0;c<a.finishWriteCbs.length;++c)a.finishWriteCbs[c](t);a.finishWriteCbs=[]}else{var l=a.writeQueue.peek();a._write(l.resourceId,l.data,l.position,l.cb)}},u.readAsArrayBuffer(n)}},c.onerror=function(e){a.errorHandler(e),i&&i(!1)}},u.onerror=function(e){a.errorHandler(e),i&&i(!1)}}},_write_no_flush:function(t,n,r,i){var a=this,o=window.indexedDB.open(e.config.FS_ROOT_DIR,3);o.onerror=function(e){a.errorHandler(e),i&&i(!1)},o.onsuccess=function(e){a.db=o.result;var s=a.db.transaction([a.filesObjectStore],"readwrite").objectStore(a.filesObjectStore),u=s.get(t);u.onsuccess=function(e){if(!e.target.result)return a.errorHandler({code:"record was not found for key"+t}),void(i&&i(!1));var o=u.result,s=o.open("readwrite"),c=s.getMetadata();c.onsuccess=function(e){var s=e.target.result.size;if(r>s){var u=o.open("readwrite"),c=r-s;a.appendZerosBeforeRealData(u,t,c,n.buffer,!1,i,function(){a.performAfterWriteOperations(t,i)})}else{var u=o.open("readwrite");u.location=r;var l=u.write(n.buffer);if(!l&&0==r&&0==n.buffer.byteLength)return void a.performAfterWriteOperations(t,i);l.onsuccess=function(){a.performAfterWriteOperations(t,i)},l.onerror=function(e){a.currentlyWriting=!1,a.errorHandler(e),i&&i(!1)}}},c.onerror=function(e){a.currentlyWriting=!1,a.errorHandler(e),i&&i(!1)}},u.onerror=function(e){a.currentlyWriting=!1,a.errorHandler(e),i&&i(!1)}}},_write:function(e,t,n,r){var i=this,a=i.db.transaction([i.filesObjectStore],"readwrite").objectStore(i.filesObjectStore),o=a.get(e);i.currentlyWriting=!0,o.onsuccess=function(a){if(!a.target.result)return i.currentlyWriting=!1,i.errorHandler({code:"record was not found for key"+e}),void(r&&r(!1));var s=o.result,u=s.open("readwrite");if(i.filesMetaData[e]){var c=i.filesMetaData[e].fileLength;if(i.filesMetaData[e].fileLength=Math.max(c,n+t.buffer.byteLength),n>c){var u=s.open("readwrite"),l=n-c;i.appendZerosBeforeRealData(u,e,l,t.buffer,!1,r,function(){i.performAfterWriteOperations(e,r)})}else{var u=s.open("readwrite");u.location=n;var d=u.write(t.buffer);if(!d&&0==t.buffer.byteLength)return void i.performAfterWriteOperations(e,r);d.onsuccess=function(){i.filesMetaData[e].appendedSinceLastFlush+=t.buffer.byteLength,i.performAfterWriteOperations(e,r),i.checkAndFlush(u,i,e,function(e){e||console.log("checkAndFlush error")},!1)},d.onerror=function(e){i.errorHandler(e),r&&r(!1)}}}else;},o.onerror=function(e){i.errorHandler(e),r&&r(!1)}},performAfterWriteOperations:function(e,t){var n=this;if(n.writeQueue.dequeue(),n.currentlyWriting=!1,n.writeQueue.isEmpty()){t&&setTimeout(function(){t(!0)},0),n.pendingObjectUrlCb[e]&&(n.createObjectURL(e,n.pendingObjectUrlCb[e]),delete n.pendingObjectUrlCb[e]);for(var r=0;r<n.finishWriteCbs.length;++r)n.finishWriteCbs[r](e);n.finishWriteCbs=[]}else{t&&setTimeout(function(){t(!0)},0);var i=n.writeQueue.peek();n._write(i.resourceId,i.data,i.position,i.cb)}},_addWriteCommand:function(e,t,n,r){var i={resourceId:e,data:t,position:n,cb:r};this.writeQueue.enqueue(i)},appendZerosBeforeRealData:function(e,t,n,r,i,a,o){var s=this;if(i)if(r.byteLength>0){var u=e.append(r);u.onsuccess=function(){s.filesMetaData[t].appendedSinceLastFlush+=r.byteLength,o&&o()},u.onerror=function(){s.currentlyWriting=!1,s.writeQueue.dequeue(),a&&a(!1)}}else o&&o();else if(n>=67108864){var c=e.append(new ArrayBuffer(67108864));c.onsuccess=function(){var i=e.flush();i.onsuccess=function(i){s.appendZerosBeforeRealData(e,t,n-67108864,r,!1,a,o)},i.onerror=function(e){}},c.onerror=function(e){s.currentlyWriting=!1,s.writeQueue.dequeue(),"The operation failed for reasons unrelated to the file storage itself and not covered by any other error code."==e.target.error.message&&"UnknownError"==e.target.error.name||"The current locked file exceeded its quota limitations."==e.target.error.message&&"QuotaExceededError"==e.target.error.name?a&&a(!1,"space"):a&&a(!1)}}else if(n>0){var l=e.append(new ArrayBuffer(n));l.onsuccess=function(){if(s.filesMetaData[t].appendedSinceLastFlush+=n,s.filesMetaData[t].appendedSinceLastFlush>s.flushSize){var i=e.flush();i.onsuccess=function(n){s.appendZerosBeforeRealData(e,t,0,r,!0,a,o)},i.onerror=function(e){}}else s.appendZerosBeforeRealData(e,t,0,r,!0,a,o)},l.onerror=function(e){"The operation failed for reasons unrelated to the file storage itself and not covered by any other error code."==e.target.error.message&&"UnknownError"==e.target.error.name||"The current locked file exceeded its quota limitations."==e.target.error.message&&"QuotaExceededError"==e.target.error.name?(s.currentlyWriting=!1,s.writeQueue.dequeue(),a&&a(!1,"space")):a&&a(!1)}}else s.appendZerosBeforeRealData(e,t,0,r,!0,a,o)},checkAndFlush:function(e,t,n,r,i){if(t.filesMetaData[n].appendedSinceLastFlush>t.flushSize||i){var a=e.flush();a.onsuccess=function(e){t.filesMetaData[n].appendedSinceLastFlush=0,r&&r(!0)},a.onerror=function(e){console.log("flush error in checkAndFlush function")}}else r&&r(!0)},registerEvents:function(){this.errorHandler=function(t){var n="";switch(t.code){default:n=t}radio("offlineStorageError").broadcast(n),e.warn("File system error: "+n)}}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(e){e.AvailabilityMap=Object.subClass({ctor:function(e,t){if(this.seeder=t,this.size=e,this.length=Math.ceil(this.size/8),this.bitArray=new Uint8Array(this.length),t)for(var n=0;n<this.length;n++)this.bitArray[n]=255;this.numOfOnBits=0,this.bitMask=[1,2,4,8,16,32,64,128]},has:function(e){if(this.isFull())return!0;var t=this.getOffsets(e);return this.bitArray[t.index]&this.bitMask[t.bit]},set:function(e){if(!this.has(e)){var t=this.getOffsets(e);return this.bitArray[t.index]=this.bitArray[t.index]|this.bitMask[t.bit],this.numOfOnBits++,!0}return!1},setSeeder:function(e){this.numOfOnBits=this.size},isFull:function(){return this.numOfOnBits==this.size},serialize:function(){return this.bitArray},deserializeAndCopy:function(e){this.bitArray=e;for(var t=0,n=0;n<e.length;++n)if(0!=e[n])for(var r=0;r<this.bitMask.length;++r)this.bitArray[n]&this.bitMask[r]&&t++;this.numOfOnBits=t},deserializeAndUpdate:function(e){for(var t=0;t<e;++t)this.set(e[t]);this.numOfOnBits+=e.length},getOffsets:function(e){var t={};return t.index=Math.floor(e/8),t.bit=e%8,t}})}(e.core.dataStructures)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n=e.core.dataStructures.AvailabilityMap;t.AvailabilityMapFS=n.subClass({ctor:function(e,t,n,r){this._super(e,!1),this.numOfOnFSBits=0,this.resourceId=t,this.metadataFile=t+".fi",this._initiateFromFilesystem(n,r),this.fsBitArray=new Uint8Array(this.length)},setFS:function(t,n){if(!this.has(t)||this.hasFS(t))return void n(!1);var r=this.getOffsets(t),i=new Uint8Array([this.fsBitArray[r.index]|this.bitMask[r.bit]]);this.fsBitArray[r.index]=this.fsBitArray[r.index]|this.bitMask[r.bit],this.numOfOnFSBits++;var a=this;e.core.data.FSio.write(this.metadataFile,i,r.index,function(t,r){return t?void n(!0):(e.warn("couldn't write index to metadata file "+a.metadataFile),"space"===r?a._handleOutOfSpaceError():a._handleWriteError(),void n(error))})},setFSFull:function(t){var n=this;e.core.data.FSio.write(this.metadataFile,this.bitArray,0,function(e){return e?void t(!0):(n._handleWriteError(),void t(!1))})},hasFS:function(e){if(this.isFullFS())return!0;var t=this.getOffsets(e);return this.fsBitArray[t.index]&this.bitMask[t.bit]},isFullFS:function(){return this.numOfOnFSBits===this.size},deserializeAndCopy:function(e){this.fsBitArray=e;for(var t=0,n=0;n<e.length;++n)if(0!=e[n])for(var r=0;r<this.bitMask.length;++r)this.fsBitArray[n]&this.bitMask[r]&&t++;this.numOfOnFSBits=t},removeBlock:function(t,n){if(this.has(t)){var r=this.getOffsets(t),i=this.bitArray[r.index]&~this.bitMask[r.bit],a=this;e.core.data.FSio.write(this.metadataFile,i,r.index,function(t,o){t?(a.bitArray[r.index]=i,n(!0)):(e.warn("couldn't write index to metadata file "+a.metadataFile),"space"===o?a._handleOutOfSpaceError():a._handleWriteError(),n(!1))})}else n(!0)},removeBlocksFrom:function(e,t){if(e>this.size-1)return void t(!0);var n=this;this.removeBlock(e,function(r){return r?void n.removeBlocksFrom(e+1,t):void t(!1)})},reset:function(e){this.removeBlocksFrom(0,e)},renameResource:function(t,n){var r=t+".fi",i=this;e.core.data.FSio.renameResource(this.metadataFile,r,function(e){e&&(i.metadataFile=r),n(e)})},_initiateFromFilesystem:function(t,n){var r=this;e.core.data.FSio.isExist(this.metadataFile,function(i){i?(e.info("metadata file "+r.metadataFile+" exists"),e.core.data.FSio.read(r.metadataFile,0,r.length,function(t,i){t?(r.deserializeAndCopy(i),e.info("finished initiating AvailabilityMap from FS"),n(!0)):(e.warn("error reading metadataFile "+r.metadataFile),n(!1))})):(e.info("metadata file "+r.metadataFile+" doesn't exist, creating a new one"),r.length<t?e.core.data.FSio.createResource(r.metadataFile,function(t){t?e.core.data.FSio.write(r.metadataFile,new Uint8Array([]),r.length-1,function(e,t){e?n(!0):("space"===t?r._handleOutOfSpaceError():r._handleWriteError(),n(!1))}):n(!1)}):(e.warn("not enough space to create metadata file: "+r.metadatFile+", removing root dir"),e.core.data.FSio.removeRootDir(function(){e.core.data.FSio.createResource(r.metadataFile,function(t){t?e.core.data.FSio.write(r.metadataFile,new Uint8Array([]),r.length-1,function(e,t){e?n(!0):("space"===t?radio("handleOutOfSpaceError").broadcast():radio("handleWriteError").broadcast(),n(!1))}):n(!1)})})))})}})}(e.core.dataStructures)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(9);!function(){e.core.Block=Object.subClass({ctor:function(t){this.blockSize=t,this.length=Math.ceil(this.blockSize/e.config.CHUNK_SIZE),this.buffer=null,this.verified=!1,this.hash=null,this.chunkMap=[],this.numOfChunksSet=0,this.numOfChunksPreset=0,this.isBeingDownloadedInHTTP=!1,this.httpDown=0,this.p2pDown=0,this.httpWaste=0,this.p2pWaste=0,this.fsLoad=0},getBlock:function(){return!!this.verified&&(!this.buffer||this.buffer)},setBlock:function(e,t){if(e.length===this.blockSize){if(!this.verified)for(var n=0,r=this.length;n<r;n++)this.setChunkOn(n);return this.buffer=e,this.httpWaste+=this.httpDown,this.p2pWaste+=this.p2pDown,this.httpDown=0,this.p2pDown=0,this.updateStats(t,e.length),!0}return!1},getChunk:function(t){if(this.verified){if(this.buffer){var n=t*e.config.CHUNK_SIZE,r=(1+t)*e.config.CHUNK_SIZE;return this.buffer.subarray(n,r)}return!0}return!1},hasChunk:function(e){return this.chunkMap[e]},hasOrPendingChunk:function(e){return"undefined"!=typeof this.chunkMap[e]},verifySize:function(t,n){return(t.length===e.config.CHUNK_SIZE||this.buffer.length===n)&&!(this.buffer.length<n)},setChunk:function(t,n,r){this.buffer||(this.buffer=new Uint8Array(this.blockSize));var i=new Uint8Array(n),a=t*e.config.CHUNK_SIZE,o=this.verifySize(n,i.length+a);return o?(this.buffer.set(i,a),this.setChunkOn(t),this.updateStats(r,n.length),!0):(e.warn("Tried to set chunk with corrupt data"),this.resetChunk(t),!1)},updateStats:function(e,t){"http"===e?this.httpDown+=t:"p2p"===e?this.p2pDown+=t:"fs"===e&&(this.fsLoad+=t)},presetChunk:function(t){return this.chunkMap||(this.chunkMap=[]),"undefined"!=typeof this.chunkMap[t]?void e.warn("The chunk is already pre/set"):(this.chunkMap[t]=!1,void this.numOfChunksPreset++)},resetChunk:function(t){return this.chunkMap||(this.chunkMap=[]),"undefined"==typeof this.chunkMap[t]?void e.warn("The chunk is not even pre/set"):(this.chunkMap[t]?this.numOfChunksSet--:this.numOfChunksPreset--,void delete this.chunkMap[t])},setChunkOn:function(t){if(this.chunkMap||(this.chunkMap=[]),"undefined"!=typeof this.chunkMap[t]){if(this.chunkMap[t])return void e.info("The chunk is already set");this.numOfChunksPreset--}this.chunkMap[t]=!0,this.numOfChunksSet++},getNumOfChunksSet:function(){return this.numOfChunksSet},isFull:function(){return this.numOfChunksSet===this.length},getNumOfChunksPreset:function(){return this.numOfChunksPreset},getNumOfBytesSet:function(){return this.chunkMap[this.length-1]&&this.blockSize!==e.config.BLOCK_SIZE?(this.numOfChunksSet-1)*e.config.CHUNK_SIZE+(this.blockSize%e.config.CHUNK_SIZE||e.config.CHUNK_SIZE):this.numOfChunksSet*e.config.CHUNK_SIZE},removeBlockData:function(){delete this.buffer},verifyBlock:function(n,r){if(this.verified)return 0;for(var i=0;i<this.length;++i)if(!this.chunkMap[i])return 0;if(null==this.hash)return this.verified=!0,1;if(this.buffer){var a=t.ArrayBuffer.hash(this.buffer.buffer);if(a===this.hash)return this.verified=!0,1;e.error("Hash didn't verify, block has been polluted")}else if(n){var a=t.ArrayBuffer.hash(n.buffer);if(a===this.hash)return this.buffer=n,this.verified=!0,this.updateStats(r,n.length),1;e.error("Hash didn't verify, block has been polluted")}},hashBlock:function(){for(var e=0;e<this.length;++e)if(!this.chunkMap[e])return 0;return this.hash=t.ArrayBuffer.hash(this.buffer.buffer),this.hash}})}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(2),r=n(9);!function(){var i=e.core.dataStructures.PendingBlockMap,a=n(5);e.core.dataStructures.BlockMap=Object.subClass({ctor:function(t,n,i,o){this.init=!1,this.resourceId=n,o?(this.hashAlg=e.CryptoJS.algo.SHA1.create(),this.aprioriHash=o):i&&(this.hashAlg=new r.ArrayBuffer,this.aprioriHash=i),this.metadata=new a.FileInfoMessage(null,t,null,null,e.config.BLOCK_SIZE,null,null,null,null),this.metadata.url=n,this.privateBlockMap=Object.create(null),this.numOfChunksInBlock=e.config.BLOCK_SIZE/e.config.CHUNK_SIZE,this.fileSize=t,this.numOfBlocks=Math.ceil(this.fileSize/e.config.BLOCK_SIZE),this.numOfChunks=Math.ceil(this.fileSize/e.config.CHUNK_SIZE),this.numOfVerifiedBlocks=0,this.firstMissingBlock=0,this.sizeOfLastBlock=t%e.config.BLOCK_SIZE,0==this.sizeOfLastBlock&&(this.sizeOfLastBlock=e.config.BLOCK_SIZE),this.availabilityMap,this.reportedToServer=!1,this.httpProgressBytes=0,this.httpExtraWaste=0,this.fs=!0,this._registerEvents(),e.config.USE_FS&&this.fileSize>e.config.SMALL_FILE_SIZE?(this.lruMap=new e.core.dataStructures.LRU(Math.floor(e.config.CACHE_SIZE/e.config.BLOCK_SIZE),this._lruRemoveCb),this._initiateFileSystem()):(this.fs=!1,this.availabilityMap=new e.core.dataStructures.AvailabilityMap(this.numOfBlocks))},dtor:function(){if(radio("handleOutOfSpaceError").unsubscribe([this._handleOutOfSpaceError,this]),radio("handleWriteError").unsubscribe([this._handleWriteError,this]),!this.isFull()){var e=this._getResourceStats();e.httpWaste+=e.httpDown,e.p2pWaste+=e.p2pDown,e.httpDown=0,e.p2pDown=0,radio("report:full").broadcast(this.resourceId,e)}},getSerializedMap:function(){return this.availabilityMap.serialize()},isFull:function(){return this.numOfBlocks==this.numOfVerifiedBlocks},has:function(e){return this.privateBlockMap[e]&&this.privateBlockMap[e].verified},hasChunk:function(e){var t=this.calcBlockIdChunkOffset(e);if(this.privateBlockMap[t.block])return this.privateBlockMap[t.block].hasChunk(t.chunk)},hasOrPendingChunk:function(e){var t=this.calcBlockIdChunkOffset(e);if(this.privateBlockMap[t.block])return this.privateBlockMap[t.block].hasOrPendingChunk(t.chunk)},getNumOfBlocks:function(){return this.numOfBlocks},getNumOfVerifiedBytes:function(){return this.numOfVerifiedBlocks==this.numOfBlocks?this.fileSize:this.numOfVerifiedBlocks*e.config.BLOCK_SIZE},getNumOfChunksInBlock:function(t){return t==this.numOfBlocks-1?Math.ceil(this.sizeOfLastBlock/e.config.CHUNK_SIZE):this.numOfChunksInBlock},getBlock:function(t,n){if(this.privateBlockMap[t]){var r=this.privateBlockMap[t].getBlock(t);if(this.fs){if(!r)return!1;if(1==r){var i=t*e.config.BLOCK_SIZE,a=this;e.core.data.FSio.read(this.resourceId,i,i+e.config.BLOCK_SIZE,function(e,r){if(e){var i=a.privateBlockMap[t];i.setBlock(r),a.lruMap.set(t,i),a.getBlock(t,n)}})}else this.lruMap.get(t),n(r)}else n(r)}},getChunkIdsOfBlock:function(t){if(t>=this.numOfBlocks)return[];for(var n=t==this.numOfBlocks-1?Math.ceil(this.sizeOfLastBlock/e.config.CHUNK_SIZE):this.numOfChunksInBlock,r=[],i=t*this.numOfChunksInBlock,a=i;a<i+n;++a)r.push(a);return r},getNumOfChunksSetInBlock:function(e){return void 0!==this.privateBlockMap[e]?this.privateBlockMap[e].getNumOfChunksSet():0},getNumOfChunksPresetInBlock:function(e){return this.privateBlockMap[e]?this.privateBlockMap[e].getNumOfChunksPreset():0},getNumOfBytesSetInBlock:function(e){return void 0!==this.privateBlockMap[e]?this.privateBlockMap[e].getNumOfBytesSet():0},getChunk:function(t,n){var r=this,i=this.calcBlockIdChunkOffset(t);if(this.privateBlockMap[i.block]){var a=this.privateBlockMap[i.block].getChunk(i.chunk);if(this.fs){if(!a)return n(!1);if(1==a){var o=i.block*e.config.BLOCK_SIZE;e.core.data.FSio.read(this.resourceId,o,o+e.config.BLOCK_SIZE,function(e,a){if(e){var o=r.privateBlockMap[i.block];o.setBlock(a),r.lruMap.set(i.block,o),r.getChunk(t,n)}})}else this.lruMap.get(i.block),n(!0,a)}else n(!0,a)}},resetChunk:function(e){var t=this.calcBlockIdChunkOffset(e);this.privateBlockMap[t.block]&&(this.privateBlockMap[t.block].resetChunk(t.chunk),i.removeChunk(this.resourceId,e))},presetChunk:function(e){var t=this.calcBlockIdChunkOffset(e);this.privateBlockMap[t.block]||this._createANewBlock(t.block),this.privateBlockMap[t.block].presetChunk(t.chunk),i.addChunk(this.resourceId,e)},setChunk:function(t,n,r){var a=this.calcBlockIdChunkOffset(t);this.privateBlockMap[a.block]||this._createANewBlock(a.block);var o=this.privateBlockMap[a.block].setChunk(a.chunk,n,r);return o?(this.verifyBlock(a.block,r),a.block):(i.removeChunk(this.resourceId,t),void radio("removeResource").broadcast(this.metadata.url,e.Request.FILE_SIZE_ERR,"Wrong filesize was received from the server"))},setWasteChunk:function(e,t){var n=this.calcBlockIdChunkOffset(e);this.privateBlockMap[n.block]||this._createANewBlock(n.block),this.privateBlockMap[n.block].p2pWaste+=t},setBlock:function(t,n,r){this.privateBlockMap[t]||this._createANewBlock(t);var i=this.privateBlockMap[t].setBlock(n,r);i&&(this.httpProgressBytes-=n.length,this.httpProgressBytes<0&&e.error("httpProgressBytes ("+this.httpProgressBytes+") < 0")),this.verifyBlock(t,r)},setResourceAsBeingDownloadedInHttp:function(){for(var e in this.privateBlockMap)this.privateBlockMap[e].isBeingDownloadedInHTTP=!0},unsetResourceAsBeingDownloadedInHttp:function(){for(var e in this.privateBlockMap)this.privateBlockMap[e].isBeingDownloadedInHTTP=!1},setBlockAsBeingDownloadedInHttp:function(e){this.privateBlockMap[e]||this._createANewBlock(e),this.privateBlockMap[e].isBeingDownloadedInHTTP=!0},unsetBlockAsBeingDownloadedInHttp:function(e){this.privateBlockMap[e]||this._createANewBlock(e),this.privateBlockMap[e].isBeingDownloadedInHTTP=!1},isEmpty:function(e){return!this.privateBlockMap[e]||!this.privateBlockMap[e].buffer},getBlockIndex:function(t){return Math.ceil(t/e.config.BLOCK_SIZE)},getMissingBlock:function(e){return e?this.getRandomMissingBlock():this.getFirstMissingBlock()},getFirstMissingBlock:function(){return this.firstMissingBlock},getRandomMissingBlock:function(){for(var e=0;e<1e3;e++){var t=this.numOfBlocks-this.firstMissingBlock,n=this.firstMissingBlock+Math.floor(Math.random()*t);if(!(n in this.privateBlockMap&&this.privateBlockMap[n].verified))return n}return this.firstMissingBlock},verifyBlock:function(t,n){if(this.privateBlockMap[t]){if(1==this.privateBlockMap[t].verifyBlock()){for(this.numOfVerifiedBlocks++;this.has(this.firstMissingBlock);)this.firstMissingBlock++;radio("blockVerified").broadcast(this.metadata.url,t);var r=this.privateBlockMap[t].blockSize;"p2p"===n?radio("blockVerifiedP2P").broadcast(this.resourceId,r):"http"===n&&radio("blockVerifiedHTTP").broadcast(this.resourceId,r),radio("blockReceived").broadcast(this.resourceId,r);var i=this;this.fs?i.getBlock(t,function(n){e.core.data.FSio.write(i.resourceId,n,t*e.config.BLOCK_SIZE,function(n,r){n?(i.lruMap.set(t,i.privateBlockMap[t]),i.availabilityMap.setFS(t,function(t){i.availabilityMap.isFullFS()&&i._verifyResource(function(t){t?(i._onResourceComplete(),radio("transferLoaded").broadcast(i.metadata)):(e.error("file verification failed"),radio("fileVerificationFailed").broadcast(),radio("removeResource").broadcast(i.resourceId,e.Request.VERIFICATION_ERR,"file verification failed"))})})):(e.warn("couldn't write block "+t+" to filesystem"),"space"===r?i._handleOutOfSpaceError():i._handleWriteError())})}):this.isFull()&&this._verifyResource(function(t){t?(i._onResourceComplete(),radio("transferLoaded").broadcast(i.metadata)):(e.error("file verification failed"),radio("fileVerificationFailed").broadcast(),radio("removeResource").broadcast(i.resourceId,e.Request.VERIFICATION_ERR,"file verification failed"))})}if(this.privateBlockMap[t].verified)return this.availabilityMap.set(t),!0}return!1},ingestBlock:function(e){return!(!this.privateBlockMap[e]||!this.privateBlockMap[e].hashBlock())&&(this.verifyBlock(e),this.privateBlockMap[e].hash)},addMetadata:function(e){this.metadata=e,this.init=!0},getMetadata:function(){return this.metadata},initiateFromLocalData:function(t,n,r){var i=this;n||(n=0),r||0==r?i.availabilityMap.hasFS(n)?e.core.data.FSio.read(i.resourceId,n*e.config.BLOCK_SIZE,(n+1)*e.config.BLOCK_SIZE,function(a,o){a?(i.initiateBlockFromLocalData(n,o)&&radio("blockReceived").broadcast(i.resourceId,i.privateBlockMap[n].blockSize),n<r?(n++,i.initiateFromLocalData(t,n,r)):(e.info("finished initiating from filesystem"),radio("resumeEnded").broadcast(),t(!0))):e.warn("couldn't initiate block "+n+" from filesystem")}):n<r?(n++,i.initiateFromLocalData(t,n,r)):(e.info("finished initiating from filesystem"),radio("resumeEnded").broadcast(),t(!0)):e.core.data.FSio.getResourceDetails(this.resourceId,function(r,a){
var o=Math.floor(a.size/e.config.BLOCK_SIZE);i.availabilityMap.removeBlocksFrom(o+1,function(r){r?i.initiateFromLocalData(t,n,o):e.error("couldn't remove blocks from availability map")})})},initiateBlockFromLocalData:function(t,n){this._createANewBlock(t);for(var r=Math.ceil(n.length/e.config.CHUNK_SIZE),i=n.length-(r-1)*e.config.CHUNK_SIZE,a=this.privateBlockMap[t],o=0;o<r;++o)a.setChunkOn(o);if(a.verifyBlock(n,"fs")){for(this.numOfVerifiedBlocks++,a.fsLoad=a.blockSize;this.has(this.firstMissingBlock);)this.firstMissingBlock++;for(var o=0;o<r;++o){var s=o<r-1?e.config.CHUNK_SIZE:i;radio("peer5_received_fs_chunk").broadcast(this.resourceId,s,t*this.numOfChunksInBlock+o)}if(this.availabilityMap.set(t),this.isFull()){var u=this;this.availabilityMap.setFSFull(function(){u._onResourceComplete(),radio("transferLoaded").broadcast(u.metadata)})}return!0}return delete this.privateBlockMap[t],!1},changeResourceId:function(t,n){if(this.fs){var r=this;e.core.data.FSio.renameResource(this.resourceId,t,function(e){e?(r.resourceId=t,r.availabilityMap.renameResource(t,function(e){n(e)})):n(e)})}else this.resourceId=t,n(!0)},getDataBlob:function(e){var t=[];this._iterateBlocks(function(e){t.push(e)},0,this.numOfBlocks-1,function(){try{var n=new Blob(t,{type:"application/octet-binary"})}catch(e){"NS_ERROR_OUT_OF_MEMORY"===e.name&&radio("outOfMemoryError").broadcast(e.result)}e(n)})},getDataUint8Array:function(e){try{var t=new Uint8Array(this.metadata.size)}catch(t){if("NS_ERROR_OUT_OF_MEMORY"===t.name){t.result;radio("outOfMemoryError").broadcast(t.result),e(!1)}return}var n=0;this._iterateBlocks(function(e){t.set(e,n),n+=e.length},0,this.numOfBlocks-1,function(n){e(t)})},getBlobUrl:function(t){var n=this;if(this.fs)e.core.data.FSio.createObjectURL(this.resourceId,function(e,n){return e?void t(e,n):void t(!1)});else{var r=function(){try{n.getDataBlob(function(e){var n=window.URL.createObjectURL(e);t(!0,n)})}catch(e){"NS_ERROR_OUT_OF_MEMORY"===e.name&&(setTimeout(r,1e4),radio("outOfMemoryError").broadcast(e.result))}};r()}},getBlob:function(t){this.fs?e.core.data.FSio.getBlob(this.resourceId,0,this.fileSize,t):this.getDataBlob(function(e){t(!0,e)})},getUint8Array:function(t){this.fs?e.core.data.FSio.getArrayBuffer(this.resourceId,0,this.fileSize,function(e,n){e?t(!0,new Uint8Array(n)):t(!1)}):this.getDataUint8Array(function(e){e?t(!0,e):t(!1)})},getText:function(t){this.getUint8Array(function(n,r){n?t(!0,e.core.util.uint8ToString(r)):t(!1)})},allocateFileSize:function(t){var n=this;e.core.data.FSio.write(this.resourceId,new Uint8Array([]),this.fileSize,function(r,i){r||"space"!=i?r||e.error("error in allocateFileSize"):n._handleOutOfSpaceError(),t(r)})},allocateFileSizeSync:function(t){e.core.data.FSio.write(this.resourceId,new Uint8Array([]),this.fileSize,function(n,r){n||"space"!=r?(n||e.error("error in allocateFileSizeSync"),t&&t(n)):e.core.data.CacheManager.handleOutOfSpace(this.resourceId,this.fileSize,function(n){n?t&&t(n):(e.warn("couldn't clear enough space from offline storage"),t&&t(n))})})},_onResourceComplete:function(){this.unsetResourceAsBeingDownloadedInHttp(),this.httpExtraWaste+=this.httpProgressBytes,this.httpProgressBytes=0,this._reportStatsToServer()},_reportStatsToServer:function(){if(!this.reportedToServer){this.reportedToServer=!0;var t=this._getResourceStats();e.info("reporting to server stats: "+this.resourceId),e.info(t),radio("report:full").broadcast(this.resourceId,t)}},_registerEvents:function(){var e=this;this._lruRemoveCb=function(t){e._removeBlockData(t)},radio("handleOutOfSpaceError").subscribe([this._handleOutOfSpaceError,this]),radio("handleWriteError").subscribe([this._handleWriteError,this])},_initiateFileSystem:function(){var t=this;e.config.USE_PERSISTENT?e.core.data.FSio.queryPersQuota(function(n,r,i){0!=i?e.core.data.FSio.requestPersQuota(i,function(n,r){n?t._createOrResumeResource(r):(e.warn("couldn't initiate filesystem"),t._fallbackToNoFS())},t.fileSize):t._initiateTempFileSystem()}):this._initiateTempFileSystem()},_initiateTempFileSystem:function(){var t=this;e.core.data.FSio.queryTempQuota(function(n,r,i){i<t.fileSize?e.config.USE_PERSISTENT?e.core.data.FSio.requestPersQuota(e.config.PERSISTENT_FS_SIZE,function(n,r){n?t.availabilityMap=new e.core.dataStructures.AvailabilityMapFS(t.numOfBlocks,t.resourceId,r,function(n){n?e.core.data.FSio.createResource(t.resourceId,function(n){n?t._resourceInitedWithFS():(e.warn("failed to create resource in filesystem"),t._fallbackToNoFS())}):(e.warn("couldn't initiate metadata file"),t._fallbackToNoFS())}):(e.warn("couldn't initiate persistent filesystem"),t._fallbackToNoFS())},t.fileSize):(e.warn("not enough space in temporary storage"),t._fallbackToNoFS()):i-r>t.fileSize?t._createOrResumeResource(i-r):i-r<t.fileSize&&t._createOrResumeResource(i-r)})},addHttpProgressBytes:function(t){this.httpProgressBytes+=t,this.httpProgressBytes>this.fileSize&&e.error("httpProgressBytes ("+this.httpProgressBytes+") > fileSize ("+this.fileSize+")")},removeHttpProgressBytes:function(t){this.isFull()||(this.httpProgressBytes-=t,this.httpExtraWaste+=t,this.httpProgressBytes<0&&e.error("httpProgressBytes ("+this.httpProgressBytes+") < 0"))},_createOrResumeResource:function(t){var n=this;n.availabilityMap=new e.core.dataStructures.AvailabilityMapFS(n.numOfBlocks,n.resourceId,t,function(t){t?n.availabilityMap.numOfOnFSBits>0?e.core.data.FSio.isExist(n.resourceId,function(t){t?(e.info("Resource "+n.resourceId+" exists already in the filesystem."),radio("resumeStarted").broadcast(),n.initiateFromLocalData(function(t){t?n._resourceInitedWithFS():(e.warn("there was a problem resuming the resource"),n._fallbackToNoFS())})):n.availabilityMap.reset(function(t){t?e.core.data.FSio.createResource(n.resourceId,function(t){t?n._resourceInitedWithFS():(e.warn("failed to create resource in filesystem"),n._fallbackToNoFS())}):(e.error("couldn't reset the availability map"),n._fallbackToNoFS())})}):e.core.data.FSio.createResource(n.resourceId,function(t){t?n._resourceInitedWithFS():(e.warn("failed to create resource in filesystem"),n._fallbackToNoFS())}):(e.warn("couldn't initiate metadata file"),n._fallbackToNoFS())})},_resourceInitedWithFS:function(){this.fs=!0,radio("filesystemInitiated"+this.resourceId).broadcast(),this.init&&radio("resourceInit").broadcast(this.metadata)},_fallbackToNoFS:function(){this.fs=!1,this.availabilityMap=new e.core.dataStructures.AvailabilityMap(this.numOfBlocks),this.init&&radio("resourceInit").broadcast(this.metadata),radio("filesystemInitiated"+this.resourceId).broadcast()},_removeBlockData:function(e){this.privateBlockMap[e]&&this.privateBlockMap[e].removeBlockData()},_handleOutOfSpaceError:function(){var t;t=this.metadata.url?this.metadata.url:this.resourceId,e.info("Out of space error"),radio("pauseResource").broadcast(t,e.Request.OUT_OF_SPACE_ERR,"out of space"),e.core.data.CacheManager.handleOutOfSpace(this.resourceId,this.fileSize,function(n){n?radio("resumeResource").broadcast(t):(e.warn("couldn't clear enough space from offline storage"),radio("removeResource").broadcast(t,e.Request.OUT_OF_SPACE_ERR,"out of space"))})},_handleWriteError:function(){e.error("offline storage write error");var t;t=this.metadata.url?this.metadata.url:this.resourceId,radio("removeResource").broadcast(t,e.Request.WRITE_ERR,"offline storage write error")},_verifyResource:function(t){if(!this.hashAlg)return void t(!0);var n=this;return this.hashAlg?void this._iterateBlocks(function(t){n.hashAlg.append?n.hashAlg.append(t):n.hashAlg.update(e.core.util.base64.encode(t))},0,this.numOfBlocks-1,function(){if(n.hashAlg.end)var r=n.hashAlg.end().toUpperCase();else var r=n.hashAlg.finalize().toString().toUpperCase();e.info("resourceId "+n.resourceId+" loaded with hash = "+r),t(r===n.aprioriHash)}):void t(!0)},_getResourceStats:function(){var e={httpDown:this.httpProgressBytes,p2pDown:0,httpWaste:this.httpExtraWaste,p2pWaste:0,fsLoad:0};for(var n in this.privateBlockMap){var r=this.privateBlockMap[n];(this.isFull()||!r.isBeingDownloadedInHTTP&&t.XHR_ALLOW_RANGE&&r.isFull())&&(e.p2pDown+=r.p2pDown),e.httpDown+=r.httpDown,e.httpWaste+=r.httpWaste,e.p2pWaste+=r.p2pWaste,e.fsLoad+=r.fsLoad}return e},_iterateBlocks:function(e,t,n,r){var i=this,a=function(t){i.getBlock(t,function(i){i&&e(i,t),t++,t<=n?a(t):r(!0)})};a(t)},_createANewBlock:function(t){var n=t==this.numOfBlocks-1?this.sizeOfLastBlock:e.config.BLOCK_SIZE;this.privateBlockMap[t]=new e.core.Block(n),this.metadata.hashes&&(this.privateBlockMap[t].hash=this.metadata.hashes[t])},calcBlockIdChunkOffset:function(e){var t=Math.floor(e/this.numOfChunksInBlock),n=e%this.numOfChunksInBlock;return{block:t,chunk:n}}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(e){e.core.dataStructures.DoublyLinkedList=Object.subClass({ctor:function(){this.length=0,this.tail=null,this.head=null},insert:function(e){var t={prev:this.tail,next:null,value:e};this.tail&&(this.tail.next=t),this.tail=t,0==this.length&&(this.head=t),this.length++},remove:function(t){t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.tail==t&&(this.tail=t.prev),this.head==t&&(this.head=t.next),!this.head&&this.length>1&&e.error("removing elem: "+t+" but no head in the DoublyLinkedList"),this.length--},toString:function(){for(var e=this.head;e;)e=e.next}})}(e)}).call(t,n(1))},function(e,t,n){(function(e){!function(){e.core.dataStructures.LRU=Object.subClass({ctor:function(t,n,r){this.max=t,this.dict={},this.list=new e.core.dataStructures.DoublyLinkedList,this.deleteCB=n,this.maxSizeThresholder=r},set:function(t,n){for(this.dict[t]&&(e.error("LRU: setting an element that already exists: "+t),this._delete(t)),this.list.insert(t),this.dict[t]={value:n,p:this.list.tail};this.maxSizeThresholder&&this.maxSizeThresholder()||!this.maxSizeThresholder&&this.list.length>this.max;){if(this.list.length<=0)return e.error("LRU::set: removed all elements");var r=this.list.head;this._delete(r.value,this.deleteCB)}},update:function(t,n){this.dict[t]?this.dict[t].value=n:e.error("LRU: updating an element that didnt exist: "+t)},get:function(e){if(this.dict[e]){var t=this.dict[e].p;return t==this.list.tail?this.dict[e].value:(this.list.remove(t),this.list.insert(e),this.dict[e].p=this.list.tail,this.dict[e].value)}return!1},_delete:function(e,t){var n=this.dict[e];this.list.remove(n.p),delete this.dict[e],t&&t(e,n.value)}})}()}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){function t(e,t){var n=Object.create(null);n.value=t,n.keys=[e],o[e]=n,s[e]=e}function n(t,n){return s[n]!==n?void e.warn("cant alias a non existing key"):(s[t]=n,void o[n].keys.push(t))}function r(e){var t=o[e]||o[s[e]];return t?t.value:void 0}function i(e){var t=s[e],n=o[t].keys;n.forEach(function(e){delete s[e]}),delete o[t]}function a(){return Object.keys(o)}var o=Object.create(null),s=Object.create(null);return{add:t,get:r,alias:n,remove:i,getAllKeys:a}}t.MultiKeyMap=n}(e.core.dataStructures)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){function t(e){var t=Math.floor(e/r);return t}function n(e){var t=h[e];if(!t)return!1;var n=Object.keys(t);for(var r in n){var i=a(e,r);if(i)return!0}return!1}function i(e){return!!f[e]}function a(t,n){var r=h[t];if(!r)return!1;var i=r[n];if(!i)return!1;var a=!e.core.util.isObjectEmpty(i);return a}function o(e,n){var r=t(n);h[e]||(h[e]=Object.create(null)),h[e][r]||(h[e][r]=Object.create(null)),h[e][r][n]=Date.now()}function s(t,n){for(var r=Math.floor(n/e.config.CHUNK_SIZE)+1,i=0;i<r;i++)o(t,i)}function u(e,t){s(e,t),f[e]=!0}function c(e,n){if(h[e]){var r=t(n);h[e][r]&&(delete h[e][r][n],delete f[e])}}function l(e,t){h[e]&&(delete h[e][t],delete f[e])}function d(e){delete h[e],delete f[e]}var h=Object.create(null),f=Object.create(null);return{isResourcePending:n,isBlockPending:a,isFullResourcePending:i,addChunk:o,addResource:s,addFullResource:u,removeChunk:c,removeBlock:l,removeResource:d}}var r=e.config.BLOCK_SIZE/e.config.CHUNK_SIZE;t.PendingBlockMap=n()}(e.core.dataStructures)}).call(t,n(1))},function(e,t,n){(function(e){!function(e,t){e.taskQueue=function(){function e(){return d[0]}function n(){l=t.core.util.asyncDefer(r)}function r(){if(0!==h){var t=s();t===!0?i(e()):("number"!=typeof t&&(t=0),window.setTimeout(n,t))}}function i(e){try{e()}catch(e){t.error("taskQueue::task() failed",e)}o(),h>0&&n()}function a(e){d[h]=e,h++,1===h&&n()}function o(){d.shift(),h--}function s(){if(!f.canrun)return!0;try{return f.canrun()}catch(e){return t.warn("taskQueue::canrun failed",e),o(),!1}}function u(){d=[],h=0}function c(){return d}var l,d=[],h=0,f={push:a,getTasks:c,reset:u,canrun:null};return f}}(e.core.util,e)}).call(t,n(1))},function(e,t,n){(function(e){!function(e,t){function r(t,n,r){function c(t){var n=e.getElementsByTagName(t);if(n.length>1){if(u.info("found multiple elements with tag "+t+", searching for correct one"),"video"!==t){u.info("looking for flash specific properties");for(var r=0;r<n.length;r++){var i=n[r];try{if(i&&(i.getbufferLength||i.vjs_getProperty))return u.info("Found element with getbufferLength or vjs_getProperty function"),i}catch(e){u.warn("flash element not accessible")}}return void u.warn("Could not find correct flash element")}u.info("no specific property for video tags yet, selecting first one")}else if(0===n.length)return;return n[0]}function l(){var e;return d?e=i(d):[h,f].some(function(t){if(t)return e=a(t),!!e||void 0}),e=e||0,o.maxGlobal({maxBufferHealth:Math.round(1e3*e)}),e}var d=t||null,h=n||null,f=r||null;return t||setInterval(function(){d=c("video")},s.VIDEOTAG_FIND_INTERVAL),n||setInterval(function(){h=c("object")},s.VIDEOTAG_FIND_INTERVAL),f||setInterval(function(){f=c("embed")},s.VIDEOTAG_FIND_INTERVAL),{getBufferLength:l}}var i=n(28),a=n(121),o=n(3),s=n(2),u=n(4);t.MediaController=r}(document,e.core.media)}).call(t,n(1))},function(e,t,n){"use strict";var r=n(23),i=n(124),a=n(11),o=n(2),s=n(30),u=n(4);if(o.INTERNAL_VIDEOTAG_MONITORING){var c,l=function(e){function t(e,t){"error"===e?u.error("internal video tag monitor error",t):o[e]?r.updateAction(n,o[e]):"fps.drop"===e&&a("external.player").broadcast({action:"fps.drop",value:t.count,vendor:"videoTag",id:n})}var n=e.id||"player";r.initPlayer(n,"videoTag");var o={ready:"ready",stop:"stop","load.start":"loadStart","load.end":"loadEnd","rebuffer.start":"buffer","rebuffer.end":"resume","seek.start":"seek","seek.end":"resume","pause.start":"pause","pause.end":"play"};i(e,t)},d=!1,h=function(){if(!d){var e=s("video");e&&(d=!0,clearInterval(c),l(e))}};document.addEventListener("DOMContentLoaded",h),document.addEventListener("readystatechange",h),c=setInterval(h,50),h()}},function(e,t,n){(function(e){!function(e){e.create=function(){function e(e,n){n=n||{};var r={init:"boolean"!=typeof n.init||n.init,enabled:"boolean"!=typeof n.enabled||n.enabled,initFunction:"function"==typeof n.initFunction?n.initFunction:null,enableFunction:"function"==typeof n.enableFunction?n.enableFunction:null,disableFunction:"function"==typeof n.disableFunction?n.disableFunction:null,retryTimer:null,initialized:"boolean"!=typeof n.initialized||n.initialized};g[e]=r,r.init&&r.initFunction&&t(e)}function t(e){var t=g[e];t.initFunction&&t.initFunction(function(){a(e)},function(){o(e)})}function n(e,t){var n=g[e];n.enableFunction?n.enableFunction(function(){n.enabled=!0},t):n.enabled=!0}function r(e,t){var n=g[e];n.disableFunction?n.disableFunction(function(){n.enabled=!1},t):n.enabled=!1}function i(t,n){if("object"==typeof t&&(n=t,t=n.key),c(t))throw new Error("Trying to init a new feature that already exist");e(t,n)}function a(e){g[e].initialized=!0}function o(e){g[e].initialized=!1}function s(e,t){c(e)&&p(e)&&n(e,t)}function u(e,t){c(e)&&f(e)&&r(e,t)}function c(e){return void 0!==g[e]}function l(e){return!!c(e)&&g[e].initialized===!0}function d(e){return!!c(e)&&(f(e)&&l(e))}function h(e){return!!c(e)&&(p(e)&&l(e))}function f(e){return!!c(e)&&g[e].enabled===!0}function p(e){return f(e)===!1}var g=Object.create(null);return{add:i,enable:s,disable:u,isEnabled:f,isDisabled:p,isEnabledAndInitialized:d,isDisabledAndInitialized:h}}}(e.featureToggle=e.featureToggle||{})}).call(t,n(1))},function(e,t,n){(function(e){!function(e){e.Playlist=function(e){function t(e,t,n){for(var r=t;r<n;r++){var i=e.segments[r],a={duration:e.durations[r],seqs:e.seqs[r]};p[i]=a}}function n(e){var n=e.segments;if(n&&0!==n.length&&(f.indexOf(n[0])===-1||f.indexOf(n[n.length-1])===-1)){if(f.indexOf(n[0])!==-1){for(var r=0;r<n.length&&f.indexOf(n[r])!==-1;r++);t(e,r,n.length);var i=n.slice(r);return void(f=f.concat(i))}if(f.indexOf(n[n.length-1])!==-1){for(var r=0;r<n.length&&f.indexOf(n[r])===-1;r++);t(e,0,r);var a=n.slice(0,r);return void(f=a.concat(f))}t(e,0,n.length),f=n.slice()}}function r(){return f}function i(e){return f.indexOf(e)}function a(e){var t=f.indexOf(e);return 0===f.length||t===f.length-1?null:t===-1?f[0]:f[t+1]}function o(e){var t=f.indexOf(e);if(t!==-1){f.splice(0,t)}}function s(e,n){var r=i(e)+1,a=r+n;if(a>=f.length&&h){for(var o=f[f.length-1],s=h(o),u=[],c=0;c<s.segs.length;c++)u[c]=s.duration;var l={segments:s.segs,durations:u};t(l,0,s.segs.length),f=f.concat(s.segs)}return f.slice(r,a)}function u(e,t){var n=s(e,t),r=n.map(function(e){var t=p[e];return{segment:e,segmentData:t}});return r}function c(){return g}function l(e){var t=p[e];return{segment:e,segmentData:t}}function d(){return f[f.length-1]}var h=e.generateNextSegments,f=[],p=Object.create(null),g=e.mode;return n(e),{getSegments:r,addSegments:n,getIndex:i,getNextSegmentUrl:a,deleteToSegment:o,getSegmentsInterval:s,getSegmentsDataInterval:u,getMode:c,getSegmentData:l,getNewestSegment:d}}}(e.core.playlist)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(3);!function(n){n.PlaylistsHandler=function(){function n(){return E}function r(t,n){if(!n)return[];void 0!==E[t]?E[t].addSegments(n):E[t]=e.core.playlist.Playlist(n);for(var r=0;r<n.segments.length;r++){var i=n.segments[r];b[i]=t}return n.segments}function i(){return b[S]}function a(){return S}function o(e){S=e}function s(e){T=e}function u(e){var t=b[e];if(t){var n=E[t];n.deleteToSegment(e)}}function c(e){var t=b[e],n=E[t];return n.getNextSegmentUrl(e)}function l(e){if(!S)return null;var t=b[S],n=E[t],r=n.getIndex(e);if(r===-1)return null;var i=n.getIndex(S);return r-i}function d(e){if(!S||e<=0)return[];var t=b[S];if(!t)return[];var n=E[t],r=n.getSegmentsInterval(S,e);return r}function h(e){e||(e=b[S]);var t=E[e];if(t)return t.getNewestSegment()}function f(e){if(!S||e<=0)return null;var t=b[S],n=E[t],r=n.getSegmentsDataInterval(S,e);r.forEach(function(e){e.segmentData.playlistName=t});var i={segmentsData:r,playlistName:t};return i}function p(){if(!S)return!1;var e=b[S],t=E[e],n=t.getIndex(S);return n>-1}function g(n,i){var a=e.core.util.PlaylistParserFactory.getParser(n);if(!a)return[];t.setMediaInfo({protocol:a.protocol});var o=a.extractPlaylistsData(n,i);if(!o)return[];var s=[];for(var u in o){var c=o[u],l=r(u,c);l&&l.length>0&&(s=s.concat(l))}return s}function v(){for(var e in E)if("live"===E[e].getMode())return!0;return!1}function m(e){var t=b[e],n=E[t],r=n.getSegmentData(e);return r.segmentData.playlistName=t,r}function _(t){if(!T)return 0;var n=b[t];if(!n)return 0;var r=E[n];if(!r)return 0;var i=r.getIndex(T),a=r.getIndex(t),o=r.getSegments();if(i===-1||a===-1)return e.warn("couldnt find lastRequestSegment or segment in playlist "+T+" "+t),0;for(var s=0,u=i+1;u<a;u++){var c=m(o[u]);s+=c.segmentData.duration}return s}var E=Object.create(null),b=Object.create(null),S=null,T=null;return{getPlaylists:n,getCurrentPlaylist:i,getLastRequestedSegment:a,setLastRequestedSegment:o,setLastLoadedSegment:s,deleteToSegment:u,getNextSegmentUrl:c,getPositionRelativeToLastRequested:l,getNextSegmentsWindow:d,getNewestSegment:h,getNextSegmentsDataWindow:f,lastRequestedSegmentExists:p,extractSegments:g,updatePlaylist:r,hasLivePlaylist:v,getSegmentData:m,getDurationFromLastLoadedToSegment:_}}}(e.core.playlist)}).call(t,n(1))},function(e,t,n){(function(t){function r(e){this.currentReport={},this.urlsMap={},this.playerEventsSanitizer=a();var t=e||{};this.onReportedEvent=t.onReportedEvent||function(){},this.registerEvents()}var i=n(6).singleton,a=n(133),o=n(11),s=n(4),u=n(3),c=n(2),l=n(14);r.prototype.registerEvents=function(){var e={speedEstimationCalculated:function(e){var t=this.urlsMap[e.url];if(t){var n=this.getSwarmReport(t);n.mode=e.mode,n.predictedSpeed=e.predictedSpeed,n.actualSpeed=e.actualSpeed,n.bytesDownloaded=e.bytesDownloaded}},fileInfoProcessed:function(e){e.swarmId&&e.url&&(this.urlsMap[e.url]=e.swarmId)},"report:full":function(e,t){var n=this.getSwarmReport(e);for(var r in t){var i=t[r];i>0&&(n[r]=n[r]?n[r]+t[r]:t[r])}},"report:p2pWaste":function(e,t){var n=this.getSwarmReport(e);n.p2pWaste=n.p2pWaste?n.p2pWaste+t:t},chunkSent:function(e,t){var n=this.getSwarmReport(e);n.p2pUp=n.p2pUp?n.p2pUp+t:t},"external.player":function(e){var t=this.playerEventsSanitizer.handle(e);if(t){"rebuffer.start"!==t.action&&"rebuffer.end"!==t.action||this.enrichRebufferReport(t);var n=this.getPlayerReport();n.push(t)}},"player.attach":function(e){["ready","load.start","load.end","pause.start","pause.end","rebuffer.start","rebuffer.end","seek.start","seek.end"].forEach(function(t){e.on(t,function(e){var t=u.getMediaInfo(),n=l({vendor:t.vendor,tracking:t.tracking,provider:t.provider},e),r=this.playerEventsSanitizer.handle(n);if(r){"rebuffer.start"!==r.action&&"rebuffer.end"!==r.action||this.enrichRebufferReport(r);var i=this.getPlayerReport();i.push(r)}},this)},this)},activePeerConnectionsNumberChanged:function(e){var t=this.getPeersReport();t.connected=e},availablePeerConnectionsNumberChanged:function(e){var t=this.getPeersReport();t.available=e}};Object.keys(e).forEach(function(t){var n=e[t];o(t).subscribe([function(){return this.onReportedEvent(),n.apply(this,arguments)},this])},this)},r.prototype.enrichRebufferReport=function(e){var t=u.getStats("*");e.context={},e.context.peers=t.numOfPeers,e.context.p2pDown=t.totalP2PDownloaded,e.context.p2pWaste=t.totalP2PWaste,e.context.httpDown=t.totalHttpDownloaded,e.context.httpWaste=t.totalHttpWaste,e.context["load.end"]=t["load.end"][0],e.context.numOfResources=this.getNumOfResources(),e.context.activeRequests=[];var n=this.getActiveResources();e.context.numOfActiveResources=n.length,n.forEach(function(t){var n=Math.round(performance.now()-t.start),r=t.resourceId||t.url;if(!r)return void s.error("Active resource without resourceId and url");var i=u.getStats(r),a=u.getSpeed(r);e.context.activeRequests.push({url:t.url,size:t.size,mod:t.mod,p2pDown:i.totalP2PDownloaded,p2pWaste:i.totalP2PWaste,p2pProgress:i.totalP2PProgress,httpDown:i.totalHttpDownloaded,httpWaste:i.totalHttpWaste,requestsCount:i.requestsCount,internalHTTPTimeouts:i.internalHTTPTimeouts||0,startBufferHealth:i.startBufferHealth,age:n,httpSpeed:Math.round(a)})});var r=u.getGlobalStats({recentAge:c.STATS_RECENT_QUERY_AGE});e.context.maxBufferHealth=r.maxBufferHealth||0,e.context.avgHTTPSpeed=Math.round(r.avgHTTPSpeed||0),e.context.internalHTTPTimeouts=r.internalHTTPTimeouts||0,e.context.playlistTimeouts=r.playlistTimeouts||0,e.context.recentP2PUploaded=r.recentP2PUploaded||0,e.context.peerConnectionsCreated=r.peerConnectionsCreated||0,e.context.totalFPSDrop=r.totalFPSDrop||0,e.context.p2pHaveReceived=r.p2pHaveMessagesReceived||0,e.context.p2pDontHaveReceived=r.p2pDontHaveMessagesReceived||0,e.context.p2pRequestReceived=r.p2pRequestMessagesReceived||0,e.context.p2pDataReceived=r.p2pDataMessagesReceived||0,e.context.p2pDownloadingReceived=r.p2pDownloadingMessagesReceived||0,e.context.p2pNewSegmentReceived=r.p2pNewSegmentMessagesReceived||0,e.context.p2pInitializingReceived=r.p2pInitializingMessagesReceived||0,e.context.p2pHaveSent=r.p2pHaveMessagesSent||0,e.context.p2pDontHaveSent=r.p2pDontHaveMessagesSent||0,e.context.p2pRequestSent=r.p2pRequestMessagesSent||0,e.context.p2pDataSent=r.p2pDataMessagesSent||0,e.context.p2pDownloadingSent=r.p2pDownloadingMessagesSent||0,e.context.p2pNewSegmentSent=r.p2pNewSegmentMessagesSent||0,e.context.p2pInitializingSent=r.p2pInitializingMessagesSent||0,e.context.matchReceived=r.matchMessagesReceived||0,e.context.sdpReceived=r.sdpMessagesReceived||0,e.context.sdpSent=r.sdpMessagesSent||0,e.context.joinSent=r.joinMessagesSent||0,e.context.leaveSent=r.leaveMessagesSent||0,e.context.numOfErrors=s.getMetrics().error},r.prototype.getActiveResources=function(){return t.state.resources.getActiveResources()},r.prototype.getNumOfResources=function(){return t.state.resources.getNumOfResources()},r.prototype.getSwarmReport=function(e){return e?(this.currentReport.swarms||(this.currentReport.swarms={}),this.currentReport.swarms[e]||(this.currentReport.swarms[e]={}),this.currentReport.swarms[e]):null},r.prototype.getPlayerReport=function(){return this.currentReport.player||(this.currentReport.player=[]),this.currentReport.player},r.prototype.getPeersReport=function(){return this.currentReport.peers||(this.currentReport.peers={}),this.currentReport.peers},r.prototype.getSwarmFileSize=function(e){if(!i.has(e))return 0;var t=i.get(e);return t.init?t.fileSize:0},r.prototype.addPeriodicalReports=function(){var e=u.getTotalDurations(),t=e.play-(this.lastPlayDuration||0),n=e.rebuffer-(this.lastRebufferDuration||0);if(this.lastPlayDuration=e.play,this.lastRebufferDuration=e.rebuffer,t||n){var r={vendor:u.getMediaInfo().vendor,action:"durations"};t>0&&(r.playDuration=t),n>0&&(r.rebufferDuration=n);var i=this.getPlayerReport();i.push(r)}},r.prototype.rotateReport=function(){this.addPeriodicalReports();var e=this.currentReport;if(e.swarms)for(var n=e.swarms,r=Object.keys(n),i=0,a=r.length;i<a;i++){var o=r[i],s=n[o],u=this.getSwarmFileSize(o);u&&(s.fileSize=u,s.httpDown+s.p2pDown>s.fileSize&&t.error("httpDown ("+s.httpDown+") + p2pDown ("+s.p2pDown+") > filesize ("+s.fileSize+")")),s.peers=t.clientInstance.controller.P2PController.getSwarmPeersCount(o)}if(!t.core.util.isObjectEmpty(e))return this.currentReport={},e},r.prototype.getSessionSummary=function(){var e=u.getTotalDurations(),t=u.getStats(),n=u.getGlobalStats(),r=u.getMediaInfo();return{action:"session.end",vendor:r.vendor,provider:r.provider,tracking:r.tracking,mediaType:r.type,mediaProtocol:r.protocol,playDuration:e.play,rebufferDuration:e.rebuffer,lastPlayerEvent:r.lastPlayerEvent,sinceLastPlayerEvent:r.sinceLastPlayerEvent?Date.now()-r.sinceLastPlayerEvent:void 0,numOfErrors:s.getMetrics().error,p2pDown:t.totalP2PDownloaded,p2pUp:t.totalP2PUploaded,httpDown:t.totalHttpDownloaded,fpsDrop:n.totalFPSDrop,avgBitrate:r.avgBitrate}},e.exports=r}).call(t,n(1))},function(e,t,n){(function(t){function n(){function e(e){if(!c[e]){var t=Object.create(null);t.loaded=0,t.speed=void 0,t.start=performance.now(),c[e]=t}}function n(e){i(e,0)}function r(e,t){i(e,t)}function i(e,t){var n=performance.now(),r=c[e];r&&(r.loaded+=t,r.speed=r.loaded/((n-r.start)/1e3))}function a(e){delete c[e]}function o(e){var n=c[e];if(n)return n.speed<0&&t.error("speed is negative ("+n.speed+")"),n.speed}function s(e){return o(e)}function u(e){delete c[e]}var c=Object.create(null);return radio("xhrSent").subscribe([e,this]),radio("xhrComplete").subscribe([n,this]),radio("httpDownloaded").subscribe([r,this]),radio("httpAborted").subscribe([a,this]),{getSpeed:o,getPredictedSpeed:s,removeResource:u}}e.exports=n()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(142);!function(){e.core.transport.AbstractPeerConnection=Object.subClass({ctor:function(n,r,i){t.call(this),this.peerConnection,this.dataChannel,this.label=i?n+r:r+n,this.originId=n,this.targetId=r,this.createAnswerConstraints={},this.createOfferConstraints={},this.startTime,this.ready=!1,this.requestDropped=0,this.numOfPendingChunks=0,this.maxNumOfPendingChunks=e.config.MAX_PENDING_CHUNKS/2,this.failure=!1},isFull:function(e){return e?this.numOfPendingChunks+e>=this.maxNumOfPendingChunks:this.numOfPendingChunks>=this.maxNumOfPendingChunks},requestSucceeded:function(e){this.requestDropped=0,e&&this.increasePeerWindow()},requestFailed:function(){++this.requestDropped>=e.config.REQUEST_DROPPED_FAIL&&this.close()},chunksRequested:function(e){this.numOfPendingChunks+=e},chunksReceived:function(e,t){this.numOfPendingChunks-=e,this.validate()},chunksLate:function(t){this.decreasePeerWindow(t),this.validate(),e.info("peer: "+this.targetId+" has a window of "+this.maxNumOfPendingChunks+" requestDropped: "+this.requestDropped)},validate:function(){this.numOfPendingChunks<0&&(this.numOfPendingChunks=0,e.error("peerConnection numOfPendingChunks < 0"))},increasePeerWindow:function(){var t=this.maxNumOfPendingChunks;this.maxNumOfPendingChunks=Math.min(e.config.MAX_PENDING_CHUNKS,this.maxNumOfPendingChunks+1),e.info("peer "+this.targetId+" window increased from "+t+" to "+this.maxNumOfPendingChunks)},decreasePeerWindow:function(t){var n=this.maxNumOfPendingChunks;this.maxNumOfPendingChunks=Math.ceil(Math.max(this.maxNumOfPendingChunks/2,this.maxNumOfPendingChunks-2*t)),e.info("peer "+this.targetId+" window decreased from "+n+" to "+this.maxNumOfPendingChunks),this.maxNumOfPendingChunks<=e.config.SMALL_WINDOW_THRESHOLD&&e.config.CLOSE_SMALL_WINDOW_CONNECTIONS&&this.close()}}),e.core.transport.AbstractPeerConnection.prototype.__proto__=t.prototype}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(5),r=n(127),i=n(3);!function(){window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate;var n=15728640-e.config.CHUNK_SIZE;e.core.transport.PeerConnectionImpl=e.core.transport.AbstractPeerConnection.subClass({ctor:function(t,r,i,a){this._super(t.id,r,i),this.initiator=i,this.signaller=t.signaller,this.peerConnection=a,this.useBase64=!1,this.dataChannelOptions={},e.config.DC_UNORDERED&&(this.dataChannelOptions.ordered=!1),e.config.DC_MAX_RETRANSMITS?this.dataChannelOptions.maxRetransmits=e.config.DC_MAX_RETRANSMITS:e.config.DC_MAX_PACKET_LIFE_TIME&&(this.dataChannelOptions.maxPacketLifeTime=e.config.DC_MAX_PACKET_LIFE_TIME),this.initiatePeerConnection(i),this.sdpQueue=[],this.sdpQueueTimer=null,this.lastLatencyTimestamp=0,this.latencySlidingWindow=e.core.util.slidingWindow(),this.sendQueue=e.core.util.taskQueue();var o=this;this.sendQueue.canrun=function(){return o.ready&&o.isAvailable()&&o.getBufferedAmount()<=n}},setupCall:function(){if(this.startTime=Date.now(),"closed"===this.peerConnection.signalingState)return e.warn("cant create offer when signaling state is closed"),void this.handlePeerDisconnection();this.peerConnection.createOffer(this.setLocalAndSendMessage_,function(e){},this.createOfferConstraints);var t=this;setTimeout(function(){t.ready||(t.failure=!0,e.warn("timeout while trying to connect to peer "+t.targetId),t.handlePeerDisconnection(t.targetId))},e.config.PC_FAIL_TIMEOUT)},handleMessage:function(t){var n=t.sdpMessage;if(e.info("handling SDP message"),n.type){var r=new RTCSessionDescription(n),i=this;if(!this.peerConnectionStateValid())return;if(this.peerConnection.remoteDescriptionSet=!0,this.peerConnection.setRemoteDescription(r,function(){if(i.peerConnection.remoteDescriptionSuccessfullySet=!0,"offer"==r.type){if(!i.peerConnectionStateValid())return;i.peerConnection.createAnswer(i.setLocalAndSendMessage_,function(e){},i.createAnswerConstraints)}},function(e){}),this.peerConnection.candidatesMsgQueue){for(var a=0;a<this.peerConnection.candidatesMsgQueue.length;++a)this.peerConnection.addIceCandidate(new RTCIceCandidate(this.peerConnection.candidatesMsgQueue[a]),this.addIceCandidateFailureCallback_,this.addIceCandidateFailureCallback_);this.peerConnection.candidatesMsgQueue=null}}else if(n.candidate){if(!this.peerConnectionStateValid())return;if(!this.peerConnection.remoteDescriptionSet)return this.peerConnection.candidatesQueue||(this.peerConnection.candidatesMsgQueue=[]),void this.peerConnection.candidatesMsgQueue.push(n);var o=JSON.stringify(n);
if(o in this.peerConnection.candidates)return void e.warn("candidate was already added");if(!this.peerConnectionStateValid())return;var s=new RTCIceCandidate(n);return this.peerConnection.addIceCandidate(s,this.addIceCandidateSuccessCallback_,this.addIceCandidateFailureCallback_),void(this.peerConnection.candidates[o]=Date.now())}},queue:function(t){var n=t;Array.isArray(t)||(n=[t]);var i=this;this.sendQueue.push(function(){"open"!=i.dataChannel.readyState.toLowerCase()&&e.warn("sending message to a non open channel "+JSON.stringify(t)+" to peer: "+i.targetId),i.send(r.encode(n))})},send:function(t){var n=this.useBase64?e.core.util.base64.encode(t):t.buffer;this._send(n,e.config.P2P_SEND_RETRIES)},_send:function(t,n){if(this.dataChannel&&"open"===this.dataChannel.readyState.toLowerCase())try{this.dataChannel.send(t);var r=this.dataChannel.bufferedAmount;r>0&&radio("channelBusy").broadcast(this.targetId)}catch(t){e.warn("dataChannel failed to send data",t)}else if(e.info("dataChannel was not ready, setting timeout"),n>0){n--;var i=this;setTimeout(function(){i._send(t,n)},e.config.PC_RESEND_INTERVAL)}},close:function(){this.ready=!1,this.sendQueue.reset();try{this.dataChannel&&this.dataChannel.close&&this.dataChannel.close()}catch(t){e.info("datachannel connection close error "+t.message)}try{this.peerConnection&&this.peerConnection.close&&"closed"!==this.peerConnection.signalingState&&this.peerConnection.close()}catch(t){e.info("peer connection close error "+t.message)}},getBufferedAmount:function(){return this.dataChannel.bufferedAmount},sendSdpMessage:function(t){if(this.sdpQueue.push(t),this.sdpQueue.length===e.config.PC_SDP_FLUSH_LENGTH)this.flushSdpMessageQueue();else if(!this.sdpQueueTimer){var n=this;this.sdpQueueTimer=setTimeout(function(){n.sdpQueueTimer=null,n.flushSdpMessageQueue()},e.config.PC_SDP_FLUSH_TIMEOUT)}},flushSdpMessageQueue:function(){if(clearTimeout(this.sdpQueueTimer),this.sdpQueueTimer=null,this.sdpQueue.length){var e=this.sdpQueue;this.sdpQueue=[],this.signaller.groupSdp(this.originId,this.targetId,e)}},initiatePeerConnection:function(e){this.initiatePeerConnectionCallbacks(),this.createPeerConnection(),e&&this.ensureHasDataChannel()},initiatePeerConnectionCallbacks:function(){this.registerEvents()},registerEvents:function(){var n=this;this.setLocalAndSendMessage_=function(e){e.sdp=n.transformOutgoingSdp(e.sdp),n.peerConnection.setLocalDescription(e,function(){},function(e){}),n.sendSdpMessage(e)},this.iceCallback_=function(e){e.candidate&&"disconnected"!=e.target.iceConnectionState&&n.sendSdpMessage(e.candidate)},this.iceStateChangedCallback_=function(t){t.target&&"disconnected"===t.target.iceConnectionState&&(e.info("iceStateChanged to disconnected"),n.handlePeerDisconnection())},this.signalingStateChangeCallback_=function(t){t.target&&"closed"==t.target.signalingState&&(e.info("signalingStateChanged to closed"),n.handlePeerDisconnection())},this.onCreateDataChannelCallback_=function(t){null!=n.dataChannel&&"closed"!=n.dataChannel.readyState&&e.warn("Received DataChannel, but we already have one."),n.dataChannel=t.channel,n.hookupDataChannelEvents()},this.onDataChannelReadyStateChange_=function(t){var r=t.target.readyState;e.info("dataChannel ready state changed for peer "+n.targetId+" to state: "+r),"open"==r.toLowerCase()&&(n.ready=!0,radio("connectionReady").broadcast(n.targetId))},this.onDataChannelClose_=function(){e.info("data channel was closed"),n.handlePeerDisconnection()},this.onMessageCallback_=function(i){var a=n.useBase64?e.core.util.base64.decode(i.data):new Uint8Array(i.data),o=r.decode(a);o.forEach(function(e){radio("dataReceivedEvent").broadcast(e,n),e.tag===t.P2P_DATA&&n.emit("data",e)})},this.addIceCandidateSuccessCallback_=function(e){},this.addIceCandidateFailureCallback_=function(t){e.warn("addIceCandidate failed "+t)}},ensureHasDataChannel:function(){null==this.peerConnection&&e.warn("Tried to create data channel, but have no peer connection."),null!=this.dataChannel&&"closed"!=this.dataChannel&&e.warn("Creating DataChannel, but we already have one."),this.createDataChannel()},createPeerConnection:function(){this.peerConnection?e.info("using peerConnection from pool"):(this.peerConnection=e.core.transport.PeerConnectionImpl.createPeerConnection(),e.info("creating peerConnection on demand")),this.peerConnection.candidates={},this.peerConnection.onicecandidate=this.iceCallback_,this.peerConnection.oniceconnectionstatechange=this.iceStateChangedCallback_,this.peerConnection.onicechange=this.iceStateChangedCallback_,this.peerConnection.onsignalingstatechange=this.signalingStateChangeCallback_,this.peerConnection.ondatachannel=this.onCreateDataChannelCallback_},createDataChannel:function(){e.info("createDataChannel "+this.targetId);try{this.dataChannel=this.peerConnection.createDataChannel(this.label,this.dataChannelOptions)}catch(t){return e.warn("failed creating datachannel: "+t.message),void this.handlePeerDisconnection()}this.hookupDataChannelEvents()},hookupDataChannelEvents:function(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=this.onMessageCallback_,this.dataChannel.onopen=this.onDataChannelReadyStateChange_,this.dataChannel.onclose=this.onDataChannelClose_,e.info("data-channel-status: "+this.dataChannel.readyState)},transformOutgoingSdp:function(e){var t=e.split("b=AS:30");if(t.length>1)var n=t[0]+"b=AS:1638400"+t[1];else n=e;return n},handlePeerDisconnection:function(){try{e.info("signaling state:",this.peerConnection.signalingState," icegathering state:",this.peerConnection.iceGatheringState," iceconnection state:",this.peerConnection.iceConnectionState," datachannel.readyState:",this.dataChannel?this.dataChannel.readyState:"undefined.undefined"),this.dataChannel&&"closed"!==this.dataChannel.readyState&&(e.info("handling peer disconnection: closing the datachannel"),this.dataChannel.close())}catch(t){e.info("error closing the data channel: "+t)}this.closed||(this.closed=!0,this.ready=!1,radio("connectionFailed").broadcast(this.targetId),this.emit("disconnect"))},peerConnectionStateValid:function(){try{return"closed"!=this.peerConnection.iceConnectionState&&"closed"!=this.peerConnection.signalingState||(e.warn("peerConnection state to "+this.targetId+" is invalid - 'not usable'"),!1)}catch(e){return!1}},isAvailable:function(){return this.dataChannel&&"open"===this.dataChannel.readyState.toLowerCase()}}),e.core.transport.PeerConnectionImpl.createPeerConnection=function(){for(var t,n=e.config.STUN_SERVERS,r=e.config.TURN_SERVERS?e.config.TURN_SERVERS:[],a=e.config.TURN_CREDENTIALS,o={iceServers:[]},s=0;s<n.length;++s)o.iceServers.push({urls:"stun:"+n[s]});for(var u=0;u<r.length;++u)o.iceServers.push({urls:"turn:"+r[u],credential:a[u]});try{t=new RTCPeerConnection(o),i.sumGlobal({peerConnectionsCreated:1})}catch(t){e.warn("Failed to create peer connection: "+t)}return t}}()}).call(t,n(1))},function(e,t,n){(function(e){var t=n(2),r=n(5),i=n(15),a=n(138),o=n(3),s=n(8);!function(){e.core.transport.WsConnection=Object.subClass({ctor:function(e,n){if(this.clientId=n,this.lastPingTimestamp=Date.now(),this.connectionDelay=0,this.socketOpenCallbacks=[],this.socket=null,this._wsServerUri=e,this._pageUrl=encodeURIComponent(s.urlWithAllowedKeys(window.location.href,t.URL_ALLOWED_QUERY_PARAMETERS)).replace(/'/g,"%27").replace(/"/g,"%22"),this._openSocket(),t.FEATURE_WS_HEARTBEAT){var r=this;setInterval(function(){r._heartbeat()},t.FEATURE_WS_HEARTBEAT_INTERVAL)}},_getWSUrl:function(){var n={id:this.clientId,page:this._pageUrl,token:i(),ver:"0.70.8",conf:t.VERSION,fallback:t.EXTERNAL_XHR_FALLBACK,enabled:e.feature.isEnabledAndInitialized(t.FEATURE_PEER5_KEY),abconfig:t.A_B_CONFIG_JSON,connectionType:window.navigator&&window.navigator.connection&&window.navigator.connection.type},r=a(n);return this._wsServerUri+"?"+r},_openSocket:function(n){if(!t.WS_ENABLED)return void e.warn("websocket is disabled");if(n&&this.socketOpenCallbacks.push(n),!this._socketInitializing){var r=this;this._socketInitializing=setTimeout(function(){r._createSocket()},this.connectionDelay)}},_createSocket:function(){e.info("trying to connect to a new websocket");try{this.socket=new(WebSocket||MozWebSocket)(this._getWSUrl())}catch(e){return void this._onSocketError(e)}this.socket.binaryType="arraybuffer",this._registerSocketEvents()},_destroySocket:function(){this._unregisterSocketEvents(),this.socket=null},_heartbeat:function(){var e=Date.now()-this.lastPingTimestamp;e>t.FEATURE_WS_HEARTBEAT_ELAPSED&&this.sendMessage(new r.HeartbeatMessage)},close:function(){this.socket.close()},_registerSocketEvents:function(){var e=this;this.socket.onopen=function(){return e._onSocketOpen.apply(e,arguments)},this.socket.onmessage=function(){return e._onSocketMessage.apply(e,arguments)},this.socket.onclose=function(){return e._onSocketClose.apply(e,arguments)},this.socket.onerror=function(){return e._onSocketError.apply(e,arguments)}},_unregisterSocketEvents:function(){this.socket.onerror=null,this.socket.onclose=null,this.socket.onmessage=null,this.socket.onopen=null},_onSocketOpen:function(){this._socketInitializing=!1,this.connectionDelay=0;for(var t;t=this.socketOpenCallbacks.shift();)e.core.util.asyncDefer(t)},_onSocketClose:function(){e.warn("websocket connection closed"),this._destroySocket()},_onSocketError:function(n){e.warn("websocket had socket error"),this._socketInitializing&&(this.connectionDelay=0===this.connectionDelay?5e3+Math.random()*t.SOCKET_RECONNECTION_INTERVAL:2*this.connectionDelay,this._socketInitializing=!1,this._openSocket())},_onSocketMessage:function(t){if("string"!=typeof t.data)return void e.warn("non string messages aren't supported");var n=JSON.parse(t.data);switch(n.tag){case r.GROUP_MATCH:o.sumGlobal({matchMessagesReceived:1}),radio("receivedGroupMatchEvent").broadcast(n);break;case r.FILE_INFO:radio("receivedFileInfo").broadcast(n);break;case r.SDP:radio("receivedSDP").broadcast(n);break;case r.GROUP_SDP:o.sumGlobal({sdpMessagesReceived:1}),radio("receivedGroupSDP").broadcast(n);break;case r.SWARM_ERROR:radio("swarmError").broadcast(n)}},sendData:function(e){var t=this.socket.send(e);return this.lastPingTimestamp=Date.now(),t},sendDataWithRetries:function(t,n){try{return this.sendData(t)}catch(a){e.info("cant send data - socket is not open",a);var r,i=this;"function"==typeof n?r=function(){if(n())return i.sendDataWithRetries(t,n)}:n&&(r=function(){i.sendDataWithRetries(t,!0)}),this._openSocket(r)}},sendMessage:function(e,t){return this.sendDataWithRetries(JSON.stringify(e),t)}})}()}).call(t,n(1))},function(e,t){"use strict";function n(){}function r(){for(var e,t=Math.random(),n=0;n<o.length;n++)if(t<o[n].tr){e=o[n];break}var r=e.from+Math.random()*(e.to-e.from);return r}var i=[{sdp:"v=0\no=- 395422344943089 2 IN IP4 127.0.0.1\ns=-\nt=0 0\na=msid-semantic: WMS\nm=application 9 DTLS/SCTP 5000\nc=IN IP4 0.0.0.0\na=ice-ufrag:DABd\na=ice-pwd:SGoOIwXt/HM/kMeXGv2xZSAO\na=fingerprint:sha-256 74:AE:62:C0:D8:E4:7B:8E:70:B2:BE:DA:C5:51:E2:1C:FD:57:26:61:50:79:D7:10:C2:69:70:27:6B:50:EF:91\na=setup:actpass\na=mid:data\na=sctpmap:5000 webrtc-datachannel 1024\n",type:"offer"},{candidate:"candidate:1178812653 1 udp 2113937151 192.168.1.9 56060 typ host generation 0 ufrag DABd network-cost 50",sdpMLineIndex:0,sdpMid:"data"},{candidate:"candidate:842163049 1 udp 1677729535 77.139.183.253 56060 typ srflx raddr 192.168.1.9 rport 56060 generation 0 ufrag DABd network-cost 50",sdpMLineIndex:0,sdpMid:"data"}],a=[{sdp:"v=0\no=- 7150939944418278371 2 IN IP4 127.0.0.1\ns=-\nt=0 0\na=msid-semantic: WMS\nm=application 9 DTLS/SCTP 5000\nc=IN IP4 0.0.0.0\nb=AS:1638400\na=ice-ufrag:UDM6\na=ice-pwd:K3qS2iHjp6JUl/9Y5CD/i+UI\na=fingerprint:sha-256 86:4B:EF:E1:D5:55:61:E1:E6:58:9D:A4:1E:6A:D0:55:0A:90:3A:16:17:52:F3:F4:47:C4:55:82:AB:AF:AB:BD\na=setup:active\na=mid:data\na=sctpmap:5000 webrtc-datachannel 1024\n",type:"answer"},{candidate:"candidate:1178812653 1 udp 2113937151 192.168.1.9 56060 typ host generation 0 ufrag DABd network-cost 50",sdpMLineIndex:0,sdpMid:"data"},{candidate:"candidate:842163049 1 udp 1677729535 77.139.183.253 56060 typ srflx raddr 192.168.1.9 rport 56060 generation 0 ufrag DABd network-cost 50",sdpMLineIndex:0,sdpMid:"data"}],o=[{from:0,to:20,tr:.0616},{from:21,to:50,tr:.133},{from:51,to:170,tr:.2773},{from:171,to:590,tr:.5183},{from:591,to:1890,tr:.897},{from:1891,to:86400,tr:1}];e.exports=function(e,t,o){function s(){return!1}function u(){g.groupSdp(f,p,i),m++}function c(){g.groupSdp(f,p,a),m++}function l(){v++,0===m&&c(),1===v&&(d(),setTimeout(h,1e3*r()))}function d(){radio("connectionReady").broadcast(p)}function h(){radio("connectionFailed").broadcast(p)}var f=e.id,p=t,g=e.signaller,v=0,m=0;return{queue:n,isFull:s,setupCall:u,handleMessage:l,initiator:o,targetId:p}}},function(e,t,n){"use strict";function r(){var e=Object.keys(a.A_B_TEST),t=null;return e.forEach(function(e){var n=a.A_B_TEST[e].length;return t&&n!==t?(o.error("A/B test config values do not match in length"),null):void(t=n)}),t}function i(){var e=r();if(!e)return"";var t=Object.keys(a.A_B_TEST),n=Math.floor(Math.random()*e),i=a.A_B_TEST.EXP_ID&&a.A_B_TEST.EXP_ID[n]||s.charAt(n),o=Object.create(null);t.forEach(function(e){var t=a.A_B_TEST[e],r=t[n];a[e]=r,o[e]=r}),o.EXP_ID=a.A_B_GROUP_ID=i,a.A_B_INITIAL_JSON=a.A_B_CONFIG_JSON=JSON.stringify(o)}var a=n(2),o=n(4),s="ABCDEFGHIJKMNLOPQRSTUVWXY";i()},function(e,t,n){(function(e){!function(e){var t=t||function(e,t){var n={},r=n.lib={},i=function(){},a=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=a.extend({init:function(e,n){e=this.words=e||[],this.sigBytes=n!=t?n:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;if(e=e.sigBytes,this.clamp(),r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((r+i)%4);else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-8*(n%4),t.length=e.ceil(n/4)},clone:function(){var e=a.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new o.init(n,t)}}),s=n.enc={},u=s.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-8*(r%4)&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-4*(r%8);return new o.init(n,t/2)}},c=s.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-8*(r%4)&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-8*(r%4);return new o.init(n,t)}},l=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},d=r.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,a=this.blockSize,s=i/(4*a),s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0);if(t=s*a,i=e.min(4*t,i),t){for(var u=0;u<t;u+=a)this._doProcessBlock(r,u);u=r.splice(0,t),n.sigBytes-=i}return new o.init(u,i)},clone:function(){var e=a.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=d.extend({cfg:a.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);!function(){var e=t,n=e.lib,r=n.WordArray,i=n.Hasher,a=[],n=e.algo.SHA1=i.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],o=n[2],s=n[3],u=n[4],c=0;80>c;c++){if(16>c)a[c]=0|e[t+c];else{var l=a[c-3]^a[c-8]^a[c-14]^a[c-16];a[c]=l<<1|l>>>31}l=(r<<5|r>>>27)+u+a[c],l=20>c?l+((i&o|~i&s)+1518500249):40>c?l+((i^o^s)+1859775393):60>c?l+((i&o|i&s|o&s)-1894007588):l+((i^o^s)-899497514),u=s,s=o,o=i<<30|i>>>2,i=r,r=l}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+o|0,n[3]=n[3]+s|0,n[4]=n[4]+u|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[(r+64>>>9<<4)+14]=Math.floor(n/4294967296),t[(r+64>>>9<<4)+15]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=i._createHelper(n),e.HmacSHA1=i._createHmacHelper(n)}(),e.CryptoJS=t}(e)}).call(t,n(1))},function(e,t,n){(function(e){!function(e){e.DownloadMode={HYBRID:1,P2P:2,HTTP:3,DYNAMIC:4}}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(e){return e&&e.stack&&r.test(e.stack)}var r=/peer5/i,i={registerEvents:function(){var t=null;t=window.onerror,"function"!=typeof t&&(t=function(){}),window.onerror=function(r,i,a,o,s){if(n(s)){e.error('Uncaught exception: "'+r+'" url:"'+i+'" line: '+a+" col: "+o,s);var u=radio("unhandledError");u.broadcast.apply(u,arguments)}t.apply(window,arguments)}}};i.registerEvents(),t.errorHandler=i}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n={readFileInSlices:function(t,n,r,i){var a,o=new FileReader,s=0;o.onloadend=function(u){u.target.readyState==FileReader.DONE&&i(t,u.target.result,function(){s++,(s+1)*r<n.size?(a=n.slice(s*r,(s+1)*r),1==o.readyState&&e.error("onloadend in file: "+n+" readyState==1"),o.readAsArrayBuffer(a)):s*r<n.size?(a=n.slice(s*r,n.size),o.readAsArrayBuffer(a)):i(t)})},a=n.slice(s*r,(s+1)*r),o.readAsArrayBuffer(a)}};t.fileHandler=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(e){function t(){function e(e,t){n[e]=t}function t(e){return n[e]}var n=Object.create(null);return{addMapping:e,getLength:t}}e.HashUrlLengthMap=t()}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(8);!function(n){var r=function(){function n(e){var t=e.split("?")[0],n=t.split("/");return n[n.length-1]="",n.join("/")}function r(e){var t=document.createElement("a");return t.href=e,t.protocol+"//"+t.hostname}function i(e,t){var n=e.split("/"),r=t.split("/");n.pop();for(var i=0;i<r.length;i++)"."!=r[i]&&(".."==r[i]?n.pop():n.push(r[i]));return n.join("/").trim()}function a(a,o){o=o.toString();var s=n(a),u=r(a),c=o.split("\n"),l=c.filter(function(e){return"#"!==e[0]&&""!==e}),d=l.map(function(n){return"/"===n[0]?n=u+n:s&&n.indexOf(s)===-1&&n.indexOf("://")===-1&&(n=i(s,n)),e.config.ZIXI_DIGEST&&(n=t.zixi(n)),n});return d}function o(e){e=e.toString();var t=e.split("\n"),n=t.filter(function(e){return e.indexOf("#EXTINF")!==-1}).map(function(e){var t=e.indexOf(",");return t===-1?Number(e.substring(8)):Number(e.substring(8,t))});return n}function s(e){for(var t,n,r=e.toString().split("\n"),i=0;i<r.length;i++)if(t=r[i],t.indexOf("#EXT-X-MEDIA-SEQUENCE:")>-1){n=t;break}var a=0;void 0!==n&&(a=+n.substr(22));var o=r.filter(function(e){return e.indexOf("#EXTINF")!==-1}).map(function(e,t){return a+t});return o}function u(r,i){var a=n(r),o=i.split("\n"),s=o.filter(function(e){return e=e.trim(),0!==e.indexOf("#")&&!!e.match(/\.(m3u8)/)}),u=s.map(function(n){return a&&n.indexOf(a)===-1&&n.indexOf("://")===-1&&(n=a+n),e.config.ZIXI_DIGEST&&(n=t.zixi(n)),n});return u}function c(e,t){var n=u(e,t);if(n&&n.length>0){for(var r=Object.create(null),i=0;i<n.length;i++){var c=n[i];r[c]=null}return r}var d=a(e,t),h=o(t),f=s(t),p=l(t)?"live":"vod",g={segments:d,durations:h,seqs:f,mode:p},v={};return v[e]=g,v}function l(e){return e=e.toString(),e.indexOf("#EXT-X-ENDLIST")===-1}return{extractPlaylistsData:c,isLiveMod:l,protocol:"hls"}},i=r();n.M3U8PlaylistParser=i}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n=function(t){function n(t,n){var r=t.querySelector("MPD").getAttribute("suggestedPresentationDelay");if(r){var i=e.core.util.durationToSeconds(r);i<0&&(i=0),n=Math.min(n,i)}for(var a=null,o=t.querySelectorAll("SegmentTemplate"),s=0;s<o.length;s++){var u=o[s],c=u.getAttribute("startNumber");if(c&&c>0){a=t;var l=u.getAttribute("duration"),d=u.getAttribute("timescale"),h=d?l/d:l,f=Math.floor(n/h),p=Math.max(0,c-f);u.setAttribute("startNumber",p)}}return a}function r(e,t){var n=e.documentElement.getAttribute("availabilityStartTime");if(!n)return e;var r=new Date(n);return r.setSeconds(r.getSeconds()+t),e.documentElement.setAttribute("availabilityStartTime",r.toISOString()),e}function i(e,t){var i=n(e,t);return i?i:r(e,t)}function a(e,t){for(var n=e.getAttribute("d"),r=e.getAttribute("r")||0;r>=0&&t>0;)t-=n,r--;return e.setAttribute("r",r),t}function o(e,t){for(var n=e.getAttribute("timescale"),r=t*n,i=e.querySelector("SegmentTimeline"),o=i.querySelectorAll("S");r>0&&o.length>0;){var s=o[o.length-1];if(r=a(s,r),s.getAttribute("r")<0){if(!(o.length>1)){s.setAttribute("r",0);break}i.removeChild(s)}o=i.querySelectorAll("S")}}function s(e,t){for(var n=e.querySelectorAll("SegmentTemplate"),r=0;r<n.length;r++){var i=n[r];o(i,t)}return e}function u(e,t){for(var n=Number(e.getAttribute("duration")),r=e.getAttribute("timescale"),i=r?Number(r):1,a=n/i,o=Math.floor(t/a),s=e.querySelectorAll("SegmentURL"),u=s.length>o?o:s.length-1,c=s.length-1;u>0;c--,u--)e.removeChild(s[c])}function c(e,t){for(var n=e.querySelectorAll("SegmentList"),r=0;r<n.length;r++){var i=n[r];u(i,t)}return e}function l(e,t){var n=e.documentElement.outerHTML;return n.indexOf("$Time$")!==-1&&(e=s(e,t)),n.indexOf("$Number$")!==-1&&(e=i(e,t)),n.indexOf("SegmentList")!==-1&&(e=c(e,t)),e.documentElement.outerHTML}function d(t,n,r){var i=r-e.config.SEGMENTS_AFTER_PRUNE+1;if(i<=0)return t;var a=t.indexOf(n[0])-1,o=t.indexOf(n[i])-1,s=t.slice(0,a),u=t.slice(o),c=s.concat(u);return c=c.map(function(e){if(e.indexOf("#EXT-X-MEDIA-SEQUENCE")!==-1){var t=+e.match(/\d+/)[0];e="#EXT-X-MEDIA-SEQUENCE:"+(t+i)}return e})}function h(t){if(e.config.EXTERNAL_MEDIA_LIVE_START_POS&&e.config.EXTERNAL_MEDIA_LIVE_START_POS!==-1)return p;var n=e.core.util.M3U8PlaylistParser.extractPlaylistsData("",p)[""];if(!n||"live"!==n.mode)return p;if(!n||void 0===n.durations)return p;for(var r=0,i=n.durations.length;r<t&&i>0;)r+=n.durations[i-1],i--;if(i=Math.max(i,e.config.MIN_NUMBER_OF_REMAINING_SEGMENTS),n.segments.length<=i)return p;var a,o=p.split("\n").map(function(e){return","===e[e.length-1]?e.substring(0,e.length-1):e}),s=n.segments[i],u=o.indexOf(s)-1,c=o.slice(0,u);return a=e.config.FEATURE_PRUNE_SEGMENTS_FROM_START?d(c,n.segments,i-1):c,""===o[o.length-1]&&""!==a[a.length-1]&&a.push(""),a.join("\n")}function f(e){if("string"!=typeof p||!p||0===p.length||0===e)return p;if(p.indexOf("#EXTM3U")>-1)return h(e);var t=new DOMParser,n=t.parseFromString(p,"application/xml"),r=n.querySelector("MPD");if(r&&"dynamic"===r.getAttribute("type")){var i=l(n,e);return i}return p}var p=t;return{delayManifest:f}};t.ManifestManipulator=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){window=window||self,function(t){t.loadScript=function(e,t){var n=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.src=e,r.onreadystatechange=t,r.onload=t,n.appendChild(r)},t.isObjectEmpty=function(e){for(var t in e)if(e[t])return!1;return!0},t.envokeCallback=function(e,n,r){r=r||window,e&&"function"==typeof e&&t.asyncDefer(function(){e.apply(r,n)})},t.envokeCallbackSync=function(e,t,n){n=n||window,e&&"function"==typeof e&&e.apply(n,t)},t.executeFunctionByName=function(e,t,n){for(var r=e.split("."),i=r.pop(),a=0;a<r.length;a++)t=t[r[a]];return t[i].apply(t,n)},t.uint8ToString=function(e){for(var t=32768,n=[],r=0;r<e.length;r+=t)n.push(String.fromCharCode.apply(null,e.subarray(r,r+t)));return n.join("")},t.overrideNative=function(){var e=Math.floor;Math.floor=function(t){var n=t;if(!isNaN(n))return e(t)};var t=Math.ceil;Math.ceil=function(e){var n=e;if(!isNaN(n))return t(e)};var n=Math.round;Math.round=function(e){var t=e;if(!isNaN(t))return n(e)}},t.parseResponseHeaders=function(e){var t={};if(!e)return t;for(var n=e.split("\r\n"),r=0;r<n.length;r++){var i=n[r],a=i.indexOf(": ");if(a>0){var o=i.substring(0,a).toLocaleLowerCase(),s=i.substring(a+2);t[o]=s}}return t},t.parseResponseLengthHeader=function(e,t){return e&&2==e.split("/").length?parseInt(e.split("/")[1]):t?parseInt(t):void 0};var n={},r=0;window.addEventListener("message",function(e){if(e.data&&"string"==typeof e.data&&e.data.indexOf("peer5")!==-1){var t=e.data.substr(6);void 0!==n[t]&&(n[t][0].apply(n[t][1]),delete n[t])}}),t.asyncDefer=function(e,t){r++,n[r]=[e,t],window.postMessage("peer5/"+r,location.href)},t.removeSubDomain=function(e){var t=e.split(".");return t.shift(),t.join(".")},t.durationToSeconds=function(e){function t(e){if(!e)return 0;var t=e.substring(0,e.length-1);return Number(t)}var n=/P([0-9.]+Y)?([0-9.]+M)?([0-9.]+D)?T([0-9.]+H)?([0-9.]+M)?([0-9.]+S)?$/i;if(n.test(e)){var r=n.exec(e),i=0;return i+=31536e3*t(r[1]),i+=2592e3*t(r[2]),i+=86400*t(r[3]),i+=3600*t(r[4]),i+=60*t(r[5]),i+=t(r[6])}return-1},t.longestSequence=function(e){for(var t=0,n=0,r=0,i=0,a=e.slice().sort(),o=1,s=a.length;o<s;o++)a[o]===a[o-1]+1?(i++,i>r&&(r=i,t=o-i,n=o)):i=0;return a.slice(t,n+1)},t.average=function(e){for(var t=0,n=0,r=e.length;n<r;n++)t+=e[n];return t/r},e.core.util.overrideNative()}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n=e.core.util,r=function(){function t(e,t){for(var n,r,i=0;i<Math.min(e.length,t.length);i++)if(e[i]!==t[i]){n=i;break}for(var a=e.length-1,o=t.length-1;a>=0&&o>=0;a--,o--)if(e[a]!==t[o]){r=o;break}var s=t.substring(n,r+1);return Number(s)}function r(e){var t=e.split("/"),n=t[0]+"//"+t[2]+"/";return n}function i(e){if(e.mpdAvailabilityStartTime>e.manifestCreationTime)return-1;var t=e.mpdSuggestedPresentationDelay||0,n=e.mpdTimeShiftBufferDepth||0,r=e.segmentTemplate,i=r.segmentDuration/r.timescale,a=e.manifestCreationTime-(e.mpdAvailabilityStartTime+e.periodStart);if(a<0)return-1;var o=a-2*i-n;o<0&&(o=0);var s=Math.ceil(o/i)*i,u=a;if(u<0)return-1;var c=Math.floor(u/i)*i,l=c-t;l<0&&(l=0);var d,h=Math.floor(l/i)*i;d=h>=s?h:s;var f=d/i+1;return f+=e.segmentTemplate.startNumber||0}function a(e,t){for(var n=[],r=e.mediaPresentationDuration,i=0;i<e.periods.length;i++){var a=e.periods[i];if(r=a.duration||r,a.adaptationSets)for(var o=0;o<a.adaptationSets.length;o++){var s=a.adaptationSets[o];if(s.representations)for(var u=0;u<s.representations.length;u++){var c=s.representations[u];c.mpdType=e.type,c.mpdAvailabilityStartTime=e.availabilityStartTime,c.mpdSuggestedPresentationDelay=e.suggestedPresentationDelay,c.mpdTimeShiftBufferDepth=e.timeShiftBufferDepth,c.periodStart=a.start,c.periodDuration=r,c.manifestCreationTime=t,n.push(c)}}}return n}function o(e){if(e.baseUrl&&e.baseUrl.path_){var t=e.baseUrl.path_.lastIndexOf("/");return t!==-1?e.baseUrl.path_.substring(0,t+1):e.baseUrl.path_}return""}function s(e){var r=n.UrlUtils.combine(e.urlPrefix,n.UrlUtils.combine(e.segmentBaseUrl,e.staticParsedUrlTemplate)),a=Math.ceil(1800/e.normalizedSegmentDuration),o=i(e);if(o<0)return null;for(var s=o+a,u=[],c=[],l=o;l<s;l++){var d=r.replace("$Number$",l);u.push(d),c.push(l)}return u={segs:u,seqs:c,generateNextSegments:function(n){for(var i=t(r,n),o=i+1,s=o+a,u=e.segmentTemplate.segmentDuration/(e.segmentTemplate.timescale||1),c=[],l=[],d=o;d<s;d++){var h=r.replace("$Number$",d);c.push(h),l.push(d)}return{segs:c,duration:u,seqs:l}}}}function u(e){for(var t=Math.ceil(e.periodDuration/e.normalizedSegmentDuration),r=e.segmentTemplate.startNumber||1,i=r+t,a=[],o=[],s=r;s<i;s++){var u=e.staticParsedUrlTemplate.replace("$Number$",s),c=n.UrlUtils.combine(e.urlPrefix,n.UrlUtils.combine(e.segmentBaseUrl,u));a.push(c),o.push(s)}return{segs:a,seqs:o}}function c(e){var t=[],r=[],i=[];if(e.segmentTemplate&&e.segmentTemplate.timeline&&e.segmentTemplate.timeline.timePoints&&e.segmentTemplate.timeline.timePoints.length>0)for(var a=null,o=0;o<e.segmentTemplate.timeline.timePoints.length;o++){var s=e.segmentTemplate.timeline.timePoints[o],u=[],c=s.startTime||a||0;a=c+s.duration*(s.repeat||1);for(var l=c,d=0;d<(s.repeat||1);l+=s.duration,d++){var h=s.duration/(e.segmentTemplate.timescale||1);r.push(h);var f=e.staticParsedUrlTemplate.replace("$Time$",l),p=n.UrlUtils.combine(e.urlPrefix,n.UrlUtils.combine(e.segmentBaseUrl,f));u.push(p),i.push(l)}t=t.concat(u)}return{segs:t,durations:r,seqs:i}}function l(e){var t;t=e.periodDuration?u(e):s(e);for(var n=e.segmentTemplate.segmentDuration/(e.segmentTemplate.timescale||1),r=[],i=0;i<t.segs.length;i++)r.push(n);return t.durations=r,t}function d(e){var t=o(e);if(e.segmentList&&e.segmentList.segmentUrls&&e.segmentList.segmentUrls.length>0){for(var r=e.segmentList.segmentDuration/(e.segmentList.timescale||1),i=[],a=0;a<e.segmentList.segmentUrls.length;a++)i.push(r);var s=e.segmentList.segmentUrls.map(function(t){var r=n.UrlUtils.combine(e.urlPrefix,n.UrlUtils.combine(e.segmentBaseUrl,t.mediaUrl.path_));return r});return{segs:s,durations:i}}if(e.segmentTemplate&&e.segmentTemplate.mediaUrlTemplate){if(e.staticParsedUrlTemplate=e.segmentTemplate.mediaUrlTemplate.replace("$Bandwidth$",e.bandwidth).replace("$RepresentationID$",e.id),e.normalizedSegmentDuration=e.segmentTemplate.timescale?e.segmentTemplate.segmentDuration/e.segmentTemplate.timescale:e.segmentTemplate.segmentDuration,e.segmentBaseUrl=t,e.staticParsedUrlTemplate.indexOf("$Time$")!==-1)return c(e);if(e.staticParsedUrlTemplate.indexOf("$Number$")!==-1){var u=l(e);if(u)return u}return[]}return[]}function h(e,t,n){for(var r={},i=0;i<t.length;i++){var a=t[i];a.urlPrefix=e;var o=d(a),s="representation_"+i+"_"+a.id,u={segments:o.segs||[],durations:o.durations||[],seqs:o.seqs||[],mode:n,generateNextSegmentsFunc:o.generateNextSegments};r[s]=u}return r}function f(t,n){var i=e.shaka.dash.mpd.parseMpd(n,t);if(!i)return null;var o=(new Date).getTime()/1e3,s=a(i,o),u=r(t),c=p(n)?"live":"vod",l=h(u,s,c);return l}function p(t){var n=e.shaka.dash.mpd.parseMpd(t,"http://dummy.com/");return"dynamic"===n.type}return{extractPlaylistsData:f,isLiveMod:p,protocol:"dash"}},i=r();t.MPDPlaylistParser=i}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n=function(){function t(t){var n=l[t];n.idleTimeout&&clearTimeout(n.idleTimeout),n.idleTimeout=setTimeout(function(){radio("connectionIdle").broadcast({peerId:t,peerData:n})},1e3*e.config.SECONDS_BEFORE_IDLE)}function n(e){l[e]={idleTimeout:null,totalBytesReceived:0,totalDownloadTime:0,lastDownloadTimestamp:Date.now(),totalBytesSent:0,lastUploadTimestamp:Date.now(),lastSwarmReportedAsHave:null,lastHaveReportTimestamp:Date.now()},t(e)}function r(e,r){l[e]||n(e);var i=l[e];i.totalBytesSent+=r,i.lastUploadTimestamp=Date.now(),t(e)}function i(e,t){c[e]||(c[e]=Object.create(null));for(var n=0;n<t.length;n++){var r=t[n];c[e][r]=Date.now()}}function a(e,r,i){l[e]||n(e);var a=l[e],o=i.bytes,s=Date.now()-c[r][i.id];a.totalBytesReceived+=o,a.totalDownloadTime+=s,a.lastDownloadTimestamp=Date.now(),t(e)}function o(e){l[e]||n(e)}function s(e){delete l[e]}function u(e,t){
l[e]||n(e);var r=l[e];r.lastSwarmReportedAsHave=t,r.lastHaveReportTimestamp=Date.now()}var c=Object.create(null),l=Object.create(null);return{reportChunksRequestFromPeer:i,reportChunksReceivedFromPeer:a,reportUploadToPeer:r,reportPeerConnected:o,reportPeerDisconnected:s,reportPeerHaveSwarm:u}};t.PeersPerformanceTracker=n()}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){function t(t){for(;t.length>e.config.RELEVANT_LAST_ENTRIES;)t.pop()}function n(e,n,r){var i={bytes:n,speed:r};"p2p"===e?(u.unshift(i),t(u)):(c.unshift(i),t(c))}function r(t){var n=0,r=Math.min(e.config.RELEVANT_LAST_ENTRIES,t.length);if(r<=0)return 0;var i;for(i=0;i<r;i++)n+=t[i].speed;var a=n/i;return a}function i(){return r(u)}function a(){return r(c)}function o(e,t){var n,r,i;e.loadedP2P?(r=e.currentTarget._p2pBps,n="p2p",i=e.loadedP2P):e.loadedHTTP&&(r=e.currentTarget._httpBps,n="http",i=e.loadedHTTP);var a={url:e.currentTarget._url,mode:n,predictedSpeed:Math.round(r),actualSpeed:Math.round(t),bytesDownloaded:i};radio("speedEstimationCalculated").broadcast(a)}function s(t){if(t.total&&!(t.loadedP2P&&t.loadedHTTP||t.currentTarget._speed<=0)){if(t.loadedP2P)n("p2p",t.loadedP2P,t.currentTarget._speed);else{if(!t.loadedHTTP)return;n("http",t.loadedHTTP,t.currentTarget._speed)}e.config.FEATURE_DOWNLOAD_SPEED_ESTIMATION&&o(t,t.currentTarget._speed)}}var u=[],c=[];return function(){radio("downloadEnd").subscribe(s)}(),{p2pDownloadBPS:i,httpDownloadBPS:a}}radio("requestSent").subscribe(function(t){e.config.FEATURE_DOWNLOAD_SPEED_ESTIMATION&&(t._p2pBps=e.core.util.DownloadSpeedEstimator.p2pDownloadBPS(),t._httpBps=e.core.util.DownloadSpeedEstimator.httpDownloadBPS()),["load","abort"].forEach(function(e){t.addEventListener(e,function(t){t._event=e,radio("downloadEnd").broadcast(t)})})}),t.DownloadSpeedEstimator=n()}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){var n=function(){function t(e){var t=e._url.indexOf(".mpd")>-1&&"arraybuffer"===e.responseType;if(!t&&e.responseType&&"text"!==e.responseType)return!1;var r=e._url;return!!n(r)}function n(t){return t.indexOf("m3u8")>-1?e.core.util.M3U8PlaylistParser:t.indexOf("mpd")>-1?e.core.util.MPDPlaylistParser:null}return{isPlaylistCandidate:t,getParser:n}},r=n();t.PlaylistParserFactory=r}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(e){function t(){function e(e,t){i[e]=t}function t(e){return i[e]}function n(e){i[e]=null}function r(){i=Object.create(null)}var i=Object.create(null);return{save:e,load:t,remove:n,clear:r}}e.createPlaylistCache=t}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){var t=n(7);!function(n){function r(n,r){function s(t,n){e.info("prefetching "+t.segment+" in p2p"),t.downloadMode="p2p";var r={onswarmstatechange:function(e){b.requestSwarmStateChanged(e)},onerror:function(e){T.reportRequestDone(i),n()},onabort:function(e){T.reportRequestDone(o),y.onRequestEvent("abort",e),n()},onload:function(e){T.reportRequestDone(a),y.onRequestEvent("load",e),200===e.currentTarget.status&&b.saveDownloadSpeed(e.currentTarget),n()}},s=e.core.util.PrefetchRequestSender(t,r),u=s.send();return T.useP2PSlot(),R[u._segmentData.segment]=u,u}function u(n){var r=new t;r.open("GET",n),r.onloadend=function(){if(this.status>=200&&this.status<300&&this.response){var t=e.core.util.PlaylistParserFactory.getParser(n),r=t.extractPlaylistsData(n,this.response),i=Object.keys(r),a=r[i[0]];if(a){S.extractSegments(n,this.response),a.rawContent=this.response,a.manifestUrl=n;var o=t.isLiveMod(this.response);o?f(a):(w.save(n,this.response),g(a))}else w.save(n,this.response),u(i[0])}},r.send()}function c(){var t=e.core.util.ManifestManipulator(E.rawContent),n=t.delayManifest(e.config.LIVE_SECONDS_DELAY);w.save(E.manifestUrl,n);var r=e.core.util.PlaylistParserFactory.getParser(E.manifestUrl),i=r.extractPlaylistsData(E.manifestUrl,n),a=Object.keys(i),o=i[a[0]];return o}function l(t){var n=t.segments;if(!n||0===n.length)return e.warn("delayed manifest shouldnt be empty"),null;for(var r=null,i=0;i<e.config.PLAYER_SEGMENTS_BUFFER&&n.length>0;i++)r=n.pop();return r}function d(){var e=c(),t=l(e);if(!t)return 0;for(var n=E.segments.indexOf(t),r=0,i=n;i<E.segments.length;i++){var a=y.getAvgDownloadTime(E.manifestUrl),o=E.durations[i],s=o*a;if(r>=s)break;r+=o}return i}function h(){if(!P){for(var e=null,t=d();t<E.segments.length&&(e=E.segments[t],R[e]);t++);if(e)for(var n=v(e),r=T.availableP2PSlots();t<E.segments.length&&r>0;t++){var i=n.segmentsData.shift();s(i,function(){h()}),r--}}}function f(t){E=t,h(),P||setTimeout(function(){u(t.manifestUrl)},e.config.PREFETCH_LIVE_INTERVAL_MS)}function p(e){if(!P)for(var t=T.availableP2PSlots();t>0&&e.length>0;){var n=e.shift();s(n,function(){p(e)}),t--}}function g(e){if(e.segments&&0!==e.segments.length){var t=e.segments[0],n=v(t);p(n.segmentsData)}}function v(t){var n=S.getSegmentData(t);S.setLastRequestedSegment(t);var r=S.getNextSegmentsDataWindow(e.config.SEGMENTS_TO_PREFETCH_BEFORE_PLAY);return r.segmentsData.unshift(n),r}function m(t){u(t),setTimeout(function(){_(),w.clear()},1e3*e.config.STOP_PREFETCH_AFTER_SECONDS)}function _(){P=!0,Object.keys(R).forEach(function(e){var t=R[e];4!==t.readyState&&t.abort()})}var E,b=r,S=n.playlistsHandler,T=n.prefetchSlotsHandler,y=n.prefetchSpeedEstimator,R=Object.create(null),w=n.playlistsCache,P=!1;return{startPrefetch:m,stopPrefetch:_}}var i="error",a="load",o="abort";n.prePlayPrefetcher=r}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(t,n){function r(e){var t={type:"fileDownloaded",url:e.currentTarget._url,loaded:e.loaded,p2p:e.loadedP2P,http:e.loadedHTTP,waste:e.loadedP2P+e.loadedHTTP-e.total,fileSize:e.total,downloadTimeMS:Date.now()-e.currentTarget.timestamp};window.P2PPerformanceUpdate&&window.P2PPerformanceUpdate(t)}function i(){var t=new e.VideoRequest({downloadMode:o.downloadMode||"p2p",origin:"preload"}),n=o.segment;return t._segmentData=o,t.mediaPrefetch=!0,t.responseType="arraybuffer",t.open("GET",n),t.onswarmstatechange=function(e){s.onswarmstatechange&&s.onswarmstatechange(e)},t.onerror=function(t){e.info("onerror prefetching resource: "+n),s.onerror&&s.onerror(t)},t.onabort=function(e){s.onabort&&s.onabort(e)},t.onload=function(t){e.info(t),e.info("onload "+n),r(t),s.onload&&s.onload(t)},e.info("requesting "+n),t}function a(){return u.send(),u}var o=t,s=n,u=i();return{send:a}}t.PrefetchRequestSender=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(t){function n(){S++,S>=e.config.ADD_SLOT_LOADED_REQUESTS_THRESHOLD&&b&&l()}function o(){S=0}function s(){T++,T>=e.config.REDUCE_SLOT_ABORTS_THRESHOLD&&d()}function u(){T=0}function c(e){switch(p(),e){case r:o();break;case a:s(),o();break;case i:n()}}function l(){if(e.config.FEATURE_LIMIT_SLOTS_BY_PEERS){var t=g(),n=_();n>t&&(y.availableP2PSlots++,b=!1,u(),o())}else y.availableP2PSlots++,b=!1,u(),o()}function d(){var t=g();t<=e.config.MINIMUM_P2P_SLOTS||(y.availableP2PSlots--,u(),o())}function h(t){if(e.config.FEATURE_LIMIT_SLOTS_BY_PEERS){if(0===t)return;var n=g();if(n<=t)return;var r=Math.min(n-t,n-e.config.MINIMUM_P2P_SLOTS);y.availableP2PSlots-=r,u(),o()}}function f(){y.availableP2PSlots--,E++}function p(){y.availableP2PSlots++,E--}function g(){var e=y.availableP2PSlots+E;return e}function v(){return y.availableP2PSlots}function m(){b=!0}var _=t,E=0,b=!1,S=0,T=0,y={availableP2PSlots:e.config.INITIAL_P2P_SLOTS};return function(){radio("activePeerConnectionsNumberChanged").subscribe([h,this])}(),{availableP2PSlots:v,useP2PSlot:f,askForP2PSlot:m,reportRequestDone:c}}var r="error",i="load",a="abort";t.PrefetchSlotsHandler=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(){function t(t,n){var i=t.segmentData.playlistName,o=t.segmentData.duration,s=n/1e3;a[i]||(a[i]=[]),a[i].unshift({duration:o,downloadTime:s}),a[i].length>r&&a[i].splice(e.config.TIME_ESTIMATION_LIST_LENGTH,e.config.TIME_ESTIMATION_LIST_LENGTH)}function n(t){if(!a[t]||0===a[t].length)return e.config.INITIAL_DL_SECS_ESTIMATION;for(var n=a[t],r=0,i=0,o=0;o<Math.min(e.config.TIME_ESTIMATION_LIST_LENGTH,n.length);o++){var s=n[o];r+=s.duration,i+=s.downloadTime}var u=i/r;return u}function i(e,n){var r=n.currentTarget,i=Date.now()-r._startTime;if("load"===e)t(r._segmentData,i);else if("abort"===e){var a=n.total?n.loadedP2P/n.total:0;if(0===a)return;var o=i/a;t(r._segmentData,o)}}var a=Object.create(null);return{onRequestEvent:i,getAvgDownloadTime:n}}var r=2*e.config.TIME_ESTIMATION_LIST_LENGTH;t.PrefetchSpeedEstimator=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(t){function n(t,n){function o(t){t.downloadMode="p2p";var n={onswarmstatechange:function(e){g.requestSwarmStateChanged(e)},onerror:function(e){m.reportRequestDone(r),g.onP2PPrefetchComplete()},onabort:function(e){m.reportRequestDone(a),g.onP2PPrefetchComplete(),_.onRequestEvent("abort",e)},onload:function(e){m.reportRequestDone(i),g.onP2PPrefetchComplete(),_.onRequestEvent("load",e),200===e.currentTarget.status&&g.saveDownloadSpeed(e.currentTarget)}},o=e.core.util.PrefetchRequestSender(t,n),s=o.send();return m.useP2PSlot(),E[s._segmentData.segment]=s,s}function s(){if(!b||!b.segmentData)return 0;var e=b.segmentData.duration,t=(Date.now()-b.segmentData.playerAskTime)/1e3,n=e-t;return n}function u(e,t){var n=0;t.forEach(function(e){E[e.segment]||n++}),n>e&&m.askForP2PSlot()}function c(t){if(t)for(var n=s(),r=e.config.EXTERNAL_MEDIA_MAXBUFFER-n;r>0&&t.length>0;){var i=t.shift();S[i.segment]=!0,r-=i.segmentData.duration}}function l(e,t){if(S[e.segment])return null;var n=e.segmentData.duration,r=e.segmentData.playlistName,i=_.getAvgDownloadTime(r),a=i*n;if(a*=1.15,null===t||t>a){var s=g.getSeeders(e.segment),u=s?Object.keys(s).length:0;if(u>0&&!E[e.segment]){var c=o(e);return{xhr:c,url:e.segment}}}return null}function d(t){var n=m.availableP2PSlots();if(0===n)return e.warn("no available p2p slots for too long"),null;for(var r=t.length-1;r>=0;r--){var i=t[r],a=l(i,null);if(a)return a}return null}function h(){var t=v.getNextSegmentsDataWindow(e.config.P2P_VOD_WINDOW);if(!t||0===t.segmentsData.length)return[];var n=t.segmentsData,r=m.availableP2PSlots();u(r,n);for(var i=s(),a=[],o=0,c=0;o<r&&c<n.length;c++){var h=n[c],f=l(h,i);f&&(a.push(f),o++),i+=h.segmentData.duration}if(0===a.length){var p=d(n);p&&a.push(p)}return a}function f(){var t=v.getNextSegmentsDataWindow(e.config.P2P_VOD_WINDOW);c(t.segmentsData)}function p(e){v.setLastRequestedSegment(e),T&&(f(),T=!1);var t=v.getSegmentData(e);t.segmentData.playerAskTime=Date.now(),b=t,delete E[t.segment]}var g=n,v=t.playlistsHandler,m=t.prefetchSlotsHandler,_=t.prefetchSpeedEstimator,E=Object.create(null),b=null,S=Object.create(null),T=!0;return{prefetchSegments:h,updatePlayerLastRequestedSegment:p}}var r="error",i="load",a="abort";t.SegmentsPrefetcher=n}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(t){"use strict";var n={};n.randomKFromN=function(e,t){var n=[];if(e>t){for(var r=0;r<=t;r++)n.push(r);return n}for(;n.length<e;){for(var i=Math.ceil(Math.random()*(t+1))-1,a=!1,r=0;r<n.length;r++)if(n[r]==i){a=!0;break}a||n.push(i)}return n},n.randSample=function(e,t){if(0==e.length)return e;var r=n.randomKFromN(t,e.length-1);return n.sampleIndexes(e,r)},n.sampleIndexes=function(e,t){for(var n=[],r=0;r<t.length;r++)n.push(e[t[r]]);return n},n.shuffle=function(e){var t,n,r=e.length;if(r)for(;--r;)n=Math.floor(Math.random()*(r+1)),t=e[n],e[n]=e[r],e[r]=t;return e},n.randomOffset=function(e,t,n){for(var r=(t-e)/n,i=[],a=0;a<=r;a++)for(var o=0;o<=a;o++)i.push(a);var s=i.length,u=Math.floor(Math.random()*s);return i[u]*n+e},Object.keys(n).forEach(function(e){t.core.util[e]=n[e]}),e.exports=n}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.DataViewReader=function(t,n){this.dataView_=t,this.littleEndian_=n==e.shaka.util.DataViewReader.Endianness.LITTLE_ENDIAN,this.position_=0},e.shaka.util.DataViewReader.Endianness={BIG_ENDIAN:0,LITTLE_ENDIAN:1},e.shaka.util.DataViewReader.prototype.hasMoreData=function(){return this.position_<this.dataView_.byteLength},e.shaka.util.DataViewReader.prototype.getPosition=function(){return this.position_},e.shaka.util.DataViewReader.prototype.getLength=function(){return this.dataView_.byteLength},e.shaka.util.DataViewReader.prototype.readUint8=function(){try{var e=this.dataView_.getUint8(this.position_)}catch(e){this.throwOutOfBounds_()}return this.position_+=1,e},e.shaka.util.DataViewReader.prototype.readUint16=function(){try{var e=this.dataView_.getUint16(this.position_,this.littleEndian_)}catch(e){this.throwOutOfBounds_()}return this.position_+=2,e},e.shaka.util.DataViewReader.prototype.readUint32=function(){try{var e=this.dataView_.getUint32(this.position_,this.littleEndian_)}catch(e){this.throwOutOfBounds_()}return this.position_+=4,e},e.shaka.util.DataViewReader.prototype.readUint64=function(){var e,t;try{this.littleEndian_?(e=this.dataView_.getUint32(this.position_,!0),t=this.dataView_.getUint32(this.position_+4,!0)):(t=this.dataView_.getUint32(this.position_,!1),e=this.dataView_.getUint32(this.position_+4,!1))}catch(e){this.throwOutOfBounds_()}if(t>2097151)throw new shaka.util.Error(shaka.util.Error.Category.MEDIA,shaka.util.Error.Code.JS_INTEGER_OVERFLOW);return this.position_+=8,t*Math.pow(2,32)+e},e.shaka.util.DataViewReader.prototype.readBytes=function(e){this.position_+e>this.dataView_.byteLength&&this.throwOutOfBounds_();var t=this.dataView_.buffer.slice(this.position_,this.position_+e);return this.position_+=e,new Uint8Array(t)},e.shaka.util.DataViewReader.prototype.skip=function(e){this.position_+e>this.dataView_.byteLength&&this.throwOutOfBounds_(),this.position_+=e},e.shaka.util.DataViewReader.prototype.readTerminatedString=function(){for(var t=this.position_;this.hasMoreData();){var n=this.dataView_.getUint8(this.position_);if(0==n)break;this.position_+=1}var r=this.dataView_.buffer.slice(t,this.position_);return this.position_+=1,e.shaka.util.StringUtils.fromUTF8(r)},e.shaka.util.DataViewReader.prototype.throwOutOfBounds_=function(){throw new shaka.util.Error(shaka.util.Error.Category.MEDIA,shaka.util.Error.Code.BUFFER_READ_OUT_OF_BOUNDS)}}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.LanguageUtils.match=function(t,n,r){e.shaka.util.LanguageUtils;return r==n||(t>=e.shaka.util.LanguageUtils.MatchType.BASE_LANGUAGE_OKAY&&r==n.split("-")[0]||t>=e.shaka.util.LanguageUtils.MatchType.OTHER_SUB_LANGUAGE_OKAY&&r.split("-")[0]==n.split("-")[0])},e.shaka.util.LanguageUtils.MatchType={EXACT:0,BASE_LANGUAGE_OKAY:1,OTHER_SUB_LANGUAGE_OKAY:2,MIN:0,MAX:2},e.shaka.util.LanguageUtils.normalize=function(t){var n=t.toLowerCase().split("-"),r=n[0],i=e.shaka.util.LanguageUtils.isoMap_[r];return i&&(n[0]=i),n.join("-")},e.shaka.util.LanguageUtils.isoMap_={aar:"aa",abk:"ab",afr:"af",aka:"ak",alb:"sq",amh:"am",ara:"ar",arg:"an",arm:"hy",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bak:"ba",bam:"bm",baq:"eu",bel:"be",ben:"bn",bih:"bh",bis:"bi",bod:"bo",bos:"bs",bre:"br",bul:"bg",bur:"my",cat:"ca",ces:"cs",cha:"ch",che:"ce",chi:"zh",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",cze:"cs",dan:"da",deu:"de",div:"dv",dut:"nl",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fij:"fj",fin:"fi",fra:"fr",fre:"fr",fry:"fy",ful:"ff",geo:"ka",ger:"de",gla:"gd",gle:"ga",glg:"gl",glv:"gv",gre:"el",grn:"gn",guj:"gu",hat:"ht",hau:"ha",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ice:"is",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",ipk:"ik",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lin:"ln",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mac:"mk",mah:"mh",mal:"ml",mao:"mi",mar:"mr",may:"ms",mkd:"mk",mlg:"mg",mlt:"mt",mon:"mn",mri:"mi",msa:"ms",mya:"my",nau:"na",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nor:"no",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",per:"fa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",rum:"ro",run:"rn",rus:"ru",sag:"sg",san:"sa",sin:"si",slk:"sk",slo:"sk",slv:"sl",sme:"se",smo:"sm",sna:"sn",snd:"sd",som:"so",sot:"st",spa:"es",sqi:"sq",srd:"sc",srp:"sr",ssw:"ss",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tib:"bo",tir:"ti",ton:"to",tsn:"tn",tso:"ts",tuk:"tk",tur:"tr",twi:"tw",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",vol:"vo",wel:"cy",wln:"wa",wol:"wo",xho:"xh",yid:"yi",yor:"yo",zha:"za",zho:"zh",zul:"zu"}}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.Mp4Parser.findBox=function(t,n){for(;n.hasMoreData();){var r=n.getPosition(),i=n.readUint32(),a=n.readUint32();if(1==i?i=n.readUint64():0==i&&(i=n.getLength()-r),a==t)return i;n.skip(i-(n.getPosition()-r))}return e.shaka.util.Mp4Parser.BOX_NOT_FOUND},e.shaka.util.Mp4Parser.findSampleDescriptionBox=function(t,n){for(var r=new e.shaka.util.DataViewReader(new DataView(t),e.shaka.util.DataViewReader.Endianness.BIG_ENDIAN),i=e.shaka.util.Mp4Parser,a=[[i.BOX_TYPE_MOOV,0],[i.BOX_TYPE_TRAK,0],[i.BOX_TYPE_MDIA,0],[i.BOX_TYPE_MINF,0],[i.BOX_TYPE_STBL,0],[i.BOX_TYPE_STSD,8],[n,0]],o=i.BOX_NOT_FOUND,s=0;s<a.length;s++){var u=a[s][0],c=a[s][1];if(o=i.findBox(u,r),o==i.BOX_NOT_FOUND)return i.BOX_NOT_FOUND;r.skip(c)}return o},e.shaka.util.Mp4Parser.BOX_NOT_FOUND=-1,e.shaka.util.Mp4Parser.BOX_TYPE_MDAT=1835295092,e.shaka.util.Mp4Parser.BOX_TYPE_MOOV=1836019574,e.shaka.util.Mp4Parser.BOX_TYPE_TRAK=1953653099,e.shaka.util.Mp4Parser.BOX_TYPE_MDIA=1835297121,e.shaka.util.Mp4Parser.BOX_TYPE_MINF=1835626086,e.shaka.util.Mp4Parser.BOX_TYPE_STBL=1937007212,e.shaka.util.Mp4Parser.BOX_TYPE_STSD=1937011556}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.dash.mpd.parseMpd=function(t,n){var r=new DOMParser,i=r.parseFromString(t,"text/xml");if(!i)return null;var a={baseUrl:new e.goog.Uri(n)};return e.shaka.dash.mpd.parseChild_(a,i,e.shaka.dash.mpd.Mpd)},e.shaka.dash.mpd.DEFAULT_MIN_BUFFER_TIME_=5,e.shaka.dash.mpd.DEFAULT_SUGGESTED_PRESENTATION_DELAY_=1,e.shaka.dash.mpd.Mpd=function(){this.url=null,this.id=null,this.type="static",this.baseUrl=null,this.updateLocation=null,this.mediaPresentationDuration=null,this.minBufferTime=e.shaka.dash.mpd.DEFAULT_MIN_BUFFER_TIME_,this.minUpdatePeriod=null,this.availabilityStartTime=null,this.timeShiftBufferDepth=null,this.suggestedPresentationDelay=e.shaka.dash.mpd.DEFAULT_SUGGESTED_PRESENTATION_DELAY_,this.periods=[]},e.shaka.dash.mpd.Period=function(){this.id=null,this.start=null,this.duration=null,this.baseUrl=null,this.segmentBase=null,this.segmentList=null,this.segmentTemplate=null,this.adaptationSets=[]},e.shaka.dash.mpd.AdaptationSet=function(){this.id=null,this.lang=null,this.contentType=null,this.width=null,this.height=null,this.mimeType=null,this.codecs=null,this.main=!1,this.baseUrl=null,this.segmentBase=null,this.segmentList=null,this.segmentTemplate=null,this.contentProtections=[],this.representations=[]},e.shaka.dash.mpd.Role=function(){this.value=null},e.shaka.dash.mpd.ContentComponent=function(){this.id=null,this.lang=null,this.contentType=null},e.shaka.dash.mpd.Representation=function(){this.id=null,this.lang=null,this.bandwidth=null,this.width=null,this.height=null,this.mimeType=null,this.codecs=null,this.baseUrl=null,this.segmentBase=null,this.segmentList=null,this.segmentTemplate=null,this.contentProtections=[]},e.shaka.dash.mpd.ContentProtection=function(){this.schemeIdUri=null,this.value=null,this.children=[],this.pssh=null},e.shaka.dash.mpd.CencPssh=function(){this.psshBox=null,this.parsedPssh=null},e.shaka.dash.mpd.BaseUrl=function(){this.url=null},e.shaka.dash.mpd.Location=function(){this.url=null},e.shaka.dash.mpd.SegmentBase=function(){this.baseUrl=null,this.timescale=1,this.presentationTimeOffset=null,this.indexRange=null,this.representationIndex=null,this.initialization=null},e.shaka.dash.mpd.SegmentBase.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.SegmentBase;return n.baseUrl=this.baseUrl?new e.goog.Uri(this.baseUrl):null,n.timescale=this.timescale,n.presentationTimeOffset=this.presentationTimeOffset,n.indexRange=t.clone_(this.indexRange),n.representationIndex=t.clone_(this.representationIndex),n.initialization=t.clone_(this.initialization),n},e.shaka.dash.mpd.RepresentationIndex=function(){this.url=null,this.range=null},e.shaka.dash.mpd.RepresentationIndex.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.RepresentationIndex;return n.url=this.url?new e.goog.Uri(this.url):null,n.range=t.clone_(this.range),n},e.shaka.dash.mpd.Initialization=function(){this.url=null,this.range=null},e.shaka.dash.mpd.Initialization.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.Initialization;return n.url=this.url?new e.goog.Uri(this.url):null,n.range=t.clone_(this.range),n},e.shaka.dash.mpd.SegmentList=function(){this.baseUrl=null,this.timescale=1,this.presentationTimeOffset=null,this.segmentDuration=null,this.startNumber=1,this.initialization=null,this.segmentUrls=[]},e.shaka.dash.mpd.SegmentList.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.SegmentList;return n.baseUrl=this.baseUrl?new e.goog.Uri(this.baseUrl):null,n.timescale=this.timescale,n.presentationTimeOffset=this.presentationTimeOffset,n.segmentDuration=this.segmentDuration,n.startNumber=this.startNumber,n.initialization=t.clone_(this.initialization),n.segmentUrls=this.segmentUrls.map(function(e){return e.clone()}),n},e.shaka.dash.mpd.SegmentUrl=function(){this.mediaUrl=null,this.mediaRange=null},e.shaka.dash.mpd.SegmentUrl.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.SegmentUrl;return n.mediaUrl=this.mediaUrl?new e.goog.Uri(this.mediaUrl):null,n.mediaRange=t.clone_(this.mediaRange),n},e.shaka.dash.mpd.SegmentTemplate=function(){this.timescale=1,this.presentationTimeOffset=null,this.segmentDuration=null,this.startNumber=1,this.mediaUrlTemplate=null,this.indexUrlTemplate=null,this.initializationUrlTemplate=null,this.timeline=null},e.shaka.dash.mpd.SegmentTemplate.prototype.clone=function(){var t=e.shaka.dash.mpd,n=new e.shaka.dash.mpd.SegmentTemplate;return n.timescale=this.timescale,n.presentationTimeOffset=this.presentationTimeOffset,n.segmentDuration=this.segmentDuration,n.startNumber=this.startNumber,n.mediaUrlTemplate=this.mediaUrlTemplate,n.indexUrlTemplate=this.indexUrlTemplate,n.initializationUrlTemplate=this.initializationUrlTemplate,n.timeline=t.clone_(this.timeline),n},e.shaka.dash.mpd.SegmentTimeline=function(){this.timePoints=[]},e.shaka.dash.mpd.SegmentTimeline.prototype.clone=function(){var t=new e.shaka.dash.mpd.SegmentTimeline;return t.timePoints=this.timePoints.map(function(e){return e.clone()}),t},e.shaka.dash.mpd.SegmentTimePoint=function(){this.startTime=null,this.duration=null,this.repeat=null},e.shaka.dash.mpd.SegmentTimePoint.prototype.clone=function(){var t=new e.shaka.dash.mpd.SegmentTimePoint;return t.startTime=this.startTime,t.duration=this.duration,t.repeat=this.repeat,t},e.shaka.dash.mpd.Range=function(e,t){this.begin=e,this.end=t},e.shaka.dash.mpd.Range.prototype.clone=function(){return new e.shaka.dash.mpd.Range(this.begin,this.end)},e.shaka.dash.mpd.Mpd.TAG_NAME="MPD",e.shaka.dash.mpd.Period.TAG_NAME="Period",e.shaka.dash.mpd.AdaptationSet.TAG_NAME="AdaptationSet",e.shaka.dash.mpd.Role.TAG_NAME="Role",e.shaka.dash.mpd.ContentComponent.TAG_NAME="ContentComponent",e.shaka.dash.mpd.Representation.TAG_NAME="Representation",e.shaka.dash.mpd.ContentProtection.TAG_NAME="ContentProtection",e.shaka.dash.mpd.CencPssh.TAG_NAME="cenc:pssh",e.shaka.dash.mpd.BaseUrl.TAG_NAME="BaseURL",e.shaka.dash.mpd.Location.TAG_NAME="Location",e.shaka.dash.mpd.SegmentBase.TAG_NAME="SegmentBase",e.shaka.dash.mpd.RepresentationIndex.TAG_NAME="RepresentationIndex",e.shaka.dash.mpd.Initialization.TAG_NAME="Initialization",e.shaka.dash.mpd.SegmentList.TAG_NAME="SegmentList",e.shaka.dash.mpd.SegmentUrl.TAG_NAME="SegmentURL",e.shaka.dash.mpd.SegmentTemplate.TAG_NAME="SegmentTemplate",e.shaka.dash.mpd.SegmentTimeline.TAG_NAME="SegmentTimeline",e.shaka.dash.mpd.SegmentTimePoint.TAG_NAME="S",e.shaka.dash.mpd.Mpd.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.url=new e.goog.Uri(t.baseUrl),this.id=r.parseAttr_(n,"id",r.parseString_),this.type=r.parseAttr_(n,"type",r.parseString_)||"static",this.mediaPresentationDuration=r.parseAttr_(n,"mediaPresentationDuration",r.parseDuration_),this.minBufferTime=r.parseAttr_(n,"minBufferTime",r.parseDuration_,this.minBufferTime),this.minUpdatePeriod=r.parseAttr_(n,"minimumUpdatePeriod",r.parseDuration_,this.minUpdatePeriod),this.availabilityStartTime=r.parseAttr_(n,"availabilityStartTime",r.parseDate_,this.availabilityStartTime),this.timeShiftBufferDepth=r.parseAttr_(n,"timeShiftBufferDepth",r.parseDuration_,this.timeShiftBufferDepth),this.suggestedPresentationDelay=r.parseAttr_(n,"suggestedPresentationDelay",r.parseDuration_,this.suggestedPresentationDelay);var i=r.parseChild_(this,n,r.BaseUrl);this.baseUrl=r.resolveUrl_(t.baseUrl,i?i.url:null);var a=r.parseChild_(this,n,r.Location);a&&(this.updateLocation=r.resolveUrl_(t.baseUrl,a.url)),this.periods=r.parseChildren_(this,n,r.Period)},e.shaka.dash.mpd.Period.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.id=r.parseAttr_(n,"id",r.parseString_),this.start=r.parseAttr_(n,"start",r.parseDuration_),this.duration=r.parseAttr_(n,"duration",r.parseDuration_);var i=r.parseChild_(this,n,r.BaseUrl);this.baseUrl=r.resolveUrl_(t.baseUrl,i?i.url:null),this.segmentBase=r.parseChild_(this,n,r.SegmentBase),this.segmentList=r.parseChild_(this,n,r.SegmentList),this.segmentTemplate=r.parseChild_(this,n,r.SegmentTemplate),this.adaptationSets=r.parseChildren_(this,n,r.AdaptationSet)},e.shaka.dash.mpd.AdaptationSet.prototype.parse=function(t,n){var r=e.shaka.dash.mpd,i=r.parseChild_(this,n,r.ContentComponent)||{},a=r.parseChild_(this,n,r.Role);this.id=r.parseAttr_(n,"id",r.parseString_),this.lang=r.parseAttr_(n,"lang",r.parseString_,i.lang),this.contentType=r.parseAttr_(n,"contentType",r.parseString_,i.contentType),this.width=r.parseAttr_(n,"width",r.parsePositiveInt_),this.height=r.parseAttr_(n,"height",r.parsePositiveInt_),this.mimeType=r.parseAttr_(n,"mimeType",r.parseString_),this.codecs=r.parseAttr_(n,"codecs",r.parseString_),this.main=a&&"main"==a.value,this.lang&&(this.lang=e.shaka.util.LanguageUtils.normalize(this.lang));var o=r.parseChild_(this,n,r.BaseUrl);this.baseUrl=r.resolveUrl_(t.baseUrl,o?o.url:null),this.contentProtections=r.parseChildren_(this,n,r.ContentProtection),!this.contentType&&this.mimeType&&(this.contentType=this.mimeType.split("/")[0]),this.segmentBase=t.segmentBase?r.mergeChild_(this,n,t.segmentBase):r.parseChild_(this,n,r.SegmentBase),this.segmentList=t.segmentList?r.mergeChild_(this,n,t.segmentList):r.parseChild_(this,n,r.SegmentList),this.segmentTemplate=t.segmentTemplate?r.mergeChild_(this,n,t.segmentTemplate):r.parseChild_(this,n,r.SegmentTemplate),this.representations=r.parseChildren_(this,n,r.Representation),!this.mimeType&&this.representations.length&&(this.mimeType=this.representations[0].mimeType,!this.contentType&&this.mimeType&&(this.contentType=this.mimeType.split("/")[0]))},e.shaka.dash.mpd.Role.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.value=r.parseAttr_(n,"value",r.parseString_)},e.shaka.dash.mpd.ContentComponent.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.id=r.parseAttr_(n,"id",r.parseString_),this.lang=r.parseAttr_(n,"lang",r.parseString_),this.contentType=r.parseAttr_(n,"contentType",r.parseString_),this.lang&&(this.lang=e.shaka.util.LanguageUtils.normalize(this.lang))},e.shaka.dash.mpd.Representation.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.id=r.parseAttr_(n,"id",r.parseString_),this.bandwidth=r.parseAttr_(n,"bandwidth",r.parsePositiveInt_),this.width=r.parseAttr_(n,"width",r.parsePositiveInt_,t.width),this.height=r.parseAttr_(n,"height",r.parsePositiveInt_,t.height),this.mimeType=r.parseAttr_(n,"mimeType",r.parseString_,t.mimeType),this.codecs=r.parseAttr_(n,"codecs",r.parseString_,t.codecs),this.lang=t.lang;var i=r.parseChild_(this,n,r.BaseUrl);this.baseUrl=r.resolveUrl_(t.baseUrl,i?i.url:null),this.contentProtections=r.parseChildren_(this,n,r.ContentProtection),this.segmentBase=t.segmentBase?r.mergeChild_(this,n,t.segmentBase):r.parseChild_(this,n,r.SegmentBase),this.segmentList=t.segmentList?r.mergeChild_(this,n,t.segmentList):r.parseChild_(this,n,r.SegmentList),this.segmentTemplate=t.segmentTemplate?r.mergeChild_(this,n,t.segmentTemplate):r.parseChild_(this,n,r.SegmentTemplate),0==this.contentProtections.length&&(this.contentProtections=t.contentProtections)},e.shaka.dash.mpd.ContentProtection.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.schemeIdUri=r.parseAttr_(n,"schemeIdUri",r.parseString_),this.value=r.parseAttr_(n,"value",r.parseString_),this.pssh=r.parseChild_(this,n,r.CencPssh),this.children=Array.prototype.slice.call(n.childNodes)},e.shaka.dash.mpd.CencPssh.prototype.parse=function(t,n){var r=e.shaka.dash.mpd,i=e.shaka.util.Uint8ArrayUtils,a=r.getContents_(n);if(a){this.psshBox=i.fromBase64(a);try{this.parsedPssh=new e.shaka.util.Pssh(this.psshBox)}catch(e){if(!(e instanceof RangeError))throw e}}},e.shaka.dash.mpd.BaseUrl.prototype.parse=function(t,n){this.url=e.shaka.dash.mpd.getContents_(n)},e.shaka.dash.mpd.Location.prototype.parse=function(t,n){this.url=e.shaka.dash.mpd.getContents_(n)},e.shaka.dash.mpd.SegmentBase.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.baseUrl=t.baseUrl||this.baseUrl,this.timescale=r.parseAttr_(n,"timescale",r.parsePositiveInt_,this.timescale),this.presentationTimeOffset=r.parseAttr_(n,"presentationTimeOffset",r.parseNonNegativeInt_,this.presentationTimeOffset),this.indexRange=r.parseAttr_(n,"indexRange",r.parseRange_,this.indexRange),this.representationIndex=r.parseChild_(this,n,r.RepresentationIndex)||this.representationIndex,this.initialization=r.parseChild_(this,n,r.Initialization)||this.initialization},e.shaka.dash.mpd.RepresentationIndex.prototype.parse=function(t,n){var r=e.shaka.dash.mpd,i=r.parseAttr_(n,"sourceURL",r.parseString_);this.url=r.resolveUrl_(t.baseUrl,i),this.range=r.parseAttr_(n,"range",r.parseRange_,r.clone_(t.indexRange))},e.shaka.dash.mpd.Initialization.prototype.parse=function(t,n){var r=e.shaka.dash.mpd,i=r.parseAttr_(n,"sourceURL",r.parseString_);this.url=r.resolveUrl_(t.baseUrl,i),this.range=r.parseAttr_(n,"range",r.parseRange_)},e.shaka.dash.mpd.SegmentList.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.baseUrl=t.baseUrl||this.baseUrl,this.timescale=r.parseAttr_(n,"timescale",r.parsePositiveInt_,this.timescale),this.presentationTimeOffset=r.parseAttr_(n,"presentationTimeOffset",r.parseNonNegativeInt_,this.presentationTimeOffset),this.segmentDuration=r.parseAttr_(n,"duration",r.parsePositiveInt_,this.segmentDuration),this.startNumber=r.parseAttr_(n,"startNumber",r.parseNonNegativeInt_,this.startNumber),this.initialization=r.parseChild_(this,n,r.Initialization)||this.initialization,this.segmentUrls=r.parseChildren_(this,n,r.SegmentUrl)||this.segmentUrls},e.shaka.dash.mpd.SegmentUrl.prototype.parse=function(t,n){var r=e.shaka.dash.mpd,i=r.parseAttr_(n,"media",r.parseString_);this.mediaUrl=r.resolveUrl_(t.baseUrl,i),this.mediaRange=r.parseAttr_(n,"mediaRange",r.parseRange_)},e.shaka.dash.mpd.SegmentTemplate.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.timescale=r.parseAttr_(n,"timescale",r.parsePositiveInt_,this.timescale),this.presentationTimeOffset=r.parseAttr_(n,"presentationTimeOffset",r.parseNonNegativeInt_,this.presentationTimeOffset),this.segmentDuration=r.parseAttr_(n,"duration",r.parsePositiveInt_,this.segmentDuration),this.startNumber=r.parseAttr_(n,"startNumber",r.parseNonNegativeInt_,this.startNumber),this.mediaUrlTemplate=r.parseAttr_(n,"media",r.parseString_,this.mediaUrlTemplate),this.indexUrlTemplate=r.parseAttr_(n,"index",r.parseString_,this.indexUrlTemplate),
this.initializationUrlTemplate=r.parseAttr_(n,"initialization",r.parseString_,this.initializationUrlTemplate),this.timeline=r.parseChild_(this,n,r.SegmentTimeline)||this.timeline},e.shaka.dash.mpd.SegmentTimeline.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.timePoints=r.parseChildren_(this,n,r.SegmentTimePoint)},e.shaka.dash.mpd.SegmentTimePoint.prototype.parse=function(t,n){var r=e.shaka.dash.mpd;this.startTime=r.parseAttr_(n,"t",r.parseNonNegativeInt_),this.duration=r.parseAttr_(n,"d",r.parseNonNegativeInt_),this.repeat=r.parseAttr_(n,"r",r.parseNonNegativeInt_)},e.shaka.dash.mpd.resolveUrl_=function(t,n){var r=n?new e.goog.Uri(n):null;return t?r?t.resolve(r):t:r},e.shaka.dash.mpd.mergeChild_=function(t,n,r){var i=e.shaka.dash.mpd,a=i.clone_(r),o=i.findChild_(n,r.constructor.TAG_NAME);return o&&a.parse(t,o),a},e.shaka.dash.mpd.parseChild_=function(t,n,r){var i=e.shaka.dash.mpd,a=null,o=i.findChild_(n,r.TAG_NAME);return o&&(a=new r,a.parse(t,o)),a},e.shaka.dash.mpd.findChild_=function(e,t){for(var n=null,r=0;r<e.childNodes.length;r++)if(e.childNodes[r].tagName==t){if(n)return null;n=e.childNodes[r]}return n},e.shaka.dash.mpd.parseChildren_=function(e,t,n){for(var r=[],i=0;i<t.childNodes.length;i++)if(t.childNodes[i].tagName==n.TAG_NAME){var a=new n;a.parse.call(a,e,t.childNodes[i]),r.push(a)}return r},e.shaka.dash.mpd.getContents_=function(e){var t=e.firstChild;return t.nodeType!=Node.TEXT_NODE?null:t.nodeValue},e.shaka.dash.mpd.clone_=function(e){return e?e.clone():null},e.shaka.dash.mpd.parseAttr_=function(e,t,n,r){var i=n(e.getAttribute(t));return null!=i?i:void 0!==r?r:null},e.shaka.dash.mpd.parseDate_=function(e){if(!e)return null;var t=Date.parse(e);return isNaN(t)?null:Math.floor(t/1e3)},e.shaka.dash.mpd.parseDuration_=function(t){if(!t)return null;var n="^P(?:([0-9]*)Y)?(?:([0-9]*)M)?(?:([0-9]*)D)?(?:T(?:([0-9]*)H)?(?:([0-9]*)M)?(?:([0-9.]*)S)?)?$",r=new RegExp(n).exec(t);if(!r)return null;var i=0,a=e.shaka.dash.mpd.parseNonNegativeInt_(r[1]);a&&(i+=31536e3*a);var o=e.shaka.dash.mpd.parseNonNegativeInt_(r[2]);o&&(i+=2592e3*o);var s=e.shaka.dash.mpd.parseNonNegativeInt_(r[3]);s&&(i+=86400*s);var u=e.shaka.dash.mpd.parseNonNegativeInt_(r[4]);u&&(i+=3600*u);var c=e.shaka.dash.mpd.parseNonNegativeInt_(r[5]);c&&(i+=60*c);var l=e.shaka.dash.mpd.parseFloat_(r[6]);return l&&(i+=l),i},e.shaka.dash.mpd.parseRange_=function(t){var n=/([0-9]+)-([0-9]+)/.exec(t);if(!n)return null;var r=e.shaka.dash.mpd.parseNonNegativeInt_(n[1]);if(null==r)return null;var i=e.shaka.dash.mpd.parseNonNegativeInt_(n[2]);return null==i?null:new e.shaka.dash.mpd.Range(r,i)},e.shaka.dash.mpd.parsePositiveInt_=function(e){var t=window.parseInt(e,10);return t>0?t:null},e.shaka.dash.mpd.parseNonNegativeInt_=function(e){var t=window.parseInt(e,10);return t>=0?t:null},e.shaka.dash.mpd.parseFloat_=function(e){var t=window.parseFloat(e);return isNaN(t)?null:t},e.shaka.dash.mpd.parseString_=function(e){return e}}).call(t,n(1))},function(e,t,n){(function(e){e.goog=e.goog||{},e.goog.uri=e.goog.uri||{},e.goog.uri.utils=e.goog.uri.utils||{},e.shaka=e.shaka||{},e.shaka.media=e.shaka.media||{},e.shaka.player=e.shaka.player||{},e.shaka.util=e.shaka.util||{},e.shaka.dash=e.shaka.dash||{},e.shaka.util.Clock=e.shaka.util.Clock||{},e.shaka.util.LanguageUtils=e.shaka.util.LanguageUtils||{},e.shaka.util.Uint8ArrayUtils=e.shaka.util.Uint8ArrayUtils||{},e.shaka.util.StringUtils=e.shaka.util.StringUtils||{},e.shaka.util.Mp4Parser=e.shaka.util.Mp4Parser||{},e.shaka.util.DataViewReader=e.shaka.util.DataViewReader||{},e.shaka.util.Pssh=e.shaka.util.Pssh||{},e.shaka.dash.mpd=e.shaka.dash.mpd||{},e.shaka.dash.MpdUtils=e.shaka.dash.MpdUtils||{}}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.Pssh=function(t){this.systemIds=[],this.cencKeyIds=[],this.dataBoundaries=[];for(var n=new e.shaka.util.DataViewReader(new DataView(t.buffer),e.shaka.util.DataViewReader.Endianness.BIG_ENDIAN),r=!1;n.hasMoreData();){var i=e.shaka.util.Mp4Parser.findBox(e.shaka.util.Pssh.BOX_TYPE,n);if(i==e.shaka.util.Mp4Parser.BOX_NOT_FOUND)break;r=!0;var a=n.getPosition()-8,o=n.readUint8();if(o>1)n.skip(i-(n.getPosition()-a));else{n.skip(3);var s=e.shaka.util.Uint8ArrayUtils.toHex(n.readBytes(16)),u=[];if(o>0)for(var c=n.readUint32(),l=0;l<c;++l){var d=e.shaka.util.Uint8ArrayUtils.toHex(n.readBytes(16));u.push(d)}var h=n.readUint32();n.skip(h),this.cencKeyIds.push.apply(this.cencKeyIds,u),this.systemIds.push(s),this.dataBoundaries.push({start:a,end:n.getPosition()-1}),n.getPosition()!=a+i&&n.skip(i-(n.getPosition()-a))}}},e.shaka.util.Pssh.BOX_TYPE=1886614376}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.StringUtils.fromUTF8=function(t){if(!t)return"";var n=new Uint8Array(t);239==n[0]&&187==n[1]&&191==n[2]&&(n=n.subarray(3));var r=e.shaka.util.StringUtils.fromCharCode_(n),i=escape(r);try{return decodeURIComponent(i)}catch(e){throw new shaka.util.Error(shaka.util.Error.Category.TEXT,shaka.util.Error.Code.BAD_ENCODING)}},e.shaka.util.StringUtils.fromUTF16=function(e,t){if(!e)return"";if(e.byteLength%2!=0)throw new shaka.util.Error(shaka.util.Error.Category.TEXT,shaka.util.Error.Code.BAD_ENCODING);var n;if(e instanceof ArrayBuffer)n=e;else{var r=new Uint8Array(e.byteLength);r.set(new Uint8Array(e)),n=r.buffer}for(var i=e.byteLength/2,a=new Uint16Array(i),o=new DataView(n),s=0;s<i;s++)a[s]=o.getUint16(2*s,t);return shaka.util.StringUtils.fromCharCode_(a)},e.shaka.util.StringUtils.fromBytesAutoDetect=function(t){var n=e.shaka.util.StringUtils,r=new Uint8Array(t);if(239==r[0]&&187==r[1]&&191==r[2])return n.fromUTF8(r);if(254==r[0]&&255==r[1])return n.fromUTF16(r.subarray(2),!1);if(255==r[0]&&254==r[1])return n.fromUTF16(r.subarray(2),!0);var i=function(e,t){return e.byteLength<=t||e[t]>=32&&e[t]<=126}.bind(null,r);if(0==r[0]&&0==r[2])return n.fromUTF16(t,!1);if(0==r[1]&&0==r[3])return n.fromUTF16(t,!0);if(i(0)&&i(1)&&i(2)&&i(3))return n.fromUTF8(t);throw new shaka.util.Error(shaka.util.Error.Category.TEXT,shaka.util.Error.Code.UNABLE_TO_DETECT_ENCODING)},e.shaka.util.StringUtils.toUTF8=function(e){for(var t=encodeURIComponent(e),n=unescape(t),r=new Uint8Array(n.length),i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return r.buffer},e.shaka.util.StringUtils.fromCharCode_=function(e){for(var t=16e3,n="",r=0;r<e.length;r+=t){var i=e.subarray(r,r+t);n+=String.fromCharCode.apply(null,i)}return n}}).call(t,n(1))},function(e,t,n){(function(e){e.shaka.util.Uint8ArrayUtils.toBase64=function(e,t){var n=String.fromCharCode.apply(null,e),r=void 0==t||t,i=window.btoa(n).replace(/\+/g,"-").replace(/\//g,"_");return r?i:i.replace(/=*$/,"")},e.shaka.util.Uint8ArrayUtils.fromBase64=function(e){for(var t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),n=new Uint8Array(t.length),r=0;r<t.length;++r)n[r]=t.charCodeAt(r);return n},e.shaka.util.Uint8ArrayUtils.fromHex=function(e){for(var t=new Uint8Array(e.length/2),n=0;n<e.length;n+=2)t[n/2]=window.parseInt(e.substr(n,2),16);return t},e.shaka.util.Uint8ArrayUtils.toHex=function(e){for(var t="",n=0;n<e.length;++n){var r=e[n].toString(16);1==r.length&&(r="0"+r),t+=r}return t},e.shaka.util.Uint8ArrayUtils.equal=function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0;n<e.length;++n)if(e[n]!=t[n])return!1;return!0}}).call(t,n(1))},function(e,t,n){(function(e){e.goog.Uri=function(t){var n;t instanceof e.goog.Uri?(this.setScheme(t.getScheme()),this.setUserInfo(t.getUserInfo()),this.setDomain(t.getDomain()),this.setPort(t.getPort()),this.setPath(t.getPath()),this.setQueryData(t.getQueryData().clone()),this.setFragment(t.getFragment())):t&&(n=e.goog.uri.utils.split(String(t)))?(this.setScheme(n[e.goog.uri.utils.ComponentIndex.SCHEME]||"",!0),this.setUserInfo(n[e.goog.uri.utils.ComponentIndex.USER_INFO]||"",!0),this.setDomain(n[e.goog.uri.utils.ComponentIndex.DOMAIN]||"",!0),this.setPort(n[e.goog.uri.utils.ComponentIndex.PORT]),this.setPath(n[e.goog.uri.utils.ComponentIndex.PATH]||"",!0),this.setQueryData(n[e.goog.uri.utils.ComponentIndex.QUERY_DATA]||"",!0),this.setFragment(n[e.goog.uri.utils.ComponentIndex.FRAGMENT]||"",!0)):this.queryData_=new e.goog.Uri.QueryData(null,null)},e.goog.Uri.prototype.scheme_="",e.goog.Uri.prototype.userInfo_="",e.goog.Uri.prototype.domain_="",e.goog.Uri.prototype.port_=null,e.goog.Uri.prototype.path_="",e.goog.Uri.prototype.queryData_,e.goog.Uri.prototype.fragment_="",e.goog.Uri.prototype.toString=function(){var t=[],n=this.getScheme();n&&t.push(e.goog.Uri.encodeSpecialChars_(n,e.goog.Uri.reDisallowedInSchemeOrUserInfo_,!0),":");var r=this.getDomain();if(r){t.push("//");var i=this.getUserInfo();i&&t.push(e.goog.Uri.encodeSpecialChars_(i,e.goog.Uri.reDisallowedInSchemeOrUserInfo_,!0),"@"),t.push(e.goog.Uri.removeDoubleEncoding_(encodeURIComponent(r)));var a=this.getPort();null!=a&&t.push(":",String(a))}var o=this.getPath();o&&(this.hasDomain()&&"/"!=o.charAt(0)&&t.push("/"),t.push(e.goog.Uri.encodeSpecialChars_(o,"/"==o.charAt(0)?e.goog.Uri.reDisallowedInAbsolutePath_:e.goog.Uri.reDisallowedInRelativePath_,!0)));var s=this.getEncodedQuery();s&&t.push("?",s);var u=this.getFragment();return u&&t.push("#",e.goog.Uri.encodeSpecialChars_(u,e.goog.Uri.reDisallowedInFragment_)),t.join("")},e.goog.Uri.prototype.resolve=function(t){var n=this.clone(),r=t.hasScheme();r?n.setScheme(t.getScheme()):r=t.hasUserInfo(),r?n.setUserInfo(t.getUserInfo()):r=t.hasDomain(),r?n.setDomain(t.getDomain()):r=t.hasPort();var i=t.getPath();if(r)n.setPort(t.getPort());else if(r=t.hasPath()){if("/"!=i.charAt(0))if(this.hasDomain()&&!this.hasPath())i="/"+i;else{var a=n.getPath().lastIndexOf("/");a!=-1&&(i=n.getPath().substr(0,a+1)+i)}i=e.goog.Uri.removeDotSegments(i)}return r?n.setPath(i):r=t.hasQuery(),r?n.setQueryData(t.getQueryData().clone()):r=t.hasFragment(),r&&n.setFragment(t.getFragment()),n},e.goog.Uri.prototype.clone=function(){return new e.goog.Uri(this)},e.goog.Uri.prototype.getScheme=function(){return this.scheme_},e.goog.Uri.prototype.setScheme=function(t,n){return this.scheme_=n?e.goog.Uri.decodeOrEmpty_(t,!0):t,this.scheme_&&(this.scheme_=this.scheme_.replace(/:$/,"")),this},e.goog.Uri.prototype.hasScheme=function(){return!!this.scheme_},e.goog.Uri.prototype.getUserInfo=function(){return this.userInfo_},e.goog.Uri.prototype.setUserInfo=function(t,n){return this.userInfo_=n?e.goog.Uri.decodeOrEmpty_(t):t,this},e.goog.Uri.prototype.hasUserInfo=function(){return!!this.userInfo_},e.goog.Uri.prototype.getDomain=function(){return this.domain_},e.goog.Uri.prototype.setDomain=function(t,n){return this.domain_=n?e.goog.Uri.decodeOrEmpty_(t,!0):t,this},e.goog.Uri.prototype.hasDomain=function(){return!!this.domain_},e.goog.Uri.prototype.getPort=function(){return this.port_},e.goog.Uri.prototype.setPort=function(e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);this.port_=e}else this.port_=null;return this},e.goog.Uri.prototype.hasPort=function(){return null!=this.port_},e.goog.Uri.prototype.getPath=function(){return this.path_},e.goog.Uri.prototype.setPath=function(t,n){return this.path_=n?e.goog.Uri.decodeOrEmpty_(t,!0):t,this},e.goog.Uri.prototype.hasPath=function(){return!!this.path_},e.goog.Uri.prototype.hasQuery=function(){return""!==this.queryData_.toString()},e.goog.Uri.prototype.setQueryData=function(t,n){return t instanceof e.goog.Uri.QueryData?this.queryData_=t:(n||(t=e.goog.Uri.encodeSpecialChars_(t,e.goog.Uri.reDisallowedInQuery_)),this.queryData_=new e.goog.Uri.QueryData(t,null)),this},e.goog.Uri.prototype.getEncodedQuery=function(){return this.queryData_.toString()},e.goog.Uri.prototype.getDecodedQuery=function(){return this.queryData_.toDecodedString()},e.goog.Uri.prototype.getQueryData=function(){return this.queryData_},e.goog.Uri.prototype.getFragment=function(){return this.fragment_},e.goog.Uri.prototype.setFragment=function(t,n){return this.fragment_=n?e.goog.Uri.decodeOrEmpty_(t):t,this},e.goog.Uri.prototype.hasFragment=function(){return!!this.fragment_},e.goog.Uri.removeDotSegments=function(e){if(".."==e||"."==e)return"";if(e.indexOf("./")==-1&&e.indexOf("/.")==-1)return e;for(var t=0==e.lastIndexOf("/",0),n=e.split("/"),r=[],i=0;i<n.length;){var a=n[i++];"."==a?t&&i==n.length&&r.push(""):".."==a?((r.length>1||1==r.length&&""!=r[0])&&r.pop(),t&&i==n.length&&r.push("")):(r.push(a),t=!0)}return r.join("/")},e.goog.Uri.decodeOrEmpty_=function(e,t){return e?t?decodeURI(e):decodeURIComponent(e):""},e.goog.Uri.encodeSpecialChars_=function(t,n,r){if(e.goog.isString(t)){var i=encodeURI(t).replace(n,e.goog.Uri.encodeChar_);return r&&(i=e.goog.Uri.removeDoubleEncoding_(i)),i}return null},e.goog.Uri.encodeChar_=function(e){var t=e.charCodeAt(0);return"%"+(t>>4&15).toString(16)+(15&t).toString(16)},e.goog.Uri.removeDoubleEncoding_=function(e){return e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")},e.goog.Uri.reDisallowedInSchemeOrUserInfo_=/[#\/\?@]/g,e.goog.Uri.reDisallowedInRelativePath_=/[\#\?:]/g,e.goog.Uri.reDisallowedInAbsolutePath_=/[\#\?]/g,e.goog.Uri.reDisallowedInQuery_=/[\#\?@]/g,e.goog.Uri.reDisallowedInFragment_=/#/g,e.goog.Uri.QueryData=function(e,t){this.encodedQuery_=e||null},e.goog.Uri.QueryData.prototype.ensureKeyMapInitialized_=function(){if(!this.keyMap_&&(this.keyMap_={},this.count_=0,this.encodedQuery_))for(var e=this.encodedQuery_.split("&"),t=0;t<e.length;t++){var n=e[t].indexOf("="),r=null,i=null;n>=0?(r=e[t].substring(0,n),i=e[t].substring(n+1)):r=e[t],r=decodeURIComponent(r.replace(/\+/g," ")),i=i||"",this.add(r,decodeURIComponent(i.replace(/\+/g," ")))}},e.goog.Uri.QueryData.prototype.keyMap_=null,e.goog.Uri.QueryData.prototype.count_=null,e.goog.Uri.QueryData.prototype.getCount=function(){return this.ensureKeyMapInitialized_(),this.count_},e.goog.Uri.QueryData.prototype.add=function(e,t){this.ensureKeyMapInitialized_(),this.encodedQuery_=null;var n=this.keyMap_.hasOwnProperty(e)&&this.keyMap_[e];return n||(this.keyMap_[e]=n=[]),n.push(t),this.count_++,this},e.goog.Uri.QueryData.prototype.toString=function(){if(this.encodedQuery_)return this.encodedQuery_;if(!this.keyMap_)return"";var e=[];for(var t in this.keyMap_)for(var n=encodeURIComponent(t),r=this.keyMap_[t],i=0;i<r.length;i++){var a=n;""!==r[i]&&(a+="="+encodeURIComponent(r[i])),e.push(a)}return this.encodedQuery_=e.join("&")},e.goog.Uri.QueryData.prototype.toDecodedString=function(){return e.goog.Uri.decodeOrEmpty_(this.toString())},e.goog.Uri.QueryData.prototype.clone=function(){var t=new e.goog.Uri.QueryData;if(t.encodedQuery_=this.encodedQuery_,this.keyMap_){var n={};for(var r in this.keyMap_)n[r]=this.keyMap_[r].concat();t.keyMap_=n,t.count_=this.count_}return t}}).call(t,n(1))},function(e,t,n){(function(e){e.goog.uri.utils.splitRe_=new RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$"),e.goog.uri.utils.ComponentIndex={SCHEME:1,USER_INFO:2,DOMAIN:3,PORT:4,PATH:5,QUERY_DATA:6,FRAGMENT:7},e.goog.uri.utils.split=function(t){return t.match(e.goog.uri.utils.splitRe_)}}).call(t,n(1))},function(e,t,n){(function(e){!function(e){e.slidingWindow=function(e){function t(e){o.push(e),o.length>i&&o.shift();var t=0;o.forEach(function(e){t+=e}),a=t/o.length}function n(){return a}function r(){var e=o.length?o[0]:-(1/0);return o.forEach(function(t){t<e&&(e=t)}),e}e=e||{};var i=e.maxSize||5,a=0,o=[];return{addValue:t,getAverage:n,getMinimum:r}}}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(e){function t(){function e(e,t){r[e]=t,i[t]=e}function t(e){return i[e]}function n(e){return r[e]}var r=Object.create(null),i=Object.create(null);return{addMapping:e,getUrl:t,getSwarmId:n}}e.UrlSwarmIdMap=t()}(e.core.util)}).call(t,n(1))},function(e,t,n){(function(e){!function(e){var t=function(){function e(e,t){if(!e)return t;if(!t)return e;var n="/",r="";if(e.indexOf("://")!==-1){var i=e.split("://");n=i[0]+"://",r=i[1]}else r=e;for(var a=r.split("/").filter(function(e){return e.length>0}),o=(t.match(/\.\.\//g)||[]).length,s=0;s<o;s++)a.pop();var u=n+a.join("/");t=t.replace(/\.\.\//g,""),"/"===t[0]&&(t=t.replace("/",""));var c=u.lastIndexOf("/")===u.length-1?u+t:u+"/"+t;return c}return{combine:e}},n=t();e.UrlUtils=n}(e.core.util)}).call(t,n(1))},function(e,t,n){"use strict";var r=n(4),i=n(11);e.exports=function(e){return e?e.element&&"function"==typeof e.on?(e.on("error",function(e){e&&r.error("playerAdapterError",e)}),i("player.attach").broadcast(e),!0):(r.error("attachPlayer received invalid adapter - "+(e&&(typeof e||"undefined"))),!1):(r.error("called 'attachPlayer' without adapter"),!1)}},function(e,t,n){"use strict";function r(){window.peer5.Request=h,window.peer5.VideoRequest=h,window.peer5.CatchAllVideoRequest=h,window.peer5.FragmentRequest=h,window.peer5.PlaylistRequest=h}function i(){window.peer5.Request=o,window.peer5.VideoRequest=s,window.peer5.CatchAllVideoRequest=u,window.peer5.FragmentRequest=c,window.peer5.PlaylistRequest=l}var a=n(4),o=n(10),s=n(16),u=n(21),c=n(22),l=n(24),d=n(2),h=n(7),f={p2p:function(e){e===!0?(i(),a.info("P2P requests have been disabled")):e===!1&&(r(),a.info("P2P requests have been enabled"))},abr:function(e){if(!d.DISABLE_ABR_CONFIGURE)switch(e){case"hlsjs":d.MIMIC_REAL_HTTP_DOWNLOAD=!1,d.PLAYER_REQUEST_ALWAYS_HTTP=!1,d.EXTERNAL_MEDIA_HLSJS_OVERRIDE=!0,a.info("changed ABR mode to [hlsjs]");break;case"transparent":d.MIMIC_REAL_HTTP_DOWNLOAD=!0,d.PLAYER_REQUEST_ALWAYS_HTTP=!0,d.EXTERNAL_MEDIA_HLSJS_OVERRIDE=!1,a.info("changed ABR mode to [transparent]");break;default:a.error("Requested unknown abr mode ["+e+"]")}}};e.exports=function(e){if(!e||"object"!=typeof e)throw new TypeError("Invalid options - expected object");Object.keys(e).forEach(function(t){f[t]&&f[t](e[t])})}},function(e,t,n){"use strict";var r=n(135);e.exports=function(){return r.isWebSocketSupported()&&r.isWebRTCSupported()||!1}},function(e,t,n){"use strict";var r=n(2);r.VERSION+=".1",r.TOKEN="5tfjqh4gf2ts6ja7m5at",r.URL_ALLOWED_QUERY_PARAMETERS=["url"],e.exports=r},function(e,t,n){"use strict";var r=n(2);e.exports=function(e){var t="EXTERNAL_"+e;return t=t.toUpperCase(),r[t]}},function(e,t,n){"use strict";function r(){}function i(e){var t=!1,n=e.EXPERIMENTS&&e.EXPERIMENTS[u.A_B_GROUP_ID];delete e.EXPERIMENTS,Object.keys(e).forEach(function(n){t=!0,u[n]=e[n]});var r=JSON.parse(u.A_B_CONFIG_JSON||"{}");return n&&"object"==typeof n&&Object.keys(n).forEach(function(e){t=!0,u[e]=r[e]=n[e]}),"undefined"!=typeof r.DYNAMIC_CONFIG&&(t=!0,delete r.DYNAMIC_CONFIG),r&&Object.keys(r).length||u.A_B_GROUP_ID?(u.A_B_CONFIG_JSON=JSON.stringify(r),t):t}function a(e){var t=e||r,n=s();if(!n)return void t(!1);o.info("fetching dynamic config");var a=new XMLHttpRequest;a.open("GET","//api.peer5.com/config/"+n+".json"),a.responseType="text",a.onloadend=function(){if(a.status<200||a.status>299)return o.warn("Failed to load dynamic config - bad status "+a.status),void t(!1);var e;try{e=JSON.parse(a.response)}catch(e){return o.warn("Failed to parse dynamic config - "+(e&&e.message||e)),void t(!1)}if(e&&"object"==typeof e&&!Array.isArray(e)){var n=i(e);t(n),o.info("Loaded dynamic config")}else o.info("Tried to load invalid dynamic config format - "+typeof e),t(!1)},a.send()}var o=n(4),s=n(15),u=n(2);e.exports=a},function(e,t,n){"use strict";var r=n(1);r.config=n(2);var i=n(117);n(71),n(43),n(80),n(11);var a=n(4);n(83),n(27),n(81),n(84),n(112),n(88),n(110),n(85),n(111),n(60),n(61),n(17),n(64),n(65),n(68),n(26),n(76),n(77),n(25);var o=n(3);n(67),n(55),n(90),n(56),n(35),n(38),n(41),n(34),n(82),n(36),n(69),n(78),n(51),n(50),n(52),n(53),n(42);var s=n(20);n(62),n(63),n(58),n(59),n(44),n(46),n(48),n(66),n(149),n(33),n(10),n(16),n(22),n(24),n(32),n(91),n(104),n(101),n(107),n(106),n(105),n(100),n(102),n(109),n(108),n(103),n(89),n(86),n(92),n(72),n(73),n(87),n(93),n(95),n(94),n(97),n(96),n(98),n(45),n(54),n(57),n(23),n(70);var u=n(113),c=n(114),l=n(115),d=n(132),h=n(21);e.exports=window.peer5={setLogLevel:a.setLogLevel,prefetch:r.prefetch,Request:r.Request,VideoRequest:r.VideoRequest,CatchAllVideoRequest:h,FragmentRequest:r.FragmentRequest,PlaylistRequest:r.PlaylistRequest,isSupported:l,getCompatibilityStatus:r.getCompatibilityStatus,isEnabled:r.isEnabled,getStats:o.publicGetStats,trigger:s,DATACHANNELS_ERROR:r.DATACHANNELS_ERROR,WEBSOCKETS_ERROR:r.WEBSOCKETS_ERROR,FILESYSTEM_ERROR:r.FILESYSTEM_ERROR,getConfig:i,players:r.players,attachPlayer:u,configure:c,showStats:d.showStats,hideStats:d.hideStats,browserName:r.browserName,browserVersion:r.browserVersion,version:"0.70.8"}},function(e,t,n){"use strict";var r=n(2),i=n(4),a=n(5),o=n(3);e.exports=function(e,t,n){function s(){R&&S.forEach(function(e){t.hasChunk(e)||t.resetChunk(e)})}function u(){var e=S.length-y;0===e?i.error("P2PRequest expired, but no chunks actually did"):E.chunksLate(e),0!==y?E.requestSucceeded():E.requestFailed(),s(),R=null}function c(e){return i.info("setting p2p request being late timeout to "+e+"ms for "+S.length+" chunks, peerId: "+E.targetId+", swarmId: "+b),setTimeout(u,e)}function l(){E&&(s(),v())}function d(){E.requestSucceeded(!0),v()}function h(e,n){E.chunksReceived(1,Date.now()-T),y++,t.hasChunk(e)?t.isFull()?radio("report:p2pWaste").broadcast(b,n.length):t.setWasteChunk(e,n.length):(radio("p2pProgress").broadcast(b,n.length),t.setChunk(e,n,"p2p")),radio("P2PMaybeAvailableEvent").broadcast(b,E.targetId),y===S.length&&(R?d():v())}function f(e){e.swarmId===b&&S.indexOf(e.chunkId)>=0&&h(e.chunkId,e.payload)}function p(){E.once("disconnect",l),E.on("data",f)}function g(){E.removeListener("disconnect",l),E.removeListener("data",f)}function v(){g(),E=null,R&&(clearTimeout(R),R=null)}function m(){S.forEach(function(e){E.chunksRequested(1),t.presetChunk(e)})}function _(){o.sumGlobal({p2pRequestMessagesSent:1}),E.queue(new a.RequestMessage(b,S))}var E=e,b=t.resourceId,S=n.slice(),T=Date.now(),y=0,R=c(r.PC_CHUNK_EXPIRATION_TIMEOUT);return p(),m(),_(),{}}},function(e,t){"use strict";e.exports=function(e){if(e.getbufferLength)try{return e.getbufferLength()}catch(e){}if(e.vjs_getProperty)try{return e.vjs_getProperty("buffered")}catch(e){}return 0}},function(e,t){"use strict";function n(e){if("number"==typeof e.webkitDroppedFrameCount)return{total:e.webkitDecodedFrameCount,dropped:e.webkitDroppedFrameCount};if("function"==typeof e.getVideoPlaybackQuality){var t=e.getVideoPlaybackQuality();if("number"==typeof t.droppedVideoFrames)return{total:t.totalVideoFrames,dropped:t.droppedVideoFrames}}return"number"==typeof e.mozDecodedFrames&&"number"==typeof e.mozPresentedFrames?{total:e.mozDecodedFrames,dropped:e.mozDecodedFrames-e.mozPresentedFrames}:{total:0,dropped:0}}e.exports=n},function(e,t){"use strict";function n(e){var t=8*e.webkitVideoDecodedByteCount||0,n=8*e.webkitAudioDecodedByteCount||0;return t||n?{video:t,audio:n,total:t+n}:{video:0,audio:0,total:0}}e.exports=n},function(e,t,n){"use strict";function r(e,t,n){function r(e,n){t(e,n)}function s(){return!O}function u(){s()&&(y?(y=!1,r("pause.end")):R?w||(w=!0,r("load.end")):(R=!0,w=!0,r("load.start"),r("load.end",{ignoreDuration:!0})))}function c(){clearTimeout(S),S=setTimeout(function(){b.play()},1)}function l(){v.forEach(function(e){T.addEventListener(e,b.adDetection)}),g.forEach(function(e){T.addEventListener(e,b[e])})}function d(){v.forEach(function(e){T.removeEventListener(e,b.adDetection)}),g.forEach(function(e){T.removeEventListener(e,b[e])})}function h(){m.destroy(),_.destroy(),d(),clearTimeout(E),clearTimeout(S)}var f=n||{},p=i("video",e);if(!p)return console.warn("VideoTagEventsWrapper: Invalid identifier. can't attach videoTag events"),null;var g=["pause","play","playing","canplaythrough","progress"],v=["abort","canplay","canplaythrough","durationChange","emptied","encrypted","ended","error","interruptbegin","interruptend","loadeddata","loadedmetadata","seeked","seeking","volumechange","waiting","loadstart","pause","play","playing","suspend"];f.droppedFramesSampleRate=f.droppedFramesSampleRate||5e3,f.droppedFramesThreshold=f.droppedFramesThreshold||.2,f.bitsDecodedSampleRate=f.bitsDecodedSampleRate||5e3;var m,_,E,b,S,T=p,y=!1,R=!1,w=!1,P=!1,I=!1,O=!1;return b={ready:function(){r("ready"),b.adDetection(),!T.paused&&T.currentTime?b.playing():T.autoplay&&c()},playing:u,canplaythrough:function(){!y&&T.currentTime&&u()},progress:function(){T.paused||u()},pause:function(){clearTimeout(S),s()&&!y&&R&&(y=!0,r("pause.start"))},play:function(){s()&&(clearTimeout(S),S=setTimeout(function(){s()&&(y||R||(R=!0,r("load.start")))},20))},"seek.start":function(){s()&&(R&&!w&&(w=!0,r("load.end")),P=!0,r("seek.start"))},"seek.end":function(){s()&&(P=!1,r("seek.end"))},"rebuffer.end":function(){s()&&(I=!1,r("rebuffer.end"))},"rebuffer.start":function(){s()&&(I=!0,r("rebuffer.start"))},"ad.start":function(){O||(O=!0,clearTimeout(S),R&&!w&&(w=!0,r("error",new Error("Ad loaded while load.starting")),r("load.end",{ignoreDuration:!0})),I&&(I=!1,r("rebuffer.end")),P&&(P=!1,r("seek.end")),!y&&R&&(y=!0,r("pause.start")),r("ad.start"))},"ad.end":function(){O&&(O=!1,r("ad.end"))},adDetection:function(){var e=T.currentSrc||T.src;if(e){var t=/^(blob|mediasource):/.test(e),n=/^(blob|mediasource):(https?(%3A|:)\/\/)[^\/]*youtube\.com\//i.test(e);!t||n?b["ad.start"]():b["ad.end"]()}}},m=a(T,function(e){b[e]()},f),_=o(T,function(e,t){r(e,t)},f),E=setTimeout(function(){l(),b.ready()},0),{forceLoadStart:c,destroy:h}}var i=n(30),a=n(126),o=n(125);e.exports=r},function(e,t,n){"use strict";function r(e,t,n){function r(){clearInterval(o),clearInterval(s)}var o,s,u={},c={};return o=setInterval(function(){var r=i(e),a=r.total-u.total,o=r.dropped-u.dropped;o>0&&t("fps.drop.raw",{count:o}),a&&o>0&&o/a>n.droppedFramesThreshold&&t("fps.drop",{count:o}),u=r},n.droppedFramesSampleRate),s=setInterval(function(){var n=a(e),r=n.total-c.total;r>0&&t("bitsDecoded",{count:r}),c=n},n.bitsDecodedSampleRate),{destroy:r}}var i=n(122),a=n(123);e.exports=r},function(e,t,n){"use strict";function r(e,t,n){function r(){var t=i(e),n=!N&&L!==t;return N=!1,L=t,n}function a(){return!(!e.paused||!B&&!H)&&r()}function o(){return I&&y===I&&!R&&!P}function s(){return x||(x=y),y-x>=k}function u(){return P}function c(){return U}function l(){if(!o()&&(F=null,B))return u()||c()||s()}function d(){if(o()&&(x=null,!B))return F||(F=T),T-F>=A}function h(){d()?(B=!0,F=null,t("rebuffer.start")):l()&&(B=!1,x=null,t("rebuffer.end"))}function f(){return w&&!R}function p(){return j||(j=y),y-j>M}function g(){return U}function v(){if(!f()&&(q=null,H))return g()||p()}function m(){if(f()&&(j=null,!H))return q||(q=T),T-q>D}function _(){m()?(H=!0,q=null,t("seek.start")):v()&&(H=!1,j=null,t("seek.end"))}function E(){clearInterval(S),S=setInterval(function(){e.paused||(N=!0),(!e.paused||B||H)&&(T=Date.now(),y=1e3*e.currentTime,R=e.paused,w=e.seeking,P=w||H,U=a(),h(),_(),I=y)},C)}function b(){clearInterval(S)}var S,T,y,R,w,P,I,O=n||{},C=O.sampleRate||50,A=O.bufferEnterThreshold||250,k=O.bufferExitThreshold||250,D=O.seekEnterThreshold||250,M=O.seekExitThreshold||100,N=!0,L=null,U=!1,B=!1,F=null,x=null,H=!1,q=null,j=null;return E(),{destroy:b}}var i=n(28);e.exports=r},function(e,t,n){"use strict";function r(e){return e.length>N&&(e=e.substr(0,N)),new Array(N-e.length+1).join(" ").concat(e)}function i(e){var t=e.reduce(function(e,t){return e+t.length},0),n=new Uint8Array(t),r=0;return e.forEach(function(e){n.set(e,r),r+=e.length}),n}function a(e){return String.fromCharCode.apply(null,e).trim()}function o(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}function s(e,t){var n=t,r=0;return r+=e[n++]<<24,r+=e[n++]<<16,r+=e[n++]<<8,r+=e[n]}function u(e){var t=0,n=e;"number"!=typeof n.length&&(n=Array.prototype.slice.call(arguments));for(var r=new Uint8Array(4*n.length),i=0;i<n.length;i++){var a=n[i];r[t++]=(4278190080&a)>>24,r[t++]=(16711680&a)>>16,r[t++]=(65280&a)>>8,r[t++]=255&a}return r}function c(e){return e?new Uint8Array([1]):new Uint8Array([0])}function l(e,t){return 0!==e[t]}function d(e){var t=o(r(e.swarmId)),n=u(e.chunkId);return i([t,n,e.payload])}function h(e,t,n){var r=t,i=a(e.subarray(r,r+N));r+=N;var o=s(e,r);r+=4;var u=e.subarray(r,r+n);return new M.DataMessage(i,o,u)}function f(e){var t=o(r(e.swarmId)),n=u(e.chunkIds);return i([t,n])}function p(e,t,n){var r=t,i=a(e.subarray(r,r+N));r+=N;for(var o=[];r<t+n;)o.push(s(e,r)),r+=4;return new M.RequestMessage(i,o)}function g(e){var t=[],n=o(r(e.swarmId));t.push(n);var a=o(e.hashUrl);t.push(a);var s=c(e.seeder);t.push(s);var l=u(e.filesize);t.push(l);var d=c(e.complete);return t.push(d),e.complete&&t.push(e.availabilityMap),i(t)}function v(e){var t=o(r(e.swarmId)),n=o(e.hashUrl);return i([t,n])}function m(e){var t=u(e.timestamp),n=u(e.originBufferedAmount);return i([t,n])}function _(e){var t=u(e.timestamp),n=u(e.originBufferedAmount),r=u(e.remoteBufferedAmount);return i([t,n,r])}function E(e){var t=o(r(e.swarmId)),n=o(e.hashUrl);return i([t,n])}function b(e){var t=o(e.hashUrl);return i([t])}function S(e){var t=u(e.segSeq);return i([t])}function T(e,t){var n=t,r=s(e,n);n+=4;var i=s(e,n);return new M.LatencyRequestMessage(r,i)}function y(e,t){var n=t,r=s(e,n);n+=4;var i=s(e,n);n+=4;var a=s(e,n);return new M.LatencyResponseMessage(r,i,a)}function R(e,t,n){var r,i=t,o=a(e.subarray(i,i+N));i+=N;var u=a(e.subarray(i,i+L));i+=L;var c=l(e,i);i++;var d=s(e,i);if(i+=4,!c){var h=l(e,i);i++,h&&(r=e.subarray(i,t+n))}return new M.HaveMessage(o,c,r,u,d)}function w(e,t){var n=t,r=a(e.subarray(n,n+N));n+=N;var i=a(e.subarray(n,n+L));return new M.DontHaveMessage(r,i)}function P(e,t){var n=t,r=a(e.subarray(n,n+N));n+=N;var i=a(e.subarray(n,n+L));return new M.DownloadingMessage(r,i)}function I(e,t){var n=t,r=a(e.subarray(n,n+L));return new M.InitializingMessage(r)}function O(e,t){var n=t,r=s(e,n);return new M.NewSegmentMessage(r)}function C(e){var t=JSON.stringify(e);return o(t)}function A(e,t,n){var r=t;try{var i=a(e.subarray(r,r+n));return JSON.parse(i)}catch(e){return null}}function k(e,t,n){var r=e,i=n,a=new Uint8Array(5+i.length),o=i.length;return a[r++]=t,a.set(u(o),r),r+=B,a.set(i,r),a}function D(e,t){var n=t,r=e[n++],i=s(e,n);n+=B;var a=e.subarray(n,n+i);return[r,a]}var M=n(5),N=36,L=32,U=1,B=4,F={};F[M.P2P_DATA]={encode:d,decode:h},F[M.P2P_REQUEST]={encode:f,decode:p},F[M.P2P_HAVE]={encode:g,decode:R},F[M.P2P_DONT_HAVE]={encode:v,decode:w},F[M.P2P_VERSION]={encode:C,decode:A},F[M.P2P_LATENCY_REQUEST]={encode:m,decode:T},F[M.P2P_LATENCY_RESPONSE]={encode:_,decode:y},F[M.P2P_DOWNLOADING]={encode:E,decode:P},F[M.P2P_NEW_SEGMENT]={encode:S,decode:O},F[M.P2P_INITIALIZING]={encode:b,decode:I},t.encode=function(e){var t=[];return e.forEach(function(e){var n=F[e.tag];if(n&&n.encode){var r=n.encode(e);t.push(k(0,e.tag,r))}}),i(t)},t.decode=function(e){for(var t=0,n=[];t<e.length;){var r=D(e,t),i=r[0],a=r[1];t+=U+B;var o=F[i];if(!o||!o.decode)return null;n.push(o.decode(e,t,a.length)),t+=a.length}return n}},function(e,t,n){"use strict";var r=n(29);e.exports=function(e,t,n){var i=r(e);return i.loaded=t,i.lengthComputable=!1,n&&(i.lengthComputable=!0,i.total=n),i}},function(e,t,n){"use strict";var r=n(2),i=n(4),a=n(128);e.exports=function(e,t,n,o,s,u){function c(){var n=Math.floor((Date.now()-f)/r.MIMIC_REAL_HTTP_INTERVAL);if(n>0){var l=n*h;if(l<o){setTimeout(c,r.MIMIC_REAL_HTTP_INTERVAL),i.info("creating fake progress event for resource: "+t);var d=a(e,l,o);s(d)}else i.info("finishing fake download for resource: "+t),u()}}var l=o/n,d=1e3*l/r.MIMIC_REAL_HTTP_INTERVAL,h=Math.floor(o/d),f=Date.now();i.info("starting fake download for resource: "+t+" with total time of: "+l+"s and size: "+o),setTimeout(c,r.MIMIC_REAL_HTTP_INTERVAL)}},function(e,t,n){(function(t){"use strict";var r=n(31);e.exports=function(){function e(e){radio("requestError"+e._url).subscribe([e.requestErrorEvent,e]),radio("HTTPHeadersReceived"+e._url).subscribe([e.HTTPHeadersReceivedEvent,e]),radio("fileInfoProcessed"+e._url).subscribe([e.fileInfoProcessedEvent,e]),radio("resourceReady"+e._url).subscribe([e.resourceReadyEvent,e]),radio("blockReceived"+e._url).subscribe([e.blockReceivedEvent,e]),radio("transferLoaded"+e._url).subscribe([e.transferLoadedEvent,e]),radio("httpProgress"+e._url).subscribe([e.httpProgressEvent,e]),
radio("chunkSent"+e._url).subscribe([e.chunkSentEvent,e]),radio("activePeerConnectionsNumberChanged").subscribe([e.activePeerConnectionsNumberChangedEvent,e])}function n(e){radio("requestError"+e._url).unsubscribe([e.requestErrorEvent,e]),radio("HTTPHeadersReceived"+e._url).unsubscribe([e.HTTPHeadersReceivedEvent,e]),radio("fileInfoProcessed"+e._url).unsubscribe([e.fileInfoProcessedEvent,e]),radio("resourceReady"+e._url).unsubscribe([e.resourceReadyEvent,e]),radio("blockReceived"+e._url).unsubscribe([e.blockReceivedEvent,e]),radio("transferLoaded"+e._url).unsubscribe([e.transferLoadedEvent,e]),radio("httpProgress"+e._url).unsubscribe([e.httpProgressEvent,e]),radio("chunkSent"+e._url).unsubscribe([e.chunkSentEvent,e]),radio("activePeerConnectionsNumberChanged").unsubscribe([e.activePeerConnectionsNumberChangedEvent,e])}function i(n){var i=r(n._url),a=o[i];a||(a=o[i]={activeRequest:null,pendingRequests:[]}),a.activeRequest?a.pendingRequests.push(n):(a.activeRequest=n,e(n),"GET"===n._method?t.clientInstance.addResource(n._url,n.downloadMode,n._meta):"POST"===n._method&&t.clientInstance.readBlobData(n._url,n._data))}function a(e){var t=r(e._url),a=o[t];if(a)if(a.activeRequest===e){a.activeRequest=null,n(e);var s=a.pendingRequests.shift();s?i(s):delete o[t]}else a.pendingRequests=a.pendingRequests.filter(function(t){return t!==e})}var o=Object.create(null);return radio("resource:complete").subscribe(function(e){var t=r(e.url),n=o[t];if(n){var i=n.activeRequest;i&&i._getUrlAndTriggerOnLoad(e)}}),{addRequest:i,removeRequest:a}}}).call(t,n(1))},function(e,t,n){"use strict";function r(){function e(e){var t=Date.now();switch(e){case"load.end":l.push({action:s,timeStamp:t});break;case"pause.start":case"stop":h=!0,l.push({action:u,timeStamp:t});break;case"pause.end":h=!1,l.push({action:s,timeStamp:t});break;case"rebuffer.start":d.push({action:s,timeStamp:t}),l.push({action:u,timeStamp:t}),clearTimeout(f),f=setTimeout(function(){d.push({action:u,timeStamp:Date.now()}),o.warn("User is rebuffering for too long - forcing rebuffer end")},i.MAX_REBUFFER_DURATION);break;case"rebuffer.end":clearTimeout(f),d.push({action:u,timeStamp:t}),h||l.push({action:s,timeStamp:t})}}function t(e,t,n){for(var r=e,i=0,a=1;a<r.length;a++){var o=r[a],c=r[a-1];o.action===u&&c.action===s&&(i+=o.timeStamp-c.timeStamp)}var l=r[r.length-1];l.action===s&&(i+=n-l.timeStamp),p[t]+=i}function n(e){l=[l[l.length-1]],l[0].timeStamp=e,d=[d[d.length-1]],d[0].timeStamp=e}function r(){var e=Date.now();return t(l,"play",e),t(d,"rebuffer",e),n(e),a({},p)}var c=Date.now(),l=[{action:u,timeStamp:c}],d=[{action:u,timeStamp:c}],h=!1,f=null,p={play:0,rebuffer:0};return{processEvent:e,getTotalDurations:r}}var i=n(2),a=n(14),o=n(4),s=!0,u=!1;e.exports=r},function(e,t,n){"use strict";var r=n(2),i=n(137),a=!1,o={showStats:function(e){window.p5_stats_config=e,a||(a=!0,i("//api.peer5.com/peer5.stats.plugin.js"))},hideStats:function(){}},s=[/^(\w+:)?\/\/player\.kaltura\.com\//i,/(\?|\?.*&)peer5_show_stats=true([&#]|$)/i].some(function(e){return e.test(location.href)});(r.STATS_ENABLE_OVERLAY||s)&&o.showStats(),e.exports=o},function(e,t,n){"use strict";var r=n(4);e.exports=function(){function e(e){var t={action:e.action};return(e.vendor||n)&&(t.vendor=e.vendor||n),i.forEach(function(n){e[n]&&(t[n]=e[n])}),t}function t(t){return r.logPlayerEvent(t),n=t.vendor||n,"pause.start"===t.action||"pause.end"===t.action||"stop"===t.action||/\.raw$/.test(t.action)?null:e(t)}var n=null,i=["occurrence","provider","tracking","duration","timeSinceLoaded","timeSinceReady","value"];return{handle:t}}},function(e,t,n){"use strict";function r(e){function t(e,t,n){var r=e;Object.keys(t).forEach(function(e){r[e]=n(r[e],t[e])})}function n(e,t,n){return t+(e-t)/n}function r(e,n){var r=Date.now()-b;t(e,n,function(e,t){var n=e;n||(n=[]),n.unshift({timestamp:Date.now(),value:t});for(var i=n.length;i--;){if(n[i].timestamp>r){n.splice(i+1,n.length);break}0===i&&n.splice(i,n.length)}return n})}function o(){var e={};return t(e,_,function(e,t){return t.value}),e}function s(e){var n={},r=Date.now()-(e.recentAge||E);return t(n,S.recentSums,function(e,t){var n=0;return t.some(function(e){return!(e.timestamp>r)||(n+=e.value,!1)}),n}),n}function u(e){var n={},r=Date.now()-(e.recentAge||E);return t(n,S.recentAverages,function(e,t){var n=0,i=0;return t.some(function(e){return!(e.timestamp>r)||(n++,i+=e.value,!1)}),i/n||0}),n}function c(e){t(v,e,function(e,t){return(e||0)+t})}function l(e){t(m,e,function(e,t){return Math.max(e||0,t)})}function d(e){t(_,e,function(e,t){var r=e;return r?(r.count++,r.value=n(t,r.value,r.count),r):{value:t,count:1}})}function h(e){r(S.recentSums,e)}function f(e){r(S.recentAverages,e)}function p(e){var t=e||{},n=o(),r=s(t),a=u(t);return i({},n,r,a,m,v)}var g=e||{},v={},m={},_={},E=g.recentAge||a.STATS_RECENT_QUERY_AGE,b=g.maxRecentAge||a.STATS_RECENT_MAX_AGE,S={recentSums:{},recentAverages:{}};return{sum:c,max:l,average:d,sumRecent:h,averageRecent:f,getStats:p}}var i=n(14),a=n(2);e.exports=r},function(e,t){"use strict";t.isWebRTCSupported=function(){var e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;try{var t=new e(null);return"createDataChannel"in t}catch(e){return!1}},t.isWebSocketSupported=function(){return!(!window.WebSocket&&!window.MozWebSocket)}},function(e,t){"use strict";function n(e){for(var t=[],n=0;n<e.length;n++)t.push({start:e.start(n),end:e.end(n)});return t.sort(function(e,t){var n=e.start-t.start;return n?n:t.end-e.end}),t}function r(e,t){return e.reduce(function(e,n){var r=e.length;if(r){var i=e[r-1];if(n.start-i.end<t)return n.end>i.end&&(i.end=n.end),e}return e.push({start:n.start,end:n.end}),e},[])}function i(e,t,i){for(var a=i||0,o=t||0,s=n(e),u=r(s,a),c={rangeStart:0,rangeEnd:0,rangeLength:0,timeAhead:0},l=0,d=u.length;l<d;l++){var h=u[l].start,f=u[l].end,p=Math.ceil(1e3*o)/1e3,g=Math.ceil(1e3*h)/1e3,v=Math.ceil(1e3*f)/1e3;if(p+a>=g&&p<=v){c.rangeStart=Math.min(g,p),c.rangeEnd=v,c.rangeLength=v-c.rangeStart,c.timeAhead=v-p;break}}return c}e.exports=i},function(e,t){"use strict";function n(){}e.exports=function(e,t){function r(){a.parentNode&&a.parentNode.removeChild(a)}var i=t||n,a=document.createElement("script");a.src=e,a.onload=function(){r(),i(null)},a.onerror=function(){r(),i(new Error("failed to load script"))},(document.body||document.head).appendChild(a)}},function(e,t){"use strict";function n(e,t){var n=t||{};return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?Object.keys(e).reduce(function(t,r){var i=e[r],a=""===i||0===i||i===!1,o="string"==typeof i||"number"==typeof i||"boolean"==typeof i;if(!i&&!a||!o){if(n.ignoreEmpty!==!1)return t;i=""}return t.push(encodeURIComponent(r)+"="+encodeURIComponent(i)),t},[]).join("&"):""}e.exports=n},function(e,t){"use strict";function n(){function e(e){r.push(e)}function t(){i||(i=!0,r.forEach(function(e){e()}))}function n(e,t,n){var r=e,i=r[t];r[t]=function(){n(),"function"==typeof i&&i()}}var r=[],i=!1;return n(window,"onbeforeunload",t),n(window,"onunload",t),{listeners:r,onExit:e}}e.exports=n(),e.exports.factory=n},function(e,t){"use strict";t.normalizeUrl=function(e){var t=document.createElement("a");return t.href=e,t.href},t.removeKeysFromQuery=function(e,t){var n=e.indexOf("?"),r=e.indexOf("#");if(!e||!t||!t.length||n===-1||r>0&&r<n)return e;var i=e.substring(0,n),a=e.substring(n+1,r!==-1?r:e.length),o=r!==-1?e.substring(r+1):"",s=a.split("&").filter(function(e){var n=e.split("=");return t.indexOf(decodeURIComponent(n[0]))===-1}).join("&");return i+"?"+s+(o?"#"+o:"")}},function(e,t){"use strict";t.wowza=function(e){var t=/\/media_w\d+/i,n=/(\/media_w)\d+/i;t.test(e)&&(e=e.replace(n,"$1"));var r=/\/media(_[^_]*)+?_tk\w+/i,i=/(\/media(?:_[^_]*)+?_tk)[^_]+/i;r.test(e)&&(e=e.replace(i,"$1"));var a=/_w\d+_mpd\./i,o=/(_w)\d+/i;return a.test(e)&&(e=e.replace(o,"$1")),e}},function(e,t,n){"use strict";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(){this._events=new r,this._eventsCount=0}var o=Object.prototype.hasOwnProperty,s="~";Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)o.call(e,t)&&n.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e,t){var n=s?s+e:e,r=this._events[n];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var i=0,a=r.length,o=new Array(a);i<a;i++)o[i]=r[i].fn;return o},a.prototype.emit=function(e,t,n,r,i,a){var o=s?s+e:e;if(!this._events[o])return!1;var u,c,l=this._events[o],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,r),!0;case 5:return l.fn.call(l.context,t,n,r,i),!0;case 6:return l.fn.call(l.context,t,n,r,i,a),!0}for(c=1,u=new Array(d-1);c<d;c++)u[c-1]=arguments[c];l.fn.apply(l.context,u)}else{var h,f=l.length;for(c=0;c<f;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),d){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,n);break;case 4:l[c].fn.call(l[c].context,t,n,r);break;default:if(!u)for(h=1,u=new Array(d-1);h<d;h++)u[h-1]=arguments[h];l[c].fn.apply(l[c].context,u)}}return!0},a.prototype.on=function(e,t,n){var r=new i(t,n||this),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},a.prototype.once=function(e,t,n){var r=new i(t,n||this,!0),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},a.prototype.removeListener=function(e,t,n,i){var a=s?s+e:e;if(!this._events[a])return this;if(!t)return 0===--this._eventsCount?this._events=new r:delete this._events[a],this;var o=this._events[a];if(o.fn)o.fn!==t||i&&!o.once||n&&o.context!==n||(0===--this._eventsCount?this._events=new r:delete this._events[a]);else{for(var u=0,c=[],l=o.length;u<l;u++)(o[u].fn!==t||i&&!o[u].once||n&&o[u].context!==n)&&c.push(o[u]);c.length?this._events[a]=1===c.length?c[0]:c:0===--this._eventsCount?this._events=new r:delete this._events[a]}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&(0===--this._eventsCount?this._events=new r:delete this._events[t])):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prototype.setMaxListeners=function(){return this},a.prefixed=s,a.EventEmitter=a,e.exports=a},function(e,t){function n(e,t,n,i){return JSON.stringify(e,r(t,i),n)}function r(e,t){var n=[],r=[];return null==t&&(t=function(e,t){return n[0]===t?"[Circular ~]":"[Circular ~."+r.slice(0,n.indexOf(t)).join(".")+"]"}),function(i,a){if(n.length>0){var o=n.indexOf(this);~o?n.splice(o+1):n.push(this),~o?r.splice(o,1/0,i):r.push(i),~n.indexOf(a)&&(a=t.call(this,i,a))}else n.push(a);return null==e?a:e.call(this,i,a)}}t=e.exports=n,t.getSerialize=r},function(e,t){"use strict";function n(e){this.name="RavenConfigError",this.message=e}n.prototype=new Error,n.prototype.constructor=n,e.exports=n},function(e,t){"use strict";var n=function(e,t,n){var r=e[t],i=e;if(t in e){var a="warn"===t?"warning":t;e[t]=function(){var e=[].slice.call(arguments),t=""+e.join(" "),o={level:a,logger:"console",extra:{arguments:e}};n&&n(t,o),r&&Function.prototype.apply.call(r,i,e)}}};e.exports={wrapMethod:n}},function(e,t,n){"use strict";function r(){return+new Date}function i(){this._hasJSON=!("object"!=typeof JSON||!JSON.stringify),this._hasDocument=!a(C),this._lastCapturedException=null,this._lastEventId=null,this._globalServer=null,this._globalKey=null,this._globalProject=null,this._globalContext={},this._globalOptions={logger:"javascript",ignoreErrors:[],ignoreUrls:[],whitelistUrls:[],includePaths:[],crossOrigin:"anonymous",collectWindowErrors:!0,maxMessageLength:0,stackTraceLimit:50,autoBreadcrumbs:!0},this._ignoreOnError=0,this._isRavenInstalled=!1,this._originalErrorStackTraceLimit=Error.stackTraceLimit,this._originalConsole=O.console||{},this._originalConsoleMethods={},this._plugins=[],this._startTime=r(),this._wrappedBuiltIns=[],this._breadcrumbs=[],this._lastCapturedEvent=null,this._keypressTimeout,this._location=O.location,this._lastHref=this._location&&this._location.href;for(var e in this._originalConsole)this._originalConsoleMethods[e]=this._originalConsole[e]}function a(e){return void 0===e}function o(e){return"function"==typeof e}function s(e){return"[object String]"===A.toString.call(e)}function u(e){return"object"==typeof e&&null!==e}function c(e){for(var t in e)return!1;return!0}function l(e){var t=A.toString.call(e);return u(e)&&"[object Error]"===t||"[object Exception]"===t||e instanceof Error}function d(e,t){var n,r;if(a(e.length))for(n in e)p(e,n)&&t.call(null,n,e[n]);else if(r=e.length)for(n=0;n<r;n++)t.call(null,n,e[n])}function h(e,t){return t?(d(t,function(t,n){e[t]=n}),e):e}function f(e,t){return!t||e.length<=t?e:e.substr(0,t)+"…"}function p(e,t){return A.hasOwnProperty.call(e,t)}function g(e){for(var t,n=[],r=0,i=e.length;r<i;r++)t=e[r],s(t)?n.push(t.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")):t&&t.source&&n.push(t.source);return new RegExp(n.join("|"),"i")}function v(e){var t=[];return d(e,function(e,n){t.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}),t.join("&")}function m(e){var t=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?$/);if(!t)return{};var n=t[6]||"",r=t[8]||"";return{protocol:t[2],host:t[4],path:t[5],relative:t[5]+n+r}}function _(){var e=window.crypto||window.msCrypto;if(!a(e)&&e.getRandomValues){var t=new Uint16Array(8);e.getRandomValues(t),t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;var n=function(e){for(var t=e.toString(16);t.length<4;)t="0"+t;return t};return n(t[0])+n(t[1])+n(t[2])+n(t[3])+n(t[4])+n(t[5])+n(t[6])+n(t[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})}function E(e){for(var t,n=5,r=80,i=[],a=0,o=0,s=" > ",u=s.length;e&&a++<n&&(t=b(e),!("html"===t||a>1&&o+i.length*u+t.length>=r));)i.push(t),o+=t.length,e=e.parentNode;return i.reverse().join(s)}function b(e){var t,n,r,i,a,o=[];if(!e||!e.tagName)return"";if(o.push(e.tagName.toLowerCase()),e.id&&o.push("#"+e.id),t=e.className,t&&s(t))for(n=t.split(" "),a=0;a<n.length;a++)o.push("."+n[a]);var u=["type","name","title","alt"];for(a=0;a<u.length;a++)r=u[a],i=e.getAttribute(r),i&&o.push("["+r+'="'+i+'"]');return o.join("")}function S(e,t,n,r){var i=e[t];e[t]=n(i),r&&r.push([e,t,i])}var T=n(148),y=n(144),R=n(143),w=n(145).wrapMethod,P="source protocol user pass host port path".split(" "),I=/^(?:(\w+):)?\/\/(?:(\w+)(:\w+)?@)?([\w\.-]+)(?::(\d+))?(\/.*)/,O="undefined"!=typeof window?window:void 0,C=O&&O.document;i.prototype={VERSION:"3.8.0",debug:!1,TraceKit:T,config:function(e,t){var n=this;if(n._globalServer)return this._logDebug("error","Error: Raven has already been configured"),n;if(!e)return n;var r=n._globalOptions;t&&d(t,function(e,t){"tags"===e||"extra"===e?n._globalContext[e]=t:r[e]=t}),n.setDSN(e),r.ignoreErrors.push(/^Script error\.?$/),r.ignoreErrors.push(/^Javascript error: Script error\.? on line 0$/),r.ignoreErrors=g(r.ignoreErrors),r.ignoreUrls=!!r.ignoreUrls.length&&g(r.ignoreUrls),r.whitelistUrls=!!r.whitelistUrls.length&&g(r.whitelistUrls),r.includePaths=g(r.includePaths),r.maxBreadcrumbs=Math.max(0,Math.min(r.maxBreadcrumbs||100,100));var i={xhr:!0,console:!0,dom:!0,location:!0},a=r.autoBreadcrumbs;return"[object Object]"==={}.toString.call(a)?a=h(i,a):a!==!1&&(a=i),r.autoBreadcrumbs=a,T.collectWindowErrors=!!r.collectWindowErrors,n},install:function(){var e=this;return e.isSetup()&&!e._isRavenInstalled&&(T.report.subscribe(function(){e._handleOnErrorStackInfo.apply(e,arguments)}),e._instrumentTryCatch(),e._globalOptions.autoBreadcrumbs&&e._instrumentBreadcrumbs(),e._drainPlugins(),e._isRavenInstalled=!0),Error.stackTraceLimit=e._globalOptions.stackTraceLimit,this},setDSN:function(e){var t=this,n=t._parseDSN(e),r=n.path.lastIndexOf("/"),i=n.path.substr(1,r);t._dsn=e,t._globalKey=n.user,t._globalSecret=n.pass&&n.pass.substr(1),t._globalProject=n.path.substr(r+1),t._globalServer=t._getGlobalServer(n),t._globalEndpoint=t._globalServer+"/"+i+"api/"+t._globalProject+"/store/"},context:function(e,t,n){return o(e)&&(n=t||[],t=e,e=void 0),this.wrap(e,t).apply(this,n)},wrap:function(e,t,n){function r(){var r=[],a=arguments.length,s=!e||e&&e.deep!==!1;for(n&&o(n)&&n.apply(this,arguments);a--;)r[a]=s?i.wrap(e,arguments[a]):arguments[a];try{return t.apply(this,r)}catch(t){throw i._ignoreNextOnError(),i.captureException(t,e),t}}var i=this;if(a(t)&&!o(e))return e;if(o(e)&&(t=e,e=void 0),!o(t))return t;try{if(t.__raven__)return t;if(t.__raven_wrapper__)return t.__raven_wrapper__}catch(e){return t}for(var s in t)p(t,s)&&(r[s]=t[s]);return r.prototype=t.prototype,t.__raven_wrapper__=r,r.__raven__=!0,r.__inner__=t,r},uninstall:function(){return T.report.uninstall(),this._restoreBuiltIns(),Error.stackTraceLimit=this._originalErrorStackTraceLimit,this._isRavenInstalled=!1,this},captureException:function(e,t){if(!l(e))return this.captureMessage(e,h({trimHeadFrames:1,stacktrace:!0},t));this._lastCapturedException=e;try{var n=T.computeStackTrace(e);this._handleStackInfo(n,t)}catch(t){if(e!==t)throw t}return this},captureMessage:function(e,t){if(!this._globalOptions.ignoreErrors.test||!this._globalOptions.ignoreErrors.test(e)){var n=h({message:e+""},t);if(t&&t.stacktrace){var r;try{throw new Error(e)}catch(e){r=e}r.name=null,t=h({fingerprint:e,trimHeadFrames:(t.trimHeadFrames||0)+1},t);var i=T.computeStackTrace(r),a=this._prepareFrames(i,t);n.stacktrace={frames:a.reverse()}}return this._send(n),this}},captureBreadcrumb:function(e){var t=h({timestamp:r()/1e3},e);return this._breadcrumbs.push(t),this._breadcrumbs.length>this._globalOptions.maxBreadcrumbs&&this._breadcrumbs.shift(),this},addPlugin:function(e){var t=[].slice.call(arguments,1);return this._plugins.push([e,t]),this._isRavenInstalled&&this._drainPlugins(),this},setUserContext:function(e){return this._globalContext.user=e,this},setExtraContext:function(e){return this._mergeContext("extra",e),this},setTagsContext:function(e){return this._mergeContext("tags",e),this},clearContext:function(){return this._globalContext={},this},getContext:function(){return JSON.parse(R(this._globalContext))},setEnvironment:function(e){return this._globalOptions.environment=e,this},setRelease:function(e){return this._globalOptions.release=e,this},setDataCallback:function(e){var t=this._globalOptions.dataCallback;return this._globalOptions.dataCallback=o(e)?function(n){return e(n,t)}:e,this},setShouldSendCallback:function(e){var t=this._globalOptions.shouldSendCallback;return this._globalOptions.shouldSendCallback=o(e)?function(n){return e(n,t)}:e,this},setTransport:function(e){return this._globalOptions.transport=e,this},lastException:function(){return this._lastCapturedException},lastEventId:function(){return this._lastEventId},isSetup:function(){return!!this._hasJSON&&(!!this._globalServer||(this.ravenNotConfiguredError||(this.ravenNotConfiguredError=!0,this._logDebug("error","Error: Raven has not been configured.")),!1))},afterLoad:function(){var e=O.RavenConfig;e&&this.config(e.dsn,e.config).install()},showReportDialog:function(e){if(C){e=e||{};var t=e.eventId||this.lastEventId();if(!t)throw new y("Missing eventId");var n=e.dsn||this._dsn;if(!n)throw new y("Missing DSN");var r=encodeURIComponent,i="";i+="?eventId="+r(t),i+="&dsn="+r(n);var a=e.user||this._globalContext.user;a&&(a.name&&(i+="&name="+r(a.name)),a.email&&(i+="&email="+r(a.email)));var o=this._getGlobalServer(this._parseDSN(n)),s=C.createElement("script");s.async=!0,s.src=o+"/api/embed/error-page/"+i,(C.head||C.body).appendChild(s)}},_ignoreNextOnError:function(){var e=this;this._ignoreOnError+=1,setTimeout(function(){e._ignoreOnError-=1})},_triggerEvent:function(e,t){var n,r;if(this._hasDocument){t=t||{},e="raven"+e.substr(0,1).toUpperCase()+e.substr(1),C.createEvent?(n=C.createEvent("HTMLEvents"),n.initEvent(e,!0,!0)):(n=C.createEventObject(),n.eventType=e);for(r in t)p(t,r)&&(n[r]=t[r]);if(C.createEvent)C.dispatchEvent(n);else try{C.fireEvent("on"+n.eventType.toLowerCase(),n)}catch(e){}}},_breadcrumbEventHandler:function(e){var t=this;return function(n){if(t._keypressTimeout=null,t._lastCapturedEvent!==n){t._lastCapturedEvent=n;var r,i=n.target;try{r=E(i)}catch(e){r="<unknown>"}t.captureBreadcrumb({category:"ui."+e,message:r})}}},_keypressEventHandler:function(){var e=this,t=1e3;return function(n){var r=n.target,i=r&&r.tagName;if(i&&("INPUT"===i||"TEXTAREA"===i||r.isContentEditable)){var a=e._keypressTimeout;a||e._breadcrumbEventHandler("input")(n),clearTimeout(a),e._keypressTimeout=setTimeout(function(){e._keypressTimeout=null},t)}}},_captureUrlChange:function(e,t){var n=m(this._location.href),r=m(t),i=m(e);this._lastHref=t,n.protocol===r.protocol&&n.host===r.host&&(t=r.relative),n.protocol===i.protocol&&n.host===i.host&&(e=i.relative),this.captureBreadcrumb({category:"navigation",data:{to:t,from:e}})},_instrumentTryCatch:function(){function e(e){return function(t,r){for(var i=new Array(arguments.length),a=0;a<i.length;++a)i[a]=arguments[a];var s=i[0];return o(s)&&(i[0]=n.wrap(s)),e.apply?e.apply(this,i):e(i[0],i[1])}}function t(e){var t=O[e]&&O[e].prototype;t&&t.hasOwnProperty&&t.hasOwnProperty("addEventListener")&&(S(t,"addEventListener",function(t){return function(r,a,o,s){try{a&&a.handleEvent&&(a.handleEvent=n.wrap(a.handleEvent))}catch(e){}var u;return i&&i.dom&&("EventTarget"===e||"Node"===e)&&("click"===r?u=n._breadcrumbEventHandler(r):"keypress"===r&&(u=n._keypressEventHandler())),t.call(this,r,n.wrap(a,void 0,u),o,s)}},r),S(t,"removeEventListener",function(e){return function(t,n,r,i){try{n=n&&(n.__raven_wrapper__?n.__raven_wrapper__:n)}catch(e){}return e.call(this,t,n,r,i)}},r))}var n=this,r=n._wrappedBuiltIns,i=this._globalOptions.autoBreadcrumbs;S(O,"setTimeout",e,r),S(O,"setInterval",e,r),O.requestAnimationFrame&&S(O,"requestAnimationFrame",function(e){return function(t){return e(n.wrap(t))}},r);for(var a=["EventTarget","Window","Node","ApplicationCache","AudioTrackList","ChannelMergerNode","CryptoOperation","EventSource","FileReader","HTMLUnknownElement","IDBDatabase","IDBRequest","IDBTransaction","KeyOperation","MediaController","MessagePort","ModalWindow","Notification","SVGElementInstance","Screen","TextTrack","TextTrackCue","TextTrackList","WebSocket","WebSocketWorker","Worker","XMLHttpRequest","XMLHttpRequestEventTarget","XMLHttpRequestUpload"],s=0;s<a.length;s++)t(a[s]);var u=O.jQuery||O.$;u&&u.fn&&u.fn.ready&&S(u.fn,"ready",function(e){return function(t){return e.call(this,n.wrap(t))}},r)},_instrumentBreadcrumbs:function(){function e(e,n){e in n&&o(n[e])&&S(n,e,function(e){return t.wrap(e)})}var t=this,n=this._globalOptions.autoBreadcrumbs,r=t._wrappedBuiltIns;if(n.xhr&&"XMLHttpRequest"in O){var i=XMLHttpRequest.prototype;S(i,"open",function(e){return function(n,r){return s(r)&&r.indexOf(t._globalKey)===-1&&(this.__raven_xhr={method:n,url:r,status_code:null}),e.apply(this,arguments)}},r),S(i,"send",function(n){return function(r){function i(){if(a.__raven_xhr&&(1===a.readyState||4===a.readyState)){try{a.__raven_xhr.status_code=a.status}catch(e){}t.captureBreadcrumb({type:"http",category:"xhr",data:a.__raven_xhr})}}for(var a=this,s=["onload","onerror","onprogress"],u=0;u<s.length;u++)e(s[u],a);return"onreadystatechange"in a&&o(a.onreadystatechange)?S(a,"onreadystatechange",function(e){return t.wrap(e,void 0,i)}):a.onreadystatechange=i,n.apply(this,arguments)}},r)}n.xhr&&"fetch"in O&&S(O,"fetch",function(e){return function(n,r){for(var i=new Array(arguments.length),a=0;a<i.length;++a)i[a]=arguments[a];var o="GET";i[1]&&i[1].method&&(o=i[1].method);var s={method:o,url:i[0],status_code:null};return t.captureBreadcrumb({type:"http",category:"fetch",data:s}),e.apply(this,i).then(function(e){return s.status_code=e.status,e})}},r),n.dom&&this._hasDocument&&(C.addEventListener?(C.addEventListener("click",t._breadcrumbEventHandler("click"),!1),C.addEventListener("keypress",t._keypressEventHandler(),!1)):(C.attachEvent("onclick",t._breadcrumbEventHandler("click")),C.attachEvent("onkeypress",t._keypressEventHandler())));var a=O.chrome,u=a&&a.app&&a.app.runtime,c=!u&&O.history&&history.pushState;if(n.location&&c){var l=O.onpopstate;O.onpopstate=function(){var e=t._location.href;if(t._captureUrlChange(t._lastHref,e),l)return l.apply(this,arguments)},S(history,"pushState",function(e){return function(){var n=arguments.length>2?arguments[2]:void 0;return n&&t._captureUrlChange(t._lastHref,n+""),e.apply(this,arguments)}},r)}if(n.console&&"console"in O&&console.log){var h=function(e,n){t.captureBreadcrumb({message:e,level:n.level,category:"console"})};d(["debug","info","warn","error","log"],function(e,t){w(console,t,h)})}},_restoreBuiltIns:function(){for(var e;this._wrappedBuiltIns.length;){e=this._wrappedBuiltIns.shift();var t=e[0],n=e[1],r=e[2];t[n]=r}},_drainPlugins:function(){var e=this;d(this._plugins,function(t,n){var r=n[0],i=n[1];r.apply(e,[e].concat(i))})},_parseDSN:function(e){var t=I.exec(e),n={},r=7;try{for(;r--;)n[P[r]]=t[r]||""}catch(t){throw new y("Invalid DSN: "+e)}if(n.pass&&!this._globalOptions.allowSecretKey)throw new y("Do not specify your secret key in the DSN. See: http://bit.ly/raven-secret-key");return n},_getGlobalServer:function(e){var t="//"+e.host+(e.port?":"+e.port:"");return e.protocol&&(t=e.protocol+":"+t),t},_handleOnErrorStackInfo:function(){this._ignoreOnError||this._handleStackInfo.apply(this,arguments)},_handleStackInfo:function(e,t){var n=this._prepareFrames(e,t);this._triggerEvent("handle",{stackInfo:e,options:t}),this._processException(e.name,e.message,e.url,e.lineno,n,t)},_prepareFrames:function(e,t){var n=this,r=[];if(e.stack&&e.stack.length&&(d(e.stack,function(e,t){var i=n._normalizeFrame(t);i&&r.push(i)}),t&&t.trimHeadFrames))for(var i=0;i<t.trimHeadFrames&&i<r.length;i++)r[i].in_app=!1;return r=r.slice(0,this._globalOptions.stackTraceLimit)},_normalizeFrame:function(e){if(e.url){var t={filename:e.url,lineno:e.line,colno:e.column,function:e.func||"?"};return t.in_app=!(this._globalOptions.includePaths.test&&!this._globalOptions.includePaths.test(t.filename)||/(Raven|TraceKit)\./.test(t.function)||/raven\.(min\.)?js$/.test(t.filename)),t}},_processException:function(e,t,n,r,i,a){var o;if((!this._globalOptions.ignoreErrors.test||!this._globalOptions.ignoreErrors.test(t))&&(t+="",i&&i.length?(n=i[0].filename||n,i.reverse(),o={frames:i}):n&&(o={frames:[{filename:n,lineno:r,in_app:!0}]}),(!this._globalOptions.ignoreUrls.test||!this._globalOptions.ignoreUrls.test(n))&&(!this._globalOptions.whitelistUrls.test||this._globalOptions.whitelistUrls.test(n)))){var s=h({exception:{values:[{type:e,value:t,stacktrace:o}]},culprit:n},a);this._send(s)}},_trimPacket:function(e){var t=this._globalOptions.maxMessageLength;if(e.message&&(e.message=f(e.message,t)),e.exception){var n=e.exception.values[0];n.value=f(n.value,t)}return e},_getHttpData:function(){if(this._hasDocument&&C.location&&C.location.href){var e={headers:{"User-Agent":navigator.userAgent}};return e.url=C.location.href,C.referrer&&(e.headers.Referer=C.referrer),e}},_send:function(e){var t=this._globalOptions,n={project:this._globalProject,logger:t.logger,platform:"javascript"},i=this._getHttpData();i&&(n.request=i),e.trimHeadFrames&&delete e.trimHeadFrames,e=h(n,e),e.tags=h(h({},this._globalContext.tags),e.tags),e.extra=h(h({},this._globalContext.extra),e.extra),e.extra["session:duration"]=r()-this._startTime,this._breadcrumbs&&this._breadcrumbs.length>0&&(e.breadcrumbs={values:[].slice.call(this._breadcrumbs,0)}),c(e.tags)&&delete e.tags,this._globalContext.user&&(e.user=this._globalContext.user),t.environment&&(e.environment=t.environment),t.release&&(e.release=t.release),t.serverName&&(e.server_name=t.serverName),o(t.dataCallback)&&(e=t.dataCallback(e)||e),e&&!c(e)&&(o(t.shouldSendCallback)&&!t.shouldSendCallback(e)||this._sendProcessedPayload(e))},_getUuid:function(){return _()},_sendProcessedPayload:function(e,t){var n=this,r=this._globalOptions;if(this._lastEventId=e.event_id||(e.event_id=this._getUuid()),e=this._trimPacket(e),this._logDebug("debug","Raven about to send:",e),this.isSetup()){var i={sentry_version:"7",sentry_client:"raven-js/"+this.VERSION,sentry_key:this._globalKey};this._globalSecret&&(i.sentry_secret=this._globalSecret);var a=e.exception&&e.exception.values[0];this.captureBreadcrumb({category:"sentry",message:a?(a.type?a.type+": ":"")+a.value:e.message,event_id:e.event_id,level:e.level||"error"});var o=this._globalEndpoint;(r.transport||this._makeRequest).call(this,{url:o,auth:i,data:e,options:r,onSuccess:function(){n._triggerEvent("success",{data:e,src:o}),t&&t()},onError:function(r){n._triggerEvent("failure",{data:e,src:o}),r=r||new Error("Raven send failed (no additional details provided)"),t&&t(r)}})}},_makeRequest:function(e){function t(){200===n.status?e.onSuccess&&e.onSuccess():e.onError&&e.onError(new Error("Sentry error code: "+n.status))}var n=new XMLHttpRequest,r="withCredentials"in n||"undefined"!=typeof XDomainRequest;if(r){var i=e.url;"withCredentials"in n?n.onreadystatechange=function(){4===n.readyState&&t()}:(n=new XDomainRequest,i=i.replace(/^https?:/,""),n.onload=t),n.open("POST",i+"?"+v(e.auth)),n.send(R(e.data))}},_logDebug:function(e){this._originalConsoleMethods[e]&&this.debug&&Function.prototype.apply.call(this._originalConsoleMethods[e],this._originalConsole,[].slice.call(arguments,1))},_mergeContext:function(e,t){a(t)?delete this._globalContext[e]:this._globalContext[e]=h(this._globalContext[e]||{},t)}};var A=Object.prototype;i.prototype.setUser=i.prototype.setUserContext,i.prototype.setReleaseContext=i.prototype.setRelease,e.exports=i},function(e,t,n){"use strict";var r=n(146),i=window.Raven,a=new r;a.noConflict=function(){return window.Raven=i,a},a.afterLoad(),e.exports=a},function(e,t){"use strict";function n(){return"undefined"==typeof document?"":document.location.href}var r={collectWindowErrors:!0,debug:!1},i=[].slice,a="?",o=/^(?:Uncaught (?:exception: )?)?((?:Eval|Internal|Range|Reference|Syntax|Type|URI)Error): ?(.*)$/;r.report=function(){function e(e){l(),v.push(e)}function t(e){for(var t=v.length-1;t>=0;--t)v[t]===e&&v.splice(t,1)}function s(){d(),v=[]}function u(e,t){var n=null;if(!t||r.collectWindowErrors){for(var a in v)if(v.hasOwnProperty(a))try{v[a].apply(null,[e].concat(i.call(arguments,2)))}catch(e){n=e}if(n)throw n}}function c(e,t,i,s,c){var l=null;if(E)r.computeStackTrace.augmentStackTraceWithInitialElement(E,t,i,e),h();else if(c)l=r.computeStackTrace(c),u(l,!0);else{var d,f={url:t,line:i,column:s},g=void 0,v=e;if("[object String]"==={}.toString.call(e)){var d=e.match(o);d&&(g=d[1],v=d[2])}f.func=a,l={name:g,message:v,url:n(),stack:[f]},u(l,!0)}return!!p&&p.apply(this,arguments)}function l(){g||(p=window.onerror,window.onerror=c,g=!0)}function d(){g&&(window.onerror=p,g=!1,p=void 0)}function h(){var e=E,t=m;m=null,E=null,_=null,u.apply(null,[e,!1].concat(t))}function f(e,t){var n=i.call(arguments,1);if(E){if(_===e)return;h()}var a=r.computeStackTrace(e);if(E=a,_=e,m=n,setTimeout(function(){_===e&&h()},a.incomplete?2e3:0),t!==!1)throw e}var p,g,v=[],m=null,_=null,E=null;return f.subscribe=e,f.unsubscribe=t,f.uninstall=s,f}(),r.computeStackTrace=function(){function e(e){if("undefined"!=typeof e.stack&&e.stack){for(var t,r,i=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|<anonymous>).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,o=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|\[native).*?)(?::(\d+))?(?::(\d+))?\s*$/i,s=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,u=e.stack.split("\n"),c=[],l=(/^(.*) is undefined$/.exec(e.message),
0),d=u.length;l<d;++l){if(t=i.exec(u[l])){var h=t[2]&&t[2].indexOf("native")!==-1;r={url:h?null:t[2],func:t[1]||a,args:h?[t[2]]:[],line:t[3]?+t[3]:null,column:t[4]?+t[4]:null}}else if(t=s.exec(u[l]))r={url:t[2],func:t[1]||a,args:[],line:+t[3],column:t[4]?+t[4]:null};else{if(!(t=o.exec(u[l])))continue;r={url:t[3],func:t[1]||a,args:t[2]?t[2].split(","):[],line:t[4]?+t[4]:null,column:t[5]?+t[5]:null}}!r.func&&r.line&&(r.func=a),c.push(r)}return c.length?(c[0].column||"undefined"==typeof e.columnNumber||(c[0].column=e.columnNumber+1),{name:e.name,message:e.message,url:n(),stack:c}):null}}function t(e,t,n,r){var i={url:t,line:n};if(i.url&&i.line){if(e.incomplete=!1,i.func||(i.func=a),e.stack.length>0&&e.stack[0].url===i.url){if(e.stack[0].line===i.line)return!1;if(!e.stack[0].line&&e.stack[0].func===i.func)return e.stack[0].line=i.line,!1}return e.stack.unshift(i),e.partial=!0,!0}return e.incomplete=!0,!1}function i(e,s){for(var u,c,l=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,d=[],h={},f=!1,p=i.caller;p&&!f;p=p.caller)if(p!==o&&p!==r.report){if(c={url:null,func:a,line:null,column:null},p.name?c.func=p.name:(u=l.exec(p.toString()))&&(c.func=u[1]),"undefined"==typeof c.func)try{c.func=u.input.substring(0,u.input.indexOf("{"))}catch(e){}h[""+p]?f=!0:h[""+p]=!0,d.push(c)}s&&d.splice(0,s);var g={name:e.name,message:e.message,url:n(),stack:d};return t(g,e.sourceURL||e.fileName,e.line||e.lineNumber,e.message||e.description),g}function o(t,a){var o=null;a=null==a?0:+a;try{if(o=e(t))return o}catch(e){if(r.debug)throw e}try{if(o=i(t,a+1))return o}catch(e){if(r.debug)throw e}return{name:t.name,message:t.message,url:n()}}return o.augmentStackTraceWithInitialElement=t,o.computeStackTraceFromStackProp=e,o}(),e.exports=r},function(e,t,n){(function(t){"use strict";function n(){function e(e){var t=Object.create(null);t.url=e.url,t.swarmId=e.swarmId,t.mod=e.mod,t.sha1=e.sha1,t.md5=e.md5,t.constraint=e.constraint,t.httpConstraint=e.httpConstraint,t.state=e.state,t.origin=e.origin,t.hashAlg=e.hashAlg,t.blockHashes=e.blockHashes,t.chunkRead=e.chunkRead,t.size=e.size,t.preventDownload=e.preventDownload,t.httpIdle=e.httpIdle,t.start=e.start,t.skipJoin=e.skipJoin;var n=t.url;return n&&(s.add(n,t),t.swarmId&&s.alias(swarmId,n)),t}function n(e){return s.get(e)}function r(e){s.remove(e)}function i(e,t){s.alias(e,t)}function a(){var e=s.getAllKeys();return e.map(s.get).filter(function(e){return e.state<4})}function o(){return s.getAllKeys().length}var s=t.core.dataStructures.MultiKeyMap();return{add:e,get:n,remove:r,alias:i,getActiveResources:a,getNumOfResources:o}}e.exports=n(),t.state.resources=e.exports}).call(t,n(1))}]);