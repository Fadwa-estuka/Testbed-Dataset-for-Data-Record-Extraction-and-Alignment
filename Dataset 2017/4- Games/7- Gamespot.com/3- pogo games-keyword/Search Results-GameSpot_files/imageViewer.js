(function(e){"use strict";var i=e.Phoenix,t;if(!i){e.Phoenix=i={}}t=i.ImageViewer=i.ImageViewer||{};t.Models=t.Models||{};t.Models.Image=Backbone.Model.extend({defaults:{original:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("src")){this.set({src:this.defaults.title})}}});t.Models.Comment=Backbone.Model.extend({defaults:{avatar:"/bundles/phoenixsite/images/core/loose/no-image-30x30.png"},initialize:function(){if(!this.get("avatar")){this.set({avatar:this.defaults.title})}}})})(this);
(function(e){"use strict";var o=e.Phoenix,n;if(!o){e.Phoenix=o={}}n=o.ImageViewer=o.ImageViewer||{};n.Collections=n.Collections||{};n.Collections.Images=Backbone.Collection.extend({model:n.Models.Image,parse:function(e,o){return e.images},initialize:function(){this.on("add",function(e){if(!e.id){throw new Error("Invalid model data.")}})}});n.Collections.Comments=Backbone.Collection.extend({model:n.Models.Comment})})(this);
(function(e){"use strict";var s=e.Phoenix,t;if(!s){e.Phoenix=s={}}t=s.ImageViewer=s.ImageViewer||{};t.Views=t.Views||{};t.Views.Mixins={loadResults:function(e,s){var t=this;s=s||{};if(!this.loadingResults){this.loadingResults=true;this.collection.fetch({url:e.fetchUrl,remove:false,data:{images:e.imageIds,start:e.startingIndex+=e.requestThreshold,count:e.requestThreshold,object:e.objectId||""},success:function(e,i){t.loadingResults=false;if(s.success){s.success.call(t,i)}},error:function(e,s,i){t.loadingResults=false},complete:function(){if(s.complete){s.complete.call(t)}}})}}}})(this);
(function(e){"use strict";var i=Phoenix.getDocument();e.Views.Viewer=Backbone.View.extend(_.extend({},e.Views.Mixins,{el:Phoenix.jQuery.getBody(),els:{},collectionIndex:0,viewerOpen:false,viewerMode:"",gutterSize:0,btnSize:120,thumbSize:150,imageIds:"",objectId:"",activeGuid:null,startingIndex:0,requestThreshold:30,windowWidth:null,windowHeight:null,paneWidth:null,paneHeight:null,commentUrl:null,viewerEnabled:true,entryUrl:"",isPhone:false,currentFetch:null,returnFocusEl:null,commandsTipCookieKey:"image_commands_tip_hidden",commandsTipFadeOutDelay:4e3,commandsTipHideDelay:2e3,commandsTipTimeout:null,events:{"click #js-image-close":"closeViewer","click #js-image-prev":"prevImage","click #js-image-next":"nextImage","click #js-image-pane":"nextImage","click #js-image-view-film":"toggleFilmStrip","click #js-image-fs":"toggleFullscreen","click #wrapper figure a":"loadFromEmbed"},initialize:function(){var i=this;this.setEls().setStage();this.entryUrl=window.location.pathname+window.location.search;var t=$('meta[itemprop="deviceType"]').attr("content");if(t==="phone"){this.isPhone=true}this.initializeCollection();if(this.isPhone){return}this.commentPoster=new e.Views.CommentPoster({});Phoenix.jQuery.getWindow().on({resize:$.proxy(this.setStage,this),keydown:$.proxy(this.keypressHandler,this)});this.els.$sideColumn.on("click","a",function(e){i.stopEvent(e);i.closeViewer(e,true);window.location.href=e.target.href})},initializeCollection:function(){var t=this;if(this.currentFetch!==null){this.currentFetch.abort()}var s=Phoenix.jQuery.getWrapper().find("#galleryMarker");this.viewerMode=s.data("mode")?s.data("mode"):"adHoc";this.requestThreshold=this.calculateThreshold();var n=$("meta[itemprop=cdnHost]").attr("content");this.fetchUrl="/js/image-data.json";if(this.viewerMode==="gallery"){this.imageIds=s.data("galleryId");this.objectId=s.data("objectId");window.onbeforeunload=function(e){t.closeViewer(e,true)}}else if(this.viewerMode==="permalink"){this.fetchUrl=n+this.fetchUrl;this.imageIds=s.data("refId");$("#js-image-close").hide()}else if(this.viewerMode==="adHoc"){var r=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")}).get();if(r.length>=300){this.destroyCollection();this.disableViewer();$("figure a").click(function(e){e.preventDefault();if($(this).attr("href").length>0){window.open($(this).attr("href").replace("square_avatar","original"),"_blank")}return false})}this.fetchUrl=n+this.fetchUrl;this.imageIds=r.join(",");window.onbeforeunload=function(e){t.closeViewer(e,true)};i.on("image-viewer-rescrape",function(i){var s=Phoenix.jQuery.getWrapper().find("figure a[data-ref-id]").map(function(){return this.getAttribute("data-ref-id")});var n=t.imageIds.split(",");var r=_.difference(s,n);t.imageIds=r.join(",");t.loadResults(e.App);t.imageIds=_.union(n,r).join(",")})}if(this.imageIds===""){return}this.currentFetch=this.collection.fetch({url:this.fetchUrl,data:{images:this.imageIds,start:this.startingIndex,count:this.requestThreshold,object:this.objectId},success:function(){Phoenix.jQuery.getWindow().trigger("collectionLoaded");if(t.collection.length>0){t.commentUrl=t.collection.at(0).get("addCommentUrl")}},error:function(e,i,t){if(i==="timeout"){}}})},destroyCollection:function(){this.startingIndex=0;this.collection.reset()},disableViewer:function(){this.viewerEnabled=false},enableViewer:function(){this.viewerEnabled=true},render:function(t){if(this.isPhone){return}if(!this.viewerOpen){i.trigger("render_page_event",["image_view"])}this.activeGuid=t;var s=this.collection.get(t);this.imageView=new e.Views.ImageView({model:s});this.titleBar=new e.Views.TitleBar({model:s});this.info=new e.Views.InfoBar({model:s});if(this.collection.length>1&&!this.filmstrip){this.filmstrip=new e.Views.Filmstrip({collection:this.collection})}this.togglePaginationVisibility();if(!this.viewerOpen){this.els.$viewer.attr({tabindex:"0",open:"true",role:"dialog","aria-describedby":"imageSource","aria-labelledby":"js-image-title"});this.els.$viewer.addClass("filmstripOpen");if(this.shouldShowCommandsTip()){this.toggleCommandsTip("show")}Phoenix.jQuery.getHtml().css("overflow-y","hidden");this.viewerOpen=true}return this},calculateThreshold:function(){if(this.viewerMode==="adHoc"){return-1}if(this.isPhone){return 5}return Math.floor(this.windowWidth/this.thumbSize)*Math.ceil(this.stripHeight/this.thumbSize)},keypressHandler:function(e){if(!this.viewerOpen){return}var i=Phoenix.Core.keycodes;if(this.$el.data("filmstripOpen")){switch(e.which){case i.rightArrow:this.filmstrip.moveHighlight("right");break;case i.leftArrow:this.filmstrip.moveHighlight("left");break;case i.downArrow:this.filmstrip.moveHighlight("down");break;case i.upArrow:this.filmstrip.moveHighlight("up");break;case i.escapeKey:this.toggleFilmStrip();break;case i.enterKey:this.filmstrip.showImage(e);break}}else{switch(e.which){case i.escapeKey:this.closeViewer();break;case i.rightArrow:this.nextImage();break;case i.leftArrow:this.prevImage();break;case i.upArrow:this.toggleFilmStrip();break}}return this},closeViewer:function(e,t){if(!this.viewerOpen){return}if(e){e.preventDefault();e.stopPropagation()}if(this.viewerMode==="permalink"&&!t){return false}i.trigger("remove_page_event",["image_view"]);this.els.$viewer.removeClass("filmstripOpen");this.els.$viewer.removeAttr("open role aria-describedby tabindex");if(this.isCommandsTipOpen()!==false){this.toggleCommandsTip("hide")}Phoenix.jQuery.getHtml().css("overflow-y","scroll");this.resetUrl();this.viewerOpen=false;if(this.returnFocusEl){this.returnFocusEl.focus()}return this},resetUrl:function(){e.Routers.AppRouter.navigate(this.entryUrl);return this},prevImage:function(e){this.stopEvent(e);if(this.collectionIndex===0){return false}this.collectionIndex--;this.setUrlHash();return this},nextImage:function(e){this.stopEvent(e);if(this.collectionIndex>=this.collection.length-3){this.loadMoreImages()}if(this.collectionIndex===this.collection.length-1){return false}this.collectionIndex++;this.setUrlHash();return this},loadMoreImages:function(i){if(this.viewerMode!=="gallery"){return}this.loadResults(e.App,{complete:function(){if(i){i()}}})},setUrlHash:function(t){var s=this.viewerOpen;if(!s){i.trigger("render_page_event",["image_view",true])}else{i.trigger("update_page_event",["image_view"])}t=t||this.collection.at(this.collectionIndex).id;e.Routers.AppRouter.navigate("images/"+t,{trigger:true,replace:s});return this},loadImage:function(e){this.collectionIndex=_.indexOf(this.collection.models,this.collection.get(e));if(this.collectionIndex===-1){Phoenix.Ui.showErrorMessage("Error loading image viewer: invalid model data.");this.resetUrl();throw new Error("Model not set.")}this.render(e);return this},loadFromEmbed:function(e){if(!this.viewerEnabled){return}var i=$(e.currentTarget).data("refId");if(i){this.returnFocusEl=e.currentTarget;this.stopEvent(e).setUrlHash(i)}return this},showFilmStrip:function(){this.els.$viewer.addClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",true);return this},hideFilmStrip:function(){this.els.$viewer.removeClass("imageStripOpen");this.els.$imageBtnIcon.toggleClass("icon-caret-up icon-caret-down");this.$el.data("filmstripOpen",false);return this},toggleFilmStrip:function(e){this.stopEvent(e);if(this.$el.data("filmstripOpen")){this.hideFilmStrip()}else{this.showFilmStrip();this.filmstrip.render.call(this.filmstrip,null,this.collectionIndex)}},stopEvent:function(e){if(e){e.preventDefault();e.stopPropagation()}return this},togglePaginationVisibility:function(){if(this.collection.length===1){return false}else if(this.collectionIndex===0){this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.addClass("hidden")}else if(this.collectionIndex===this.collection.length-1){this.els.$imageNext.addClass("hidden");this.els.$imagePrev.removeClass("hidden")}else{this.els.$imageNext.removeClass("hidden");this.els.$imagePrev.removeClass("hidden")}return this},setEls:function(){var e=this.els,i=e.$viewer=$("#js-filmstrip");e.$imageBtnIcon=i.find("#js-btn-icon");e.$imagePane=i.find("#js-image-pane");e.$sideColumn=i.find("#js-side-column");e.$imagePrev=i.find("#js-image-prev");e.$imageNext=i.find("#js-image-next");e.$imageSource=i.find("#imageSource");e.$filmstripTab=i.find("#js-image-view-film");e.$imageStrip=i.find("#js-image-strip");e.$adLeader=i.find("#js-image-ad-leader");e.$commandsTip=i.find("#js-image-commands-tip");e.$imageClose=i.find("#js-image-close");return this},setStage:function(){var e=this.els;this.windowWidth=Phoenix.jQuery.getWindow().width();this.windowHeight=Phoenix.jQuery.getWindow().height();this.stripHeight=Math.floor(this.windowHeight*.5*.95);var i=this.windowHeight-e.$adLeader.height(),t=null,s=[e.$sideColumn];var n=$("#js-image-fs").data("fullscreen");var r=3*this.gutterSize;this.paneWidth=this.windowWidth-e.$sideColumn.width()-10;this.paneHeight=i;e.$sideColumn.css({top:e.$adLeader.outerHeight()});e.$imagePane.css({width:this.paneWidth,height:this.paneHeight});e.$imageClose.css({top:e.$adLeader.outerHeight()+40,right:e.$sideColumn.width()+40});for(t=0;t<s.length;t++){s[t].height(i)}this.centerFilmstripTab();this.imageStripRowSize=Math.floor(this.windowWidth/this.thumbSize);if(this.imageView){this.imageView.centerImage()}return this},centerFilmstripTab:function(){this.els.$filmstripTab.css({left:this.paneWidth/2-this.btnSize/2});return this},toggleFullscreen:function(e){var i=$("#js-image-fs"),t=false;if(i.data("fullscreen")){this.closeFullscreen()}else{this.openFullscreen();t=true}$.cookie("image-viewer-fullscreen",t);return false},openFullscreen:function(){var e=$("#js-image-fs");if(e.data("fullscreen")){return}e.data("cachedSideColWidth",this.els.$sideColumn.width());e.data("cachedMainColWidth",this.els.$imagePane.width());this.paneWidth=Phoenix.jQuery.getWindow().width();this.els.$sideColumn.width("0");this.els.$imagePane.width(this.paneWidth);this.els.$imageClose.css({right:40});this.centerFilmstripTab();this.imageView.centerImage();this.isFullscreen=true;e.data("fullscreen",true)},closeFullscreen:function(){var e=$("#js-image-fs");if(!e.data("fullscreen")){return}var i=e.data("cachedSideColWidth");this.els.$sideColumn.width(i);this.paneWidth=this.windowWidth-i;this.els.$imagePane.css({width:this.paneWidth,height:this.paneHeight});this.els.$imageClose.css({right:i+40});this.centerFilmstripTab();this.imageView.centerImage();e.data("fullscreen",false);this.isFullscreen=false},isCommandsTipOpen:function(){var e=this.els.$commandsTip;if(e.hasClass("image-commands-tip-fade-out")){return"fadedOut"}else if(e.hasClass("image-commands-tip-hide")){return false}else{return true}},shouldShowCommandsTip:function(){if(!$.cookie(this.commandsTipCookieKey)){$.cookie(this.commandsTipCookieKey,"1",{expires:30,path:"/"});return true}else{if(this.isCommandsTipOpen()){this.toggleCommandsTip("hide")}return false}},toggleCommandsTip:function(e){var i=this;switch(e){case"show":if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}if(this.isCommandsTipOpen()!==true){this.els.$commandsTip.removeClass("image-commands-tip-fade-out image-commands-tip-hide")}this.commandsTipTimeout=window.setTimeout(function(){i.toggleCommandsTip("fadeOut")},this.commandsTipFadeOutDelay);break;case"fadeOut":if(this.isCommandsTipOpen()===true){this.els.$commandsTip.addClass("image-commands-tip-fade-out");this.commandsTipTimeout=window.setTimeout(function(){i.toggleCommandsTip("hide")},this.commandsTipHideDelay)}break;default:if(this.isCommandsTipOpen()!==false){if(this.commandsTipTimeout!==null){window.clearTimeout(this.commandsTipTimeout);this.commandsTipTimeout=null}this.els.$commandsTip.addClass("image-commands-tip-hide").removeClass("image-commands-tip-fade-out")}}}}))})(Phoenix.ImageViewer||{});
(function(e){"use strict";e.Views.TitleBar=Backbone.View.extend({el:$("#js-image-title"),initialize:function(){this.render()},render:function(){this.$el.html(this.model.get("caption"));return this}})})(Phoenix.ImageViewer||{});
(function(e){"use strict";e.Views.InfoBar=Backbone.View.extend({el:$("#imageInfo"),template:_.template($("#imageInfoBarTemplate").html()),initialize:function(){this.render()},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}})})(Phoenix.ImageViewer||{});
(function(e,t,i,h){"use strict";e.Views.ImageView=i.View.extend({el:$("#imageSource"),imagePane:$("#js-image-pane"),loader:null,initialize:function(){var i=this,h=new Image;this.paneHeight=e.App.paneHeight;this.paneWidth=e.App.paneWidth;this.oldPaneHeight=this.paneHeight;this.oldPaneWidth=this.paneWidth;this.imageHeight=this.realImageHeight=this.model.get("height");this.imageWidth=this.realImageWidth=this.model.get("width");this.ratio=this.realImageWidth/this.realImageHeight;if(this.imageHeight===null){h.src=this.model.get("scale_super");h.onload=function(){i.imageHeight=this.height;i.imageWidth=this.width;i.realImageHeight=this.height;i.realImageWidth=this.width;i.model.set("height",this.height);i.model.set("width",this.width);i.resetImageSize();i.centerImage()}}this.model.on("change:height",function(){this.imageHeight=this.model.get("height")},this);this.model.on("change:width",function(){this.imageWidth=this.model.get("width")},this);this.clearImage();this.$el.fadeOut("fast",$.proxy(this.render,this));if(!this.$el.data("loadEventRegistered")){this.$el.on("load",function(){i.imagePane.removeClass("loading");i.$el.fadeIn("fast",function(){i.$el.focus()})}).on("error",function(){t.Ui.showErrorMessage("Error loading image. Please try another.")});this.$el.data("loadEventRegistered",true)}},checkDimensions:function(){if(this.realImageWidth<=e.App.paneWidth&&this.realImageHeight<=e.App.paneHeight){this.resetImageSize();return}if(e.App.paneWidth>0&&this.imageWidth===0)this.imageWidth=1;if(e.App.paneHeight>0&&this.imageHeight===0)this.imageHeight=1;if(this.oldPaneWidth!==e.App.paneWidth||this.imageWidth>e.App.paneWidth||this.oldPaneHeight!==e.App.paneHeight||this.imageHeight>e.App.paneHeight){if(this.ratio>e.App.paneWidth/e.App.paneHeight){this.adjustWidth()}else{this.adjustHeight()}this.oldPaneWidth=e.App.paneWidth;this.oldPaneHeight=e.App.paneHeight}},adjustWidth:function(){this.model.set({width:e.App.paneWidth,height:Math.round(1/this.ratio*e.App.paneWidth)})},adjustHeight:function(){this.model.set({width:Math.round(this.ratio*e.App.paneHeight),height:e.App.paneHeight})},resetImageSize:function(){this.model.set({width:this.realImageWidth,height:this.realImageHeight})},render:function(){t.getDocument().trigger("pre_page_event",["image_view"]);var i=this,a=this.$el,s=this.model.get("scale_super");this.imagePane.addClass("loading");i.centerImage();if(h.srcset){a.attr("srcset",i.model.get("original")+" "+i.realImageWidth+"w, "+i.model.get("scale_super")+" "+i.model.get("scale_super_width")+"w, "+i.model.get("scale_medium")+" "+i.model.get("scale_medium_width")+"w")}else{a.attr("src",s)}var g=i.model.get("comments");if(!g){var n=i.model.get("getCommentsUrl");$.ajax({url:n,data:{guid:i.model.get("id")},success:function(t){if(t.success){var h=t.data;i.model.set("comments",h);e.App.comments=new e.Views.Comments({collection:new e.Collections.Comments(h)})}}})}t.getDocument().trigger("on_page_event",["image_view"]);$(window).trigger("resize");return this},centerImage:function(t){this.checkDimensions();this.$el.css({width:this.imageWidth,height:this.imageHeight,top:this.imageHeight>=e.App.paneHeight?0:(e.App.paneHeight-this.imageHeight)/2,left:this.imageWidth>=e.App.paneWidth?0:(e.App.paneWidth-this.imageWidth)/2}).attr("sizes",this.imageWidth+"px");if(t){t.call(this)}return this},clearImage:function(){this.$el.removeAttr("src");this.$el.removeAttr("srcset");t.getDocument().trigger("post_page_event",["image_view"])}})})(Phoenix.ImageViewer||{},Phoenix,Backbone,Modernizr);
(function(e){"use strict";e.Views.FilmstripItem=Backbone.View.extend({el:$("#js-image-strip"),template:_.template($("#imageFilmstripTemplate").html()),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.template(this.model.toJSON())}})})(Phoenix.ImageViewer||{});
(function(i){"use strict";i.Views.Filmstrip=Backbone.View.extend(_.extend({},i.Views.Mixins,{el:$("#js-image-strip"),loadMore:$("#js-image-strip-load-more"),highlightedClass:"imgboxart",scrollThreshold:100,throttledLazyLoad:null,built:false,events:{"click #js-image-strip-load-more":"loadMoreImages","click a":"showImage",scroll:"checkScroll"},initialize:function(){this.collection.on("reset",function(i){this.built=false;this.collection.models=i.models;this.clearImages()},this).on("add",function(i){console.log("add");this.addImage(i)},this);this.$el.closest(".image-strip").addClass("imagestripActive");this.isLoading=false;this.throttledLazyLoad=_.throttle(this.loadVisibleImages,100);this.$el.contents().filter(function(){return this.nodeType===3}).remove()},render:function(i,e){if(this.built){this.scrollToIndex(e);this.loadVisibleImages();this.highlight(e);return false}i=i||this.collection.models;_.each(i,function(i){this.addImage(i)},this);if(e){this.scrollToIndex(e)}this.loadVisibleImages();if(e){this.highlight(e)}this.built=true;return this},scrollToIndex:function(i){var e=this.$el.find("li:eq("+i+")");var t=e.position().top+this.$el.scrollTop();this.$el.scrollTop(t)},showImage:function(e){e.preventDefault();e.stopPropagation();var t=i.App,s=null;var l=null;if(e.which===Phoenix.Core.keycodes.enterKey){l=this.$el.find("li ."+this.highlightedClass).parents("li").first();if(l.attr("id")==="js-image-strip-load-more"){this.loadMoreImages();return}s=l.find("a").attr("data-ref-id")}else{l=$(e.currentTarget);s=l.attr("data-ref-id");l=l.parent()}var a=this.$el.find("li").length;var o=this.$el.find("li").index(l[0]);if(o+5>a){t.filmstrip.loadMoreImages()}t.setUrlHash(s).toggleFilmStrip()},clearImages:function(){this.$el.children().remove()},addImage:function(e){var t=$(new i.Views.FilmstripItem({model:e}).render());t.contents().filter(function(){return this.nodeType===3}).remove();this.$el.append(t);this.loadMore.remove();this.$el.append(this.loadMore)},highlight:function(i){this.$el.find("li a."+this.highlightedClass).removeClass(this.highlightedClass).end().find("li:eq("+i+") a").addClass(this.highlightedClass)},moveHighlight:function(i){var e=this.$el.find("li"),t=this,s=e.filter(function(){return $(this).find("a."+t.highlightedClass).length>0}),l=s.index(),a=function(i){s.find("a").removeClass();var l=e.eq(i);l.find("a").addClass(t.highlightedClass);if(i+5>e.length){t.loadMoreImages()}var a=t.$el.scrollTop();var o=l.position().top;var r=o+a+l.outerHeight();var h=a+t.$el.outerHeight();if(r>h){var n=r-h+20;t.$el.animate({scrollTop:a+n},1e3)}else if(o<0){t.$el.animate({scrollTop:a+o-20},1e3)}};var o=e.first().position().left;var r=this.$el.outerWidth();var h=e.first().outerWidth(true);var n=Math.floor((r-2*o)/h);if(i==="right"){if(l===e.length-2){return false}a(l+1)}else if(i==="up"){if(l===0){return false}var d=l-n;if(d<0){d=0}a(d)}else if(i==="down"){if(l===e.length-2){return false}var d=l+n;if(d>e.length-2){d=e.length-2}a(d)}else if(i==="left"){if(l===0){return false}a(l-1)}},checkScroll:function(){var e=this;if(this.el.scrollTop+this.el.clientHeight+this.scrollThreshold>this.el.scrollHeight){this.loadResults(i.App,{success:e.loadVisibleImages})}this.throttledLazyLoad()},loadMoreImages:function(){this.loadResults(i.App,{success:this.loadVisibleImages});this.throttledLazyLoad()},loadVisibleImages:function(){i.App.stripHeight=i.App.els.$viewer.find("#js-image-strip").height();if(this.loadingVisible){return false}this.loadingVisible=true;this.$el.find("img[data-img-src]").each(function(){var e=$(this),t=Math.round(e.closest("li").position().top);if(t>=0&&t<=i.App.stripHeight&&e.data("imgSrc")){$("<img />").on("load",function(){e.attr("src",e.data("imgSrc")).addClass("loaded").removeAttr("data-img-src")}).attr("src",e.data("imgSrc"))}});this.loadingVisible=false}}))})(Phoenix.ImageViewer||{});
(function(e){"use strict";e.Views.Comments=Backbone.View.extend({el:$("#imageComments"),template:_.template($("#imageCommentsTemplate").html()),initialize:function(){this.$el.empty();this.render()},render:function(){_.each(this.collection.models,function(e){this.add(e.toJSON())},this);return this},add:function(e){if(!e){Phoenix.Ui.showErrorMessage("Error posting comment, please try again later.");return false}this.$el.append(this.template(e));return true}})})(Phoenix.ImageViewer||{});
(function(e){"use strict";e.Views.CommentPoster=Backbone.View.extend({el:$("#imageCommentPoster"),posting:false,initialize:function(){var n=this;this.$el.find("#postComment").on("click",function(t){t.preventDefault();t.stopPropagation();if(n.posting){return}var i=n.$el.find("#imageComment").val();n.posting=true;$.ajax({type:"POST",url:e.App.commentUrl,data:{guid:e.App.activeGuid,comment:i},beforeSend:function(){},complete:function(){n.posting=false},success:function(t){var i=e.App.comments.add(t.data);if(!i){return}Phoenix.Ui.showSuccessMessage("Comment posted.");n.$el.find("#imageComment").val("");n.hideComments()},error:function(e,n,t){Phoenix.Ui.showSuccessMessage("Error posting comment.")}})})},hideComments:function(){this.$el.parent().addClass("hide")},showComments:function(){this.$el.parent().removeClass("hide")}})})(Phoenix.ImageViewer||{});
(function(e){"use strict";e.Routers=e.Routers||{};e.Routers.ImageViewer=Backbone.Router.extend({routes:{"images/:id/":"loadImage","images/:id":"loadImage","*notFound":"closeViewer"},initialize:function(){e.App=new e.Views.Viewer({collection:new e.Collections.Images})},loadImage:function(t){e.App.loadImage(t);var i=$('meta[itemprop="deviceType"]').attr("content");if(i==="phone"){return}e.App.commentPoster.showComments();if($.cookie("image-viewer-fullscreen")==="true"){e.App.openFullscreen()}else{e.App.closeFullscreen()}},closeViewer:function(t){e.App.closeViewer()}});e.initialize=function(){var t=false;var i=false;var n=false;var o=function(){return Backbone.History.started};var a=function(){if(o()||!t||!i||!n){return}var e=$('meta[itemprop="deviceType"]').attr("content");if(!o()&&e!=="phone"){if(!window.history.pushState){var a=location.pathname;if(a.indexOf("/images/")===0||a.indexOf("images")===0){if(a.indexOf("/")===0){a=a.substr(1)}location.hash=a}Backbone.history.start({pushState:false,root:location.host+location.pathname})}else{Backbone.history.start({pushState:true})}}};var r={tracking_initialized:function(){i=true;a()}};var s=function(){var e=$(".ad-settings");if(!e||e.length<1){t=true;return}r.ads_initialized=function(){t=true;a()}};return function(){e.Routers.AppRouter=new e.Routers.ImageViewer;Phoenix.jQuery.getWindow().on("collectionLoaded",function(){n=true;a()});s();$(document).on(r)}}();$(e.initialize())})(Phoenix.ImageViewer||{});