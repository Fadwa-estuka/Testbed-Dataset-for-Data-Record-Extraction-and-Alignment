MC.Challenge=new function(){var c=this;var b;var a=null;var d;this.init=function(){if(typeof challenge_data!="undefined"){c.challenge_info=challenge_data;c._startChallengeExpiryTime();c.updateChallengeBox()}$(".livestamp").each(function(){var e=$(this).data("livestamp");$(this).html(moment(e).fromNow())})};this.getURLParameter=function(e){var g=window.location.search.substring(1);var h=g.split("&");for(var f=0;f<h.length;f++){var j=h[f].split("=");if(j[0]==e){return j[1]}}return(false)};this._padCounter=function(e){var f="00";return f.substring(0,f.length-e.toString().length)+e};this.updateChallengeBox=function(e){if((typeof(e)!="undefined")&&(typeof(e)!="undefined")){c.challenge_info=e}if(c.challenge_info){c._hideAllDivs();if(c.challenge_info.expire_date!=null){$("div#challenge").show();if(c.challenge_info.player1_score!=null){$("#"+c.challenge_info.player1_id+"-user-score").html(c.challenge_info.player1_score)}if(c.challenge_info.player2_score!=null){$("#"+c.challenge_info.player2_id+"-user-score").html(c.challenge_info.player2_score)}if(c.challenge_info.winner!=null){$("div#challenge-again").show();if(c.challenge_info.winner==1){$("#"+c.challenge_info.player1_id+"-challenge-status").html("WINNER");$("#"+c.challenge_info.player1_id+"-challenge-status").addClass("winner")}else{if(c.challenge_info.winner==2){$("#"+c.challenge_info.player2_id+"-challenge-status").html("WINNER");$("#"+c.challenge_info.player2_id+"-challenge-status").addClass("winner")}else{$("#"+c.challenge_info.player1_id+"-challenge-status").html("DRAW");$("#"+c.challenge_info.player1_id+"-challenge-status").addClass("draw");$("#"+c.challenge_info.player2_id+"-challenge-status").html("DRAW");$("#"+c.challenge_info.player2_id+"-challenge-status").addClass("draw")}}}else{$("div#challenge-expiry-container").show()}}else{if(game_data.user_id==c.challenge_info.player1_id){$('div#pending-challenge[data-player="player1"]').show()}else{$('div#pending-challenge[data-player="player2"]').show()}}c._startChallengeExpiryTime()}};this.acceptChallenge=function(){stats_manager.trackerChallenges("accept");if(typeof(c.challenge_info)!="undefined"){$.ajax({url:"/games/challenges/accept",type:"POST",dataType:"JSON",data:{game_id:c.challenge_info.game_id,player1_id:c.challenge_info.player1_id,player2_id:c.challenge_info.player2_id,created_date:c.challenge_info.created_date},success:function(e){if(typeof e.success==="undefined"){throw ("Challenge.acceptChallenge - Error: Can't accept the challenge")}if(!e.success){throw ("Challenge.acceptChallenge - Error: "+e.message)}else{if(typeof e.challenge_data!="undefined"){c.challenge_info=e.challenge_data}c.updateChallengeBox()}},error:function(e){throw ("Challenge.acceptChallenge - Error: Error in ajax call")}})}};this.rematchChallenge=function(){stats_manager.trackerChallenges("rematch");if(typeof(c.challenge_info)!="undefined"){$.ajax({url:"/games/challenges/rematch",type:"POST",dataType:"JSON",data:{game_id:c.challenge_info.game_id,player1_id:game_data.user_id,player2_id:game_data.user_id==c.challenge_info.player1_id?c.challenge_info.player2_id:c.challenge_info.player1_id,created_date:c.challenge_info.created_date},success:function(e){if(typeof e.success==="undefined"){throw ("Challenge.rematchChallenge - Error: Can't rematch the challenge")}if(!e.success){throw ("Challenge.rematchChallenge - Error: "+e.message)}else{if(typeof e.challenge_data!="undefined"){c.challenge_info=e.challenge_data}c.updateChallengeBox()}},error:function(e){throw ("Challenge.rematchChallenge - Error: Error in ajax call")}})}};this.rejectChallenge=function(){if(typeof(c.challenge_info)!="undefined"){$.ajax({url:"/games/challenges/reject",type:"POST",dataType:"JSON",data:{game_id:c.challenge_info.game_id,player1_id:c.challenge_info.player1_id,player2_id:c.challenge_info.player2_id,created_date:c.challenge_info.created_date},success:function(e){if(typeof e.success==="undefined"){throw ("Challenge.rejectChallenge - Error: Can't accept the challenge")}if(!e.success){throw ("Challenge.rejectChallenge - Error: "+e.message)}stats_manager.trackerChallenges("reject");clearInterval(c.interval_handler);c._hideAllDivs();$("div#rejected-challenge").show()},error:function(e){throw ("Challenge.rejectChallenge - Error: Error in ajax call")}})}};this.getChallenge=function(e){if(typeof(c.challenge_info)!="undefined"){$.ajax({url:"/games/challenges/getLatest",type:"POST",dataType:"JSON",data:{game_id:c.challenge_info.game_id,player1_id:c.challenge_info.player1_id,player2_id:c.challenge_info.player2_id,created_date:c.challenge_info.created_date},success:function(f){if(typeof f.success==="undefined"){throw ("Challenge.getChallenge - Error: Can't get the challenge")}if(!f.success){delete c.challenge_info;e(null)}else{if(typeof f.challenge_data!="undefined"){c.challenge_info=f.challenge_data;e(f.challenge_data)}else{e(null)}}},error:function(f){throw ("Challenge.getChallenge - Error: Error in ajax call")}})}};this._startChallengeExpiryTime=function(){if(typeof(c.challenge_info)!="undefined"){if(c.challenge_info.expire_date){var k=new Date();var g=k.getMonth()+1;var j=k.getFullYear();var f=k.getTime();var i=new Date(c.challenge_info.expire_date.replace(" ","T"));var h=i.getTime();var e=Math.ceil((h-f)/1000);c.countdown=e;clearInterval(c.interval_handler);c.interval_handler=setInterval(function(){c.countdown--;var p=c.countdown;if(p<60){var o=0;var l=0;var m=0;var n=p}else{if(p<3600){var o=0;var l=0;var m=Math.floor(p/60)%60;p-=m*60;var n=p}else{if(p<86400){var o=0;var l=Math.floor(p/3600)%24;p-=l*3600;var m=Math.floor(p/60)%60;p-=m*60;var n=p}else{var o=Math.floor(p/86400);p-=o*86400;var l=Math.floor(p/3600)%24;p-=l*3600;var m=Math.floor(p/60)%60;p-=m*60;var n=p}}}if((p<=0)||(p%60==0)){clearInterval(c.interval_handler);c.getChallenge(function(){c.updateChallengeBox()})}else{if(l>0){$("#challenge-expiry-hours").html(l+" hours")}else{$("#challenge-expiry-hours").html("")}if(m>0){$("#challenge-expiry-minutes").html(m+" minutes")}else{$("#challenge-expiry-minutes").html("")}if(n>0){$("#challenge-expiry-seconds").html(n+" seconds")}else{$("#challenge-expiry-seconds").html("")}}},1000)}else{clearInterval(c.interval_handler);c.interval_handler=setInterval(function(){c.getChallenge(function(){if(typeof c.challenge_info!=="undefined"){if(c.challenge_info.winner==-1){clearInterval(c.interval_handler);c._hideAllDivs();$("div#rejected-challenge").show()}else{if(c.challenge_info.expire_date!=null){c.updateChallengeBox()}}}else{clearInterval(c.interval_handler)}})},60000)}}};this._hideAllDivs=function(){$("div#new-challenge").hide();$("div#pending-challenge").hide();$("div#challenge-again").hide();$("div#challenge-expiry-container").hide();$("div#challenge").hide();$("div#rejected-challenge").hide();if(typeof c.challenge_info!="undefined"){$("#"+c.challenge_info.player1_id+"-challenge-status").removeClass("winner loser draw");$("#"+c.challenge_info.player2_id+"-challenge-status").removeClass("winner loser draw");$("#"+c.challenge_info.player1_id+"-user-score").html("Awaiting score");$("#"+c.challenge_info.player2_id+"-user-score").html("Awaiting score")}};return{updateChallengeBox:this.updateChallengeBox,getChallenge:this.getChallenge,acceptChallenge:this.acceptChallenge,rematchChallenge:this.rematchChallenge,rejectChallenge:this.rejectChallenge,challenge_info:this.challenge_info,init:this.init}};$(document).ready(MC.Challenge.init());